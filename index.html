<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>GhostRun</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Noto+Sans+KR:wght@200;300;400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
:root{
  --bg:#0c0c0e;--sf:#141416;--sf2:#1a1a1d;
  --ln:rgba(255,255,255,.07);--dim:rgba(255,255,255,.22);--mid:rgba(255,255,255,.48);
  --hi:#ede9e1;--acc:#c8f050;--acc2:rgba(200,240,80,.12);
  --gold:#d4b54a;--silver:#a8b0b8;--bronze:#b07444;
  --fd:"Cormorant Garamond",Georgia,serif;
  --fb:"Noto Sans KR",system-ui,sans-serif;
}
body{background:var(--bg);color:var(--hi);font-family:var(--fb);display:flex;flex-direction:column;height:100dvh;max-width:430px;margin:0 auto;position:relative}

/* NAV */
#nav{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:16px 20px 0;min-height:50px}
.logo{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
#clock{font-size:11px;font-weight:200;color:var(--dim);font-variant-numeric:tabular-nums}

/* BOTTOM TAB BAR */
#btabs{flex-shrink:0;display:flex;align-items:stretch;background:rgba(14,14,16,.97);border-top:1px solid var(--ln);padding-bottom:env(safe-area-inset-bottom,0px);z-index:50}
.btab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:9px 4px 8px;background:none;border:none;cursor:pointer;font-family:var(--fb);font-size:9px;font-weight:200;letter-spacing:.06em;color:var(--dim);transition:color .2s}
.btab svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;transition:stroke .2s}
.btab.on{color:var(--hi)}
.btab-dot{width:4px;height:4px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity .2s}
.btab.on .btab-dot{opacity:1}

/* MAIN VIEWS */
#main{flex:1;min-height:0;overflow:hidden;position:relative}
.mview{position:absolute;inset:0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .2s;overflow:hidden}
.mview.on{opacity:1;pointer-events:all}

/* === SHOT VIEW === */
#v-shot{padding:10px 14px 0;background:var(--bg)}
#card{flex:1;position:relative;border-radius:18px;overflow:hidden;background:#101012;min-height:0}
#bg-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s}
#empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#13131a,#0c0c0e)}
.e-grain{position:absolute;inset:0;opacity:.3;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23f)' opacity='.07'/%3E%3C/svg%3E")}
.e-icon{font-size:26px;opacity:.18;filter:grayscale(1);position:relative}
.e-hint{font-size:10px;font-weight:200;letter-spacing:.14em;color:var(--dim);opacity:.55;position:relative}
#ovs{position:absolute;inset:0;z-index:5;pointer-events:none}
.ov{position:absolute;inset:0;transition:opacity .35s}
.ov.off{opacity:0}
.ft{position:absolute;top:0;left:0;right:0;height:170px;background:linear-gradient(180deg,rgba(0,0,0,.75),transparent)}
.fb{position:absolute;bottom:0;left:0;right:0;height:260px;background:linear-gradient(0deg,rgba(0,0,0,.92) 0%,rgba(0,0,0,.4) 55%,transparent)}
.ov-hd{position:absolute;top:0;left:0;right:0;padding:16px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.runner{display:flex;align-items:center;gap:6px;cursor:pointer;pointer-events:all}
.r-em{font-size:17px;line-height:1;transition:transform .18s}
.runner:active .r-em{transform:scale(1.15)}
.r-nm{font-size:12px;font-weight:200;color:rgba(255,255,255,.72)}
.ov-dt{font-size:9px;font-weight:200;color:rgba(255,255,255,.22);text-align:right;line-height:1.9}
.chip{position:absolute;display:flex;align-items:baseline;gap:4px;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.09);border-radius:99px;padding:5px 12px;pointer-events:none}
.ch-n{font-family:var(--fd);font-style:italic;font-size:20px;line-height:1}
.ch-n.g{color:var(--gold)}.ch-n.s{color:var(--silver)}.ch-n.b{color:var(--bronze)}.ch-n.o{color:var(--acc)}
.ch-of{font-size:10px;font-weight:200;color:rgba(255,255,255,.28)}
/* Ghost */
.gchip{top:16px;right:16px}
.gboard{position:absolute;right:14px;bottom:68px;display:flex;flex-direction:column;gap:2px;pointer-events:none}
.gb-lbl{font-size:8px;font-weight:200;letter-spacing:.12em;color:rgba(255,255,255,.18);text-align:right;margin-bottom:3px}
.gb-row{display:flex;align-items:center;gap:5px;padding:4px 8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.06);border-radius:6px;backdrop-filter:blur(4px)}
.gb-row.me{background:rgba(200,240,80,.08);border-color:rgba(200,240,80,.2)}
.gb-n{font-size:9px;font-weight:300;color:rgba(255,255,255,.22);width:11px;text-align:right}
.gb-n.g{color:var(--gold)}.gb-n.s{color:var(--silver)}.gb-n.b{color:var(--bronze)}
.gb-e{font-size:11px}
.gb-d{font-size:9px;font-weight:300;color:rgba(255,255,255,.42);margin-left:auto;font-variant-numeric:tabular-nums}
.gb-d.me{color:var(--acc)}
.g-bot{position:absolute;bottom:0;left:0;right:64px;padding:0 18px 18px}
.g-dist{font-family:var(--fd);font-style:italic;font-size:52px;font-weight:300;line-height:.9;letter-spacing:-.02em}
.g-du{font-family:var(--fb);font-size:15px;font-weight:200;color:var(--mid);margin-left:3px;vertical-align:middle}
.g-stats{display:flex;margin-top:9px}
.g-s{flex:1;display:flex;flex-direction:column;gap:2px}
.g-s+.g-s{border-left:1px solid rgba(255,255,255,.07);padding-left:13px}
.g-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:rgba(255,255,255,.2)}
.g-sv{font-size:13px;font-weight:300;color:var(--mid)}
.g-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.g-brand{font-size:9px;font-weight:200;letter-spacing:.16em;color:rgba(255,255,255,.1)}
.g-tag{font-size:9px;font-weight:200;color:rgba(200,240,80,.42)}
#mmg{width:40px;height:40px;border-radius:5px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4);display:block}
/* Path */
.p-logo{font-family:var(--fd);font-style:italic;font-size:13px;font-weight:300;color:rgba(255,255,255,.3)}
.p-mapbg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
#mmp{width:62%;max-width:220px;aspect-ratio:1;opacity:.25}
.p-chip{bottom:116px;left:50%;top:auto;transform:translateX(-50%)}
.p-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px;display:flex;justify-content:space-between;align-items:flex-end}
.p-stat{display:flex;flex-direction:column;gap:2px}
.p-l{font-size:8px;font-weight:200;letter-spacing:.12em;color:rgba(255,255,255,.22)}
.p-v{font-family:var(--fd);font-style:italic;font-size:29px;color:var(--hi);line-height:1}
.p-u{font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid)}
/* Stamp */
.st-vign{position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.62) 100%)}
.st-logo{font-size:9px;font-weight:200;letter-spacing:.2em;color:rgba(255,255,255,.2)}
.st-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px}
.st-rrow{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.st-rn{font-family:var(--fd);font-style:italic;font-size:34px;line-height:1}
.st-rn.g{color:var(--gold)}.st-rn.s{color:var(--silver)}.st-rn.b{color:var(--bronze)}.st-rn.o{color:var(--acc)}
.st-of{font-size:12px;font-weight:200;color:rgba(255,255,255,.3)}
.st-dist{font-family:var(--fd);font-style:italic;font-size:50px;line-height:.9;letter-spacing:-.02em}
.st-du{font-family:var(--fb);font-size:17px;font-weight:200;color:var(--mid);margin-left:2px}
.st-sub{display:flex;gap:14px;margin-top:8px}
.ss{display:flex;flex-direction:column;gap:1px}
.ss-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:rgba(255,255,255,.2)}
.ss-v{font-size:13px;font-weight:300;color:var(--mid)}
.st-badge{position:absolute;bottom:16px;right:16px;width:82px;height:82px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.44);backdrop-filter:blur(8px)}
.st-badge::before{content:"";position:absolute;inset:5px;border-radius:50%;border:1px solid rgba(200,240,80,.1)}
.sb-em{font-size:23px;line-height:1}
.sb-done{font-size:7px;font-weight:200;letter-spacing:.12em;color:rgba(200,240,80,.5)}
.sb-date{font-size:7px;font-weight:200;color:rgba(255,255,255,.18)}
#mms{position:absolute;top:70px;right:18px;width:42px;height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4);display:block}
#tbar{flex-shrink:0;display:flex;gap:6px;padding:8px 14px 5px;overflow-x:auto;scrollbar-width:none}
#tbar::-webkit-scrollbar{display:none}
.th{flex-shrink:0;background:none;border:1px solid var(--ln);border-radius:99px;padding:6px 14px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.06em;color:var(--dim);cursor:pointer;transition:all .2s}
.th.on{border-color:rgba(255,255,255,.3);color:var(--hi)}
#shot-acts{flex-shrink:0;display:flex;gap:8px;padding:5px 14px 10px}
.ai{width:46px;background:var(--sf);border:1px solid var(--ln);border-radius:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s;flex-shrink:0}
.ai:active{background:rgba(255,255,255,.1)}
.ai svg{width:17px;height:17px;stroke:var(--mid);stroke-width:1.5;fill:none;stroke-linecap:round;stroke-linejoin:round}
.asave{flex:1;background:var(--hi);border:none;border-radius:13px;font-family:var(--fb);font-size:13px;font-weight:300;letter-spacing:.04em;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:opacity .2s}
.asave:active{opacity:.8}

/* === RECORDS VIEW === */
#v-records{overflow-y:auto;scrollbar-width:none;background:var(--bg)}
#v-records::-webkit-scrollbar{display:none}
.rec-header{padding:20px 20px 16px;border-bottom:1px solid var(--ln)}
.rec-h-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:14px}
.rec-total-row{display:flex;gap:0}
.rec-stat{flex:1;display:flex;flex-direction:column;gap:3px}
.rec-stat+.rec-stat{border-left:1px solid var(--ln);padding-left:16px}
.rec-sl{font-size:9px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.rec-sv{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;color:var(--hi)}
.month-strip{padding:16px 20px 0}
.ms-label{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:10px}
.month-dots{display:flex;gap:3px;flex-wrap:wrap}
.md{width:10px;height:10px;border-radius:2px;background:rgba(255,255,255,.07)}
.md.run{background:rgba(200,240,80,.5)}
.md.today{background:var(--acc);box-shadow:0 0 5px rgba(200,240,80,.5)}
.log-section{padding:16px 20px 0}
.log-label{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:12px}
.log-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--ln)}
.log-date-col{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:1px;width:32px}
.log-month{font-size:8px;font-weight:200;color:var(--dim)}
.log-day{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;line-height:1}
.log-route{width:44px;height:44px;flex-shrink:0;border-radius:7px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4)}
.log-info{flex:1;display:flex;flex-direction:column;gap:3px}
.log-crew-tag{font-size:9px;font-weight:200;background:var(--sf2);border:1px solid var(--ln);border-radius:99px;padding:2px 8px;color:var(--dim);display:inline-flex;align-items:center;gap:3px;width:fit-content}
.log-dist{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;line-height:1}
.log-sub{font-size:10px;font-weight:200;color:var(--dim)}
.log-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.log-rank-chip{font-family:var(--fd);font-style:italic;font-size:16px;font-weight:300}
.log-rank-chip.g{color:var(--gold)}.log-rank-chip.s{color:var(--silver)}.log-rank-chip.b{color:var(--bronze)}.log-rank-chip.o{color:var(--acc)}
.crews-section{padding:16px 20px 24px}
.crew-past-card{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--ln)}
.cpc-em{font-size:22px;flex-shrink:0}
.cpc-info{flex:1;display:flex;flex-direction:column;gap:2px}
.cpc-name{font-size:13px;font-weight:300}
.cpc-meta{font-size:10px;font-weight:200;color:var(--dim)}
.cpc-badge{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.expert-badge{background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.25);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:300;color:rgba(200,240,80,.85)}
.cpc-rank{font-family:var(--fd);font-style:italic;font-size:14px}
.cpc-rank.g{color:var(--gold)}.cpc-rank.s{color:var(--silver)}.cpc-rank.b{color:var(--bronze)}.cpc-rank.o{color:var(--acc)}

/* === CREW VIEW === */
#v-crew{background:var(--bg)}
#ctabs{flex-shrink:0;display:flex;padding:0 18px;border-bottom:1px solid var(--ln);overflow-x:auto;scrollbar-width:none}
#ctabs::-webkit-scrollbar{display:none}
.ctab{flex-shrink:0;background:none;border:none;border-bottom:1.5px solid transparent;padding:12px 12px 9px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.07em;color:var(--dim);cursor:pointer;transition:all .25s;white-space:nowrap}
.ctab.on{color:var(--hi);border-bottom-color:var(--hi)}
.cpane{flex:1;display:none;flex-direction:column;overflow-y:auto;scrollbar-width:none;padding:0 18px 120px}
.cpane::-webkit-scrollbar{display:none}
.cpane.on{display:flex}

/* no-crew empty state */
#no-crew{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 28px 40px;text-align:center;overflow-y:auto;scrollbar-width:none}
#no-crew::-webkit-scrollbar{display:none}
#no-crew.hidden{display:none}
.nc-ghost{font-size:52px;margin-bottom:18px;animation:floatGhost 3s ease-in-out infinite}
@keyframes floatGhost{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.nc-title{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;margin-bottom:8px}
.nc-sub{font-size:12px;font-weight:200;color:var(--dim);line-height:1.7;margin-bottom:32px}
.nc-actions{display:flex;flex-direction:column;gap:10px;width:100%}
.nc-btn-primary{background:var(--hi);border:none;border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .2s;letter-spacing:.02em}
.nc-btn-primary:active{opacity:.85}
.nc-btn-sec{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
.nc-btn-sec:active{background:rgba(255,255,255,.08)}
.nc-divider{display:flex;align-items:center;gap:10px;padding:4px 0}
.nc-divider::before,.nc-divider::after{content:'';flex:1;height:1px;background:var(--ln)}
.nc-divider span{font-size:10px;font-weight:200;color:rgba(255,255,255,.15)}
.nc-nearby-preview{width:100%;background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:14px 16px;margin-top:4px}
.nc-near-label{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:10px}
.nc-near-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--ln)}
.nc-near-row:last-child{border-bottom:none;padding-bottom:0}
.nc-near-em{font-size:16px;flex-shrink:0}
.nc-near-info{flex:1;min-width:0}
.nc-near-name{font-size:12px;font-weight:300}
.nc-near-meta{font-size:9px;font-weight:200;color:var(--dim);margin-top:1px}
.nc-near-pct{font-family:var(--fd);font-style:italic;font-size:15px;font-weight:300;color:var(--acc);opacity:.8;flex-shrink:0}
.nc-near-join{background:rgba(200,240,80,.12);border:1px solid rgba(200,240,80,.25);border-radius:99px;padding:5px 13px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer;flex-shrink:0;transition:background .2s}
.nc-near-join:active{background:rgba(200,240,80,.22)}

/* JOIN MODAL */
#join-modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .28s}
#join-modal.on{opacity:1;pointer-events:all}
.jm-box{width:100%;max-width:430px;background:#111113;border:1px solid var(--ln);border-bottom:none;border-radius:22px 22px 0 0;padding:24px 20px 44px;transform:translateY(16px);transition:transform .3s}
#join-modal.on .jm-box{transform:translateY(0)}
.jm-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:5px}
.jm-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:22px;line-height:1.6}
.jm-input{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px 16px;font-family:var(--fb);font-size:16px;font-weight:300;color:var(--hi);letter-spacing:.1em;outline:none;transition:border-color .2s;caret-color:var(--acc);margin-bottom:12px;text-transform:uppercase}
.jm-input::placeholder{color:rgba(255,255,255,.2);letter-spacing:.06em;text-transform:none}
.jm-input:focus{border-color:rgba(200,240,80,.4)}
.jm-preview{background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.18);border-radius:14px;padding:14px 16px;margin-bottom:14px;display:none}
.jm-preview.on{display:flex;align-items:center;gap:12px}
.jm-prev-em{font-size:26px;flex-shrink:0}
.jm-prev-info{flex:1}
.jm-prev-name{font-size:14px;font-weight:300;margin-bottom:3px}
.jm-prev-meta{font-size:10px;font-weight:200;color:var(--dim)}
.jm-prev-pct{font-family:var(--fd);font-style:italic;font-size:22px;color:var(--acc);opacity:.85;flex-shrink:0}
.jm-confirm{width:100%;background:var(--hi);border:none;border-radius:14px;padding:14px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;transition:opacity .2s;display:none;margin-bottom:8px}
.jm-confirm.on{display:block}
.jm-confirm:active{opacity:.85}
.jm-cancel{width:100%;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer}

/* CREATE CREW MODAL */
#create-modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .28s}
#create-modal.on{opacity:1;pointer-events:all}
.cm-box{width:100%;max-width:430px;background:#111113;border:1px solid var(--ln);border-bottom:none;border-radius:22px 22px 0 0;padding:24px 20px 44px;transform:translateY(16px);transition:transform .3s;max-height:88dvh;overflow-y:auto;scrollbar-width:none}
.cm-box::-webkit-scrollbar{display:none}
#create-modal.on .cm-box{transform:translateY(0)}
.cm-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:5px}
.cm-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:24px;line-height:1.6}
.cm-field{margin-bottom:18px}
.cm-label{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:8px}
.cm-text-input{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;font-family:var(--fb);font-size:14px;font-weight:200;color:var(--hi);outline:none;transition:border-color .2s;caret-color:var(--acc)}
.cm-text-input:focus{border-color:rgba(200,240,80,.35)}
.cm-text-input::placeholder{color:rgba(255,255,255,.18)}
.cm-emoji-row{display:flex;gap:8px;flex-wrap:wrap}
.cm-em-opt{width:46px;height:46px;background:var(--sf);border:1px solid var(--ln);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all .2s}
.cm-em-opt.on{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.07);transform:scale(1.06)}
.cm-goal-row{display:flex;gap:8px}
.cm-goal-opt{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s}
.cm-goal-opt.on{border-color:rgba(200,240,80,.35);background:rgba(200,240,80,.07)}
.cm-goal-km{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300;color:var(--hi);display:block}
.cm-goal-lbl{font-size:8px;font-weight:200;color:var(--dim)}
.cm-confirm{width:100%;background:var(--hi);border:none;border-radius:14px;padding:14px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;margin-top:4px;transition:opacity .2s}
.cm-confirm:active{opacity:.85}
.cm-cancel{width:100%;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer;margin-top:8px}
/* crew header */
.crew-hdr{display:flex;justify-content:space-between;align-items:center;padding:18px 0 14px;border-bottom:1px solid var(--ln)}
.crew-hdr-left{display:flex;flex-direction:column;gap:2px}
.crew-hdr-loc{font-size:10px;font-weight:200;color:var(--acc);opacity:.75;margin-top:2px}
.crew-hdr-name{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.crew-hdr-sub{font-size:10px;font-weight:200;color:var(--dim)}
.crew-expert-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(212,181,74,.15),rgba(200,240,80,.08));border:1px solid rgba(212,181,74,.3);border-radius:99px;padding:5px 11px;font-size:10px;font-weight:300;color:rgba(212,181,74,.9)}
/* goal card */
.gc-card{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:16px 16px 14px;margin:14px 0}
.gc-top{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.gc-lbl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:5px}
.gc-nums{display:flex;align-items:baseline;gap:4px}
.gc-cur{font-family:var(--fd);font-style:italic;font-size:38px;font-weight:300;line-height:1}
.gc-sep{font-size:14px;font-weight:200;color:var(--dim)}
.gc-tot{font-size:16px;font-weight:200;color:var(--dim)}
.gc-unit{font-size:11px;font-weight:200;color:var(--dim);opacity:.5;margin-left:2px}
.gc-pct{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;color:var(--acc);opacity:.85}
.prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:12px}
.pf{height:1px;background:var(--acc);transition:width 1.4s cubic-bezier(.4,0,.2,1);position:relative}
.pd{position:absolute;right:-3px;top:-2.5px;width:6px;height:6px;border-radius:50%;background:var(--acc);box-shadow:0 0 8px rgba(200,240,80,.5)}
.gc-meta{display:flex}
.gm{flex:1;display:flex;flex-direction:column;gap:2px}
.gm+.gm{border-left:1px solid var(--ln);padding-left:12px}
.gm-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.gm-v{font-size:13px;font-weight:300;color:var(--mid)}
.gm-v.a{color:var(--acc);opacity:.85}
/* crew lb */
.lb-hdr{display:flex;justify-content:space-between;margin-bottom:10px;padding-top:4px}
.lb-ttl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim)}
.lb-cnt{font-size:9px;font-weight:200;color:rgba(255,255,255,.15)}
.lbrow{display:flex;align-items:center;gap:9px;padding:10px 0;border-bottom:1px solid var(--ln)}
.lbrow.clickable{cursor:pointer;transition:background .15s;border-radius:8px;padding:10px 6px;margin:0 -6px}
.lbrow.clickable:active{background:rgba(255,255,255,.04)}
.lbrow.me .lb-nm{color:var(--hi)}.lbrow.me .lb-d{color:var(--acc);opacity:.85}
.lbpos{width:17px;font-size:11px;font-weight:300;text-align:center;color:var(--dim);flex-shrink:0}
.lbpos.g{color:var(--gold)}.lbpos.s{color:var(--silver)}.lbpos.b{color:var(--bronze)}
.lbem{font-size:15px;flex-shrink:0}
.lb-nm-col{flex:1;min-width:0;display:flex;flex-direction:column;gap:1px}
.lb-nm{font-size:12px;font-weight:200;color:var(--mid);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-hint{font-size:9px;font-weight:200;color:rgba(255,255,255,.2)}
.lb-rt{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.lb-d{font-size:12px;font-weight:300;color:var(--mid);font-variant-numeric:tabular-nums}
.lb-bg{width:42px;height:1px;background:rgba(255,255,255,.07)}
.lb-bar{height:1px}
.lb-bar.me{background:var(--acc)}.lb-bar.g{background:var(--gold)}.lb-bar.s{background:var(--silver)}.lb-bar.b{background:var(--bronze)}.lb-bar.o{background:rgba(255,255,255,.18)}
/* nearby crews */
.nb-sec-hdr{padding:18px 0 10px;border-bottom:1px solid var(--ln)}
.nb-area{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.nb-desc{font-size:10px;font-weight:200;color:var(--dim);margin-top:3px}
.nb-row{padding:14px 0;border-bottom:1px solid var(--ln)}
.nb-top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.nb-left{display:flex;flex-direction:column;gap:3px}
.nb-rank-name{display:flex;align-items:center;gap:7px}
.nb-arank{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300;flex-shrink:0}
.nb-arank.g{color:var(--gold)}.nb-arank.s{color:var(--silver)}.nb-arank.b{color:var(--bronze)}.nb-arank.o{color:var(--acc)}
.nb-cname{font-size:14px;font-weight:300}
.nb-mine-tag{font-size:8px;font-weight:200;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:99px;padding:2px 7px;color:rgba(200,240,80,.8)}
.nb-cmeta{font-size:9px;font-weight:200;color:var(--dim)}
.nb-pct{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;color:var(--acc);opacity:.85}
.nb-prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:10px}
.nb-pf{height:1px;background:rgba(200,240,80,.5);position:relative}
.nb-pd{position:absolute;right:-2px;top:-2px;width:5px;height:5px;border-radius:50%;background:rgba(200,240,80,.7)}
.nb-bottom{display:flex;justify-content:space-between;align-items:center}
.nb-ghosts{font-size:14px;letter-spacing:.02em}
.nb-nums{display:flex;gap:14px}
.nbn{display:flex;flex-direction:column;align-items:flex-end;gap:1px}
.nbn-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.nbn-v{font-family:var(--fd);font-style:italic;font-size:14px;font-weight:300}
/* past crews pane */
.past-sec-hdr{display:flex;justify-content:space-between;align-items:center;padding:18px 0 12px;border-bottom:1px solid var(--ln)}
.past-sec-title{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.create-btn{display:flex;align-items:center;gap:5px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.25);border-radius:99px;padding:6px 12px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer;transition:background .2s}
.create-btn:active{background:rgba(200,240,80,.18)}
.past-card{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--ln)}
.pc-em{font-size:20px;flex-shrink:0}
.pc-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:3px}
.pc-name{font-size:13px;font-weight:300}
.pc-meta{font-size:10px;font-weight:200;color:var(--dim)}
.pc-expert{background:linear-gradient(135deg,rgba(212,181,74,.15),rgba(200,240,80,.08));border:1px solid rgba(212,181,74,.28);border-radius:99px;padding:2px 8px;font-size:8px;font-weight:200;color:rgba(212,181,74,.85);display:inline-block;margin-top:3px}
.pc-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.pc-rank{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.pc-rank.g{color:var(--gold)}.pc-rank.s{color:var(--silver)}.pc-rank.b{color:var(--bronze)}.pc-rank.o{color:var(--acc)}
.pc-dist{font-size:10px;font-weight:200;color:var(--dim)}

/* EXPERT MODAL */
#expert-modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
#expert-modal.on{opacity:1;pointer-events:all}
.em-box{width:100%;max-width:430px;background:#111113;border:1px solid var(--ln);border-bottom:none;border-radius:20px 20px 0 0;padding:22px 20px 40px;transform:translateY(14px);transition:transform .3s}
#expert-modal.on .em-box{transform:translateY(0)}
.em-title{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;margin-bottom:4px}
.em-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:20px}
.em-option{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--sf);border:1px solid var(--ln);border-radius:14px;margin-bottom:8px;cursor:pointer;transition:border-color .2s}
.em-option:hover{border-color:rgba(200,240,80,.25)}
.em-opt-em{font-size:24px}
.em-opt-info{display:flex;flex-direction:column;gap:3px;flex:1}
.em-opt-name{font-size:13px;font-weight:300}
.em-opt-req{font-size:10px;font-weight:200;color:var(--dim)}
.em-cancel{width:100%;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer;margin-top:8px}

/* MEMBER MODAL */
#member-modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
#member-modal.on{opacity:1;pointer-events:all}
.mm-box{width:100%;max-width:430px;background:#111113;border:1px solid var(--ln);border-bottom:none;border-radius:20px 20px 0 0;padding:0 0 40px;transform:translateY(14px);transition:transform .3s;max-height:85dvh;overflow-y:auto;scrollbar-width:none}
#member-modal.on .mm-box{transform:translateY(0)}
.mm-box::-webkit-scrollbar{display:none}
.mm-head{display:flex;align-items:center;gap:12px;padding:22px 20px 16px;border-bottom:1px solid var(--ln)}
.mm-em{font-size:32px}
.mm-identity{flex:1;display:flex;flex-direction:column;gap:3px}
.mm-name{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.mm-crew{font-size:11px;font-weight:200;color:var(--dim)}
.mm-rank-badge{font-family:var(--fd);font-style:italic;font-size:28px;font-weight:300}
.mm-rank-badge.g{color:var(--gold)}.mm-rank-badge.s{color:var(--silver)}.mm-rank-badge.b{color:var(--bronze)}.mm-rank-badge.o{color:var(--acc)}
.mm-stats-row{display:flex;padding:16px 20px;border-bottom:1px solid var(--ln)}
.mm-stat{flex:1;display:flex;flex-direction:column;gap:2px}
.mm-stat+.mm-stat{border-left:1px solid var(--ln);padding-left:14px}
.mm-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.mm-sv{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.mm-runs-label{padding:14px 20px 8px;font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim)}
.mm-run-row{display:flex;align-items:center;gap:10px;padding:10px 20px;border-bottom:1px solid var(--ln)}
.mm-run-date{font-size:9px;font-weight:200;color:var(--dim);width:44px;flex-shrink:0}
.mm-run-dist{font-family:var(--fd);font-style:italic;font-size:17px;font-weight:300;flex:1}
.mm-run-sub{font-size:10px;font-weight:200;color:var(--dim)}
.mm-close{width:calc(100% - 40px);margin:16px 20px 0;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer}

/* HIGH FIVE */
#hifi-wrap{position:fixed;bottom:78px;right:16px;z-index:60;display:flex;flex-direction:column;align-items:flex-end;gap:8px;pointer-events:none;opacity:0;transition:opacity .3s}
#hifi-wrap.on{opacity:1;pointer-events:all}
.hifi-user-pill{display:flex;align-items:center;gap:6px;background:rgba(14,14,16,.9);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:6px 11px;backdrop-filter:blur(10px);white-space:nowrap;animation:slideInRight .3s ease}
@keyframes slideInRight{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}
.hu-em{font-size:13px}
.hu-nm{font-size:10px;font-weight:200;color:var(--hi)}
.hu-dist{font-size:9px;font-weight:200;color:var(--acc);margin-left:2px}
#hifi-btn{width:54px;height:54px;border-radius:50%;background:var(--hi);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;box-shadow:0 4px 20px rgba(0,0,0,.5);transition:transform .15s,background .2s;position:relative}
#hifi-btn:active{transform:scale(.9)}
#hifi-btn.sent{background:rgba(200,240,80,.2);border:2px solid rgba(200,240,80,.4);font-size:20px}
.hifi-cnt{position:absolute;top:-3px;right:-3px;width:17px;height:17px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bg);font-family:var(--fb)}
.hifi-fly{position:fixed;font-size:28px;pointer-events:none;z-index:250;animation:hifiFly .8s ease forwards}
@keyframes hifiFly{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-90px) scale(1.5)}}

/* AVATAR */
#avs{position:fixed;inset:0;z-index:90;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
#avs.on{opacity:1;pointer-events:all}
.av-box{width:100%;max-width:430px;background:#111113;border:1px solid var(--ln);border-bottom:none;border-radius:20px 20px 0 0;padding:16px 18px 36px;transform:translateY(12px);transition:transform .3s}
#avs.on .av-box{transform:translateY(0)}
.av-ttl{font-size:9px;font-weight:200;letter-spacing:.14em;color:var(--dim);text-align:center;margin-bottom:12px}
.av-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px}
.avc{display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 3px 7px;border-radius:11px;border:1px solid transparent;background:var(--sf);cursor:pointer;transition:all .2s}
.avc:active{background:rgba(255,255,255,.09)}
.avc.on{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06)}
.ave{font-size:22px;line-height:1}
.avl{font-size:8px;font-weight:200;color:var(--dim)}.avc.on .avl{color:var(--hi)}

/* TOAST / FLASH */
#toast{position:fixed;z-index:200;bottom:82px;left:50%;transform:translateX(-50%) translateY(5px);background:rgba(12,12,14,.96);border:1px solid rgba(255,255,255,.08);border-radius:99px;padding:7px 16px;font-size:11px;font-weight:200;color:var(--mid);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
#flash{position:fixed;inset:0;z-index:300;background:rgba(255,255,255,.1);opacity:0;pointer-events:none;transition:opacity .08s}
#flash.on{opacity:1}
input[type=file]{display:none}
</style>
</head>
<body>

<div id="nav"><span class="logo">GhostRun</span><span id="clock"></span></div>

<div id="main">

<!-- SHOT -->
<div id="v-shot" class="mview on">
  <div id="card">
    <img id="bg-img" src="" alt="">
    <div id="empty-state"><div class="e-grain"></div><div class="e-icon">üåô</div><div class="e-hint">ÏÇ¨ÏßÑÏùÑ Î∂àÎü¨Ïò§ÏÑ∏Ïöî</div></div>
    <div id="ovs">
      <div class="ov" id="ov-g">
        <div class="ft"></div><div class="fb"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-g">üëª</span><span class="r-nm" id="nm-g">Ïú†Î†π3</span></div>
          <div class="ov-dt" id="dt-g"></div>
        </div>
        <div class="chip gchip"><span class="ch-n" id="cn-g"></span><span class="ch-of" id="co-g"></span></div>
        <div class="gboard" id="gboard"><div class="gb-lbl">ÌÅ¨Î£® ÏàúÏúÑ</div></div>
        <div class="g-bot">
          <div style="margin-bottom:6px">
            <div class="g-dist">5.20<span class="g-du">km</span></div>
          </div>
          <div class="g-stats">
            <div class="g-s"><span class="g-sl">Pace</span><span class="g-sv">5'12"</span></div>
            <div class="g-s"><span class="g-sl">Time</span><span class="g-sv">26'58"</span></div>
            <div class="g-s"><span class="g-sl">Cal</span><span class="g-sv">312</span></div>
          </div>
          <div class="g-foot"><span class="g-brand">GhostRun ¬∑ Îî∞Î°ú Îòê Í∞ôÏù¥</span><span class="g-tag"># Ghost</span></div>
        </div>
        <canvas id="mmg" width="40" height="40" style="position:absolute;right:16px;bottom:20px;border-radius:5px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4)"></canvas>
      </div>
      <div class="ov off" id="ov-p">
        <div class="ft"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:190px;background:linear-gradient(0deg,rgba(0,0,0,.9),rgba(0,0,0,.4) 55%,transparent)"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-p">üëª</span><span class="r-nm" id="nm-p">Ïú†Î†π3</span></div>
          <span class="p-logo">GhostRun</span>
        </div>
        <div class="p-mapbg"><canvas id="mmp" width="220" height="220"></canvas></div>
        <div class="chip p-chip"><span class="ch-n" id="cn-p"></span><span style="font-size:9px;font-weight:200;color:rgba(255,255,255,.28)">Îì±</span><span class="ch-of" id="co-p" style="opacity:.5"></span></div>
        <div class="p-bot">
          <div class="p-stat"><span class="p-l">Distance</span><span class="p-v">5.20<span class="p-u"> km</span></span></div>
          <div class="p-stat" style="text-align:right"><span class="p-l" style="text-align:right">Avg Pace</span><span class="p-v">5'12"<span class="p-u">/km</span></span></div>
        </div>
      </div>
      <div class="ov off" id="ov-s">
        <div class="st-vign"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:270px;background:linear-gradient(0deg,rgba(0,0,0,.9),transparent)"></div>
        <div class="ov-hd" style="background:linear-gradient(180deg,rgba(0,0,0,.5),transparent);padding-bottom:10px">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-s">üëª</span><span class="r-nm" id="nm-s">Ïú†Î†π3</span></div>
          <span class="st-logo">GhostRun</span>
        </div>
        <div class="st-bot">
          <div class="st-rrow"><span class="st-rn" id="st-rn">3Îì±</span><span class="st-of" id="st-of">/ 8Î™Ö</span></div>
          <div class="st-dist">5.20<span class="st-du">km</span></div>
          <div class="st-sub">
            <div class="ss"><span class="ss-l">Pace</span><span class="ss-v">5'12"</span></div>
            <div class="ss"><span class="ss-l">Time</span><span class="ss-v">26'58"</span></div>
            <div class="ss"><span class="ss-l">Cal</span><span class="ss-v">312</span></div>
          </div>
        </div>
        <div class="st-badge"><span class="sb-em" id="em-b">üëª</span><span class="sb-done">Completed</span><span class="sb-date" id="bd"></span></div>
        <canvas id="mms" width="40" height="40"></canvas>
      </div>
    </div>
  </div>
  <div id="tbar">
    <button class="th on" data-t="g">üëª Ghost</button>
    <button class="th" data-t="p">üó∫ Path</button>
    <button class="th" data-t="s">üéñ Stamp</button>
  </div>
  <div id="shot-acts">
    <label class="ai"><input type="file" id="ic" accept="image/*" capture="environment"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></label>
    <label class="ai"><input type="file" id="ig" accept="image/*"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></label>
    <button class="asave" id="bsave"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Ï†ÄÏû•ÌïòÍ∏∞</button>
  </div>
</div>

<!-- RECORDS -->
<div id="v-records" class="mview">
  <div class="rec-header">
    <div class="rec-h-title">ÎÇòÏùò Í∏∞Î°ù</div>
    <div class="rec-total-row">
      <div class="rec-stat"><span class="rec-sl">Ï¥ù Í±∞Î¶¨</span><span class="rec-sv">312.4<span style="font-family:var(--fb);font-size:13px;font-weight:200;color:var(--dim)"> km</span></span></div>
      <div class="rec-stat"><span class="rec-sl">Ï¥ù Îü∞</span><span class="rec-sv">62<span style="font-family:var(--fb);font-size:13px;font-weight:200;color:var(--dim)"> Ìöå</span></span></div>
      <div class="rec-stat"><span class="rec-sl">Ï∞∏Ïó¨ ÌÅ¨Î£®</span><span class="rec-sv">5<span style="font-family:var(--fb);font-size:13px;font-weight:200;color:var(--dim)"> Í∞ú</span></span></div>
    </div>
  </div>
  <div class="month-strip"><div class="ms-label">Ïù¥Î≤à Îã¨ ÌôúÎèô</div><div class="month-dots" id="month-dots"></div></div>
  <div class="log-section"><div class="log-label">ÏµúÍ∑º Îü∞</div><div id="run-log"></div></div>
  <div class="crews-section"><div class="log-label">Ï∞∏Ïó¨ÌñàÎçò ÌÅ¨Î£®</div><div id="past-crews-rec"></div></div>
</div>

<!-- CREW -->
<div id="v-crew" class="mview">
  <!-- NO CREW STATE (shown when user hasn't joined a crew) -->
  <div id="no-crew">
    <div class="nc-ghost">üëª</div>
    <div class="nc-title">ÏïÑÏßÅ ÌÅ¨Î£®Í∞Ä ÏóÜÏñ¥Ïöî</div>
    <div class="nc-sub">ÌÅ¨Î£®Ïóê Ï∞∏Ïó¨ÌïòÎ©¥ Ìï®Íªò Îã¨Î¶¨Í≥†<br>ÏÑúÎ°úÏùò Í∏∞Î°ùÏùÑ Î≥º Ïàò ÏûàÏñ¥Ïöî</div>
    <div class="nc-actions">
      <button class="nc-btn-primary" onclick="openJoinModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Ï¥àÎåÄ ÏΩîÎìúÎ°ú Ï∞∏Ïó¨ÌïòÍ∏∞
      </button>
      <div class="nc-divider"><span>ÎòêÎäî</span></div>
      <div class="nc-nearby-preview">
        <div class="nc-near-label">üìç ÎÇ¥ Í∑ºÏ≤ò ÌÅ¨Î£®</div>
        <div class="nc-near-row">
          <span class="nc-near-em">üßõ</span>
          <div class="nc-near-info">
            <div class="nc-near-name">ÎìúÎùºÌÅòÎùº ÌÅ¨Î£®</div>
            <div class="nc-near-meta">ÎßàÌè¨Íµ¨ ¬∑ 8Î™Ö ¬∑ #GR-1138</div>
          </div>
          <span class="nc-near-pct">62%</span>
          <button class="nc-near-join" onclick="quickJoin('ÎìúÎùºÌÅòÎùº ÌÅ¨Î£®','üßõ','#GR-1138',62)">Ï∞∏Ïó¨</button>
        </div>
        <div class="nc-near-row">
          <span class="nc-near-em">üßü</span>
          <div class="nc-near-info">
            <div class="nc-near-name">Ï¢ÄÎπÑ ÌÅ¨Î£®</div>
            <div class="nc-near-meta">ÎßàÌè¨Íµ¨ ¬∑ 6Î™Ö ¬∑ #GR-0442</div>
          </div>
          <span class="nc-near-pct">65%</span>
          <button class="nc-near-join" onclick="quickJoin('Ï¢ÄÎπÑ ÌÅ¨Î£®','üßü','#GR-0442',65)">Ï∞∏Ïó¨</button>
        </div>
        <div class="nc-near-row">
          <span class="nc-near-em">üéÉ</span>
          <div class="nc-near-info">
            <div class="nc-near-name">Ìò∏Î∞ï ÌÅ¨Î£®</div>
            <div class="nc-near-meta">ÎßàÌè¨Íµ¨ ¬∑ 5Î™Ö ¬∑ #GR-3391</div>
          </div>
          <span class="nc-near-pct">48%</span>
          <button class="nc-near-join" onclick="quickJoin('Ìò∏Î∞ï ÌÅ¨Î£®','üéÉ','#GR-3391',48)">Ï∞∏Ïó¨</button>
        </div>
      </div>
      <div class="nc-divider"><span>ÏßÅÏ†ë ÎßåÎì§Í∏∞</span></div>
      <button class="nc-btn-sec" onclick="openCreateModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        ÏÉà ÌÅ¨Î£® ÎßåÎì§Í∏∞
      </button>
    </div>
  </div>

  <!-- CREW CONTENT (hidden until joined) -->
  <div id="crew-content" class="hidden" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div id="ctabs">
      <button class="ctab on" data-c="my">ÎÇ¥ ÌÅ¨Î£®</button>
      <button class="ctab" data-c="near">ÌÅ¨Î£® Îû≠ÌÇπ</button>
      <button class="ctab" data-c="past">ÎÇ¥ ÌÅ¨Î£® Î™®ÏïÑÎ≥¥Í∏∞</button>
    </div>
    <div class="cpane on" id="cp-my">
      <div class="crew-hdr">
        <div class="crew-hdr-left"><div class="crew-hdr-name" id="ch-name">üëª Ïú†Î†π ÌÅ¨Î£®</div><div class="crew-hdr-sub" id="ch-sub">#GR-2847 ¬∑ 2Ïõî ¬∑ 8Î™Ö</div><div class="crew-hdr-loc">üìç ÎßàÌè¨Íµ¨ ¬∑ ÏÑúÏö∏</div></div>
        <div class="crew-expert-badge">‚≠ê Expert ÌÅ¨Î£®</div>
      </div>
      <div class="gc-card">
        <div class="gc-top">
          <div><div class="gc-lbl">ÌÅ¨Î£® Î™©Ìëú</div><div class="gc-nums"><span class="gc-cur" id="gcc">37.8</span><span class="gc-sep"> / </span><span class="gc-tot">100</span><span class="gc-unit">km</span></div></div>
          <span class="gc-pct" id="gcp">38%</span>
        </div>
        <div class="prog"><div class="pf" id="gcpf" style="width:0%"><div class="pd"></div></div></div>
        <div class="gc-meta">
          <div class="gm"><span class="gm-l">Ïù∏Ïõê</span><span class="gm-v" id="gcm1"></span></div>
          <div class="gm"><span class="gm-l">ÎÇ¥ Í∏∞Ïó¨</span><span class="gm-v a" id="gcm2"></span></div>
          <div class="gm"><span class="gm-l">1ÏúÑÍπåÏßÄ</span><span class="gm-v" id="gcm3"></span></div>
          <div class="gm"><span class="gm-l">ÎÇ®ÏùÄ Î™©Ìëú</span><span class="gm-v" id="gcm4"></span></div>
        </div>
      </div>
      <div class="lb-hdr"><span class="lb-ttl">ÌÅ¨Î£® ÏàúÏúÑ</span><span class="lb-cnt" id="crew-lb-cnt"></span></div>
      <div id="crew-lb"></div>
    </div>
    <div class="cpane" id="cp-near"><div class="nb-sec-hdr"><div class="nb-area">ÎßàÌè¨Íµ¨ ÌÅ¨Î£® Îû≠ÌÇπ</div><div class="nb-desc">ÎÇ¥ ÏúÑÏπò Í∏∞Ï§Ä ¬∑ Î∞òÍ≤Ω 5km ÌÅ¨Î£®</div></div><div id="nearby-list"></div></div>
    <div class="cpane" id="cp-past">
      <div class="past-sec-hdr"><span class="past-sec-title">ÎÇ¥ ÌÅ¨Î£® ÌûàÏä§ÌÜ†Î¶¨</span><button class="create-btn" onclick="openExpertModal()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Expert ÌÅ¨Î£® ÎßåÎì§Í∏∞</button></div>
      <div id="past-crews-list"></div>
    </div>
  </div>
</div>

</div>

<!-- BOTTOM NAV -->
<div id="btabs">
  <button class="btab on" data-v="shot"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>Ïù∏Ï¶ùÏÉ∑<div class="btab-dot"></div></button>
  <button class="btab" data-v="crew"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>ÌÅ¨Î£®<div class="btab-dot"></div></button>
  <button class="btab" data-v="records"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>ÎÇ¥ Í∏∞Î°ù<div class="btab-dot"></div></button>
</div>

<!-- HIGH FIVE -->
<div id="hifi-wrap">
  <div id="hifi-users"></div>
  <div style="position:relative;align-self:flex-end">
    <button id="hifi-btn" onclick="sendHiFi()">ü§ö</button>
    <div class="hifi-cnt" id="hifi-cnt">2</div>
  </div>
</div>

<!-- JOIN MODAL -->
<div id="join-modal">
  <div class="jm-box">
    <div class="jm-title">ÌÅ¨Î£® Ï∞∏Ïó¨ÌïòÍ∏∞</div>
    <div class="jm-sub">Ï¥àÎåÄ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÎ©¥<br>ÌÅ¨Î£®ÏõêÏùò Í∏∞Î°ùÏùÑ Ìï®Íªò Î≥º Ïàò ÏûàÏñ¥Ïöî</div>
    <input class="jm-input" id="jm-input" type="text" placeholder="Ï¥àÎåÄ ÏΩîÎìú ÏûÖÎ†• (Ïòà: GR-2847)" maxlength="10" oninput="onJoinInput(this.value)">
    <div class="jm-preview" id="jm-preview">
      <span class="jm-prev-em" id="jp-em">üëª</span>
      <div class="jm-prev-info">
        <div class="jm-prev-name" id="jp-name">Ïú†Î†π ÌÅ¨Î£®</div>
        <div class="jm-prev-meta" id="jp-meta">ÎßàÌè¨Íµ¨ ¬∑ 8Î™Ö ÌôúÎèô Ï§ë</div>
      </div>
      <span class="jm-prev-pct" id="jp-pct">38%</span>
    </div>
    <button class="jm-confirm" id="jm-confirm" onclick="confirmJoin()">Ïù¥ ÌÅ¨Î£® Ï∞∏Ïó¨ÌïòÍ∏∞ ü§ù</button>
    <button class="jm-cancel" onclick="closeJoinModal()">Ï∑®ÏÜå</button>
  </div>
</div>

<!-- CREATE CREW MODAL -->
<div id="create-modal">
  <div class="cm-box">
    <div class="cm-title">ÏÉà ÌÅ¨Î£® ÎßåÎì§Í∏∞</div>
    <div class="cm-sub">ÌÅ¨Î£®Î•º ÎßåÎì§Í≥† ÏπúÍµ¨Îì§ÏùÑ Ï¥àÎåÄÌï¥Î≥¥ÏÑ∏Ïöî<br>Îß§Ïõî ÏÉà ÏãúÏ¶åÏù¥ ÏãúÏûëÎèºÏöî</div>
    <div class="cm-field">
      <div class="cm-label">ÌÅ¨Î£® Ïù¥Î¶Ñ</div>
      <input class="cm-text-input" id="cm-name" type="text" placeholder="Ïòà: ÏÉàÎ≤Ω Ïú†Î†π ÌÅ¨Î£®" maxlength="16">
    </div>
    <div class="cm-field">
      <div class="cm-label">ÌÅ¨Î£® Ïù¥Î™®ÏßÄ</div>
      <div class="cm-emoji-row" id="cm-emoji-row">
        <div class="cm-em-opt on" data-em="üëª">üëª</div>
        <div class="cm-em-opt" data-em="üßõ">üßõ</div>
        <div class="cm-em-opt" data-em="üßü">üßü</div>
        <div class="cm-em-opt" data-em="üíÄ">üíÄ</div>
        <div class="cm-em-opt" data-em="üéÉ">üéÉ</div>
        <div class="cm-em-opt" data-em="ü¶á">ü¶á</div>
        <div class="cm-em-opt" data-em="üòà">üòà</div>
        <div class="cm-em-opt" data-em="‚ö°">‚ö°</div>
      </div>
    </div>
    <div class="cm-field">
      <div class="cm-label">Ïù¥Î≤à Îã¨ Î™©Ìëú Í±∞Î¶¨</div>
      <div class="cm-goal-row" id="cm-goal-row">
        <div class="cm-goal-opt" data-km="50"><span class="cm-goal-km">50</span><span class="cm-goal-lbl">km</span></div>
        <div class="cm-goal-opt on" data-km="100"><span class="cm-goal-km">100</span><span class="cm-goal-lbl">km</span></div>
        <div class="cm-goal-opt" data-km="150"><span class="cm-goal-km">150</span><span class="cm-goal-lbl">km</span></div>
        <div class="cm-goal-opt" data-km="200"><span class="cm-goal-km">200</span><span class="cm-goal-lbl">km</span></div>
      </div>
    </div>
    <div class="cm-field">
      <div class="cm-label">ÌôúÎèô ÏßÄÏó≠</div>
      <input class="cm-text-input" id="cm-area" type="text" placeholder="Ïòà: ÎßàÌè¨Íµ¨" maxlength="12" value="ÎßàÌè¨Íµ¨">
    </div>
    <button class="cm-confirm" onclick="confirmCreate()">ÌÅ¨Î£® ÎßåÎì§Í∏∞ ‚ú®</button>
    <button class="cm-cancel" onclick="closeCreateModal()">Ï∑®ÏÜå</button>
  </div>
</div>

<!-- AVATAR SHEET -->
<div id="avs"><div class="av-box"><div class="av-ttl">Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</div><div class="av-grid" id="avgrid"></div></div></div>

<!-- EXPERT MODAL -->
<div id="expert-modal"><div class="em-box">
  <div class="em-title">Expert ÌÅ¨Î£® ÎßåÎì§Í∏∞</div>
  <div class="em-sub">ÏùºÏ†ï Í∏∞Í∞Ñ Îã¨ÏÑ± Ïãú Ï†ÑÏö© ÌÅ¨Î£®Î•º Í∞úÏÑ§Ìï† Ïàò ÏûàÏñ¥Ïöî</div>
  <div class="em-option" onclick="selectExpert()">
    <span class="em-opt-em">üëª</span>
    <div class="em-opt-info"><span class="em-opt-name">Ghost Master ÌÅ¨Î£®</span><span class="em-opt-req">Ï°∞Í±¥: 3Í∞úÏõî Ïó∞ÏÜç 100km Îã¨ÏÑ± ‚úì Îã¨ÏÑ±!</span></div>
    <span style="font-size:10px;color:rgba(200,240,80,.8)">Í∞úÏÑ§ Í∞ÄÎä•</span>
  </div>
  <div class="em-option" style="opacity:.5;pointer-events:none">
    <span class="em-opt-em">üíÄ</span>
    <div class="em-opt-info"><span class="em-opt-name">Skull Elite ÌÅ¨Î£®</span><span class="em-opt-req">Ï°∞Í±¥: 6Í∞úÏõî Ïó∞ÏÜç 150km (ÏßÑÌñâ Ï§ë 4/6)</span></div>
    <span style="font-size:11px;color:rgba(255,255,255,.25)">üîí</span>
  </div>
  <div class="em-option" style="opacity:.5;pointer-events:none">
    <span class="em-opt-em">‚ö°</span>
    <div class="em-opt-info"><span class="em-opt-name">Speed Phantom ÌÅ¨Î£®</span><span class="em-opt-req">Ï°∞Í±¥: ÌéòÏù¥Ïä§ 5Î∂Ñ Ïù¥ÎÇ¥ 10Ìöå Îã¨ÏÑ± (7/10)</span></div>
    <span style="font-size:11px;color:rgba(255,255,255,.25)">üîí</span>
  </div>
  <button class="em-cancel" onclick="closeExpertModal()">Ï∑®ÏÜå</button>
</div></div>

<!-- MEMBER MODAL -->
<div id="member-modal"><div class="mm-box" id="mm-box"></div></div>

<canvas id="ec" style="display:none"></canvas>
<div id="flash"></div>
<div id="toast"></div>

<script>
'use strict';

const CREW=[
  {emoji:'üëª',name:'Ïú†Î†π1',dist:8.40,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π2',dist:7.85,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π3',dist:5.20,isMe:true},
  {emoji:'üëª',name:'Ïú†Î†π4',dist:4.90,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π5',dist:4.10,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π6',dist:3.80,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π7',dist:2.40,isMe:false},
  {emoji:'üëª',name:'Ïú†Î†π8',dist:1.20,isMe:false},
];
const GOAL=100,MI=CREW.findIndex(c=>c.isMe),MR=MI+1,N=CREW.length;
const TKM=parseFloat(CREW.reduce((s,c)=>s+c.dist,0).toFixed(2));
const PCT=Math.round(TKM/GOAL*100);

const NEARBY_CREWS=[
  {name:'ÎìúÎùºÌÅòÎùº ÌÅ¨Î£®',em:'üßõ',code:'#GR-1138',n:8,total:62.4,goal:100,areaRank:1,myRoom:false},
  {name:'Ï¢ÄÎπÑ ÌÅ¨Î£®',em:'üßü',code:'#GR-0442',n:6,total:51.8,goal:80,areaRank:2,myRoom:false},
  {name:'Ïú†Î†π ÌÅ¨Î£®',em:'üëª',code:'#GR-2847',n:8,total:37.85,goal:100,areaRank:3,myRoom:true},
  {name:'Ìò∏Î∞ï ÌÅ¨Î£®',em:'üéÉ',code:'#GR-3391',n:5,total:28.6,goal:60,areaRank:4,myRoom:false},
  {name:'Ìï¥Í≥® ÌÅ¨Î£®',em:'üíÄ',code:'#GR-5512',n:7,total:22.1,goal:70,areaRank:5,myRoom:false},
  {name:'Î∞ïÏ•ê ÌÅ¨Î£®',em:'ü¶á',code:'#GR-6680',n:4,total:15.3,goal:50,areaRank:6,myRoom:false},
];

const PAST_CREWS=[
  {name:'Ïú†Î†π ÌÅ¨Î£®',em:'üëª',period:'2025.02',rank:3,dist:5.20,expert:true,active:true},
  {name:'Ï¢ÄÎπÑ ÌÅ¨Î£®',em:'üßü',period:'2025.01',rank:1,dist:9.80,expert:false,active:false},
  {name:'Ìï¥Í≥® ÌÅ¨Î£®',em:'üíÄ',period:'2024.12',rank:2,dist:7.60,expert:true,active:false},
  {name:'ÎìúÎùºÌÅòÎùº ÌÅ¨Î£®',em:'üßõ',period:'2024.11',rank:4,dist:6.10,expert:false,active:false},
  {name:'Î∞ïÏ•ê ÌÅ¨Î£®',em:'ü¶á',period:'2024.10',rank:1,dist:11.20,expert:false,active:false},
];

const RUN_LOG=[
  {date:'02.18',month:'Feb',dist:5.20,pace:"5'12\"",time:"26'58\"",cal:312,crewName:'Ïú†Î†π ÌÅ¨Î£®',rank:3,ri:0},
  {date:'02.14',month:'Feb',dist:4.80,pace:"5'20\"",time:"25'36\"",cal:288,crewName:'Ïú†Î†π ÌÅ¨Î£®',rank:4,ri:1},
  {date:'02.10',month:'Feb',dist:6.10,pace:"5'08\"",time:"31'17\"",cal:366,crewName:'Ïú†Î†π ÌÅ¨Î£®',rank:2,ri:2},
  {date:'02.05',month:'Feb',dist:3.90,pace:"5'35\"",time:"21'47\"",cal:234,crewName:'Ïú†Î†π ÌÅ¨Î£®',rank:5,ri:0},
  {date:'01.28',month:'Jan',dist:9.80,pace:"5'01\"",time:"49'10\"",cal:588,crewName:'Ï¢ÄÎπÑ ÌÅ¨Î£®',rank:1,ri:1},
  {date:'01.21',month:'Jan',dist:8.40,pace:"5'14\"",time:"43'58\"",cal:504,crewName:'Ï¢ÄÎπÑ ÌÅ¨Î£®',rank:2,ri:2},
];

const MEMBER_RUNS={
  'Ïú†Î†π1':[{d:'02.17',dist:2.50,pace:"5'20\""},{d:'02.13',dist:3.10,pace:"5'15\""},{d:'02.09',dist:2.80,pace:"5'22\""}],
  'Ïú†Î†π2':[{d:'02.16',dist:3.20,pace:"5'10\""},{d:'02.12',dist:2.60,pace:"5'18\""},{d:'02.08',dist:2.05,pace:"5'25\""}],
  'Ïú†Î†π4':[{d:'02.15',dist:2.10,pace:"5'30\""},{d:'02.11',dist:1.80,pace:"5'35\""},{d:'02.07',dist:1.00,pace:"5'40\""}],
  'Ïú†Î†π5':[{d:'02.14',dist:1.50,pace:"5'45\""},{d:'02.10',dist:1.60,pace:"5'40\""}],
  'Ïú†Î†π6':[{d:'02.13',dist:1.20,pace:"5'50\""},{d:'02.09',dist:1.30,pace:"5'48\""},{d:'02.05',dist:1.30,pace:"5'50\""}],
  'Ïú†Î†π7':[{d:'02.12',dist:0.90,pace:"6'00\""},{d:'02.08',dist:0.90,pace:"5'58\""}],
  'Ïú†Î†π8':[{d:'02.18',dist:0.60,pace:"6'10\""},{d:'02.14',dist:0.60,pace:"6'05\""}],
};

const NEARBY_USERS=[
  {emoji:'üëª',name:'Ïú†Î†π1',dist:'0.3km Ïïû'},
  {emoji:'üßõ',name:'ÎìúÎùºÌÅòÎùº2',dist:'0.7km Í∑ºÏ≤ò'},
];

const RC=r=>r===1?'g':r===2?'s':r===3?'b':'o';
const COL=r=>r===1?'#d4b54a':r===2?'#a8b0b8':r===3?'#b07444':'#c8f050';

// CLOCK
function tick(){
  const n=new Date(),p=v=>String(v).padStart(2,'0');
  document.getElementById('clock').textContent=`${p(n.getHours())}:${p(n.getMinutes())}`;
  const ds=`${n.getFullYear()}.${p(n.getMonth()+1)}.${p(n.getDate())}`;
  const dtg=document.getElementById('dt-g');if(dtg)dtg.innerHTML=`${ds}<br>${n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}`;
  const bd=document.getElementById('bd');if(bd)bd.textContent=ds;
}
tick();setInterval(tick,1000);

// ROUTE
const ROUTE=[[37.5665,126.978],[37.567,126.979],[37.5676,126.9796],[37.5682,126.9803],[37.5687,126.9814],[37.5681,126.9822],[37.5673,126.9828],[37.5664,126.9822],[37.5656,126.9815],[37.565,126.9804],[37.5648,126.9793],[37.5654,126.9782],[37.566,126.9778],[37.5665,126.978]];
const ROUTES=[ROUTE,ROUTE.map(p=>[p[0]+.003,p[1]-.002]),ROUTE.map(p=>[p[0]-.002,p[1]+.003])];
function drawRoute(canvas,opts={}){
  const{stroke='#c8f050',lw=1.5,pad=7,alpha=.82,ri=0}=opts;
  const R=ROUTES[ri%ROUTES.length];
  const W=canvas.width,H=canvas.height,ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const la=R.map(p=>p[0]),ln=R.map(p=>p[1]);
  const mla=Math.min(...la),xla=Math.max(...la),mln=Math.min(...ln),xln=Math.max(...ln);
  const rl=xla-mla||.001,rn=xln-mln||.001;
  const xy=(a,n2)=>[pad+(n2-mln)/rn*(W-pad*2),pad+(xla-a)/rl*(H-pad*2)];
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw+2;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=.1;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=alpha;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  const[sx,sy]=xy(R[0][0],R[0][1]);ctx.beginPath();ctx.arc(sx,sy,1.8,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.4)';ctx.fill();
  const last=R[R.length-1];const[ex,ey]=xy(last[0],last[1]);
  ctx.save();ctx.beginPath();ctx.arc(ex,ey,2.5,0,Math.PI*2);ctx.fillStyle=stroke;ctx.shadowColor=stroke;ctx.shadowBlur=6;ctx.fill();ctx.restore();
}
drawRoute(document.getElementById('mmg'));
drawRoute(document.getElementById('mmp'),{lw:3,pad:18,alpha:.2});
drawRoute(document.getElementById('mms'));

// BOTTOM TABS
let curView='shot';
// Simulate first-time user (no crew yet). Set to true to skip onboarding.
let hasCrew = false;

function showCrewView(){
  const nc=document.getElementById('no-crew');
  const cc=document.getElementById('crew-content');
  if(hasCrew){
    nc.style.display='none';
    cc.style.display='flex';
  } else {
    nc.style.display='flex';
    cc.style.display='none';
  }
}

document.getElementById('btabs').addEventListener('click',e=>{
  const b=e.target.closest('.btab');if(!b)return;
  const v=b.dataset.v;if(v===curView)return;curView=v;
  document.querySelectorAll('.mview').forEach(el=>el.classList.remove('on'));
  document.getElementById('v-'+v).classList.add('on');
  document.querySelectorAll('.btab').forEach(t=>t.classList.toggle('on',t.dataset.v===v));
  const hw=document.getElementById('hifi-wrap');
  hw.classList.toggle('on',v!=='shot');
  if(v!=='shot')showHiFiUsers();
  if(v==='crew'){showCrewView();if(hasCrew){initCrew();initNearby();initPastCrews();}}
  if(v==='records')initRecords();
});

// SHOT OVERLAYS
function applyRank(){
  const k=RC(MR);
  ['cn-g','cn-p'].forEach(id=>{const el=document.getElementById(id);if(el){el.className='ch-n '+k;el.textContent=MR;}});
  document.getElementById('co-g').textContent='/ '+N;
  document.getElementById('co-p').textContent=N+'Î™Ö Ï§ë';
  const sr=document.getElementById('st-rn');if(sr){sr.className='st-rn '+k;sr.textContent=MR+'Îì±';}
  document.getElementById('st-of').textContent='/ '+N+'Î™Ö';
  buildBoard();
}
function buildBoard(){
  const b=document.getElementById('gboard');if(!b)return;
  b.innerHTML='<div class="gb-lbl">ÌÅ¨Î£® ÏàúÏúÑ</div>';
  const show=MR>3?[...CREW.slice(0,3),null,CREW[MI]]:CREW.slice(0,3);
  show.forEach(c=>{
    if(!c){const s=document.createElement('div');s.style.cssText='height:1px;background:rgba(255,255,255,.06);margin:2px 0';b.appendChild(s);return;}
    const r=CREW.indexOf(c)+1,me=c.isMe,k=RC(r);
    const row=document.createElement('div');row.className='gb-row'+(me?' me':'');
    row.innerHTML=`<span class="gb-n ${k}">${r}</span><span class="gb-e">${c.emoji}</span><span class="gb-d${me?' me':''}">${c.dist.toFixed(1)}</span>`;
    b.appendChild(row);
  });
}
applyRank();

let AT='g';
document.getElementById('tbar').addEventListener('click',e=>{
  const b=e.target.closest('.th');if(!b)return;const t=b.dataset.t;if(t===AT)return;AT=t;
  ['ov-g','ov-p','ov-s'].forEach(id=>document.getElementById(id).classList.toggle('off',!id.endsWith(t)));
  document.querySelectorAll('.th').forEach(x=>x.classList.toggle('on',x.dataset.t===t));
});

// PHOTO
let pURL=null;
const bgEl=document.getElementById('bg-img'),emEl=document.getElementById('empty-state');
function loadFile(f){if(!f?.type.startsWith('image/'))return;if(pURL)URL.revokeObjectURL(pURL);pURL=URL.createObjectURL(f);bgEl.onload=()=>{bgEl.style.opacity='1';emEl.style.display='none';};bgEl.src=pURL;}
document.getElementById('ic').addEventListener('change',e=>loadFile(e.target.files[0]));
document.getElementById('ig').addEventListener('change',e=>loadFile(e.target.files[0]));

// AVATAR
const AVATARS=[{e:'üëª',l:'Ïú†Î†π'},{e:'üßõ',l:'Î±ÄÌååÏù¥Ïñ¥'},{e:'üßü',l:'Ï¢ÄÎπÑ'},{e:'üßå',l:'Í¥¥Î¨º'},{e:'üíÄ',l:'Ìï¥Í≥®'},{e:'üï∑',l:'Í±∞ÎØ∏'},{e:'ü¶á',l:'Î∞ïÏ•ê'},{e:'üê∫',l:'ÎäëÎåÄ'},{e:'üòà',l:'ÏïÖÎßà'},{e:'üéÉ',l:'Ìò∏Î∞ï'}];
(function buildAvGrid(){
  const g=document.getElementById('avgrid');
  AVATARS.forEach((av,i)=>{
    const c=document.createElement('div');c.className='avc'+(i===0?' on':'');
    c.innerHTML=`<span class="ave">${av.e}</span><span class="avl">${av.l}</span>`;
    c.addEventListener('click',()=>{
      document.querySelectorAll('.avc').forEach(x=>x.classList.remove('on'));c.classList.add('on');
      ['g','p','s'].forEach(t=>{const em=document.getElementById('em-'+t),nm=document.getElementById('nm-'+t);if(em)em.textContent='üëª';if(nm)nm.textContent=CREW[MI].name;});
      document.getElementById('em-b').textContent='üëª';closeAv();
    });g.appendChild(c);
  });
})();
function openAv(){document.getElementById('avs').classList.add('on');}
function closeAv(){document.getElementById('avs').classList.remove('on');}
document.getElementById('avs').addEventListener('click',function(e){if(e.target===this)closeAv();});

// CREW SUB TABS
const CPANES={my:'cp-my',near:'cp-near',past:'cp-past'};
document.getElementById('ctabs').addEventListener('click',e=>{
  const b=e.target.closest('.ctab');if(!b)return;const c=b.dataset.c;
  document.querySelectorAll('.cpane').forEach(el=>el.classList.remove('on'));
  document.getElementById(CPANES[c]).classList.add('on');
  document.querySelectorAll('.ctab').forEach(t=>t.classList.toggle('on',t.dataset.c===c));
  if(c==='my')initCrew();if(c==='near')initNearby();if(c==='past')initPastCrews();
});

// INIT CREW
let crewInited=false;
function initCrew(){
  if(crewInited)return;crewInited=true;
  const myD=CREW[MI].dist,maxD=CREW[0].dist;
  document.getElementById('gcc').textContent=TKM.toFixed(1);
  document.getElementById('gcp').textContent=PCT+'%';
  document.getElementById('gcm1').textContent=N+'Î™Ö';
  document.getElementById('gcm2').textContent=(myD/GOAL*100).toFixed(1)+'%';
  document.getElementById('gcm3').textContent=MR===1?'ü•á 1ÏúÑ':'‚àí'+(maxD-myD).toFixed(1)+'km';
  document.getElementById('gcm4').textContent=(GOAL-TKM).toFixed(1)+'km';
  setTimeout(()=>document.getElementById('gcpf').style.width=Math.min(PCT,100)+'%',80);
  document.getElementById('crew-lb-cnt').textContent=N+'Î™Ö';
  const lb=document.getElementById('crew-lb');lb.innerHTML='';
  CREW.forEach((c,i)=>{
    const rank=i+1,me=c.isMe,k=RC(rank),posC=rank<=3?k:'';
    const row=document.createElement('div');
    row.className='lbrow'+(me?' me':' clickable');
    if(!me)row.onclick=()=>openMemberModal(c,rank);
    row.innerHTML=`
      <span class="lbpos${posC?' '+posC:''}">${rank}</span>
      <span class="lbem">${c.emoji}</span>
      <div class="lb-nm-col">
        <div class="lb-nm">${c.name}${me?'<span style="font-size:9px;color:rgba(200,240,80,.65);margin-left:5px">ÎÇò</span>':''}</div>
        ${!me?'<div class="lb-hint">Í∏∞Î°ù Î≥¥Í∏∞ ‚Üí</div>':''}
      </div>
      <div class="lb-rt">
        <span class="lb-d">${c.dist.toFixed(2)}<span style="font-size:9px;opacity:.4"> km</span></span>
        <div class="lb-bg"><div class="lb-bar ${me?'me':posC||'o'}" style="width:${Math.round(c.dist/maxD*100)}%"></div></div>
      </div>`;
    lb.appendChild(row);
  });
}

// INIT NEARBY
let nearbyInited=false;
function initNearby(){
  if(nearbyInited)return;nearbyInited=true;
  const container=document.getElementById('nearby-list');container.innerHTML='';
  NEARBY_CREWS.forEach(room=>{
    const pct=Math.round(room.total/room.goal*100),k=RC(room.areaRank);
    const members=Array(room.n).fill(room.em).join('');
    const row=document.createElement('div');row.className='nb-row';
    if(room.myRoom)row.style.cssText='border-left:2px solid rgba(200,240,80,.35);padding-left:10px;margin-left:-10px';
    row.innerHTML=`
      <div class="nb-top-row">
        <div class="nb-left">
          <div class="nb-rank-name">
            <span class="nb-arank ${k}">${room.areaRank}</span>
            <span class="nb-cname">${room.em} ${room.name}</span>
            ${room.myRoom?'<span class="nb-mine-tag">ÎÇ¥ ÌÅ¨Î£®</span>':''}
          </div>
          <div class="nb-cmeta">${room.code} ¬∑ ${room.n}Î™Ö</div>
        </div>
        <span class="nb-pct">${pct}%</span>
      </div>
      <div class="nb-prog"><div class="nb-pf" style="width:${pct}%"><div class="nb-pd"></div></div></div>
      <div class="nb-bottom">
        <div class="nb-ghosts">${members}</div>
        <div class="nb-nums">
          <div class="nbn"><span class="nbn-l">Îã¨ÏÑ±</span><span class="nbn-v">${room.total.toFixed(1)}<span style="font-family:var(--fb);font-size:10px;font-weight:200;color:var(--dim)"> km</span></span></div>
          <div class="nbn"><span class="nbn-l">Î™©Ìëú</span><span class="nbn-v" style="color:var(--mid)">${room.goal}<span style="font-family:var(--fb);font-size:10px;font-weight:200;color:var(--dim)"> km</span></span></div>
        </div>
      </div>`;
    container.appendChild(row);
  });
}

// INIT PAST CREWS
let pastInited=false;
function initPastCrews(){
  if(pastInited)return;pastInited=true;
  const list=document.getElementById('past-crews-list');list.innerHTML='';
  PAST_CREWS.forEach(c=>{
    const k=RC(c.rank);
    const card=document.createElement('div');card.className='past-card';
    card.innerHTML=`
      <span class="pc-em">${c.em}</span>
      <div class="pc-info">
        <div class="pc-name">${c.name}${c.active?'<span style="font-size:9px;color:rgba(200,240,80,.7);margin-left:5px">ÌôúÎèôÏ§ë</span>':''}</div>
        <div class="pc-meta">${c.period} ¬∑ ${c.dist.toFixed(1)}km Îã¨ÏÑ±</div>
        ${c.expert?'<span class="pc-expert">‚≠ê Expert ÌÅ¨Î£®</span>':''}
      </div>
      <div class="pc-right"><span class="pc-rank ${k}">${c.rank}Îì±</span><span class="pc-dist">${c.dist.toFixed(1)}km</span></div>`;
    list.appendChild(card);
  });
}

// INIT RECORDS
let recsInited=false;
function initRecords(){
  if(recsInited)return;recsInited=true;
  const dots=document.getElementById('month-dots');
  const today=new Date(),daysInMonth=new Date(today.getFullYear(),today.getMonth()+1,0).getDate();
  const runDays=new Set([5,10,14,18]);
  for(let d=1;d<=daysInMonth;d++){
    const dot=document.createElement('div');dot.className='md'+(d===today.getDate()?' today':runDays.has(d)?' run':'');dots.appendChild(dot);
  }
  const logEl=document.getElementById('run-log');
  RUN_LOG.forEach((r,i)=>{
    const k=RC(r.rank);
    const item=document.createElement('div');item.className='log-item';
    const cv=document.createElement('canvas');cv.width=44;cv.height=44;cv.className='log-route';
    const dc=document.createElement('div');dc.className='log-date-col';
    dc.innerHTML=`<span class="log-month">${r.month}</span><span class="log-day">${r.date.split('.')[1]}</span>`;
    const info=document.createElement('div');info.className='log-info';
    info.innerHTML=`<span class="log-crew-tag">üëª ${r.crewName}</span><span class="log-dist">${r.dist.toFixed(2)}<span style="font-size:11px;font-weight:200;color:var(--dim)"> km</span></span><span class="log-sub">Pace ${r.pace} ¬∑ ${r.time}</span>`;
    const right=document.createElement('div');right.className='log-right';
    right.innerHTML=`<span class="log-rank-chip ${k}">${r.rank}Îì±</span>`;
    item.appendChild(dc);item.appendChild(cv);item.appendChild(info);item.appendChild(right);
    logEl.appendChild(item);
    setTimeout(()=>drawRoute(cv,{pad:5,lw:1.2,ri:r.ri}),50*i);
  });
  const pcEl=document.getElementById('past-crews-rec');
  PAST_CREWS.forEach(c=>{
    const k=RC(c.rank);
    const item=document.createElement('div');item.className='crew-past-card';
    item.innerHTML=`<span class="cpc-em">${c.em}</span><div class="cpc-info"><div class="cpc-name">${c.name}</div><div class="cpc-meta">${c.period} ¬∑ ${c.dist.toFixed(1)}km</div></div><div class="cpc-badge">${c.expert?'<span class="expert-badge">‚≠ê Expert</span>':''}<span class="cpc-rank ${k}">${c.rank}Îì±</span></div>`;
    pcEl.appendChild(item);
  });
}

// MEMBER MODAL
function openMemberModal(member,rank){
  const k=RC(rank),runs=MEMBER_RUNS[member.name]||[];
  document.getElementById('mm-box').innerHTML=`
    <div class="mm-head">
      <span class="mm-em">${member.emoji}</span>
      <div class="mm-identity"><div class="mm-name">${member.name}</div><div class="mm-crew">üëª Ïú†Î†π ÌÅ¨Î£® ¬∑ 2025.02</div></div>
      <span class="mm-rank-badge ${k}">${rank}Îì±</span>
    </div>
    <div class="mm-stats-row">
      <div class="mm-stat"><span class="mm-sl">Ïù¥Î≤à Îã¨</span><span class="mm-sv">${member.dist.toFixed(2)}<span style="font-family:var(--fb);font-size:11px;font-weight:200;color:var(--dim)"> km</span></span></div>
      <div class="mm-stat"><span class="mm-sl">Îü∞ ÌöüÏàò</span><span class="mm-sv">${runs.length}<span style="font-family:var(--fb);font-size:11px;font-weight:200;color:var(--dim)"> Ìöå</span></span></div>
    </div>
    <div class="mm-runs-label">ÏµúÍ∑º Í∏∞Î°ù</div>
    ${runs.map(r=>`<div class="mm-run-row"><span class="mm-run-date">${r.d}</span><span class="mm-run-dist">${r.dist.toFixed(2)}<span style="font-family:var(--fb);font-size:10px;font-weight:200;color:var(--dim)"> km</span></span><span class="mm-run-sub">Pace ${r.pace}</span></div>`).join('')}
    <button class="mm-close" onclick="closeMemberModal()">Îã´Í∏∞</button>`;
  document.getElementById('member-modal').classList.add('on');
}
function closeMemberModal(){document.getElementById('member-modal').classList.remove('on');}
document.getElementById('member-modal').addEventListener('click',function(e){if(e.target===this)closeMemberModal();});

// JOIN MODAL
const CODE_MAP={
  'GR-2847':{name:'Ïú†Î†π ÌÅ¨Î£®',em:'üëª',meta:'ÎßàÌè¨Íµ¨ ¬∑ 8Î™Ö ÌôúÎèô Ï§ë',pct:38},
  'GR-1138':{name:'ÎìúÎùºÌÅòÎùº ÌÅ¨Î£®',em:'üßõ',meta:'ÎßàÌè¨Íµ¨ ¬∑ 8Î™Ö ÌôúÎèô Ï§ë',pct:62},
  'GR-0442':{name:'Ï¢ÄÎπÑ ÌÅ¨Î£®',em:'üßü',meta:'ÎßàÌè¨Íµ¨ ¬∑ 6Î™Ö ÌôúÎèô Ï§ë',pct:65},
  'GR-3391':{name:'Ìò∏Î∞ï ÌÅ¨Î£®',em:'üéÉ',meta:'ÎßàÌè¨Íµ¨ ¬∑ 5Î™Ö ÌôúÎèô Ï§ë',pct:48},
};
let joinTarget=null;

function openJoinModal(){document.getElementById('join-modal').classList.add('on');}
function closeJoinModal(){
  document.getElementById('join-modal').classList.remove('on');
  document.getElementById('jm-input').value='';
  document.getElementById('jm-preview').classList.remove('on');
  document.getElementById('jm-confirm').classList.remove('on');
  joinTarget=null;
}
document.getElementById('join-modal').addEventListener('click',function(e){if(e.target===this)closeJoinModal();});

function onJoinInput(v){
  const code=v.toUpperCase().replace(/[^A-Z0-9-]/g,'');
  const match=CODE_MAP[code];
  const preview=document.getElementById('jm-preview');
  const confirm=document.getElementById('jm-confirm');
  if(match){
    document.getElementById('jp-em').textContent=match.em;
    document.getElementById('jp-name').textContent=match.name;
    document.getElementById('jp-meta').textContent=match.meta;
    document.getElementById('jp-pct').textContent=match.pct+'%';
    preview.classList.add('on');confirm.classList.add('on');
    joinTarget=match;joinTarget.code=code;
  } else {
    preview.classList.remove('on');confirm.classList.remove('on');
    joinTarget=null;
  }
}

function confirmJoin(){
  if(!joinTarget)return;
  hasCrew=true;crewInited=false;
  closeJoinModal();
  showCrewView();
  initCrew();initNearby();initPastCrews();
  toast('ü§ù '+joinTarget.name+' Ï∞∏Ïó¨ ÏôÑÎ£å!');
}

function quickJoin(name,em,code,pct){
  hasCrew=true;crewInited=false;
  showCrewView();
  initCrew();initNearby();initPastCrews();
  toast('ü§ù '+name+' Ï∞∏Ïó¨ ÏôÑÎ£å!');
}

// CREATE CREW MODAL
let selEm='üëª',selGoal=100;

function openCreateModal(){document.getElementById('create-modal').classList.add('on');}
function closeCreateModal(){document.getElementById('create-modal').classList.remove('on');}
document.getElementById('create-modal').addEventListener('click',function(e){if(e.target===this)closeCreateModal();});

document.getElementById('cm-emoji-row').addEventListener('click',e=>{
  const opt=e.target.closest('.cm-em-opt');if(!opt)return;
  document.querySelectorAll('.cm-em-opt').forEach(x=>x.classList.remove('on'));
  opt.classList.add('on');selEm=opt.dataset.em;
});
document.getElementById('cm-goal-row').addEventListener('click',e=>{
  const opt=e.target.closest('.cm-goal-opt');if(!opt)return;
  document.querySelectorAll('.cm-goal-opt').forEach(x=>x.classList.remove('on'));
  opt.classList.add('on');selGoal=parseInt(opt.dataset.km);
});

function confirmCreate(){
  const name=document.getElementById('cm-name').value.trim()||'ÏÉà ÌÅ¨Î£®';
  const area=document.getElementById('cm-area').value.trim()||'ÎßàÌè¨Íµ¨';
  closeCreateModal();
  hasCrew=true;crewInited=false;
  // update crew header display
  const chn=document.getElementById('ch-name');if(chn)chn.textContent=selEm+' '+name;
  const chs=document.getElementById('ch-sub');if(chs)chs.textContent='#GR-NEW ¬∑ 2Ïõî ¬∑ 1Î™Ö';
  showCrewView();
  initCrew();initNearby();initPastCrews();
  toast('‚ú® '+name+' ÌÅ¨Î£®Í∞Ä ÎßåÎì§Ïñ¥Ï°åÏñ¥Ïöî!');
}

// EXPERT MODAL
function openExpertModal(){document.getElementById('expert-modal').classList.add('on');}
function closeExpertModal(){document.getElementById('expert-modal').classList.remove('on');}
document.getElementById('expert-modal').addEventListener('click',function(e){if(e.target===this)closeExpertModal();});
function selectExpert(){closeExpertModal();toast('‚ú® Ghost Master ÌÅ¨Î£®Í∞Ä Í∞úÏÑ§ÎêêÏñ¥Ïöî!');}

// HIGH FIVE
let hifiShown=false;
function showHiFiUsers(){
  if(hifiShown)return;hifiShown=true;
  const el=document.getElementById('hifi-users');
  NEARBY_USERS.forEach((u,i)=>{
    setTimeout(()=>{
      const div=document.createElement('div');div.className='hifi-user-pill';
      div.innerHTML=`<span class="hu-em">${u.emoji}</span><span class="hu-nm">${u.name}</span><span class="hu-dist">${u.dist}</span>`;
      el.appendChild(div);
    },i*200);
  });
  document.getElementById('hifi-cnt').textContent=NEARBY_USERS.length;
}
function sendHiFi(){
  const btn=document.getElementById('hifi-btn');
  btn.classList.add('sent');btn.textContent='‚úÖ';
  const rect=btn.getBoundingClientRect();
  const fly=document.createElement('div');fly.className='hifi-fly';fly.textContent='ü§ö';
  fly.style.cssText='left:'+rect.left+'px;top:'+rect.top+'px';
  document.body.appendChild(fly);
  setTimeout(()=>fly.remove(),900);
  toast('üëã Ï£ºÎ≥Ä Îü¨ÎÑàÏóêÍ≤å ÌïòÏù¥ÌååÏù¥Î∏åÎ•º Î≥¥ÎÉàÏñ¥Ïöî!');
  setTimeout(()=>{btn.classList.remove('sent');btn.textContent='ü§ö';},2000);
}

// EXPORT
const ND=new Date(),PD=v=>String(v).padStart(2,'0');
const TODAY=ND.getFullYear()+'.'+PD(ND.getMonth()+1)+'.'+PD(ND.getDate());
const NOWT=ND.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});

document.getElementById('bsave').addEventListener('click',()=>{
  const card=document.getElementById('card'),rect=card.getBoundingClientRect();
  const W=rect.width,H=rect.height,DPR=2;
  const ec=document.getElementById('ec');ec.width=W*DPR;ec.height=H*DPR;
  const ctx=ec.getContext('2d');ctx.scale(DPR,DPR);
  if(bgEl.src&&bgEl.naturalWidth){const sc=Math.max(W/bgEl.naturalWidth,H/bgEl.naturalHeight);ctx.drawImage(bgEl,(W-bgEl.naturalWidth*sc)/2,(H-bgEl.naturalHeight*sc)/2,bgEl.naturalWidth*sc,bgEl.naturalHeight*sc);}
  else{ctx.fillStyle='#101012';ctx.fillRect(0,0,W,H);}
  AT==='g'?xGhost(ctx,W,H):AT==='p'?xPath(ctx,W,H):xStamp(ctx,W,H);
  document.getElementById('flash').classList.add('on');
  setTimeout(()=>document.getElementById('flash').classList.remove('on'),110);
  try{const a=document.createElement('a');a.download='ghostrun_'+AT+'_'+Date.now()+'.jpg';a.href=ec.toDataURL('image/jpeg',.92);a.click();toast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');}
  catch(e){toast('ÏÇ¨ÏßÑÏùÑ Î®ºÏ†Ä Î∂àÎü¨Ïò§ÏÑ∏Ïöî');}
});

function grd(ctx,x,y,w,h,...s){const g=ctx.createLinearGradient(x,y,x,y+h);s.forEach(([t,c])=>g.addColorStop(t,c));ctx.fillStyle=g;ctx.fillRect(x,y,w,h);}
function rr(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.closePath();}

function xGhost(ctx,W,H){
  grd(ctx,0,0,W,170,[0,'rgba(0,0,0,.75)'],[1,'rgba(0,0,0,0)']);
  grd(ctx,0,H-260,W,260,[0,'rgba(0,0,0,0)'],[.45,'rgba(0,0,0,.4)'],[1,'rgba(0,0,0,.92)']);
  ctx.font='16px serif';ctx.fillText('üëª',20,42);
  ctx.fillStyle='rgba(237,233,225,.78)';ctx.font='200 12px sans-serif';ctx.fillText(CREW[MI].name,43,40);
  ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='200 9px sans-serif';ctx.fillText(TODAY,W-18,34);ctx.fillText(NOWT,W-18,48);ctx.textAlign='left';
  ctx.fillStyle='rgba(0,0,0,.52)';ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=1;rr(ctx,W-68,16,52,26,13);ctx.fill();ctx.stroke();
  ctx.fillStyle=COL(MR);ctx.font='italic 300 20px "Cormorant Garamond",serif';ctx.textAlign='center';ctx.fillText(MR,W-52,34);
  ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='200 9px sans-serif';ctx.fillText('/'+N,W-30,34);ctx.textAlign='left';
  let by=52;ctx.fillStyle='rgba(255,255,255,.15)';ctx.font='200 8px sans-serif';ctx.textAlign='right';ctx.fillText('ÌÅ¨Î£® ÏàúÏúÑ',W-16,by);by+=10;ctx.textAlign='left';
  const show=MR>3?[...CREW.slice(0,3),null,CREW[MI]]:CREW.slice(0,3);
  show.forEach(c=>{
    if(!c){ctx.fillStyle='rgba(255,255,255,.06)';ctx.fillRect(W-110,by,94,1);by+=5;return;}
    const r=CREW.indexOf(c)+1,me=c.isMe;
    ctx.fillStyle=me?'rgba(200,240,80,.07)':'rgba(0,0,0,.42)';rr(ctx,W-110,by,94,17,5);ctx.fill();
    if(me){ctx.strokeStyle='rgba(200,240,80,.15)';ctx.lineWidth=1;rr(ctx,W-110,by,94,17,5);ctx.stroke();}
    ctx.fillStyle=COL(r);ctx.font='300 9px sans-serif';ctx.fillText(r,W-104,by+12);
    ctx.font='11px serif';ctx.fillText(c.emoji,W-92,by+13);
    ctx.fillStyle=me?'#c8f050':'rgba(255,255,255,.45)';ctx.font='300 9px sans-serif';ctx.textAlign='right';ctx.fillText(c.dist.toFixed(1),W-18,by+12);ctx.textAlign='left';
    by+=21;
  });
  ctx.fillStyle='rgba(237,233,225,.92)';ctx.font='italic 300 52px "Cormorant Garamond",serif';ctx.fillText('5.20',18,H-60);
  ctx.fillStyle='rgba(237,233,225,.3)';ctx.font='200 15px sans-serif';ctx.fillText('km',116,H-60);
  let sx=18;[['Pace',"5'12\""],['Time',"26'58\""],['Cal','312']].forEach(([l,v],i)=>{
    if(i>0){ctx.fillStyle='rgba(255,255,255,.07)';ctx.fillRect(sx-7,H-42,1,18);}
    ctx.fillStyle='rgba(255,255,255,.18)';ctx.font='200 8px sans-serif';ctx.fillText(l,sx,H-42);
    ctx.fillStyle='rgba(237,233,225,.55)';ctx.font='300 14px sans-serif';ctx.fillText(v,sx,H-26);sx+=72;
  });
  // mini map: bottom-right corner, separate from all text
  const ms=42,mx=W-ms-16,my2=H-ms-16;
  const mc=document.createElement('canvas');mc.width=ms;mc.height=ms;drawRoute(mc);
  ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;rr(ctx,mx,my2,ms,ms,5);ctx.stroke();ctx.drawImage(mc,mx,my2);
  ctx.fillStyle='rgba(255,255,255,.1)';ctx.font='200 9px sans-serif';ctx.fillText('GhostRun ¬∑ Îî∞Î°ú Îòê Í∞ôÏù¥',18,H-10);
}
function xPath(ctx,W,H){
  grd(ctx,0,0,W,120,[0,'rgba(0,0,0,.7)'],[1,'rgba(0,0,0,0)']);
  grd(ctx,0,H-190,W,190,[0,'rgba(0,0,0,0)'],[1,'rgba(0,0,0,.9)']);
  ctx.font='16px serif';ctx.fillText('üëª',20,40);
  ctx.fillStyle='rgba(237,233,225,.75)';ctx.font='200 12px sans-serif';ctx.fillText(CREW[MI].name,43,38);
  ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='italic 300 13px serif';ctx.fillText('GhostRun',W-18,38);ctx.textAlign='left';
  const S=Math.min(W,H)*.55,CX=(W-S)/2,CY=(H-S)/2;
  const mc=document.createElement('canvas');mc.width=S;mc.height=S;drawRoute(mc,{lw:3,pad:S*.1,alpha:.18});
  ctx.globalAlpha=.55;ctx.drawImage(mc,CX,CY);ctx.globalAlpha=1;
  const pW=112,pH=28,pX=(W-pW)/2,pY=H/2-14;
  ctx.fillStyle='rgba(0,0,0,.55)';ctx.strokeStyle='rgba(255,255,255,.09)';ctx.lineWidth=1;rr(ctx,pX,pY,pW,pH,14);ctx.fill();ctx.stroke();
  ctx.fillStyle=COL(MR);ctx.font='italic 300 22px serif';ctx.textAlign='center';ctx.fillText(MR,pX+pW*.3,pY+20);
  ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='200 10px sans-serif';ctx.fillText('Îì± / '+N+'Î™Ö',pX+pW*.62,pY+20);ctx.textAlign='left';
  ctx.fillStyle='rgba(237,233,225,.88)';ctx.font='italic 300 30px serif';ctx.fillText('5.20 km',18,H-20);
  ctx.textAlign='right';ctx.font='italic 300 30px serif';ctx.fillText("5'12\"",W-18,H-20);ctx.textAlign='left';
  ctx.fillStyle='rgba(255,255,255,.18)';ctx.font='200 9px sans-serif';ctx.fillText('DISTANCE',18,H-50);
  ctx.textAlign='right';ctx.fillText('AVG PACE',W-18,H-50);ctx.textAlign='left';
}
function xStamp(ctx,W,H){
  const vg=ctx.createRadialGradient(W/2,H*.42,H*.2,W/2,H*.42,H*.75);vg.addColorStop(0,'rgba(0,0,0,0)');vg.addColorStop(1,'rgba(0,0,0,.65)');ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
  grd(ctx,0,H-270,W,270,[0,'rgba(0,0,0,0)'],[1,'rgba(0,0,0,.9)']);grd(ctx,0,0,W,90,[0,'rgba(0,0,0,.55)'],[1,'rgba(0,0,0,0)']);
  ctx.font='16px serif';ctx.fillText('üëª',18,40);
  ctx.fillStyle='rgba(237,233,225,.68)';ctx.font='200 12px sans-serif';ctx.fillText(CREW[MI].name,41,38);
  ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.16)';ctx.font='200 9px sans-serif';ctx.fillText('GHOSTRUN',W-18,38);ctx.textAlign='left';
  ctx.fillStyle=COL(MR);ctx.font='italic 300 36px serif';ctx.fillText(MR+'Îì±',18,H-168);
  ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='200 12px sans-serif';ctx.fillText('/ '+N+'Î™Ö',72,H-168);
  ctx.fillStyle='rgba(237,233,225,.9)';ctx.font='italic 300 50px serif';ctx.fillText('5.20',18,H-74);
  ctx.fillStyle='rgba(237,233,225,.28)';ctx.font='200 17px sans-serif';ctx.fillText(' km',118,H-74);
  ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='200 8px sans-serif';ctx.fillText("Pace  5'12\"    Time  26'58\"    Cal  312",18,H-42);
  // badge: bottom-right
  const CX=W-60,CY=H-60,R=46;
  ctx.beginPath();ctx.arc(CX,CY,R,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=1;ctx.stroke();
  ctx.beginPath();ctx.arc(CX,CY,R-5,0,Math.PI*2);ctx.strokeStyle='rgba(200,240,80,.1)';ctx.lineWidth=1;ctx.stroke();
  ctx.font='22px serif';ctx.textAlign='center';ctx.fillText('üëª',CX,CY-4);
  ctx.fillStyle='rgba(200,240,80,.45)';ctx.font='200 7px sans-serif';ctx.fillText('COMPLETED',CX,CY+12);
  ctx.fillStyle='rgba(255,255,255,.16)';ctx.font='200 7px sans-serif';ctx.fillText(TODAY,CX,CY+23);ctx.textAlign='left';
  // mini map: top-right, below header text, no overlap with bottom content
  const ms=42,mmx=W-ms-16,mmy=68;
  const mc=document.createElement('canvas');mc.width=ms;mc.height=ms;drawRoute(mc);
  ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;rr(ctx,mmx,mmy,ms,ms,6);ctx.stroke();ctx.drawImage(mc,mmx,mmy);
}

function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('on');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('on'),2600);}
</script>
</body>
</html>
