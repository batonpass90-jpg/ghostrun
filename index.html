<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ClapRun — 오늘도 뛰는 모든 러너에게</title>
<meta name="description" content="혼자 달리지만 혼자가 아닌 러닝 앱. 주변 러너와 실시간 연결되고, 달린 후 Clap으로 서로를 응원하세요.">
<meta name="keywords" content="러닝,달리기,런닝앱,크루런,ClapRun,클랩런,running,GPS,페이스">
<meta name="author" content="ClapRun">

<!-- PWA -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ClapRun">
<meta name="application-name" content="ClapRun">
<meta name="theme-color" content="#0a0a0d">
<link rel="manifest" href="manifest.json">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png">
<link rel="apple-touch-startup-image" href="icons/splash-2048x2732.png" media="(device-width:1024px)">
<link rel="apple-touch-startup-image" href="icons/splash-1668x2388.png" media="(device-width:834px)">
<link rel="apple-touch-startup-image" href="icons/splash-1170x2532.png" media="(device-width:390px)">
<link rel="apple-touch-startup-image" href="icons/splash-1125x2436.png" media="(device-width:375px)">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">

<!-- OG / SNS 공유 -->
<meta property="og:type" content="website">
<meta property="og:title" content="ClapRun — 오늘도 뛰는 모든 러너에게">
<meta property="og:description" content="혼자 달리지만 혼자가 아닌 러닝 앱. 주변 러너와 실시간 연결되고, 달린 후 Clap으로 서로를 응원하세요.">
<meta property="og:image" content="icons/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://claprun.app">
<meta property="og:site_name" content="ClapRun">
<meta property="og:locale" content="ko_KR">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ClapRun — 오늘도 뛰는 모든 러너에게">
<meta name="twitter:description" content="혼자 달리지만 혼자가 아닌 러닝 앱">
<meta name="twitter:image" content="icons/og-image.png">

<!-- iOS Standalone -->
<meta name="apple-touch-fullscreen" content="yes">
<meta name="format-detection" content="telephone=no">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,300;0,400;0,600;0,700;0,800;0,900;1,300;1,400;1,700;1,900&family=Barlow:wght@300;400;500&family=Playfair+Display:ital,wght@0,700;1,400;1,700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:#0a0a0d}
:root{
  --bg:#0a0a0d;--sf:#131316;--sf2:#1a1a1e;
  --ln:rgba(255,255,255,.07);--dim:rgba(255,255,255,.28);--mid:rgba(255,255,255,.52);
  --hi:#ede9e1;--acc:#c8f050;
  --gold:#d4b54a;--silver:#a0aab4;--bronze:#b07444;
  --fd:"Playfair Display","Barlow Condensed",serif;
  --fb:"Space Grotesk","Noto Sans KR",system-ui,sans-serif;
}
body{background:var(--bg);color:var(--hi);font-family:var(--fb);
  display:flex;flex-direction:column;height:100dvh;max-width:430px;margin:0 auto;position:relative}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 36px;text-align:center;transition:opacity .7s,transform .7s}
#splash.out{opacity:0;transform:scale(1.04);pointer-events:none}
.sp-grain{position:absolute;inset:0;opacity:.2;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23f)' opacity='.07'/%3E%3C/svg%3E")}
.sp-glow{position:absolute;width:420px;height:420px;border-radius:50%;background:radial-gradient(circle,rgba(200,240,80,.07) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-55%);animation:spPulse 4s ease-in-out infinite}
@keyframes spPulse{0%,100%{transform:translate(-50%,-55%) scale(1)}50%{transform:translate(-50%,-55%) scale(1.15)}}
.sp-lines{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);background-size:38px 38px;mask-image:radial-gradient(ellipse 80% 60% at 50% 50%,black 40%,transparent 80%)}
.sp-em{font-size:62px;margin-bottom:24px;position:relative;display:flex;align-items:center;justify-content:center;height:80px}
.sp-clap-main{font-size:68px;position:relative;z-index:2;animation:clapBeat 1.6s ease-in-out infinite;display:inline-block;filter:drop-shadow(0 0 18px rgba(200,240,80,.5))}
.sp-clap-l{font-size:36px;position:absolute;left:-10px;top:8px;opacity:.35;animation:clapDrift 2.2s ease-in-out infinite;display:inline-block}
.sp-clap-r{font-size:28px;position:absolute;right:-8px;top:16px;opacity:.2;animation:clapDrift 2.8s ease-in-out infinite reverse;display:inline-block}
@keyframes clapBeat{0%,100%{transform:scale(1) rotate(-4deg)}40%{transform:scale(1.18) rotate(4deg)}70%{transform:scale(.96) rotate(-2deg)}}
@keyframes clapDrift{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-8px) rotate(8deg)}}
50%{transform:translateY(-11px)}}
.sp-logo{font-family:var(--fd);font-style:italic;font-size:72px;font-weight:300;letter-spacing:1px;margin-bottom:14px;position:relative;line-height:1}
.sp-sub{font-size:15px;font-weight:300;color:var(--mid);letter-spacing:.04em;margin-bottom:8px;position:relative}
.sp-desc{font-size:12px;font-weight:200;color:var(--dim);letter-spacing:.07em;line-height:1.9;margin-bottom:54px;position:relative}
.sp-btn{background:var(--hi);border:none;border-radius:99px;padding:17px 58px;font-family:var(--fb);font-size:15px;font-weight:300;color:var(--bg);cursor:pointer;letter-spacing:.04em;transition:all .2s;position:relative;box-shadow:0 8px 30px rgba(237,233,225,.1)}
.sp-btn:active{transform:scale(.96)}
.sp-ver{position:absolute;bottom:30px;font-size:10px;font-weight:200;letter-spacing:.14em;color:rgba(255,255,255,.12)}

/* NAV */
#nav{flex-shrink:0;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid var(--ln);background:var(--bg)}
.logo{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
#clock{font-size:11px;font-weight:200;color:var(--dim);font-variant-numeric:tabular-nums}

/* BOTTOM TABS */
#btabs{flex-shrink:0;display:flex;align-items:stretch;background:rgba(10,10,13,.97);border-top:1px solid var(--ln);padding-bottom:env(safe-area-inset-bottom,0px);z-index:50}
.btab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:7px 2px 6px;background:none;border:none;cursor:pointer;font-family:var(--fb);font-size:9px;font-weight:200;letter-spacing:.04em;color:var(--dim);transition:color .2s;min-width:0}
.btab svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}
.btab.on{color:var(--hi)}
.btab-dot{width:4px;height:4px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity .2s}
.btab.on .btab-dot{opacity:1}
.btab-run-wrap{width:42px;height:42px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;margin-bottom:1px;transition:transform .15s,background .2s}
.btab-run-wrap svg{stroke:var(--bg);fill:var(--bg);width:18px;height:18px}
.btab.on .btab-run-wrap{background:var(--hi);transform:scale(.94)}
.btab[data-v="run"] .btab-dot{display:none}

/* VIEWS */
#main{flex:1;min-height:0;overflow:hidden;position:relative}
.mview{position:absolute;inset:0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .22s;overflow:hidden}
.mview.on{opacity:1;pointer-events:all}

/* ══ HOME ══ */
#v-home{background:var(--bg);overflow-y:auto;scrollbar-width:none}
#v-home::-webkit-scrollbar{display:none}
.hm-hero{position:relative;height:272px;flex-shrink:0;overflow:hidden}
.hm-hero-bg{position:absolute;inset:0;background:linear-gradient(145deg,#0d0d1a 0%,#111128 60%,#0a0a0d 100%)}
.hm-hero-pattern{position:absolute;inset:0;opacity:.05;background-image:repeating-linear-gradient(45deg,var(--hi) 0,var(--hi) 1px,transparent 0,transparent 50%);background-size:22px 22px;mask-image:radial-gradient(ellipse at 50% 50%,black 50%,transparent 80%)}
.hm-hero-glow{position:absolute;width:340px;height:340px;border-radius:50%;background:radial-gradient(circle,rgba(200,240,80,.1) 0%,transparent 65%);top:50%;left:50%;transform:translate(-50%,-50%)}
.hm-hero-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 24px}
.hm-tag{font-size:9px;font-weight:200;letter-spacing:.18em;color:rgba(200,240,80,.65);background:rgba(200,240,80,.07);border:1px solid rgba(200,240,80,.14);border-radius:99px;padding:4px 14px;margin-bottom:16px}
.hm-hero-title{font-family:var(--fd);font-style:italic;font-size:32px;font-weight:300;text-align:center;line-height:1.1;margin-bottom:10px}
.hm-hero-sub{font-size:11px;font-weight:200;color:var(--dim);text-align:center;letter-spacing:.06em;margin-bottom:20px}
.hm-hero-stats{display:flex;gap:28px}
.hm-hs{display:flex;flex-direction:column;align-items:center;gap:2px}
.hm-hsv{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;color:var(--acc);line-height:1}
.hm-hsl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}

.hm-today{margin:16px 16px 0;padding:16px;background:var(--sf2);border:1px solid rgba(200,240,80,.13);border-radius:18px}
.hm-today-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.hm-today-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:rgba(200,240,80,.7)}
.hm-today-btn{background:var(--acc);border:none;border-radius:99px;padding:7px 16px;font-family:var(--fb);font-size:10px;font-weight:300;color:var(--bg);cursor:pointer;transition:opacity .2s}
.hm-today-btn:active{opacity:.8}
.hm-today-row{display:flex}
.hm-ts{flex:1;display:flex;flex-direction:column;gap:3px}
.hm-ts+.hm-ts{border-left:1px solid var(--ln);padding-left:16px}
.hm-tsl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.hm-tsv{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;line-height:1}

.hm-sec{padding:22px 16px 0}
.hm-sec-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:14px}
.hm-sec-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.hm-sec-more{font-size:10px;font-weight:200;color:var(--dim);cursor:pointer}
.hm-cbar{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--ln)}
.hm-cb-rk{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300;width:20px;flex-shrink:0;text-align:right}
.hm-cb-rk.g{color:var(--gold)}.hm-cb-rk.s{color:var(--silver)}.hm-cb-rk.b{color:var(--bronze)}.hm-cb-rk.o{color:var(--dim)}
.hm-cb-em{font-size:15px;flex-shrink:0}
.hm-cb-info{flex:1;min-width:0}
.hm-cb-name{font-size:13px;font-weight:300;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hm-cb-dist{font-size:10px;font-weight:200;color:var(--dim)}
.hm-cb-bar{width:50px;flex-shrink:0}
.hm-cb-bg{height:2px;background:rgba(255,255,255,.07);border-radius:2px}
.hm-cb-fill{height:2px;border-radius:2px}

.hm-feat{background:var(--sf);border:1px solid var(--ln);border-radius:18px;overflow:hidden;cursor:pointer;transition:transform .15s;margin-bottom:12px}
.hm-feat:active{transform:scale(.985)}
.hm-feat-img{height:140px;background:linear-gradient(145deg,#14142a,#0d0d1a);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hm-feat-glow{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 60%,rgba(200,240,80,.1),transparent 55%)}
.hm-feat-em{font-size:56px;position:relative;filter:drop-shadow(0 0 20px rgba(200,240,80,.18))}
.hm-feat-body{padding:16px 18px 18px}
.hm-feat-tag{font-size:9px;font-weight:200;letter-spacing:.14em;color:rgba(200,240,80,.7);margin-bottom:7px}
.hm-feat-title{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;line-height:1.25;margin-bottom:7px}
.hm-feat-desc{font-size:11px;font-weight:200;color:var(--dim);line-height:1.65}
.hm-feat-foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.hm-feat-by{font-size:9px;font-weight:200;color:rgba(255,255,255,.2)}
.hm-feat-cta{font-size:9px;font-weight:200;color:var(--acc);opacity:.8}

.hm-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.hm-card{background:var(--sf);border:1px solid var(--ln);border-radius:14px;overflow:hidden;cursor:pointer;transition:transform .15s}
.hm-card:active{transform:scale(.97)}
.hm-card-top{height:82px;background:linear-gradient(145deg,#161620,#0e0e18);display:flex;align-items:center;justify-content:center;font-size:32px;position:relative}
.hm-card-glow{position:absolute;inset:0;background:radial-gradient(circle at 70% 30%,rgba(200,240,80,.07),transparent 60%)}
.hm-card-body{padding:10px 12px 12px}
.hm-card-tag{font-size:8px;font-weight:200;letter-spacing:.12em;color:var(--acc);opacity:.7;margin-bottom:4px}
.hm-card-title{font-size:11px;font-weight:300;line-height:1.4}
.hm-card-time{font-size:9px;font-weight:200;color:var(--dim);margin-top:4px}

/* ══ RUN ══ */
#v-run{background:var(--bg)}
.rstate{display:none;flex-direction:column;height:100%;overflow-y:auto;scrollbar-width:none}
.rstate::-webkit-scrollbar{display:none}
.rstate.on{display:flex}

.rs-top{padding:20px 18px 16px;border-bottom:1px solid var(--ln);flex-shrink:0}
.rs-title{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;margin-bottom:4px}
.rs-sub{font-size:11px;font-weight:200;color:var(--dim)}

#map-wrap{flex-shrink:0;height:220px;margin:16px 16px 0;border-radius:18px;border:1px solid var(--ln);overflow:hidden;position:relative;background:var(--sf2)}
#gmap{width:100%;height:100%}
.map-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#111124,#0a0a0d);pointer-events:none}
.map-ph.hide{display:none}
.map-ph-em{font-size:32px;opacity:.35}
.map-ph-txt{font-size:11px;font-weight:200;color:var(--dim);text-align:center;padding:0 20px;line-height:1.7}
.loc-btn{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:7px;background:rgba(10,10,13,.88);border:1px solid rgba(255,255,255,.12);border-radius:99px;padding:9px 18px;cursor:pointer;backdrop-filter:blur(12px);font-family:var(--fb);font-size:11px;font-weight:200;color:var(--hi);transition:all .2s;white-space:nowrap}
.loc-btn.on{border-color:rgba(200,240,80,.4);color:var(--acc)}
.loc-dot{width:8px;height:8px;border-radius:50%;background:var(--dim);flex-shrink:0;transition:all .3s}
.loc-btn.on .loc-dot{background:var(--acc);box-shadow:0 0 8px rgba(200,240,80,.6)}

.rs-body{padding:16px 16px 0;flex:1}
.rs-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:var(--dim);margin-bottom:10px}
.gt-row{display:flex;gap:8px;margin-bottom:18px}
.gt{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:14px;padding:12px 4px;text-align:center;cursor:pointer;transition:all .2s}
.gt.on{border-color:rgba(200,240,80,.4);background:rgba(200,240,80,.06)}
.gt-em{font-size:18px;margin-bottom:4px}
.gt-nm{font-size:10px;font-weight:200;color:var(--mid)}
.gt.on .gt-nm{color:var(--hi)}
.gv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
.gv{background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:11px 4px;text-align:center;cursor:pointer;transition:all .2s}
.gv.on{border-color:rgba(200,240,80,.35);background:rgba(200,240,80,.06)}
.gv-n{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;display:block}
.gv-u{font-size:9px;font-weight:200;color:var(--dim)}
.rs-start{margin:0 16px 16px;background:var(--hi);border:none;border-radius:18px;padding:17px;font-family:var(--fb);font-size:15px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:opacity .2s;flex-shrink:0;letter-spacing:.03em}
.rs-start:active{opacity:.85}

/* active run */
.ra-map-big{flex-shrink:0;height:300px;position:relative;overflow:hidden;background:var(--sf2)}
#gmap-active{width:100%;height:100%}
.ra-map-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#111124,#0a0a0d)}
.ra-map-ph.hide{display:none}
.ra-stats{display:flex;border-top:1px solid var(--ln);border-bottom:1px solid var(--ln);flex-shrink:0}
.ra-st{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 4px;gap:4px;position:relative}
.ra-st+.ra-st::before{content:'';position:absolute;left:0;top:15%;height:70%;width:1px;background:var(--ln)}
.ra-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.ra-sv{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.ra-su{font-size:9px;font-weight:200;color:var(--dim)}
.ra-goal{padding:14px 18px;background:var(--sf);border-bottom:1px solid var(--ln);flex-shrink:0}
.ra-gl{font-size:9px;font-weight:200;letter-spacing:.1em;color:var(--dim);margin-bottom:7px;display:flex;justify-content:space-between}
.ra-bar{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:visible;position:relative}
.ra-fill{height:3px;border-radius:2px;background:var(--acc);transition:width .5s}
.ra-ctrl{display:flex;gap:10px;padding:18px 16px 20px;flex-shrink:0}
.ra-stop{flex:1;background:rgba(255,70,70,.1);border:1px solid rgba(255,70,70,.22);border-radius:16px;padding:16px;font-family:var(--fb);font-size:14px;font-weight:300;color:rgba(255,110,110,.9);cursor:pointer;transition:all .2s}
.ra-stop:active{background:rgba(255,70,70,.2)}
.ra-pause{width:56px;height:56px;background:var(--sf);border:1px solid var(--ln);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s}
.ra-pause:active{background:rgba(255,255,255,.07)}

/* finish */
#rfinish{overflow-y:auto;scrollbar-width:none}
#rfinish::-webkit-scrollbar{display:none}
.rf-top{padding:30px 20px 22px;text-align:center;border-bottom:1px solid var(--ln)}
.rf-em{font-size:52px;margin-bottom:14px}
.rf-title{font-family:var(--fd);font-style:italic;font-size:28px;font-weight:300;margin-bottom:5px}
.rf-msg{font-size:12px;font-weight:200;color:var(--dim)}
.rf-grid{display:grid;grid-template-columns:1fr 1fr}
.rf-cell{padding:20px 18px;display:flex;flex-direction:column;gap:4px;border-bottom:1px solid var(--ln)}
.rf-cell:nth-child(odd){border-right:1px solid var(--ln)}
.rf-cl{font-size:9px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.rf-cv{font-family:var(--fd);font-style:italic;font-size:34px;font-weight:300;line-height:1}
.rf-cu{font-size:11px;font-weight:200;color:var(--dim)}
.rf-acts{display:flex;gap:10px;padding:20px 16px 28px}
.rf-shot{flex:1;background:var(--hi);border:none;border-radius:16px;padding:16px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:opacity .2s}
.rf-shot:active{opacity:.85}
.rf-done{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:16px 20px;font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid);cursor:pointer}

/* ══ CREW ══ */
#v-crew{background:var(--bg)}
#no-crew{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 28px 80px;text-align:center;overflow-y:auto;scrollbar-width:none}
#no-crew::-webkit-scrollbar{display:none}
.nc-em{font-size:54px;margin-bottom:20px;animation:clapBeat 1.6s ease-in-out infinite;font-style:italic;font-size:26px;font-weight:300;margin-bottom:8px}
.nc-sub{font-size:12px;font-weight:200;color:var(--dim);line-height:1.75;margin-bottom:32px}
.nc-actions{display:flex;flex-direction:column;gap:10px;width:100%}
.nc-primary{background:var(--hi);border:none;border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .2s}
.nc-primary:active{opacity:.85}
.nc-sec{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.nc-divider{display:flex;align-items:center;gap:10px;padding:2px 0}
.nc-divider::before,.nc-divider::after{content:'';flex:1;height:1px;background:var(--ln)}
.nc-divider span{font-size:10px;font-weight:200;color:rgba(255,255,255,.15)}
.nc-nearby{width:100%;background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:14px 16px}
.nc-nl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:10px}
.nc-nr{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--ln)}
.nc-nr:last-child{border-bottom:none;padding-bottom:0}
.nc-nem{font-size:15px;flex-shrink:0}
.nc-ni{flex:1;min-width:0}
.nc-nn{font-size:12px;font-weight:300}
.nc-nm{font-size:9px;font-weight:200;color:var(--dim);margin-top:1px}
.nc-npct{font-family:var(--fd);font-style:italic;font-size:15px;color:var(--acc);opacity:.8;flex-shrink:0}
.nc-njoin{background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:5px 13px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer;flex-shrink:0}

#crew-content{display:none;flex-direction:column;flex:1;overflow:hidden}
#ctabs{flex-shrink:0;display:flex;padding:0 18px;border-bottom:1px solid var(--ln);overflow-x:auto;scrollbar-width:none;background:var(--bg)}
#ctabs::-webkit-scrollbar{display:none}
.ctab{flex-shrink:0;background:none;border:none;border-bottom:1.5px solid transparent;padding:12px 12px 9px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.07em;color:var(--dim);cursor:pointer;transition:all .25s;white-space:nowrap}
.ctab.on{color:var(--hi);border-bottom-color:var(--hi)}
.cpane{flex:1;display:none;flex-direction:column;overflow-y:auto;scrollbar-width:none;padding:0 18px 100px}
.cpane::-webkit-scrollbar{display:none}
.cpane.on{display:flex}
.crew-hdr{display:flex;justify-content:space-between;align-items:flex-start;padding:18px 0 14px;border-bottom:1px solid var(--ln)}
.crew-hdr-name{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.crew-hdr-sub{font-size:10px;font-weight:200;color:var(--dim);margin-top:2px}
.crew-hdr-loc{font-size:10px;font-weight:200;color:rgba(200,240,80,.7);margin-top:2px}
.crew-expert{background:linear-gradient(135deg,rgba(212,181,74,.14),rgba(200,240,80,.07));border:1px solid rgba(212,181,74,.28);border-radius:99px;padding:5px 11px;font-size:10px;font-weight:300;color:rgba(212,181,74,.9);flex-shrink:0;margin-top:4px}
.gc-card{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:16px;margin:14px 0}
.gc-top{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.gc-lbl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:5px}
.gc-nums{display:flex;align-items:baseline;gap:3px}
.gc-cur{font-family:var(--fd);font-style:italic;font-size:36px;font-weight:300;line-height:1}
.gc-sep,.gc-tot{font-size:14px;font-weight:200;color:var(--dim)}
.gc-unit{font-size:10px;font-weight:200;color:var(--dim);opacity:.5;margin-left:2px}
.gc-pct{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;color:var(--acc);opacity:.85}
.prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:12px}
.pf{height:1px;background:var(--acc);transition:width 1.4s cubic-bezier(.4,0,.2,1);position:relative}
.pd{position:absolute;right:-3px;top:-2.5px;width:6px;height:6px;border-radius:50%;background:var(--acc);box-shadow:0 0 8px rgba(200,240,80,.5)}
.gc-meta{display:flex}
.gm{flex:1;display:flex;flex-direction:column;gap:2px}
.gm+.gm{border-left:1px solid var(--ln);padding-left:12px}
.gm-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.gm-v{font-size:13px;font-weight:300;color:var(--mid)}
.gm-v.a{color:var(--acc);opacity:.85}
.lb-hdr{display:flex;justify-content:space-between;padding-top:4px;margin-bottom:10px}
.lb-ttl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim)}
.lb-cnt{font-size:9px;font-weight:200;color:rgba(255,255,255,.15)}
.lbrow{display:flex;align-items:center;gap:9px;padding:10px 0;border-bottom:1px solid var(--ln)}
.lbrow.click{cursor:pointer;border-radius:8px;padding:10px 6px;margin:0 -6px;transition:background .15s}
.lbrow.click:active{background:rgba(255,255,255,.04)}
.lbrow.me .lb-nm{color:var(--hi)}.lbrow.me .lb-d{color:var(--acc)}
.lbpos{width:17px;font-size:11px;font-weight:300;text-align:center;color:var(--dim);flex-shrink:0}
.lbpos.g{color:var(--gold)}.lbpos.s{color:var(--silver)}.lbpos.b{color:var(--bronze)}
.lbem{font-size:15px;flex-shrink:0}
.lb-nc{flex:1;min-width:0;display:flex;flex-direction:column;gap:1px}
.lb-nm{font-size:12px;font-weight:200;color:var(--mid);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-hint{font-size:9px;font-weight:200;color:rgba(255,255,255,.2)}
.lb-rt{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.lb-d{font-size:12px;font-weight:300;color:var(--mid)}
.lb-bg{width:40px;height:1px;background:rgba(255,255,255,.07)}
.lb-bar{height:1px}.lb-bar.me{background:var(--acc)}.lb-bar.g{background:var(--gold)}.lb-bar.s{background:var(--silver)}.lb-bar.b{background:var(--bronze)}.lb-bar.o{background:rgba(255,255,255,.18)}
.nb-hdr{padding:18px 0 10px;border-bottom:1px solid var(--ln)}
.nb-area{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.nb-desc{font-size:10px;font-weight:200;color:var(--dim);margin-top:3px}
.nb-row{padding:14px 0;border-bottom:1px solid var(--ln)}
.nb-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.nb-rn{font-family:var(--fd);font-style:italic;font-size:18px;flex-shrink:0}
.nb-rn.g{color:var(--gold)}.nb-rn.s{color:var(--silver)}.nb-rn.b{color:var(--bronze)}.nb-rn.o{color:var(--acc)}
.nb-cname{font-size:14px;font-weight:300}.nb-mine{font-size:8px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:99px;padding:2px 7px;color:rgba(200,240,80,.8)}
.nb-cmeta{font-size:9px;font-weight:200;color:var(--dim)}.nb-pct{font-family:var(--fd);font-style:italic;font-size:22px;color:var(--acc);opacity:.85}
.nb-prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:10px}
.nb-pf{height:1px;background:rgba(200,240,80,.5);position:relative}
.nb-pd{position:absolute;right:-2px;top:-2px;width:5px;height:5px;border-radius:50%;background:rgba(200,240,80,.7)}
.nb-bot{display:flex;justify-content:space-between;align-items:center}
.nb-ghosts{font-size:14px;letter-spacing:.02em}.nb-nums{display:flex;gap:14px}
.nbn{display:flex;flex-direction:column;align-items:flex-end;gap:1px}
.nbn-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}.nbn-v{font-family:var(--fd);font-style:italic;font-size:14px}
.past-hdr{display:flex;justify-content:space-between;align-items:center;padding:18px 0 12px;border-bottom:1px solid var(--ln)}
.past-title{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.expert-btn{display:flex;align-items:center;gap:5px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:6px 12px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer}
.past-card{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--ln)}
.pc-em{font-size:20px;flex-shrink:0}
.pc-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:3px}
.pc-name{font-size:13px;font-weight:300}.pc-meta{font-size:10px;font-weight:200;color:var(--dim)}
.pc-xb{background:linear-gradient(135deg,rgba(212,181,74,.14),rgba(200,240,80,.07));border:1px solid rgba(212,181,74,.28);border-radius:99px;padding:2px 8px;font-size:8px;color:rgba(212,181,74,.85);display:inline-block;margin-top:3px}
.pc-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.pc-rank{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.pc-rank.g{color:var(--gold)}.pc-rank.s{color:var(--silver)}.pc-rank.b{color:var(--bronze)}.pc-rank.o{color:var(--acc)}
.pc-dist{font-size:10px;font-weight:200;color:var(--dim)}

/* ══ SHOT ══ */
#v-shot{padding:10px 14px 0;background:var(--bg);display:flex;flex-direction:column;overflow:hidden}
#card{flex:1;position:relative;border-radius:22px;overflow:hidden;background:#080810;min-height:0;box-shadow:0 8px 40px rgba(0,0,0,.6)}
#bg-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s}
#empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#13131a,#0a0a0d)}
.e-grain{position:absolute;inset:0;opacity:.3;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23f)' opacity='.07'/%3E%3C/svg%3E")}
.e-icon{font-size:28px;opacity:.18;filter:grayscale(1);position:relative}
.e-hint{font-size:10px;font-weight:200;letter-spacing:.14em;color:var(--dim);opacity:.55;position:relative}
#ovs{position:absolute;inset:0;z-index:5;pointer-events:none}
.ov{position:absolute;inset:0;transition:opacity .35s}.ov.off{opacity:0}
.ft{position:absolute;top:0;left:0;right:0;height:170px;background:linear-gradient(180deg,rgba(0,0,0,.75),transparent)}
.fb{position:absolute;bottom:0;left:0;right:0;height:260px;background:linear-gradient(0deg,rgba(0,0,0,.92) 0%,rgba(0,0,0,.4) 55%,transparent)}
.ov-hd{position:absolute;top:0;left:0;right:0;padding:16px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.runner{display:flex;align-items:center;gap:6px;cursor:pointer;pointer-events:all}
.r-em{font-size:17px;line-height:1}.r-nm{font-size:13px;font-weight:400;color:rgba(255,255,255,.85)}
.ov-dt{font-size:9px;font-weight:200;color:rgba(255,255,255,.22);text-align:right;line-height:1.9}
.chip{position:absolute;display:flex;align-items:baseline;gap:4px;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.09);border-radius:99px;padding:5px 12px;pointer-events:none}
.ch-n{font-family:var(--fd);font-style:italic;font-size:20px;line-height:1}
.ch-n.g{color:var(--gold)}.ch-n.s{color:var(--silver)}.ch-n.b{color:var(--bronze)}.ch-n.o{color:var(--acc)}
.ch-of{font-size:10px;font-weight:200;color:rgba(255,255,255,.28)}
.gchip{top:16px;right:16px}
.gboard{position:absolute;right:14px;bottom:68px;display:flex;flex-direction:column;gap:2px;pointer-events:none}
.gb-lbl{font-size:9px;font-weight:400;letter-spacing:.14em;color:rgba(255,255,255,.4);text-align:right;margin-bottom:3px}
.gb-row{display:flex;align-items:center;gap:5px;padding:4px 8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.06);border-radius:6px}
.gb-row.me{background:rgba(200,240,80,.08);border-color:rgba(200,240,80,.2)}
.gb-n{font-size:9px;font-weight:300;color:rgba(255,255,255,.22);width:11px;text-align:right}
.gb-n.g{color:var(--gold)}.gb-n.s{color:var(--silver)}.gb-n.b{color:var(--bronze)}
.gb-e{font-size:11px}.gb-d{font-size:9px;font-weight:300;color:rgba(255,255,255,.42);margin-left:auto}
.gb-d.me{color:var(--acc)}
.g-bot{position:absolute;bottom:0;left:0;right:64px;padding:0 18px 18px}
.g-dist{font-family:var(--fd);font-style:italic;font-size:52px;font-weight:300;line-height:.9;letter-spacing:-.02em}
.g-du{font-family:var(--fb);font-size:15px;font-weight:200;color:var(--mid);margin-left:3px;vertical-align:middle}
.g-stats{display:flex;margin-top:9px}
.g-s{flex:1;display:flex;flex-direction:column;gap:2px}
.g-s+.g-s{border-left:1px solid rgba(255,255,255,.07);padding-left:13px}
.g-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:rgba(255,255,255,.2)}
.g-sv{font-size:13px;font-weight:300;color:var(--mid)}
.g-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.g-brand{font-size:9px;font-weight:200;letter-spacing:.16em;color:rgba(255,255,255,.1)}
.g-tag{font-size:9px;font-weight:200;color:rgba(200,240,80,.42)}
.p-logo{font-family:var(--fd);font-style:italic;font-size:15px;font-weight:400;color:rgba(255,255,255,.55)}
.p-mapbg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
#mmp{width:62%;max-width:220px;aspect-ratio:1;opacity:.25}
.p-chip{bottom:116px;left:50%;top:auto;transform:translateX(-50%)}
.p-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px;display:flex;justify-content:space-between;align-items:flex-end}
.p-stat{display:flex;flex-direction:column;gap:2px}
.p-l{font-size:10px;font-weight:300;letter-spacing:.18em;color:rgba(255,255,255,.5)}
.p-v{font-family:var(--fd);font-style:italic;font-size:34px;color:var(--hi);line-height:1}
.p-u{font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid)}
.st-vign{position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.62) 100%)}
.st-logo{font-size:9px;font-weight:300;letter-spacing:.15em;color:rgba(255,255,255,.28)}
.st-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px}
.st-rrow{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.st-rn{font-family:var(--fd);font-style:italic;font-size:34px;line-height:1}
.st-rn.g{color:var(--gold)}.st-rn.s{color:var(--silver)}.st-rn.b{color:var(--bronze)}.st-rn.o{color:var(--acc)}
.st-of{font-size:12px;font-weight:200;color:rgba(255,255,255,.3)}
.st-dist{font-family:var(--fd);font-style:italic;font-size:50px;line-height:.9;letter-spacing:-.02em}
.st-du{font-family:var(--fb);font-size:17px;font-weight:200;color:var(--mid);margin-left:2px}
.st-sub{display:flex;gap:14px;margin-top:8px}
.ss{display:flex;flex-direction:column;gap:1px}
.ss-l{font-size:9px;font-weight:300;letter-spacing:.12em;color:rgba(255,255,255,.5)}
.ss-v{font-size:14px;font-weight:400;color:rgba(255,255,255,.88);letter-spacing:.02em}
.st-badge{position:absolute;bottom:14px;right:14px;width:60px;height:60px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.44);backdrop-filter:blur(8px)}
.st-badge::before{content:"";position:absolute;inset:5px;border-radius:50%;border:1px solid rgba(200,240,80,.1)}
.sb-em{font-size:23px;line-height:1}.sb-done{font-size:7px;font-weight:200;letter-spacing:.12em;color:rgba(200,240,80,.5)}.sb-date{font-size:7px;font-weight:200;color:rgba(255,255,255,.18)}
#tbar{flex-shrink:0;display:flex;gap:6px;padding:8px 14px 5px;overflow-x:auto;scrollbar-width:none}
#tbar::-webkit-scrollbar{display:none}
#tbar::-webkit-scrollbar{display:none}
.th{flex-shrink:0;background:none;border:1px solid var(--ln);border-radius:99px;padding:6px 14px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.06em;color:var(--dim);cursor:pointer;transition:all .2s}
.th.on{border-color:rgba(255,255,255,.3);color:var(--hi)}
#shot-acts{flex-shrink:0;display:flex;gap:8px;padding:5px 14px 10px}
.ai{width:46px;background:var(--sf);border:1px solid var(--ln);border-radius:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.ai svg{width:17px;height:17px;stroke:var(--mid);stroke-width:1.5;fill:none;stroke-linecap:round;stroke-linejoin:round}
.asave{flex:1;background:var(--hi);border:none;border-radius:13px;font-family:var(--fb);font-size:13px;font-weight:300;letter-spacing:.04em;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:opacity .2s}
.asave:active{opacity:.85}

/* ══ RECORDS ══ */
#v-records{background:var(--bg);overflow-y:auto;scrollbar-width:none}
#v-records::-webkit-scrollbar{display:none}
.rec-hero{padding:26px 18px 22px;border-bottom:1px solid var(--ln)}
.rec-hero-lbl{font-size:10px;font-weight:300;letter-spacing:.14em;color:rgba(255,255,255,.5);margin-bottom:12px}
.rec-big{display:flex;align-items:flex-end;gap:6px;margin-bottom:5px}
.rec-big-n{font-family:"Barlow Condensed",sans-serif;font-style:normal;font-size:96px;font-weight:900;line-height:.82;letter-spacing:-.01em;color:#fff}
.rec-big-u{font-family:"Barlow Condensed",sans-serif;font-style:normal;font-size:32px;font-weight:400;color:rgba(255,255,255,.6);padding-bottom:14px;letter-spacing:.02em}
.rec-hero-sub{font-size:12px;font-weight:300;color:rgba(255,255,255,.45);margin-bottom:24px;letter-spacing:.04em}
.rec-3{display:flex;border-top:1px solid var(--ln);padding-top:0}
.rec-3s{flex:1;padding:16px 0;display:flex;flex-direction:column;align-items:center;gap:3px}
.rec-3s+.rec-3s{border-left:1px solid var(--ln)}
.rec-3sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.rec-3sv{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.rec-3su{font-size:10px;font-weight:200;color:var(--dim)}
.rec-cal{padding:22px 18px 0}
.rec-cal-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:var(--dim);margin-bottom:12px}
.cal-grid{display:flex;gap:4px;flex-wrap:wrap}
.cal-d{width:13px;height:13px;border-radius:3px;background:rgba(255,255,255,.06)}
.cal-d.run{background:rgba(200,240,80,.5)}.cal-d.today{background:var(--acc);box-shadow:0 0 7px rgba(200,240,80,.5)}
.rec-target{margin:22px 18px 0;background:var(--sf);border:1px solid var(--ln);border-radius:18px;padding:18px}
.rt-top{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.rt-lbl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:4px}
.rt-val{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300}
.rt-pct{font-family:var(--fd);font-style:italic;font-size:20px;color:var(--acc);opacity:.85}
.rt-bar{height:3px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden}
.rt-fill{height:100%;background:var(--acc);border-radius:2px;transition:width 1.4s cubic-bezier(.4,0,.2,1)}
.rec-log{padding:24px 18px 0}
.rec-log-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:16px}
.rec-log-title{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300}
.rec-log-cnt{font-size:10px;font-weight:200;color:var(--dim)}
.log-item{display:flex;align-items:center;gap:14px;padding:15px 0;border-bottom:1px solid var(--ln)}
.log-date{flex-shrink:0;display:flex;flex-direction:column;align-items:center;width:36px}
.log-mo{font-size:8px;font-weight:200;color:var(--dim)}
.log-dy{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.log-cv{width:52px;height:52px;flex-shrink:0;border-radius:10px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4)}
.log-info{flex:1;display:flex;flex-direction:column;gap:4px}
.log-crew{font-size:9px;font-weight:200;background:var(--sf2);border:1px solid var(--ln);border-radius:99px;padding:3px 9px;color:var(--dim);display:inline-flex;align-items:center;width:fit-content}
.log-km{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.log-sub{font-size:11px;font-weight:200;color:var(--dim)}
.log-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.log-rn{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300}
.log-rn.g{color:var(--gold)}.log-rn.s{color:var(--silver)}.log-rn.b{color:var(--bronze)}.log-rn.o{color:var(--acc)}
.log-kcal{font-size:9px;font-weight:200;color:var(--dim)}
.rec-crews{padding:24px 18px 100px}
.rec-crews-title{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;margin-bottom:16px}
.rcr{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--ln)}
.rcr-em{font-size:24px;flex-shrink:0}
.rcr-info{flex:1;display:flex;flex-direction:column;gap:3px}
.rcr-name{font-size:14px;font-weight:300}.rcr-meta{font-size:10px;font-weight:200;color:var(--dim)}
.rcr-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.rcr-xp{background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:3px 10px;font-size:9px;color:rgba(200,240,80,.85)}
.rcr-rank{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.rcr-rank.g{color:var(--gold)}.rcr-rank.s{color:var(--silver)}.rcr-rank.b{color:var(--bronze)}.rcr-rank.o{color:var(--acc)}

/* ══ MODALS ══ */
.modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .28s}
.modal.on{opacity:1;pointer-events:all}
.m-box{width:100%;max-width:430px;background:#111114;border:1px solid var(--ln);border-bottom:none;border-radius:22px 22px 0 0;padding:24px 20px 44px;transform:translateY(16px);transition:transform .3s;max-height:90dvh;overflow-y:auto;scrollbar-width:none}
.m-box::-webkit-scrollbar{display:none}
.modal.on .m-box{transform:translateY(0)}
.m-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:5px}
.m-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:22px;line-height:1.6}
.m-cancel{width:100%;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer;margin-top:8px}
.m-ok{width:100%;background:var(--hi);border:none;border-radius:14px;padding:14px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;transition:opacity .2s}
.m-ok:active{opacity:.85}
.mf{margin-bottom:16px}.ml{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:8px}
.mi{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;font-family:var(--fb);font-size:14px;font-weight:200;color:var(--hi);outline:none;transition:border-color .2s;caret-color:var(--acc)}
.mi:focus{border-color:rgba(200,240,80,.35)}
.mi::placeholder{color:rgba(255,255,255,.18)}
.em-row{display:flex;gap:8px;flex-wrap:wrap}
.em-opt{width:46px;height:46px;background:var(--sf);border:1px solid var(--ln);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all .2s}
.em-opt.on{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.07);transform:scale(1.06)}
.g-row{display:flex;gap:8px}
.g-opt{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s}
.g-opt.on{border-color:rgba(200,240,80,.35);background:rgba(200,240,80,.07)}
.g-opt span:first-child{font-family:var(--fd);font-style:italic;font-size:18px;display:block}
.g-opt span:last-child{font-size:8px;font-weight:200;color:var(--dim)}
.join-inp{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px 16px;font-family:var(--fb);font-size:16px;font-weight:300;color:var(--hi);letter-spacing:.1em;outline:none;transition:border-color .2s;caret-color:var(--acc);margin-bottom:12px;text-transform:uppercase}
.join-inp::placeholder{color:rgba(255,255,255,.2);text-transform:none}
.join-inp:focus{border-color:rgba(200,240,80,.4)}
.join-prev{display:none;align-items:center;gap:12px;background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.18);border-radius:14px;padding:14px 16px;margin-bottom:14px}
.join-prev.on{display:flex}
/* member modal */
.mm-hd{display:flex;align-items:center;gap:12px;padding:22px 20px 16px;border-bottom:1px solid var(--ln)}
.mm-em{font-size:32px}.mm-name{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}.mm-cl{font-size:11px;font-weight:200;color:var(--dim);margin-top:2px}
.mm-rank{font-family:var(--fd);font-style:italic;font-size:28px;font-weight:300;margin-left:auto}
.mm-rank.g{color:var(--gold)}.mm-rank.s{color:var(--silver)}.mm-rank.b{color:var(--bronze)}.mm-rank.o{color:var(--acc)}
.mm-stats{display:flex;padding:16px 20px;border-bottom:1px solid var(--ln)}
.mm-st{flex:1;display:flex;flex-direction:column;gap:2px}
.mm-st+.mm-st{border-left:1px solid var(--ln);padding-left:14px}
.mm-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}.mm-sv{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.mm-rl{padding:14px 20px 8px;font-size:9px;letter-spacing:.12em;color:var(--dim)}
.mm-rr{display:flex;align-items:center;gap:10px;padding:10px 20px;border-bottom:1px solid var(--ln)}
.mm-rd{font-size:9px;color:var(--dim);width:44px;flex-shrink:0}.mm-rk{font-family:var(--fd);font-style:italic;font-size:17px;flex:1}.mm-rp{font-size:10px;color:var(--dim)}
.mm-close{width:calc(100% - 40px);margin:14px 20px 0;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;color:var(--dim);cursor:pointer}
/* avatar */
#avs{position:fixed;inset:0;z-index:90;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
#avs.on{opacity:1;pointer-events:all}
.av-box{width:100%;max-width:430px;background:#111114;border:1px solid var(--ln);border-bottom:none;border-radius:20px 20px 0 0;padding:16px 18px 36px;transform:translateY(12px);transition:transform .3s}
#avs.on .av-box{transform:translateY(0)}
.av-ttl{font-size:9px;letter-spacing:.14em;color:var(--dim);text-align:center;margin-bottom:12px}
.av-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px}
.avc{display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 3px 7px;border-radius:11px;border:1px solid transparent;background:var(--sf);cursor:pointer;transition:all .2s}
.avc.on{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06)}
.ave{font-size:22px;line-height:1}.avl{font-size:8px;font-weight:200;color:var(--dim)}.avc.on .avl{color:var(--hi)}
/* toast/flash */
#toast{position:fixed;z-index:200;bottom:74px;left:50%;transform:translateX(-50%) translateY(5px);background:rgba(10,10,13,.96);border:1px solid rgba(255,255,255,.08);border-radius:99px;padding:8px 18px;font-size:11px;color:var(--mid);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
#flash{position:fixed;inset:0;z-index:300;background:rgba(255,255,255,.1);opacity:0;pointer-events:none;transition:opacity .08s}
#flash.on{opacity:1}
input[type=file]{display:none}

/* ══ LOGIN SCREEN ══ */
#login-screen{position:fixed;inset:0;z-index:998;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;transition:opacity .5s,transform .5s}
#login-screen.out{opacity:0;transform:scale(1.04);pointer-events:none}
.ls-logo{font-family:var(--fd);font-style:italic;font-size:36px;font-weight:300;margin-bottom:6px;text-align:center}
.ls-sub{font-size:11px;font-weight:200;color:var(--dim);text-align:center;letter-spacing:.06em;margin-bottom:36px}
.ls-form{width:100%;display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.ls-input{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px 16px;font-family:var(--fb);font-size:14px;font-weight:200;color:var(--hi);outline:none;caret-color:var(--acc);transition:border-color .2s}
.ls-input:focus{border-color:rgba(200,240,80,.4)}
.ls-input::placeholder{color:rgba(255,255,255,.2)}
.ls-btn{width:100%;background:var(--acc);border:none;border-radius:14px;padding:16px;font-family:var(--fb);font-size:14px;font-weight:400;color:var(--bg);cursor:pointer;transition:opacity .2s;letter-spacing:.03em}
.ls-btn:active{opacity:.85}
.ls-err{font-size:11px;font-weight:200;color:rgba(255,100,100,.8);text-align:center;min-height:16px;margin-top:-2px}
.ls-switch{font-size:11px;font-weight:200;color:var(--dim);text-align:center;cursor:pointer;margin-top:4px}
.ls-switch span{color:var(--acc);opacity:.85;text-decoration:underline;text-underline-offset:2px}
.ls-divider{display:flex;align-items:center;gap:10px;margin:14px 0}
.ls-divider::before,.ls-divider::after{content:'';flex:1;height:1px;background:var(--ln)}
.ls-divider span{font-size:10px;font-weight:200;color:rgba(255,255,255,.2)}
.ls-social{display:flex;gap:10px;width:100%}
.ls-social-btn{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:12px 8px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--mid);transition:all .2s}
.ls-social-btn:active{background:var(--sf2)}
.ls-social-em{font-size:16px}
.ls-mode-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:4px;align-self:flex-start}
.ls-mode-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:28px;align-self:flex-start}
/* profile badge in nav */
#nav-profile{width:28px;height:28px;border-radius:50%;background:var(--sf2);border:1px solid rgba(200,240,80,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .2s}
#nav-profile:active{transform:scale(.9)}
/* user profile modal */
.prof-hd{padding:22px 20px 16px;border-bottom:1px solid var(--ln);display:flex;align-items:center;gap:14px}
.prof-avatar{width:52px;height:52px;border-radius:50%;background:var(--sf2);border:1px solid rgba(200,240,80,.25);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
.prof-name{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.prof-email{font-size:10px;font-weight:200;color:var(--dim);margin-top:2px}
.prof-joined{font-size:9px;font-weight:200;color:rgba(200,240,80,.6);margin-top:3px}
.prof-stats-row{display:flex;padding:16px 20px;border-bottom:1px solid var(--ln)}
.prof-st{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.prof-st+.prof-st{border-left:1px solid var(--ln)}
.prof-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.prof-sv{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.prof-menu-item{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--ln);cursor:pointer;transition:background .15s}
.prof-menu-item:active{background:rgba(255,255,255,.03)}
.prof-menu-em{font-size:16px;width:22px;text-align:center}
.prof-menu-txt{flex:1;font-size:13px;font-weight:200}
.prof-menu-arrow{font-size:11px;color:var(--dim)}
.prof-logout{width:calc(100% - 40px);margin:14px 20px;background:rgba(255,70,70,.08);border:1px solid rgba(255,70,70,.18);border-radius:14px;padding:13px;font-family:var(--fb);font-size:13px;font-weight:300;color:rgba(255,110,110,.85);cursor:pointer;transition:all .2s}
.prof-logout:active{background:rgba(255,70,70,.15)}
/* server status badge */
.srv-badge{position:fixed;top:56px;right:10px;z-index:80;display:flex;align-items:center;gap:5px;background:rgba(10,10,13,.88);border:1px solid var(--ln);border-radius:99px;padding:4px 10px;font-size:9px;font-weight:200;color:var(--dim);backdrop-filter:blur(8px);pointer-events:none;transition:opacity .3s}
.srv-dot{width:6px;height:6px;border-radius:50%;background:var(--dim);flex-shrink:0}
.srv-badge.online .srv-dot{background:var(--acc);box-shadow:0 0 5px rgba(200,240,80,.5)}
.srv-badge.online{color:rgba(200,240,80,.7);border-color:rgba(200,240,80,.15)}

/* ══ RUN ACTIVE REDESIGN ══ */
@keyframes syncPulse{0%,100%{opacity:1;box-shadow:0 0 6px #c8f050}50%{opacity:.5;box-shadow:0 0 14px #c8f050}}
#ractive{display:flex;flex-direction:column}
#ra-map-container{flex:1;min-height:200px}
/* override font vars for active run */
#ra-dist{font-family:'Barlow Condensed',sans-serif!important}
#ra-pace,#ra-time{font-family:'Barlow Condensed',sans-serif!important}
/* Clap animation */
@keyframes clapBounce{0%,100%{transform:scale(1)}30%{transform:scale(1.5) rotate(-10deg)}60%{transform:scale(.9) rotate(5deg)}}
.clap-anim{animation:clapBounce .4s ease!important}
@keyframes clapFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(.7)}}
.clap-float{position:absolute;pointer-events:none;font-size:22px;animation:clapFloat .8s ease forwards;z-index:50}
/* Racing track ghost icons */
.track-icon{position:absolute;top:50%;transform:translateY(-50%);font-size:18px;transition:left .5s;pointer-events:none;filter:drop-shadow(0 0 4px rgba(200,240,80,.4))}
/* Insta feed scrollbar hide */
#insta-feed::-webkit-scrollbar{display:none}
/* Home hero number */
.hm-big-dist{font-family:'Barlow Condensed',sans-serif;font-size:88px;font-weight:900;letter-spacing:-.02em;line-height:.85;color:#c8f050}
/* Barlow font override for key elements */
.rec-big-n,.ra-sv,.log-km,.rec-3sv,.rf-cv{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.hm-sec-title,.rec-log-title,.rec-crews-title,.past-title{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.sp-logo,.ls-logo{font-family:'Barlow Condensed',sans-serif!important}
.gc-cur,.gc-pct,.gm-v,.lb-d,.mm-sv,.nb-pct,.pc-rank{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.log-dy,.log-km{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.rec-big-n,.rec-3sv{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}

/* Room tabs */
.rtab{cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s;}
.rpane{display:none;}
/* Modal base (used by room modals too) */
.modal{display:none;position:fixed;inset:0;z-index:200;}

/* ── Small text legibility fixes ── */
/* Leaderboard labels */
.btab span, .rtab { letter-spacing: .04em }
/* Room card small text */
.rm-meta, .rm-goal-txt { font-weight: 300; letter-spacing: .03em }
/* Global: any 9-10px font-size text should have reduced tracking */
[style*="font-size:9px"], [style*="font-size:10px"] { letter-spacing: .05em }
/* path overlay stat label */
.p-l { font-size: 10px; font-weight: 300; letter-spacing: .12em; color: rgba(255,255,255,.5) }
/* Ghost overlay stat label */
.g-sl { font-size: 10px; font-weight: 300; letter-spacing: .06em; color: rgba(255,255,255,.48) }
/* Barlow small text */
.bsm { font-size: 10px; font-weight: 300; letter-spacing: .08em }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5fe69b6f593b050ab5a4ba1ae791c0fc&libraries=services,clusterer"></script>
<style>
/* Kakao Maps */
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ── Supabase 초기화 ──
const _SB = supabase.createClient('https://imjcmmqsafeyfshgybji.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltamNtbXFzYWZleWZzaGd5YmppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIzMTQ0NjQsImV4cCI6MjA4Nzg5MDQ2NH0.AQpyjjCTBh4xsX4WRRZlXAvZGCnNNF5NYwTxBAd_By8');
</script>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-grain"></div><div class="sp-glow"></div><div class="sp-lines"></div>
  <div class="sp-em">
    <span class="sp-clap-main">👏</span>
    <span class="sp-clap-l">👏</span>
    <span class="sp-clap-r">👏</span>
  </div>
  <div class="sp-logo"><span style="font-style:italic;font-weight:900;letter-spacing:1px;font-size:72px"><span style="color:#c8f050">Clap</span>Run</span></div>
  <div class="sp-sub">오늘도 뛰는 모든 러너에게</div>
  <div class="sp-desc">느슨한 연대를 위한<br>비대면 매칭 플랫폼</div>
  <button class="sp-btn" onclick="hideSplash()">시작하기</button>
  <span class="sp-ver">v1.0 · 2026</span>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none">
  <div class="ls-logo">👏 <span style="font-style:italic;font-weight:900;letter-spacing:-.02em"><span style="color:#c8f050">Clap</span>Run</span></div>
  <div class="ls-sub" id="ls-sub-txt">함께 달리는 사람들</div>
  <div class="ls-mode-title" id="ls-mode-title">로그인</div>
  <div class="ls-mode-sub" id="ls-mode-sub">계속하려면 로그인하세요</div>
  <div class="ls-form">
    <input class="ls-input" id="ls-email" type="email" placeholder="이메일" autocomplete="email">
    <input class="ls-input" id="ls-pw" type="password" placeholder="비밀번호" autocomplete="current-password">
    <input class="ls-input" id="ls-nick" type="text" placeholder="닉네임 (회원가입 시)" style="display:none" autocomplete="nickname" maxlength="12">
    <div class="ls-err" id="ls-err"></div>
    <button class="ls-btn" id="ls-submit" onclick="submitAuth()">로그인</button>
  </div>
  <div class="ls-switch" id="ls-switch" onclick="toggleAuthMode()">계정이 없으신가요? <span>회원가입</span></div>
  <div class="ls-divider"><span>또는</span></div>
  <div class="ls-social">
    <button class="ls-social-btn" onclick="socialLogin('kakao')"><span class="ls-social-em">💛</span>카카오</button>
    <button class="ls-social-btn" onclick="socialLogin('naver')"><span class="ls-social-em">🟢</span>네이버</button>
    <button class="ls-social-btn" onclick="socialLogin('google')"><span class="ls-social-em">🔵</span>구글</button>
  </div>
</div>

<!-- SERVER STATUS -->
<div class="srv-badge" id="srv-badge"><div class="srv-dot"></div><span id="srv-txt">서버 연결 중...</span></div>

<!-- PROFILE MODAL -->
<div id="m-profile" class="modal"><div class="m-box" id="prof-box"></div></div>

<div id="nav"><span class="logo"><span style="font-style:italic;font-weight:900;letter-spacing:-.01em"><span style="color:#c8f050">Clap</span>Run</span></span><div style="display:flex;align-items:center;gap:10px"><span id="clock"></span><div id="nav-profile" onclick="openProfile()" title="프로필">👤</div></div></div>

<div id="main">

<!-- HOME -->
<div id="v-home" class="mview on" style="overflow-y:auto;scrollbar-width:none">
  <!-- HERO: Live runner count -->
  <div style="position:relative;overflow:hidden;flex-shrink:0;background:#0a0a0a;padding:52px 20px 28px">
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(200,240,80,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(200,240,80,.03) 1px,transparent 1px);background-size:28px 28px"></div>
    <div style="position:absolute;bottom:-40px;left:50%;transform:translateX(-50%);width:320px;height:200px;background:radial-gradient(ellipse,rgba(200,240,80,.09) 0%,transparent 65%);pointer-events:none"></div>
    <div style="position:relative">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px">
        <div style="width:8px;height:8px;border-radius:50%;background:#c8f050;box-shadow:0 0 8px #c8f050;animation:syncPulse 1.5s infinite"></div>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.2em;color:rgba(200,240,80,.65)">LIVE · 내 주변 2km</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:4px">
        <span id="hm-runner-count" style="font-family:'Barlow Condensed',sans-serif;font-size:88px;font-weight:900;color:#c8f050;line-height:.85;letter-spacing:-.02em;text-shadow:0 0 40px rgba(200,240,80,.3)">24</span>
        <div style="display:flex;flex-direction:column;gap:2px;padding-bottom:8px">
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:rgba(255,255,255,.7);line-height:1">명이</span>
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:rgba(255,255,255,.7);line-height:1">뛰는 중</span>
        </div>
      </div>
      <div style="font-size:12px;font-weight:300;color:rgba(255,255,255,.3);letter-spacing:.04em;margin-bottom:22px">지금 이 순간, 당신도 혼자가 아닙니다</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:rgba(255,255,255,.06);border-radius:14px;overflow:hidden">
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'DM Sans',sans-serif;font-size:26px;font-weight:900;color:#fff;line-height:1" id="hm-total-km">187.4</div>
          <div style="font-size:9px;font-weight:300;letter-spacing:.08em;color:rgba(255,255,255,.35);margin-top:3px">총 km (오늘)</div>
        </div>
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'DM Sans',sans-serif;font-size:26px;font-weight:900;color:#fff;line-height:1" id="hm-avg-pace">5'14"</div>
          <div style="font-size:9px;font-weight:300;letter-spacing:.08em;color:rgba(255,255,255,.35);margin-top:3px">평균 페이스</div>
        </div>
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'DM Sans',sans-serif;font-size:26px;font-weight:900;color:rgba(200,240,80,.85);line-height:1" id="hm-active-now">8</div>
          <div style="font-size:9px;font-weight:300;letter-spacing:.08em;color:rgba(255,255,255,.35);margin-top:3px">지금 러닝 중</div>
        </div>
      </div>
    </div>
  </div>
  <!-- CTA -->
  <div style="padding:16px 16px 0;flex-shrink:0">
    <button onclick="goTab('run')" style="width:100%;height:60px;background:#c8f050;border:none;border-radius:18px;font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:900;letter-spacing:.02em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 6px 24px rgba(200,240,80,.25);-webkit-tap-highlight-color:transparent">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      지금 함께 달리기
    </button>
  </div>
  <!-- 인증샷 피드 -->
  <div style="padding:24px 0 0;flex-shrink:0">
    <div style="padding:0 16px;display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px">
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800">최근 인증샷</span>
      <span style="font-size:10px;color:rgba(255,255,255,.3);cursor:pointer;touch-action:manipulation" onclick="openShotFeed()">전체 보기 →</span>
    </div>
    <div id="insta-feed" style="overflow-x:auto;scrollbar-width:none;padding:0 16px 4px;display:flex;gap:10px"></div>
  </div>
  <!-- 주변 러너 랭킹 -->
  <div style="padding:24px 16px 0;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800">주변 러너 랭킹</span>
      <div style="flex:1;height:1px;background:rgba(255,255,255,.07)"></div>
      <span style="font-size:9px;font-weight:500;letter-spacing:.1em;color:rgba(200,240,80,.55)">2KM 반경</span>
    </div>
    <div style="font-size:11px;color:rgba(255,255,255,.3);margin-bottom:16px">모두 익명 · 오늘 기준</div>
    <div style="display:flex;gap:6px;margin-bottom:14px" id="lb-tabs">
      <button class="lb-tab on" data-lb="dist" onclick="switchLbTab('dist')" style="flex:1;height:36px;border-radius:10px;border:1px solid rgba(200,240,80,.3);background:rgba(200,240,80,.1);font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:900;letter-spacing:.06em;color:#c8f050;cursor:pointer">📍 거리 TOP 10</button>
      <button class="lb-tab" data-lb="pace" onclick="switchLbTab('pace')" style="flex:1;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:900;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">⚡ 페이스 TOP 10</button>
    </div>
    <div id="lb-dist"></div>
    <div id="lb-pace" style="display:none"></div>
  </div>
  <div style="height:32px;flex-shrink:0"></div>
</div>

<!-- RUN -->
<div id="v-run" class="mview" style="background:#0a0a0a;overflow:hidden;display:flex;flex-direction:column">

  <!-- STATE 0: SETUP -->
  <div id="rsetup" class="rstate on" style="flex-direction:column;background:#0a0a0a;position:relative">
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(200,240,80,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(200,240,80,.03) 1px,transparent 1px);background-size:32px 32px;pointer-events:none"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:50%;background:radial-gradient(ellipse at 50% 100%,rgba(200,240,80,.07) 0%,transparent 65%);pointer-events:none"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 18px 0;flex-shrink:0;position:relative">
      <div style="display:flex;align-items:center;gap:7px">
        <div style="width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15)"></div>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.25)">GHOSTRUN</span>
      </div>
      <div id="setup-clock" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;color:rgba(255,255,255,.2);letter-spacing:.06em"></div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 24px;position:relative">
      <div style="font-size:56px;margin-bottom:18px;animation:clapBeat 1.6s ease-in-out infinite;filter:drop-shadow(0 0 22px rgba(200,240,80,.28))">👏</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:900;color:#fff;line-height:1;text-align:center;margin-bottom:6px">오늘의 러닝</div>
      <div style="font-size:11px;font-weight:300;color:rgba(255,255,255,.28);letter-spacing:.08em;margin-bottom:32px">크루와 함께 · 따로 또 같이</div>
      <!-- Goal type -->
      <div style="display:flex;gap:8px;margin-bottom:12px;width:100%">
        <div class="gt on" data-gt="dist" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">📍</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:400;letter-spacing:.05em;color:rgba(255,255,255,.55)">거리</div>
        </div>
        <div class="gt" data-gt="time" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">⏱</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:400;letter-spacing:.05em;color:rgba(255,255,255,.55)">시간</div>
        </div>
        <div class="gt" data-gt="speed" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">⚡</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:400;letter-spacing:.05em;color:rgba(255,255,255,.55)">페이스</div>
        </div>
        <div class="gt" data-gt="free" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">🌙</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:400;letter-spacing:.05em;color:rgba(255,255,255,.55)">자유</div>
        </div>
      </div>
      <!-- Goal values -->
      <div class="gv-grid" id="gvd" style="width:100%">
        <div class="gv" data-v="3"><span class="gv-n">3</span><span class="gv-u">km</span></div>
        <div class="gv on" data-v="5"><span class="gv-n">5</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="10"><span class="gv-n">10</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="15"><span class="gv-n">15</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="21"><span class="gv-n">21</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="42"><span class="gv-n">42</span><span class="gv-u">km</span></div>
      </div>
      <div class="gv-grid" id="gvt" style="display:none;width:100%">
        <div class="gv" data-v="20"><span class="gv-n">20</span><span class="gv-u">분</span></div>
        <div class="gv on" data-v="30"><span class="gv-n">30</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="45"><span class="gv-n">45</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="60"><span class="gv-n">60</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="90"><span class="gv-n">90</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="120"><span class="gv-n">120</span><span class="gv-u">분</span></div>
      </div>
      <div class="gv-grid" id="gvs" style="display:none;width:100%">
        <div class="gv" data-v="430"><span class="gv-n">4'30"</span><span class="gv-u">/km</span></div>
        <div class="gv on" data-v="500"><span class="gv-n">5'00"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="530"><span class="gv-n">5'30"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="600"><span class="gv-n">6'00"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="630"><span class="gv-n">6'30"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="700"><span class="gv-n">7'00"</span><span class="gv-u">/km</span></div>
      </div>
    </div>
    <!-- START RUN -->
    <div style="padding:0 16px 36px;flex-shrink:0">
      <button id="start-btn" onclick="requestHealthAccess()" style="width:100%;height:72px;background:#c8f050;border:none;border-radius:20px;font-family:'Space Grotesk',sans-serif;font-size:26px;font-weight:800;letter-spacing:.02em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:14px;box-shadow:0 8px 32px rgba(200,240,80,.32);-webkit-tap-highlight-color:transparent" onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform=''" ontouchstart="this.style.transform='scale(.97)'" ontouchend="this.style.transform=''">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        START RUN
      </button>
    </div>
  </div>

  <!-- HEALTH PERMISSION MODAL -->
  <div id="health-modal" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(5,5,5,.94);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);flex-direction:column;align-items:center;justify-content:flex-end;padding:0 0 40px">
    <div style="width:100%;max-width:420px;background:#161616;border-radius:26px 26px 22px 22px;overflow:hidden;border:1px solid rgba(255,255,255,.08)">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);margin:0 auto"></div><button onclick="closeModal('m-friends')" style="background:none;border:none;color:rgba(255,255,255,.4);font-size:20px;cursor:pointer;line-height:1">×</button></div>
      <div style="display:flex;align-items:center;justify-content:center;gap:16px;padding:24px 28px 0">
        <div style="width:56px;height:56px;border-radius:16px;background:#ff3b30;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(255,59,48,.3)">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        </div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        <div style="width:56px;height:56px;border-radius:16px;background:rgba(200,240,80,.12);border:1.5px solid rgba(200,240,80,.2);display:flex;align-items:center;justify-content:center"><span style="font-size:28px">🦊</span></div>
      </div>
      <div style="padding:20px 24px 0;text-align:center">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:#fff;margin-bottom:8px;line-height:1.1">"ClapRun"이 건강 데이터에<br>접근하려고 합니다</div>
        <div style="font-size:13px;color:rgba(255,255,255,.45);line-height:1.55;margin-bottom:4px">iPhone 피트니스 활동 데이터를 사용하여 더 정확한 러닝 기록을 제공합니다.</div>
      </div>
      <div style="margin:16px 24px 0;background:rgba(255,255,255,.04);border-radius:14px;overflow:hidden">
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.05)">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">활동 에너지 (칼로리)</div><div style="font-size:11px;color:rgba(255,255,255,.35)">소모 칼로리 측정</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.05)">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">운동 시간</div><div style="font-size:11px;color:rgba(255,255,255,.35)">운동 지속 시간</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><path d="M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0"/><path d="M12 8v4l3 3"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">이동 거리</div><div style="font-size:11px;color:rgba(255,255,255,.35)">GPS 기반 거리</div></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;padding:20px 24px 28px">
        <button onclick="grantHealthAccess()" style="width:100%;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:800;letter-spacing:.07em;color:#0a0a0a;cursor:pointer">허용</button>
        <button onclick="denyHealthAccess()" style="width:100%;height:48px;background:none;border:1.5px solid rgba(255,255,255,.1);border-radius:16px;font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:800;color:rgba(255,255,255,.4);cursor:pointer">허용 안 함</button>
      </div>
    </div>
  </div>

  <!-- STATE 1: ACTIVE RUN -->
  <div id="ractive" class="rstate" style="flex-direction:column;background:#0a0a0a;position:relative;flex:1;min-height:0">
    <div style="position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;align-items:center;gap:7px;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);border-radius:99px;padding:4px 12px 4px 8px;border:1px solid rgba(255,255,255,.08)">
      <div style="width:7px;height:7px;border-radius:50%;background:#c8f050;box-shadow:0 0 8px #c8f050;animation:syncPulse 1.5s infinite"></div>
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.15em;color:rgba(255,255,255,.6)">GHOST SYNC ACTIVE</span>
    </div>
    <div id="nearby-badge" style="position:absolute;top:10px;left:14px;z-index:10;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:4px 10px 4px 8px;display:flex;align-items:center;gap:5px;pointer-events:none">
      <span style="width:6px;height:6px;border-radius:50%;background:#34d399;display:inline-block;box-shadow:0 0 6px #34d399;flex-shrink:0"></span>
      <span id="nearby-count" style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.08em;color:rgba(255,255,255,.8)">주변 5명</span>
    </div>
    <!-- 런 중 크루 배지 (우상단) -->
    <div id="run-crew-badge" style="position:absolute;top:10px;right:14px;z-index:10;display:none;flex-direction:column;align-items:flex-end;gap:4px"></div>

    <!-- MAP + STATS -->
    <div id="ra-map-container" style="flex:1;min-height:200px;position:relative;background:#0a0a0a;display:flex;flex-direction:column">
      <!-- Kakao run map -->
      <div id="run-mapbox-map" style="position:absolute;inset:0;width:100%;height:100%"></div>
      <!-- SVG overlay for run path + dots -->
      <svg id="ra-svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:5" viewBox="0 0 400 320" preserveAspectRatio="none">
        <!-- Simulation mode path (hidden when Kakao active) -->
        <path id="ghost-path" d="M 30 290 C 70 270,100 230,140 200 C 180 170,220 150,270 110 C 310 78,350 52,390 28" fill="none" stroke="rgba(255,255,255,.1)" stroke-width="3" stroke-dasharray="8 6"/>
        <path id="run-path" d="M 30 290 C 70 270,100 230,140 200 C 180 170,220 150,270 110 C 310 78,350 52,390 28" fill="none" stroke="#c8f050" stroke-width="4" stroke-linecap="round"/>
        <!-- GPS mode path -->
        <polyline id="run-path-line" points="" fill="none" stroke="#c8f050" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
        <polyline id="run-path-glow" points="" fill="none" stroke="rgba(200,240,80,.2)" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
        <circle id="runner-glow" cx="200" cy="160" r="18" fill="rgba(200,240,80,.12)"><animate attributeName="r" values="16;22;16" dur="1.6s" repeatCount="indefinite"/></circle>
        <circle id="runner-dot" cx="200" cy="160" r="8" fill="#c8f050"><animate attributeName="r" values="8;10;8" dur="1.6s" repeatCount="indefinite"/></circle>
      </svg>
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;z-index:2;pointer-events:none;padding:16px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.24em;color:rgba(255,255,255,.35);margin-bottom:4px">DISTANCE (KM)</div>
        <div id="ra-dist" style="font-family:'Barlow Condensed',sans-serif;font-size:96px;font-weight:900;line-height:.85;color:#c8f050;text-shadow:0 0 50px rgba(200,240,80,.4);letter-spacing:-.02em">0.00</div>
        <div style="display:flex;align-items:center;gap:32px;margin-top:20px">
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
            <span style="font-size:9px;font-weight:600;letter-spacing:.2em;color:rgba(255,255,255,.3)">PACE</span>
            <span id="ra-pace" style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;color:rgba(255,255,255,.9);line-height:1">--'--"</span>
          </div>
          <div style="width:1px;height:46px;background:rgba(255,255,255,.1)"></div>
          <div style="display:flex;flex-direction:column;align-items:flex-start;gap:4px">
            <span style="font-size:9px;font-weight:600;letter-spacing:.2em;color:rgba(255,255,255,.3)">TIME</span>
            <span id="ra-time" style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;color:rgba(255,255,255,.9);line-height:1">00:00</span>
          </div>
        </div>
      </div>
    </div>
    <!-- RACING BAR -->
    <div style="background:#111;border-top:1px solid rgba(255,255,255,.06);padding:11px 16px 9px;flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.16em;color:rgba(255,255,255,.3)">START</span>
        <span id="ra-gl-txt" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.16em;color:rgba(200,240,80,.5)">5KM GOAL</span>
      </div>
      <div style="position:relative;height:32px">
        <div style="position:absolute;top:50%;left:0;right:0;height:6px;background:rgba(255,255,255,.06);border-radius:3px;transform:translateY(-50%)"></div>
        <div id="track-fill" style="position:absolute;top:50%;left:0;height:6px;background:linear-gradient(90deg,rgba(200,240,80,.25),#c8f050);border-radius:3px;transform:translateY(-50%);transition:width .6s ease;width:0%"></div>
        <div id="track-ghosts" style="position:absolute;inset:0"></div>
      </div>
    </div>
    <!-- BOTTOM ACTIONS: PAUSE + CLAP (50/50) -->
    <div style="background:#0a0a0a;border-top:1px solid rgba(255,255,255,.05);display:flex;align-items:stretch;flex-shrink:0;height:64px">
      <!-- PAUSE — left half -->
      <button id="pause-btn" onclick="handlePauseTap()" style="flex:1;background:#c8f050;border:none;display:flex;flex-direction:row;align-items:center;justify-content:center;gap:8px;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:transform .1s,opacity .1s;box-shadow:0 -3px 16px rgba(200,240,80,.25)" onmousedown="this.style.transform='scale(.98)'" onmouseup="this.style.transform=''" ontouchstart="this.style.transform='scale(.98)'" ontouchend="this.style.transform=''">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="#0a0a0a" stroke="none">
          <rect x="5" y="3" width="4" height="18" rx="1.5"/>
          <rect x="15" y="3" width="4" height="18" rx="1.5"/>
        </svg>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:.18em;color:#0a0a0a;line-height:1">PAUSE</span>
      </button>
      <!-- CLAP — right half -->
      <button id="clap-btn" onclick="doClap()" style="flex:1;background:rgba(200,240,80,.07);border:none;border-left:1px solid rgba(200,240,80,.15);display:flex;flex-direction:row;align-items:center;justify-content:center;gap:10px;cursor:pointer;-webkit-tap-highlight-color:transparent">
        <span id="clap-em" style="font-size:36px;display:block;transition:transform .2s">👏</span>
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:0px">
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.14em;color:rgba(200,240,80,.6)">CLAP</span>
          <span id="clap-count" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:#c8f050;line-height:1">0</span>
        </div>
      </button>
    </div>

        <span id="ra-cal" style="display:none">0</span>
  </div>

  <!-- STATE 1.5: PAUSED -->
  <div id="rpaused" class="rstate" style="flex-direction:column;background:#0a0a0a;position:relative;align-items:center;justify-content:center">
    <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);pointer-events:none"></div>
    <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;padding:0 28px;width:100%">
      <div style="width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;margin-bottom:20px">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.5)" stroke-width="2.5" stroke-linecap="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      </div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;color:#fff;margin-bottom:6px">일시 중지됨</div>
      <div style="display:flex;gap:28px;margin-bottom:40px">
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:#c8f050" id="ps-dist">0.00</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">KM</div></div>
        <div style="width:1px;background:rgba(255,255,255,.08)"></div>
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:rgba(255,255,255,.7)" id="ps-time">00:00</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">TIME</div></div>
        <div style="width:1px;background:rgba(255,255,255,.08)"></div>
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:rgba(255,255,255,.7)" id="ps-pace">--'--"</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">PACE</div></div>
      </div>
      <button onclick="resumeRun()" style="width:100%;height:64px;background:#c8f050;border:none;border-radius:18px;font-family:'Space Grotesk',sans-serif;font-size:22px;font-weight:800;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:12px;-webkit-tap-highlight-color:transparent;box-shadow:0 6px 24px rgba(200,240,80,.28);position:relative;z-index:2;pointer-events:auto">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        RE-START RUN
      </button>
      <button onclick="stopRun()" style="width:100%;height:56px;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.1);border-radius:18px;font-family:'Space Grotesk',sans-serif;font-size:20px;font-weight:900;color:rgba(255,255,255,.55);cursor:pointer;-webkit-tap-highlight-color:transparent;position:relative;z-index:2;pointer-events:auto">FINISH RUN</button>
    </div>
  </div>

  <!-- STATE 2: FINISH -->
  <div id="rfinish" class="rstate" style="flex-direction:column;background:#0a0a0a">
    <div style="padding:100px 32px 100px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;border-bottom:1px solid rgba(200,240,80,.08)">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-size:35px">🏅</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:50px;font-weight:900;color:#c8f050;line-height:1">완주!</div>
      </div>
      <div id="rf-msg" style="font-size:13px;font-weight:300;color:rgba(255,255,255,.4);letter-spacing:.05em;text-align:center">오늘도 잘 달렸어요</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0">
      <div style="padding:20px 14px;display:flex;flex-direction:column;gap:2px;border-right:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)">
        <span style="font-size:10px;font-weight:400;letter-spacing:.16em;color:rgba(255,255,255,.45)">DISTANCE</span>
        <span id="rf-d" style="font-family:'Barlow Condensed',sans-serif;font-size:46px;font-weight:900;color:#c8f050;line-height:1">0.00</span>
        <span style="font-size:12px;font-weight:300;color:rgba(255,255,255,.3)">km</span>
      </div>
      <div style="padding:20px 14px;display:flex;flex-direction:column;gap:2px;border-bottom:1px solid rgba(255,255,255,.06)">
        <span style="font-size:10px;font-weight:400;letter-spacing:.16em;color:rgba(255,255,255,.45)">TIME</span>
        <span id="rf-t" style="font-family:'Barlow Condensed',sans-serif;font-size:46px;font-weight:900;color:rgba(255,255,255,.85);line-height:1">00:00</span>
        <span style="font-size:12px;font-weight:300;color:rgba(255,255,255,.3)">min</span>
      </div>
      <div style="padding:20px 14px;display:flex;flex-direction:column;gap:2px;border-right:1px solid rgba(255,255,255,.06)">
        <span style="font-size:10px;font-weight:400;letter-spacing:.16em;color:rgba(255,255,255,.45)">AVG PACE</span>
        <span id="rf-p" style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;color:rgba(255,255,255,.82);line-height:1">--'--"</span>
        <span style="font-size:12px;font-weight:300;color:rgba(255,255,255,.28)">/km</span>
      </div>
      <div style="padding:20px 14px;display:flex;flex-direction:column;gap:2px">
        <span style="font-size:10px;font-weight:400;letter-spacing:.16em;color:rgba(255,255,255,.45)">CALORIES</span>
        <span id="rf-c" style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;color:rgba(255,255,255,.82);line-height:1">0</span>
        <span style="font-size:12px;font-weight:300;color:rgba(255,255,255,.28)">kcal</span>
      </div>
    </div>
    <!-- 받은 clap 표시 -->
    <div id="rf-clap-row" style="display:none;align-items:center;justify-content:center;gap:4px;padding:14px 16px 0;border-top:1px solid rgba(200,240,80,.08)"></div>
    <div style="display:flex;gap:10px;padding:12px 16px 28px;flex-shrink:0">
      <button onclick="goTab('shot')" style="flex:1;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:800;letter-spacing:.07em;color:#080808;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;-webkit-tap-highlight-color:transparent">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        인증샷
      </button>
      <button onclick="resetRun()" style="height:56px;padding:0 24px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:16px;font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:900;color:rgba(255,255,255,.45);cursor:pointer;-webkit-tap-highlight-color:transparent">완료</button>
    </div>
  </div>

</div>

<div id="v-crew" class="mview" style="background:#0a0a0a;overflow-y:auto;scrollbar-width:none">

  <!-- Sticky header -->
    <!-- Sticky header -->
  <div style="position:sticky;top:0;z-index:20;background:rgba(10,10,10,.96);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,.07);padding:16px 16px 12px;flex-shrink:0">
    <div style="margin-bottom:12px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;letter-spacing:.02em;line-height:1">러닝 크루</div>
      <div style="font-size:10px;font-weight:300;color:rgba(255,255,255,.3);letter-spacing:.04em;margin-top:1px">사회적 피로감 없는 건강한 연결</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button onclick="openFriendsModal()" style="flex:1;height:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:900;letter-spacing:.06em;color:rgba(255,255,255,.6);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;-webkit-tap-highlight-color:transparent">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>
          친구 추가
        </button>
        <button onclick="openCreateRoom()" style="flex:1;height:40px;background:#c8f050;border:none;border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:800;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;-webkit-tap-highlight-color:transparent">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="#0a0a0a"><path d="M12 5v14M5 12h14"/></svg>
          크루 만들기
        </button>
    </div>
    <div style="display:flex;gap:6px" id="room-tabs">
      <button class="rtab on" data-rt="browse" onclick="switchRoomTab('browse')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(200,240,80,.3);background:rgba(200,240,80,.1);font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.06em;color:#c8f050;cursor:pointer">공개 크루</button>
      <button class="rtab" data-rt="mine" onclick="switchRoomTab('mine')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">내 크루</button>
      <button class="rtab" data-rt="friends" onclick="switchRoomTab('friends')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">친구</button>
      <button class="rtab" data-rt="history" onclick="switchRoomTab('history')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">기록</button>
    </div>
  </div>

  <!-- ── 공개 크루 목록 ── -->
  <div id="room-pane-browse" class="rpane" style="padding:12px 16px 24px">
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <input id="join-code-input" type="text" placeholder="크루 코드 입력 (CR-XXXX)" maxlength="9"
        style="flex:1;height:42px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:0 12px;font-size:13px;color:#fff;outline:none;letter-spacing:.05em"
        oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')joinByCode()">
      <button onclick="joinByCode()" style="height:42px;padding:0 16px;background:#c8f050;border:none;border-radius:10px;font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:900;color:#0a0a0a;cursor:pointer">입장</button>
    </div>
    <div id="room-list-container"></div>
  </div>

  <!-- ── 내 크루 ── -->
  <div id="room-pane-mine" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="my-room-container"></div>
  </div>

  <!-- ── 친구 ── -->
  <div id="room-pane-friends" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="friends-container"></div>
  </div>

  <!-- ── 참여 기록 ── -->
  <div id="room-pane-history" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="room-history-container"></div>
  </div>


</div>

<!-- ── 방 만들기 모달 ── -->
<div id="m-create-room" class="modal" style="position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);align-items:flex-end;justify-content:center">
  <div style="width:100%;max-width:480px;background:#161616;border-radius:26px 26px 0 0;border:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;max-height:90vh">
    <div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>
    <div style="padding:20px 22px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;margin-bottom:4px">크루 만들기</div>
      <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:20px">방을 만들고 함께 뛸 러너를 초대하세요</div>

      <!-- 방 이름 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">크루 이름</div>
        <input id="cr-name" type="text" placeholder="예: 새벽 달리기 크루" maxlength="20"
          style="width:100%;height:46px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:300;color:#fff;outline:none;box-sizing:border-box;-webkit-tap-highlight-color:transparent"
          oninput="updateRoomCode(this.value)">
      </div>

      <!-- 목표 거리 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">목표 거리</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="cr-goal-row">
          <div class="cr-opt on" data-crv="5" onclick="setCrOpt('goal','5',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#c8f050;line-height:1">5</span>
            <span style="font-size:8px;color:rgba(200,240,80,.6)">km</span>
          </div>
          <div class="cr-opt" data-crv="10" onclick="setCrOpt('goal','10',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">10</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="21" onclick="setCrOpt('goal','21',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">21</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="42" onclick="setCrOpt('goal','42',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">42</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="custom" onclick="setCrOpt('goal','custom',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">?</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">직접</span>
          </div>
        </div>
        <input id="cr-custom-km" type="number" placeholder="직접 입력 (km)" min="1" max="999"
          style="display:none;width:100%;height:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-top:8px">
      </div>

      <!-- 기간 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">기간</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="cr-period-row">
          <div class="cr-opt cr-period-opt on" data-crv="7" onclick="setCrOpt('period','7',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#c8f050;line-height:1">7</span>
            <span style="font-size:8px;color:rgba(200,240,80,.6)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="14" onclick="setCrOpt('period','14',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">14</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="30" onclick="setCrOpt('period','30',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">30</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="0" onclick="setCrOpt('period','0',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">∞</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">무제한</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="custom" onclick="setCrOpt('period','custom',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">?</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">직접</span>
          </div>
        </div>
        <input id="cr-custom-period" type="number" placeholder="직접 입력 (일)" min="1" max="365"
          style="display:none;width:100%;height:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-top:8px">
      </div>

      <!-- 최대 인원 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">최대 인원</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="cr-max-row" style="grid-template-columns:repeat(5,1fr)">
          <div class="cr-opt cr-max-opt on" data-crv="4" onclick="setCrOpt('max','4',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:#c8f050">4</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="8" onclick="setCrOpt('max','8',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">8</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="16" onclick="setCrOpt('max','16',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">16</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="99" onclick="setCrOpt('max','99',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">∞</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">무제한</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="custom" onclick="setCrOpt('max','custom',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">?</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">직접</span>
          </div>
        </div>
        <input id="cr-custom-max" type="number" placeholder="직접 입력 (명)" min="2" max="999"
          style="display:none;width:100%;height:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-top:8px">
      </div>

      <!-- 비밀번호 토글 -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;border:1px solid rgba(255,255,255,.07)">
        <div>
          <div style="font-size:13px;font-weight:400;color:rgba(255,255,255,.8)">🔒 비밀번호 설정</div>
          <div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:1px">비공개 크루으로 만들기</div>
        </div>
        <div id="pw-toggle" onclick="toggleRoomPw()" style="width:44px;height:26px;border-radius:13px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.12);cursor:pointer;position:relative;transition:background .2s">
          <div id="pw-thumb" style="width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.4);position:absolute;top:2px;left:2px;transition:left .2s,background .2s"></div>
        </div>
      </div>
      <input id="cr-pw" type="password" placeholder="비밀번호 입력 (4~12자)" maxlength="12"
        style="display:none;width:100%;height:44px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-bottom:8px">

      <!-- 크루 코드 미리보기 -->
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.12);border-radius:10px;margin-bottom:20px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(200,240,80,.6)" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span style="font-size:10px;color:rgba(255,255,255,.4)">크루 코드</span>
        <span id="cr-code-preview" style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:rgba(200,240,80,.7);letter-spacing:.1em">CR-????</span>
        <span style="font-size:10px;color:rgba(255,255,255,.25)">(자동생성)</span>
      </div>

      <button onclick="createRoom()" style="width:100%;height:52px;background:#c8f050;border:none;border-radius:14px;font-family:'Space Grotesk',sans-serif;font-size:19px;font-weight:800;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;-webkit-tap-highlight-color:transparent">만들기</button>
      <button onclick="closeModal('m-create-room')" style="width:100%;height:38px;background:none;border:none;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:800;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px">취소</button>
    </div>
  </div>
</div>

<!-- ── 비밀번호 입장 모달 ── -->
<div id="m-room-pw" class="modal" style="position:fixed;inset:0;z-index:210;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);align-items:center;justify-content:center;padding:24px">
  <div style="width:100%;max-width:340px;background:#1a1a1a;border-radius:20px;border:1px solid rgba(255,255,255,.1);padding:28px 24px 24px;text-align:center">
    <div style="font-size:36px;margin-bottom:12px">🔒</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;margin-bottom:4px" id="pw-modal-name">비공개 크루</div>
    <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:20px">비밀번호를 입력하세요</div>
    <input id="pw-input" type="password" placeholder="비밀번호" maxlength="12"
      style="width:100%;height:48px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:0 16px;font-family:'Space Grotesk',sans-serif;font-size:16px;color:#fff;outline:none;box-sizing:border-box;text-align:center;letter-spacing:.2em;margin-bottom:8px">
    <div id="pw-modal-err" style="font-size:11px;color:rgba(255,80,80,.8);min-height:16px;margin-bottom:12px"></div>
    <button onclick="submitRoomPw()" style="width:100%;height:48px;background:#c8f050;border:none;border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:800;color:#0a0a0a;cursor:pointer">입장</button>
    <button onclick="closeModal('m-room-pw')" style="width:100%;height:36px;background:none;border:none;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:800;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px">취소</button>
  </div>
</div>

<!-- SHOT -->
<div id="v-shot" class="mview">
  <div id="card">
    <img id="bg-img" src="" alt="">
    <div id="empty-state"><div class="e-grain"></div><div class="e-icon">🌙</div><div class="e-hint">사진을 불러오세요</div></div>
    <div id="ovs">

      <!-- Ghost overlay -->
      <div class="ov" id="ov-g">
        <div class="ft"></div><div class="fb"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-g">🦊</span><span class="r-nm" id="nm-g">Runner</span></div>
          <div class="ov-dt" id="dt-g"></div>
        </div>
        <div class="g-bot">
          <div class="g-dist">5.20<span class="g-du">km</span></div>
          <div class="g-stats">
            <div class="g-s"><span class="g-sl">Pace</span><span class="g-sv">5'12"</span></div>
            <div class="g-s"><span class="g-sl">Time</span><span class="g-sv">26'58"</span></div>
            <div class="g-s"><span class="g-sl">Cal</span><span class="g-sv">312</span></div>
          </div>
          <div class="g-foot"><span class="g-brand">ClapRun · 따로 또 같이</span></div>
        </div>
      </div>

      <!-- Path overlay -->
      <div class="ov off" id="ov-p">
        <div class="ft"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:190px;background:linear-gradient(0deg,rgba(0,0,0,.9),rgba(0,0,0,.4) 55%,transparent)"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-p">🦊</span><span class="r-nm" id="nm-p">Runner</span></div>
          <span class="p-logo"><span style="font-style:italic;font-weight:900;letter-spacing:-.02em"><span style="color:#c8f050">Clap</span>Run</span></span>
        </div>
        <div class="p-mapbg"><canvas id="mmp" width="220" height="220"></canvas></div>
        <div class="p-bot">
          <div class="p-stat"><span class="p-l">Distance</span><span class="p-v">5.20<span class="p-u"> km</span></span></div>
          <div class="p-stat" style="text-align:right"><span class="p-l" style="text-align:right">Avg Pace</span><span class="p-v">5'12"<span class="p-u">/km</span></span></div>
        </div>
      </div>

      <!-- Stamp overlay -->
      <div class="ov off" id="ov-s">

        <!-- 배경 그라디언트 -->
        <div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.55) 0%,transparent 35%,transparent 50%,rgba(0,0,0,.92) 100%)"></div>

        <!-- 상단: 러너 + 로고 -->
        <div class="ov-hd">
          <div class="runner" onclick="openAv()">
            <span class="r-em" id="em-s">👏</span>
            <span class="r-nm" id="nm-s">Runner</span>
          </div>
          <span class="st-logo">
            <span style="font-style:italic;font-weight:900;letter-spacing:-.02em">
              <span style="color:#c8f050">Clap</span>Run
            </span>
          </span>
        </div>

        <!-- 중앙 COMPLETED 스탬프 -->
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-54%) rotate(-12deg);pointer-events:none;z-index:10">
          <div style="position:relative;border:3px solid rgba(200,240,80,.65);border-radius:14px;padding:14px 28px 12px;text-align:center;background:rgba(0,0,0,.18);backdrop-filter:blur(3px);box-shadow:0 0 40px rgba(200,240,80,.12),inset 0 0 30px rgba(200,240,80,.04)">
            <!-- 스탬프 코너 장식 -->
            <div style="position:absolute;top:5px;left:5px;width:10px;height:10px;border-top:1.5px solid rgba(200,240,80,.4);border-left:1.5px solid rgba(200,240,80,.4);border-radius:2px 0 0 0"></div>
            <div style="position:absolute;top:5px;right:5px;width:10px;height:10px;border-top:1.5px solid rgba(200,240,80,.4);border-right:1.5px solid rgba(200,240,80,.4);border-radius:0 2px 0 0"></div>
            <div style="position:absolute;bottom:5px;left:5px;width:10px;height:10px;border-bottom:1.5px solid rgba(200,240,80,.4);border-left:1.5px solid rgba(200,240,80,.4);border-radius:0 0 0 2px"></div>
            <div style="position:absolute;bottom:5px;right:5px;width:10px;height:10px;border-bottom:1.5px solid rgba(200,240,80,.4);border-right:1.5px solid rgba(200,240,80,.4);border-radius:0 0 2px 0"></div>
            <!-- 상단 라벨 -->
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:600;letter-spacing:.28em;color:rgba(200,240,80,.45);margin-bottom:6px">CERTIFIED</div>
            <!-- 메인 텍스트 -->
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:900;letter-spacing:.04em;color:rgba(200,240,80,.88);line-height:.85;text-shadow:0 0 24px rgba(200,240,80,.25)">COMPLETED</div>
            <!-- 날짜 -->
            <div id="bd" style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:500;letter-spacing:.22em;color:rgba(200,240,80,.45);margin-top:8px"></div>
            <!-- 박수 아이콘 -->
            <div style="font-size:26px;margin-top:6px;filter:drop-shadow(0 0 8px rgba(200,240,80,.4))">👏</div>
          </div>
        </div>

        <!-- 하단 스탯 -->
        <div class="st-bot">
          <!-- GOAL vs ACHIEVED -->
          <div style="margin-bottom:12px">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:600;letter-spacing:.2em;color:rgba(200,240,80,.55);margin-bottom:6px">GOAL vs ACHIEVED</div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;flex-direction:column;gap:2px">
                <span style="font-size:8px;font-weight:300;color:rgba(255,255,255,.3);letter-spacing:.08em">목표</span>
                <span id="st-goal-val" style="font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:800;color:rgba(255,255,255,.35);line-height:1">5.0<span style="font-size:14px;font-weight:400"> km</span></span>
              </div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;color:rgba(200,240,80,.35);font-weight:700">→</div>
              <div style="display:flex;flex-direction:column;gap:2px">
                <span style="font-size:8px;font-weight:300;color:rgba(200,240,80,.55);letter-spacing:.08em">달성</span>
                <span id="st-ach-val" style="font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:800;color:#c8f050;line-height:1">5.20<span style="font-size:14px;font-weight:400"> km</span></span>
              </div>
            </div>
          </div>
          <!-- 세부 스탯 -->
          <div class="st-sub">
            <div class="ss"><span class="ss-l">Pace</span><span class="ss-v" id="st-pace">5'12"</span></div>
            <div class="ss"><span class="ss-l">Time</span><span class="ss-v" id="st-time">26'58"</span></div>
            <div class="ss"><span class="ss-l">Cal</span><span class="ss-v" id="st-cal">312</span></div>
          </div>
        </div>

      </div>
    </div>
  </div>
  <div id="tbar">
    <button class="th on" data-t="g">👏 Clap</button>
    <button class="th" data-t="p">🗺 Path</button>
    <button class="th" data-t="s">🎖 Stamp</button>
  </div>
  <div id="shot-acts">
    <label class="ai"><input type="file" id="ic" accept="image/*" capture="environment"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></label>
    <label class="ai"><input type="file" id="ig" accept="image/*"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></label>
    <button class="asave" id="bsave"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>저장하기</button>
    <button class="asave" id="bupload" onclick="uploadToFeed()" style="background:rgba(200,240,80,.15);border:1.5px solid rgba(200,240,80,.35);color:#c8f050;touch-action:manipulation"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 10 12 5 7 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>피드 올리기</button>

  </div>
</div>


<!-- COURSE MAP -->
<div id="v-coursemap" class="mview" style="display:flex;overflow:hidden;flex-direction:column;background:#0d0d0d">

  <!-- Header -->
  <div style="position:absolute;top:0;left:0;right:0;z-index:20;padding:14px 16px 10px;background:linear-gradient(180deg,rgba(10,10,10,.98) 60%,transparent);pointer-events:none">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:#fff;line-height:1;letter-spacing:.02em">러닝 코스</div>
        <div id="cm-location" style="font-size:10px;font-weight:300;color:rgba(255,255,255,.4);letter-spacing:.06em;margin-top:2px">📍 위치 확인 중...</div>
      </div>
      <div style="display:flex;gap:6px;pointer-events:all">
        <button id="cm-draw-btn" onclick="toggleCourseDrawing()" style="height:34px;padding:0 14px;background:rgba(200,240,80,.12);border:1.5px solid rgba(200,240,80,.3);border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:900;letter-spacing:.06em;color:#c8f050;cursor:pointer">✏️ 코스 그리기</button>
      </div>
    </div>
  </div>

  <!-- Map Canvas (SVG simulated dark map) -->
  <div id="course-map-wrap" style="position:absolute;inset:0;overflow:hidden">
    <!-- Kakao course map -->
    <div id="course-mapbox-map" style="position:absolute;inset:0;width:100%;height:100%;z-index:1"></div>
    <!-- SVG draw overlay -->
    <svg id="cm-svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:5">
      <!-- User drawn path -->
      <polyline id="cm-draw-path" points="" fill="none" stroke="#c8f050" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
      <!-- GPS run path on course map -->
      <polyline id="cm-run-path" points="" fill="none" stroke="rgba(200,240,80,.7)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      <circle id="cm-draw-cursor" cx="-50" cy="-50" r="8" fill="rgba(200,240,80,.3)" stroke="#c8f050" stroke-width="1.5" style="display:none"/>
      <!-- User location dot (shown when not drawing) -->
      <circle id="cm-user-dot" cx="-50" cy="-50" r="10" fill="rgba(200,240,80,.25)"><animate attributeName="r" values="8;14;8" dur="2s" repeatCount="indefinite"/></circle>
      <circle id="cm-user-center" cx="-50" cy="-50" r="5" fill="#c8f050"/>
    </svg>
  </div>

  <!-- Course Cards (bottom sheet) -->
  <div id="cm-bottom-sheet" style="position:absolute;bottom:0;left:0;right:0;z-index:20;background:linear-gradient(0deg,rgba(10,10,10,.98) 0%,rgba(10,10,10,.92) 80%,transparent);padding:0 0 8px">
    <!-- Mode tabs -->
    <div style="display:flex;gap:8px;padding:12px 16px 8px">
      <button class="cm-tab on" data-cm="nearby" onclick="switchCmTab('nearby')" style="flex:1;height:32px;background:rgba(200,240,80,.12);border:1px solid rgba(200,240,80,.3);border-radius:8px;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.08em;color:#c8f050;cursor:pointer">추천 코스</button>
      <button class="cm-tab" data-cm="mine" onclick="switchCmTab('mine')" style="flex:1;height:32px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:8px;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:900;letter-spacing:.08em;color:rgba(255,255,255,.45);cursor:pointer">내 코스</button>
    </div>

    <!-- Nearby recommended courses -->
    <div id="cm-pane-nearby" style="overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch">
      <div id="cm-nearby-cards" style="display:flex;gap:10px;padding:0 16px 16px;width:max-content">
        <div style="color:rgba(255,255,255,.3);font-size:12px;padding:20px">위치 확인 중...</div>
      </div>
    </div>

    <!-- My courses pane -->
    <div id="cm-pane-mine" style="display:none;padding:0 16px 16px">
      <div id="cm-my-courses-list"></div>
      <button onclick="toggleCourseDrawing()" style="width:100%;height:48px;background:rgba(200,240,80,.08);border:1.5px dashed rgba(200,240,80,.25);border-radius:14px;font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:900;letter-spacing:.06em;color:rgba(200,240,80,.6);cursor:pointer;margin-top:4px">+ 새 코스 그리기</button>
    </div>
  </div>

  <!-- Drawing mode overlay (fullscreen) -->
  <div id="cm-draw-overlay" style="display:none;position:absolute;inset:0;z-index:40;pointer-events:none">

    <!-- 상단 HUD: 거리 + 포인트 -->
    <div style="position:absolute;top:0;left:0;right:0;pointer-events:none;padding:14px 16px 0;z-index:41">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <!-- 왼쪽: 모드 전환 버튼 -->
        <div style="display:flex;gap:8px;align-items:center;pointer-events:auto">
          <button id="cm-mode-move" onclick="setCmMode('move')"
            style="height:38px;padding:0 14px;background:rgba(10,10,10,.85);backdrop-filter:blur(12px);border:1.5px solid rgba(255,255,255,.2);border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:900;letter-spacing:.08em;color:rgba(255,255,255,.5);cursor:pointer;transition:all .2s">
            🗺 이동
          </button>
          <button id="cm-mode-draw" onclick="setCmMode('draw')"
            style="height:38px;padding:0 14px;background:rgba(200,240,80,.15);backdrop-filter:blur(12px);border:1.5px solid rgba(200,240,80,.5);border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:800;letter-spacing:.08em;color:#c8f050;cursor:pointer;transition:all .2s">
            ✏️ 그리기
          </button>
          <div id="cm-draw-dist" style="font-size:10px;font-weight:300;color:rgba(255,255,255,.45);background:rgba(10,10,10,.7);padding:4px 10px;border-radius:8px;backdrop-filter:blur(8px)">0.0 km</div>
        </div>
        <!-- 오른쪽: 취소 버튼 -->
        <button onclick="cancelCourseDrawing()" style="width:36px;height:36px;background:rgba(10,10,10,.8);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.15);border-radius:50%;font-size:16px;color:rgba(255,255,255,.6);cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto;touch-action:manipulation">✕</button>
      </div>
    </div>

    <!-- 하단 액션 바 -->
    <div style="position:absolute;bottom:0;left:0;right:0;z-index:41;padding:0 16px 32px;background:linear-gradient(0deg,rgba(10,10,10,.92) 60%,transparent);pointer-events:none">
      <!-- 브러시 크기 힌트 -->
      <div style="text-align:center;margin-bottom:12px">
        <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(10,10,10,.6);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:6px 14px">
          <div style="width:8px;height:8px;border-radius:50%;background:#c8f050;box-shadow:0 0 8px rgba(200,240,80,.6)"></div>
          <span style="font-size:11px;color:rgba(255,255,255,.45)">탭 또는 드래그로 경로 그리기</span>
        </div>
      </div>
      <!-- 버튼들 -->
      <div style="display:flex;gap:10px;pointer-events:auto">
        <button onclick="undoDrawPoint()" style="flex:1;height:52px;background:rgba(255,255,255,.06);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12);border-radius:14px;font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:900;letter-spacing:.04em;color:rgba(255,255,255,.6);cursor:pointer;touch-action:manipulation">↩ 되돌리기</button>
        <button onclick="clearDrawPoints()" style="width:52px;height:52px;background:rgba(255,70,70,.08);backdrop-filter:blur(12px);border:1px solid rgba(255,70,70,.2);border-radius:14px;font-size:18px;cursor:pointer;touch-action:manipulation;flex-shrink:0" title="전체 지우기">🗑</button>
        <button onclick="saveDrawnCourse()" style="flex:2;height:52px;background:#c8f050;border:none;border-radius:14px;font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:800;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;touch-action:manipulation;box-shadow:0 4px 20px rgba(200,240,80,.4)">저장하기</button>
      </div>
    </div>
  </div>


</div>

<!-- RECORDS -->

<!-- RECORDS -->
<div id="v-records" class="mview">
  <div class="rec-hero">
    <div class="rec-hero-lbl">총 누적 거리</div>
    <div class="rec-big"><span class="rec-big-n">312</span><span class="rec-big-u">.4 km</span></div>
    <div class="rec-hero-sub">62회 완주 · 러닝 47시간 28분</div>
    <div class="rec-3">
      <div class="rec-3s"><span class="rec-3sl">총 시간</span><span class="rec-3sv">47<span style="font-family:var(--fb);font-size:16px;color:var(--dim)">h</span></span><span class="rec-3su">28분</span></div>
      <div class="rec-3s"><span class="rec-3sl">평균 페이스</span><span class="rec-3sv">5'18"</span><span class="rec-3su">/km</span></div>
      <div class="rec-3s"><span class="rec-3sl">참여 크루</span><span class="rec-3sv">5</span><span class="rec-3su">개</span></div>
    </div>
  </div>
  <div class="rec-cal"><div class="rec-cal-lbl">이번 달 활동</div><div class="cal-grid" id="cal-grid"></div></div>
  <div class="rec-target">
    <div class="rt-top"><div><div class="rt-lbl">이번 달 목표</div><div class="rt-val">37.8 <span style="font-size:14px;font-weight:200;color:var(--dim)">/ 100 km</span></div></div><span class="rt-pct">38%</span></div>
    <div class="rt-bar"><div class="rt-fill" id="rt-fill" style="width:0%"></div></div>
  </div>
  <div class="rec-crews">
    <div class="rec-crews-title">참여한 크루</div>
    <div id="rec-past-crews"></div>
  </div>
  <div class="rec-log">
    <div class="rec-log-hd"><span class="rec-log-title">최근 런</span><span class="rec-log-cnt">6회</span></div>
    <div id="run-log"></div>
  </div>
</div>

</div><!-- /main -->

<!-- BOTTOM TABS -->
<div id="btabs">
  <button class="btab on" data-v="home">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>홈<div class="btab-dot"></div>
  </button>
  <button class="btab" data-v="crew">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>크루<div class="btab-dot"></div>
  </button>
  <button class="btab btab-start" data-v="run">
    <div class="btab-run-wrap"><svg viewBox="0 0 24 24" style="width:18px;height:18px"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor" stroke="none"/></svg></div>러닝
  </button>
  <button class="btab" data-v="shot">
    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>인증샷<div class="btab-dot"></div>
  </button>
  <button class="btab" data-v="coursemap">
    <svg viewBox="0 0 24 24"><path d="M3 7l6-3 6 3 6-3v13l-6 3-6-3-6 3V7z"/><path d="M9 4v13M15 7v13"/></svg>코스<div class="btab-dot"></div>
  </button>

</div>

<!-- MODALS -->
<div id="m-join" class="modal"><div class="m-box">
  <div class="m-title">크루 참여하기</div><div class="m-sub">초대 코드를 입력하면 크루원의 기록을 함께 볼 수 있어요</div>
  <input class="join-inp" id="jin" type="text" placeholder="초대 코드 (예: CR-2847)" maxlength="10" oninput="onJoinInput(this.value)">
  <div class="join-prev" id="jprev"><span style="font-size:26px" id="jp-em">🦊</span><div style="flex:1"><div style="font-size:14px;font-weight:300;margin-bottom:3px" id="jp-name"></div><div style="font-size:10px;color:var(--dim)" id="jp-meta"></div></div><span style="font-family:var(--fd);font-style:italic;font-size:22px;color:var(--acc)" id="jp-pct"></span></div>
  <button class="m-ok" id="jok" style="display:none" onclick="confirmJoin()">이 크루 참여하기 🤝</button>
  <button class="m-cancel" onclick="closeModal('m-join')">취소</button>
</div></div>

<div id="m-create" class="modal"><div class="m-box">
  <div class="m-title">새 크루 만들기</div><div class="m-sub">크루를 만들고 친구들을 초대해보세요</div>
  <div class="mf"><div class="ml">크루 이름</div><input class="mi" id="cn-inp" type="text" placeholder="예: 새벽 유령 크루" maxlength="16"></div>
  <div class="mf"><div class="ml">크루 이모지</div>
    <div class="em-row" id="em-row">
      <div class="em-opt on" data-em="🦊">🦊</div><div class="em-opt" data-em="🐆">🐆</div><div class="em-opt" data-em="🦅">🦅</div><div class="em-opt" data-em="🌊">🌊</div><div class="em-opt" data-em="🔥">🔥</div><div class="em-opt" data-em="⚡">⚡</div><div class="em-opt" data-em="🌙">🌙</div><div class="em-opt" data-em="🚀">🚀</div>
    </div>
  </div>
  <div class="mf"><div class="ml">이번 달 목표</div>
    <div class="g-row" id="g-row">
      <div class="g-opt" data-km="50"><span>50</span><span>km</span></div>
      <div class="g-opt on" data-km="100"><span>100</span><span>km</span></div>
      <div class="g-opt" data-km="150"><span>150</span><span>km</span></div>
      <div class="g-opt" data-km="200"><span>200</span><span>km</span></div>
    </div>
  </div>
  <div class="mf"><div class="ml">활동 지역</div><input class="mi" id="ca-inp" type="text" placeholder="예: 마포구" maxlength="12" value="마포구"></div>
  <button class="m-ok" onclick="confirmCreate()">크루 만들기 ✨</button>
  <button class="m-cancel" onclick="closeModal('m-create')">취소</button>
</div></div>

<div id="m-expert" class="modal"><div class="m-box">
  <div class="m-title">Expert 크루</div><div class="m-sub">일정 기간 달성 시 전용 크루를 개설할 수 있어요</div>
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--sf);border:1px solid var(--ln);border-radius:14px;margin-bottom:8px;cursor:pointer">
    <span style="font-size:24px">👏</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:300">Ghost Master 크루</div><div style="font-size:10px;color:var(--dim);margin-top:2px">조건: 3개월 연속 100km 달성 ✓</div></div>
    <span style="font-size:10px;color:rgba(200,240,80,.8)">개설 가능</span>
  </div>
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--sf);border:1px solid var(--ln);border-radius:14px;margin-bottom:8px;opacity:.5">
    <span style="font-size:24px">💪</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:300">Skull Elite 크루</div><div style="font-size:10px;color:var(--dim);margin-top:2px">조건: 6개월 연속 150km (4/6 진행중)</div></div>
    <span style="font-size:11px;color:rgba(255,255,255,.25)">🔒</span>
  </div>
  <button class="m-cancel" onclick="closeModal('m-expert')">닫기</button>
</div></div>

<div id="m-member" class="modal"><div class="m-box" id="mm-box"></div></div>
<div id="avs"><div class="av-box"><div class="av-ttl">캐릭터 선택</div><div class="av-grid" id="avgrid"></div></div></div>
<canvas id="ec" style="display:none"></canvas>
<div id="flash"></div>
<!-- SHOT FEED MODAL -->
<div id="m-shot-feed" class="modal" style="display:none">
  <div class="m-box" style="padding:0;overflow:hidden;display:flex;flex-direction:column;max-height:90vh">
    <!-- 헤더 -->
    <div style="padding:18px 20px 14px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:#fff">주변 인증샷</div>
        <div id="feed-count" style="font-size:10px;color:rgba(255,255,255,.35);margin-top:2px">근처 러너들의 러닝 기록</div>
      </div>
      <button onclick="closeModal('m-shot-feed')" style="width:30px;height:30px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:50%;color:rgba(255,255,255,.5);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
    </div>
    <!-- 피드 그리드 -->
    <div id="shot-feed-grid" style="overflow-y:auto;padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:10px;flex:1"></div>
  </div>
</div>

<div id="toast"></div>

<div id="m-friends" class="modal" style="position:fixed;inset:0;z-index:210;background:rgba(0,0,0,.88);backdrop-filter:blur(16px);align-items:flex-end;justify-content:center">
  <div style="width:100%;max-width:480px;background:#161616;border-radius:26px 26px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 40px;max-height:85vh;overflow-y:auto">
    <div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>
    <div style="padding:18px 22px 0">
      <div style="font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:900;margin-bottom:4px">친구 추가</div>
      <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:16px">닉네임 또는 GR 코드로 친구를 찾아보세요</div>
      <div style="display:flex;gap:8px;margin-bottom:18px">
        <input id="friend-search-input" type="text" placeholder="닉네임 또는 AF-XXXXXX 입력" maxlength="30"
          style="flex:1;height:46px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Space Grotesk',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box"
          oninput="searchFriends(this.value)">
        <button onclick="searchFriends(document.getElementById('friend-search-input').value)" style="height:46px;padding:0 18px;background:#c8f050;border:none;border-radius:12px;font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:800;color:#0a0a0a;cursor:pointer">검색</button>
      </div>
      <div id="friend-search-results"></div>
      <div style="margin-top:12px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px">추천 러너</div>
        <div id="friend-suggest-container"></div>
      </div>
    </div>
  </div>
</div>

<script>

// DATA
var PAST_LOGS=[
  {date:'02.18',mo:'Feb',d:5.20,pace:"5'12\"",time:"26'58\"",cal:312,ri:0},
  {date:'02.14',mo:'Feb',d:4.80,pace:"5'20\"",time:"25'36\"",cal:288,ri:1},
  {date:'02.10',mo:'Feb',d:6.10,pace:"5'08\"",time:"31'17\"",cal:366,ri:2},
  {date:'02.05',mo:'Feb',d:3.90,pace:"5'35\"",time:"21'47\"",cal:234,ri:0},
  {date:'01.28',mo:'Jan',d:9.80,pace:"5'01\"",time:"49'10\"",cal:588,ri:1},
  {date:'01.21',mo:'Jan',d:8.40,pace:"5'14\"",time:"43'58\"",cal:504,ri:2},
];
// Load saved runs from localStorage
try{
  var _saved=JSON.parse(localStorage.getItem("claprun_runs")||"[]");
  if(_saved.length>0){
    _saved.forEach(function(r){
      if(!PAST_LOGS.find(function(p){return p.date===r.date&&p.d===r.d}))PAST_LOGS.unshift(r);
    });
    // Keep most recent first - unshift already puts new items first
    if(PAST_LOGS.length>50)PAST_LOGS.length=50;
  }
}catch(e){}

const INSTA_POSTS=[
  {em:'🦊',user:'익명의 러너',dist:5.20,pace:"5'12\"",date:'오늘',caption:'새벽 러닝 성공! 🌙',colors:['#0d1a0d','#1a2e0d'],accentAngle:'145deg'},
  {em:'🐆',user:'새벽의 유령',dist:8.40,pace:"4'55\"",date:'어제',caption:'10km 도전 중! 💪',colors:['#1a0d0d','#2e1a0d'],accentAngle:'135deg'},
  {em:'🌙',user:'밤의 러너',dist:6.10,pace:"5'08\"",date:'2일 전',caption:'비 오는 날도 고!',colors:['#0d0d1a','#0d1a2e'],accentAngle:'155deg'},
  {em:'⚡',user:'바람처럼',dist:3.80,pace:"5'45\"",date:'3일 전',caption:'첫 5K 도전! 🎉',colors:['#1a100d','#2e200d'],accentAngle:'125deg'},
  {em:'🚀',user:'도심 탈출자',dist:10.50,pace:"4'42\"",date:'4일 전',caption:'하프 마라톤 준비중',colors:['#0d0d0d','#141414'],accentAngle:'160deg'},
];

// ROOM SYSTEM
const ROOM_KEY='claprun_rooms_v2', HISTORY_KEY='claprun_room_history_v2';
const SAMPLE_ROOMS=[
  {id:'CR-2847',name:'새벽 5km 챌린지',goal:5,period:7,max:8,members:3,hasPw:false,em:'🌙',createdAt:'2025-02-24'},
  {id:'CR-1138',name:'한강 10K 런',goal:10,period:14,max:16,members:11,hasPw:false,em:'🏃',createdAt:'2025-02-23'},
  {id:'CR-0442',name:'비밀 러닝 클럽',goal:21,period:30,max:4,members:2,hasPw:true,em:'🔒',createdAt:'2025-02-22'},
  {id:'CR-3391',name:'도시 탈출 런',goal:5,period:0,max:99,members:7,hasPw:false,em:'💨',createdAt:'2025-02-20'},
  {id:'CR-5512',name:'주말 러너즈',goal:42,period:30,max:8,members:4,hasPw:false,em:'🏅',createdAt:'2025-02-18'},
  {id:'CR-6680',name:'월간 100km',goal:100,period:30,max:32,members:18,hasPw:false,em:'⚡',createdAt:'2025-02-15'},
];
let roomState={createGoal:'5',createPeriod:'7',createMax:'4',createPwEnabled:false,pendingJoinId:null};

function getRooms(){try{return JSON.parse(localStorage.getItem(ROOM_KEY)||'[]');}catch{return[];}}
function saveRooms(r){localStorage.setItem(ROOM_KEY,JSON.stringify(r));}
function getHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');}catch{return[];}}
function addHistory(room){
  const hist=getHistory(), exists=hist.findIndex(h=>h.id===room.id);
  const entry={...room,joinedAt:new Date().toISOString()};
  if(exists>=0)hist.splice(exists,1);
  hist.unshift(entry);
  localStorage.setItem(HISTORY_KEY,JSON.stringify(hist.slice(0,20)));
}

function confirmCreate(){
  var nameEl=document.getElementById('cn-inp');
  if(!nameEl||!nameEl.value.trim()){showToast('크루 이름을 입력해주세요');return;}
  var emEl=document.querySelector('#em-row .em-opt.on');
  var em=emEl?emEl.dataset.em:'🦊';
  closeModal('m-create');
  openCreateRoom();
  setTimeout(function(){
    var crName=document.getElementById('cr-name');
    if(crName){crName.value=nameEl.value.trim();}
  },80);
}
function openCreateRoom(){
  document.getElementById('cr-name').value='';
  document.getElementById('cr-pw').style.display='none';
  document.getElementById('cr-custom-km').style.display='none';
  roomState.createPwEnabled=false;
  const toggle=document.getElementById('pw-toggle');
  const thumb=document.getElementById('pw-thumb');
  if(toggle)toggle.style.background='rgba(255,255,255,.1)';
  if(thumb){thumb.style.left='2px';thumb.style.background='rgba(255,255,255,.4)';}
  ['cr-goal-row','cr-period-row','cr-max-row'].forEach(rowId=>{
    const row=document.getElementById(rowId);
    if(!row)return;
    row.querySelectorAll('.cr-opt').forEach((opt,i)=>{
      const on=i===0;
      opt.style.border=on?'1px solid rgba(200,240,80,.35)':'1px solid rgba(255,255,255,.08)';
      opt.style.background=on?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    });
  });
  roomState.createGoal='5';roomState.createPeriod='7';roomState.createMax='4';
  updateRoomCode('');
  openModal('m-create-room');
  // 항상 맨 위에서 시작
  setTimeout(function(){
    var inner = document.querySelector('#m-create-room [style*="overflow-y"]');
    if(inner) inner.scrollTop = 0;
  }, 50);
}

function setCrOpt(type,val,el){
  const rowMap={goal:'cr-goal-row',period:'cr-period-row',max:'cr-max-row'};
  const row=document.getElementById(rowMap[type]);
  if(!row)return;
  row.querySelectorAll('.cr-opt').forEach(opt=>{
    const isOn=opt===el;
    opt.style.border=isOn?'1px solid rgba(200,240,80,.35)':'1px solid rgba(255,255,255,.08)';
    opt.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    opt.querySelectorAll('span').forEach(s=>{
      s.style.color=isOn?(s.style.fontSize==='8px'?'rgba(200,240,80,.6)':'#c8f050'):(s.style.fontSize==='8px'?'rgba(255,255,255,.3)':'rgba(255,255,255,.7)');
    });
  });
  if(type==='goal')roomState.createGoal=val;
  if(type==='period')roomState.createPeriod=val;
  if(type==='max')roomState.createMax=val;

  // 직접입력 필드 표시/숨김
  var customKm = document.getElementById('cr-custom-km');
  var customPeriod = document.getElementById('cr-custom-period');
  var customMax = document.getElementById('cr-custom-max');

  if(customKm) customKm.style.display = (type==='goal' && val==='custom') ? 'block' : (type==='goal' ? 'none' : customKm.style.display);
  if(customPeriod) customPeriod.style.display = (type==='period' && val==='custom') ? 'block' : (type==='period' ? 'none' : customPeriod.style.display);
  if(customMax) customMax.style.display = (type==='max' && val==='custom') ? 'block' : (type==='max' ? 'none' : customMax.style.display);

  // 직접입력 필드 포커스
  if(val==='custom'){
    var focusEl = type==='goal' ? customKm : type==='period' ? customPeriod : customMax;
    if(focusEl){ setTimeout(function(){ focusEl.focus(); }, 80); }
  }
}

function toggleRoomPw(){
  roomState.createPwEnabled=!roomState.createPwEnabled;
  const on=roomState.createPwEnabled;
  const toggle=document.getElementById('pw-toggle');
  const thumb=document.getElementById('pw-thumb');
  const input=document.getElementById('cr-pw');
  if(toggle)toggle.style.background=on?'#c8f050':'rgba(255,255,255,.1)';
  if(thumb){thumb.style.left=on?'20px':'2px';thumb.style.background=on?'#0a0a0a':'rgba(255,255,255,.4)';}
  if(input)input.style.display=on?'block':'none';
}

function updateRoomCode(name){
  const preview=document.getElementById('cr-code-preview');
  if(!preview)return;
  if(!name||name.length<1){preview.textContent='CR-????';return;}
  const code='CR-'+(Math.abs(name.split('').reduce((a,c)=>a+c.charCodeAt(0)*31,0))%9000+1000);
  preview.textContent=code;
}

function createRoom(){
  const name=document.getElementById('cr-name').value.trim();
  if(!name){showToast('방 이름을 입력해주세요');return;}

  // 목표 거리
  let goal = roomState.createGoal==='custom'
    ? parseInt(document.getElementById('cr-custom-km').value||'0')
    : parseInt(roomState.createGoal);
  if(!goal||goal<1){showToast('목표 거리를 입력해주세요');return;}

  // 기간
  let period = roomState.createPeriod==='custom'
    ? parseInt(document.getElementById('cr-custom-period').value||'0')
    : parseInt(roomState.createPeriod||'7');
  if(roomState.createPeriod==='custom'&&(!period||period<1)){showToast('기간을 입력해주세요');return;}

  // 최대 인원
  let maxVal = roomState.createMax==='custom'
    ? parseInt(document.getElementById('cr-custom-max').value||'0')
    : (roomState.createMax==='99'||roomState.createMax==='inf')?99:parseInt(roomState.createMax||'4');
  if(roomState.createMax==='custom'&&(!maxVal||maxVal<2)){showToast('최대 인원을 입력해주세요 (2명 이상)');return;}

  const pw=roomState.createPwEnabled?(document.getElementById('cr-pw').value||''):'';
  if(roomState.createPwEnabled&&pw.length<4){showToast('비밀번호는 4자 이상이어야 해요');return;}
  if(maxVal>10){showPaymentModal('crew_large');return;}

  const code='CR-'+(Math.abs(name.split('').reduce((a,c)=>a+c.charCodeAt(0)*31,0))%9000+1000);
  const room={id:code,name,goal,period,max:maxVal,members:1,hasPw:!!pw,pw,em:['🦊','🐆','🦅','🔥','⚡','🚀'][Math.floor(Math.random()*6)],createdAt:new Date().toISOString().slice(0,10),mine:true};
  const rooms=getRooms();rooms.unshift(room);saveRooms(rooms);addHistory(room);
  closeModal('m-create-room');
  showCreateSuccess(room);
  renderRoomTabs();
}
function submitRoomPw(){
  const inp=document.getElementById('pw-input');
  const errEl=document.getElementById('pw-modal-err');
  const pw=inp?inp.value:'';
  const id=roomState.pendingJoinId;
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===id);
  if(!room){closeModal('m-room-pw');return;}
  if(room.pw&&room.pw!==pw){if(errEl)errEl.textContent='비밀번호가 맞지 않아요';return;}
  closeModal('m-room-pw');joinRoom(id,pw);
}

function joinRoom(roomId,pw){
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);
  if(!room)return;
  addHistory(room);
  goalType='dist';goalVal=String(room.goal);
  renderRoomTabs();
  showCrewRoom(room);
  // 내 러닝 탭 크루 배지 업데이트
  renderRecCrewBadge(room);
}

function renderRecCrewBadge(room){
  var crewEl=document.getElementById('rec-past-crews');
  if(!crewEl)return;
  // 이미 있는지 확인
  if(document.getElementById('rec-crew-'+room.id))return;
  // 빈 상태 안내 제거
  var emptyMsg=crewEl.querySelector('div:not([id])');
  if(emptyMsg && emptyMsg.style.textAlign==='center') crewEl.removeChild(emptyMsg);
  var badge=document.createElement('div');
  badge.id='rec-crew-'+room.id;
  badge.style.cssText='display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid rgba(255,255,255,.06)';
  var ico=document.createElement('div');
  ico.style.cssText='width:40px;height:40px;border-radius:12px;background:rgba(200,240,80,.07);border:1px solid rgba(200,240,80,.15);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0';
  ico.textContent=room.emoji||'🦊';
  var info=document.createElement('div');info.style.cssText='flex:1;min-width:0';
  var nm=document.createElement('div');nm.style.cssText='font-size:13px;font-weight:400;color:rgba(255,255,255,.88)';nm.textContent=room.name;
  var sub=document.createElement('div');sub.style.cssText='font-size:11px;font-weight:200;color:rgba(255,255,255,.35);margin-top:2px';
  sub.textContent=(room.goal||5)+'km 목표 · '+((room.members||[]). length||1)+'명 참여';
  var tag=document.createElement('div');
  tag.style.cssText='font-size:10px;font-weight:700;color:#c8f050;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:6px;padding:3px 8px';
  tag.textContent='가입됨';
  info.appendChild(nm);info.appendChild(sub);
  badge.appendChild(ico);badge.appendChild(info);badge.appendChild(tag);
  crewEl.insertBefore(badge,crewEl.firstChild);
}

function showCrewRoom(room){
  var el=document.getElementById('crew-room-sheet');
  if(!el){el=document.createElement('div');el.id='crew-room-sheet';el.style.cssText='position:fixed;inset:0;z-index:400;background:#0a0a0a;overflow-y:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch';document.body.appendChild(el);}
  var myDist=parseFloat((Math.random()*room.goal*0.6).toFixed(2));
  var pct=Math.min(Math.round(myDist/room.goal*100),100);
  var period=room.period===0?'무제한':Math.max(room.period-2,1)+'일 남음';
  var nicks=['새벽의 유령','바람처럼','한강지킴이','도시의 고스트','밤의 러너'];
  var emArr=['🌙','💨','🏃','⚡','🌿'];
  function mkRow(nick,em,dist,isMe){
    var mp=Math.min(Math.round(dist/room.goal*100),100),done=dist>=room.goal;
    var d=document.createElement('div');d.style.cssText='display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.05)';
    var av=document.createElement('div');av.style.cssText='width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;'+(isMe?'background:rgba(200,240,80,.12);border:1.5px solid rgba(200,240,80,.3)':'background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)');av.textContent=em;
    var info=document.createElement('div');info.style.cssText='flex:1;min-width:0';
    var nameRow=document.createElement('div');nameRow.style.cssText='display:flex;align-items:center;gap:6px;margin-bottom:6px';
    var ns=document.createElement('span');ns.style.cssText='font-size:13px;font-weight:500;color:'+(isMe?'#c8f050':'rgba(255,255,255,.8)');ns.textContent=nick+(isMe?' (나)':'');nameRow.appendChild(ns);
    if(done){var b=document.createElement('span');b.style.cssText='font-size:9px;background:rgba(200,240,80,.15);color:#c8f050;padding:2px 6px;border-radius:4px;font-weight:700';b.textContent='완주 ✓';nameRow.appendChild(b);}
    var bar=document.createElement('div');bar.style.cssText='background:rgba(255,255,255,.06);border-radius:2px;height:4px;overflow:hidden';
    var fill=document.createElement('div');fill.style.cssText='height:100%;border-radius:2px;width:'+mp+'%;background:'+(done?'#c8f050':isMe?'rgba(200,240,80,.55)':'rgba(255,255,255,.2)');bar.appendChild(fill);
    var nums=document.createElement('div');nums.style.cssText='display:flex;justify-content:space-between;margin-top:4px';
    var nl=document.createElement('span');nl.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.35)';nl.textContent=dist+'km';
    var nr=document.createElement('span');nr.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.35)';nr.textContent=mp+'%';
    nums.appendChild(nl);nums.appendChild(nr);info.appendChild(nameRow);info.appendChild(bar);info.appendChild(nums);d.appendChild(av);d.appendChild(info);
    if(!isMe){d.style.cursor='pointer';d.onclick=function(){var rData={id:'crew_'+nick.replace(/\s/g,'_'),nick:nick,em:em,totalKm:parseFloat(dist)||0,pace:"5'15\"",level:'러너'};showMemberProfile(rData);};}return d;
  }
  el.innerHTML='';
  var hdr=document.createElement('div');hdr.style.cssText='background:rgba(10,10,10,.97);backdrop-filter:blur(16px);position:sticky;top:0;z-index:10;padding:16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:12px';
  var backBtn=document.createElement('button');backBtn.style.cssText='width:36px;height:36px;background:rgba(255,255,255,.07);border:none;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0';
  backBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.65)" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>';
  backBtn.onclick=closeCrewRoom;
  var titleDiv=document.createElement('div');titleDiv.style.cssText='flex:1';
  var t1=document.createElement('div');t1.setAttribute('style','font-size:20px;font-weight:900;color:#fff;line-height:1;font-family:Barlow Condensed,sans-serif');t1.textContent=room.name;
  var t2=document.createElement('div');t2.style.cssText='font-size:10px;font-weight:400;color:rgba(200,240,80,.5);letter-spacing:.08em;margin-top:2px';t2.textContent=room.id+(room.hasPw?' · 🔒':'');
  titleDiv.appendChild(t1);titleDiv.appendChild(t2);
  var dEl=document.createElement('div');dEl.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.35)';dEl.textContent=period;
  hdr.appendChild(backBtn);hdr.appendChild(titleDiv);hdr.appendChild(dEl);el.appendChild(hdr);
  var body=document.createElement('div');body.style.cssText='padding:20px 16px 0';
  var hero=document.createElement('div');hero.style.cssText='background:linear-gradient(135deg,rgba(200,240,80,.07),rgba(200,240,80,.02));border:1px solid rgba(200,240,80,.14);border-radius:20px;padding:20px;margin-bottom:16px';
  var heroLbl=document.createElement('div');heroLbl.style.cssText='font-size:10px;font-weight:500;letter-spacing:.15em;color:rgba(200,240,80,.55);margin-bottom:12px';heroLbl.textContent='내 진행 상황';hero.appendChild(heroLbl);
  var distRow=document.createElement('div');distRow.style.cssText='display:flex;align-items:flex-end;gap:8px;margin-bottom:14px';
  var bigDist=document.createElement('span');bigDist.setAttribute('style','font-size:58px;font-weight:900;color:#c8f050;line-height:1;font-family:Barlow Condensed,sans-serif');bigDist.textContent=myDist;
  var ofGoal=document.createElement('span');ofGoal.setAttribute('style','font-size:22px;color:rgba(255,255,255,.4);padding-bottom:7px;font-family:Barlow Condensed,sans-serif');ofGoal.textContent=' / '+room.goal+'km';
  distRow.appendChild(bigDist);distRow.appendChild(ofGoal);hero.appendChild(distRow);
  var pb=document.createElement('div');pb.style.cssText='background:rgba(0,0,0,.3);border-radius:6px;height:8px;overflow:hidden;margin-bottom:8px';
  var pf=document.createElement('div');pf.style.cssText='height:100%;background:linear-gradient(90deg,rgba(200,240,80,.4),#c8f050);border-radius:6px;width:'+pct+'%';pb.appendChild(pf);hero.appendChild(pb);
  var pnn=document.createElement('div');pnn.style.cssText='display:flex;justify-content:space-between';
  var pn1=document.createElement('span');pn1.style.cssText='font-size:11px;font-weight:300;color:rgba(255,255,255,.4)';pn1.textContent=pct+'% 달성';
  var pn2=document.createElement('span');pn2.style.cssText='font-size:11px;font-weight:300;color:rgba(255,255,255,.4)';pn2.textContent='목표까지 '+Math.max(0,room.goal-myDist).toFixed(2)+'km';
  pnn.appendChild(pn1);pnn.appendChild(pn2);hero.appendChild(pnn);body.appendChild(hero);
  var ctaGrid=document.createElement('div');ctaGrid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px';
  var goalCard=document.createElement('div');goalCard.style.cssText='background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px;text-align:center';
  var gcBig=document.createElement('div');gcBig.setAttribute('style','font-size:32px;font-weight:900;color:#c8f050;line-height:1;font-family:Barlow Condensed,sans-serif');gcBig.textContent=room.goal+'km';
  var gcSub=document.createElement('div');gcSub.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.35);margin-top:4px';gcSub.textContent='크루 목표';
  goalCard.appendChild(gcBig);goalCard.appendChild(gcSub);
  var startBtn=document.createElement('button');startBtn.style.cssText='background:#c8f050;border:none;border-radius:14px;padding:16px;text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent';
  var sbBig=document.createElement('div');sbBig.setAttribute('style','font-size:24px;font-weight:900;color:#0a0a0a;line-height:1;font-family:Barlow Condensed,sans-serif');sbBig.textContent='START';
  var sbSub=document.createElement('div');sbSub.style.cssText='font-size:10px;font-weight:500;color:rgba(0,0,0,.55);margin-top:3px';sbSub.textContent='지금 달리기';
  startBtn.appendChild(sbBig);startBtn.appendChild(sbSub);startBtn.onclick=function(){closeCrewRoom();goTab('run');};
  ctaGrid.appendChild(goalCard);ctaGrid.appendChild(startBtn);body.appendChild(ctaGrid);
  var mhdr=document.createElement('div');mhdr.style.cssText='margin-bottom:8px';
  var mh1=document.createElement('div');mh1.style.cssText='font-size:11px;font-weight:500;letter-spacing:.1em;color:rgba(255,255,255,.35);margin-bottom:3px';mh1.textContent='크루 멤버';
  var mh2=document.createElement('div');mh2.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.25);margin-bottom:12px';mh2.textContent='달성 여부만 공유 · 순위 없음';
  mhdr.appendChild(mh1);mhdr.appendChild(mh2);body.appendChild(mhdr);
  var myAv=currentUser&&currentUser.avatar?currentUser.avatar:'🦊';
  body.appendChild(mkRow('나',myAv,myDist,true));
  var cnt=Math.min((room.members||5)-1,4);
  for(var i=0;i<cnt;i++){body.appendChild(mkRow(nicks[i]||'러너'+(i+2),emArr[i]||'🏃',parseFloat((room.goal*(0.15+Math.random()*0.85)).toFixed(2)),false));}
  var inv=document.createElement('div');inv.style.cssText='background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.1);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;margin:20px 0 40px';
  var invLeft=document.createElement('div');invLeft.style.cssText='flex:1';
  var invLabel=document.createElement('div');invLabel.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.35);margin-bottom:3px';invLabel.textContent='친구 초대 코드';
  var invCode=document.createElement('div');invCode.setAttribute('style','font-size:22px;font-weight:800;color:#c8f050;letter-spacing:.1em;font-family:Barlow Condensed,sans-serif');invCode.textContent=room.id;
  invLeft.appendChild(invLabel);invLeft.appendChild(invCode);
  var cpBtn=document.createElement('button');cpBtn.style.cssText='height:34px;padding:0 14px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:9px;font-size:11px;font-weight:600;color:#c8f050;cursor:pointer';
  cpBtn.textContent='복사';cpBtn.onclick=function(){copyRoomCode(room.id);};
  inv.appendChild(invLeft);inv.appendChild(cpBtn);body.appendChild(inv);

  // ── ACTIVITY FEED ──
  var actHdr=document.createElement('div');actHdr.style.cssText='margin-top:4px;margin-bottom:8px';
  var ah1=document.createElement('div');ah1.style.cssText='font-size:11px;font-weight:500;letter-spacing:.1em;color:rgba(255,255,255,.35);margin-bottom:12px';ah1.textContent='최근 활동';
  actHdr.appendChild(ah1);body.appendChild(actHdr);
  var activities=[
    {em:'🌙',nick:'새벽의 유령',action:'3.2km 달성',time:'방금'},
    {em:'⚡',nick:'바람처럼',action:'크루 참여',time:'2분 전'},
    {em:'🏃',nick:'한강지킴이',action:room.goal+'km 완주! 🎉',time:'14분 전'},
  ];
  activities.forEach(function(a){
    var row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)';
    var av=document.createElement('div');av.style.cssText='width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0';av.textContent=a.em;
    var info=document.createElement('div');info.style.cssText='flex:1';
    var nameSpan=document.createElement('span');nameSpan.style.cssText='font-size:12px;font-weight:500;color:rgba(255,255,255,.7)';nameSpan.textContent=a.nick+' ';
    var actSpan=document.createElement('span');actSpan.style.cssText='font-size:12px;font-weight:300;color:rgba(255,255,255,.45)';actSpan.textContent=a.action;
    var timeDiv=document.createElement('div');timeDiv.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.25);margin-top:2px';timeDiv.textContent=a.time;
    info.appendChild(nameSpan);info.appendChild(actSpan);info.appendChild(timeDiv);row.appendChild(av);row.appendChild(info);body.appendChild(row);
  });

  // ── CHALLENGE BUTTON ──
  var sp2=document.createElement('div');sp2.style.height='16px';body.appendChild(sp2);
  var chalBtn=document.createElement('button');chalBtn.style.cssText='width:100%;height:52px;background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);border-radius:16px;font-family:Barlow Condensed,sans-serif;font-size:17px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.55);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px';
  chalBtn.innerHTML='<span style="font-size:20px">⚡</span> 크루에게 러닝 독려하기';
  chalBtn.onclick=function(){showToast('크루에게 독려 메시지를 보냈어요! 👏');chalBtn.style.background='rgba(200,240,80,.08)';chalBtn.style.borderColor='rgba(200,240,80,.2)';chalBtn.style.color='#c8f050';};
  body.appendChild(chalBtn);

  var sp3=document.createElement('div');sp3.style.height='32px';body.appendChild(sp3);
  el.appendChild(body);el.style.display='block';el.scrollTop=0;
}

function closeCrewRoom(){
  const el=document.getElementById('crew-room-sheet');
  if(el)el.style.display='none';
}

function switchRoomTab(tab){
  document.querySelectorAll('.rtab').forEach(t=>{
    const isOn=t.dataset.rt===tab;
    t.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    t.style.borderColor=isOn?'rgba(200,240,80,.3)':'rgba(255,255,255,.08)';
    t.style.color=isOn?'#c8f050':'rgba(255,255,255,.4)';
  });
  ['browse','mine','friends','history'].forEach(rt=>{
    const el=document.getElementById('room-pane-'+rt);
    if(el)el.style.display=rt===tab?'block':'none';
  });
  if(tab==='browse')renderPublicRooms();
  if(tab==='mine')renderMyRooms();
  if(tab==='friends')renderFriendsList();
  if(tab==='history')renderRoomHistory();
}

function renderRoomTabs(){renderPublicRooms();renderMyRooms();renderFriendsList();renderRoomHistory();}


function confirmJoin(){
  var code=(document.getElementById("jin")||{}).value||'';code=code.trim().toUpperCase();
  if(!code){showToast("코드를 입력해주세요");return;}
  var allRooms=[...(typeof SAMPLE_ROOMS!=="undefined"?SAMPLE_ROOMS:[]),...getRooms()];
  var room=allRooms.find(function(r){return r.code&&r.code.toUpperCase()===code;});
  if(!room){showToast("크루를 찾을 수 없어요 ❌");return;}
  closeModal("m-join");
  showJoinPreview(room.id);
}
function onJoinInput(val){
  val=(val||"").trim().toUpperCase();
  var prev=document.getElementById("jprev");
  if(!prev)return;
  var allRooms=[...(typeof SAMPLE_ROOMS!=="undefined"?SAMPLE_ROOMS:[]),...getRooms()];
  var found=allRooms.find(function(r){return r.code&&r.code.toUpperCase()===val;});
  if(found){
    prev.style.display="flex";
    var e=document.getElementById("jp-em");if(e)e.textContent=found.em||"🦊";
    var n=document.getElementById("jp-name");if(n)n.textContent=found.name||"크루";
    var t=document.getElementById("jp-meta");if(t)t.textContent=(found.members||0)+"명 · "+(found.dist||"?")+"km";
  }else{prev.style.display="none";}
}
function joinByCode(){
  var inp=document.getElementById('join-code-input');
  var code=(inp?inp.value.trim().toUpperCase():'');
  if(!code){showToast('코드를 입력해주세요');return;}
  // Find in all rooms
  var allRooms=[...SAMPLE_ROOMS,...getRooms()];
  var room=allRooms.find(function(r){return r.id.toUpperCase()===code;});
  if(!room){showToast('크루를 찾을 수 없어요: '+code);return;}
  if(inp)inp.value='';
  showJoinPreview(room.id);
}

function renderPublicRooms(){
  const el=document.getElementById('room-list-container');
  if(!el)return;
  const allPublic=[...SAMPLE_ROOMS,...getRooms().filter(r=>!r.mine)];
  el.innerHTML='';
  // Section label
  var lbl=document.createElement('div');lbl.style.cssText='font-size:10px;font-weight:400;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px';lbl.textContent='공개 크루';el.appendChild(lbl);
  allPublic.forEach(room=>{
    const filled=Math.min(Math.round(room.members/room.max*100),100);
    const isFull=room.members>=room.max;
    const card=document.createElement('div');
    card.style.cssText='background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:border-color .15s';
    card.innerHTML=`<div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:10px"><div style="width:42px;height:42px;border-radius:12px;background:rgba(200,240,80,.08);border:1px solid rgba(200,240,80,.12);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${room.em}</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:6px;margin-bottom:2px"><span style="font-family:Barlow Condensed,sans-serif;font-size:17px;font-weight:800;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${room.name}</span>${room.hasPw?'<span style="font-size:10px">🔒</span>':''}</div><span style="font-family:Barlow Condensed,sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;color:rgba(200,240,80,.5)">${room.id}</span></div><button onclick="tryJoinRoom('${room.id}')" ${isFull?'disabled':''} style="height:32px;padding:0 14px;background:${isFull?'rgba(255,255,255,.04)':'#c8f050'};border:none;border-radius:8px;font-family:Barlow Condensed,sans-serif;font-size:13px;font-weight:800;color:${isFull?'rgba(255,255,255,.2)':'#0a0a0a'};cursor:${isFull?'default':'pointer'};flex-shrink:0">${isFull?'마감':'입장'}</button></div><div style="display:flex;align-items:center;gap:16px;margin-bottom:10px"><div style="text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:800;color:#c8f050;line-height:1">${room.goal}km</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">목표</div></div><div style="width:1px;height:28px;background:rgba(255,255,255,.08)"></div><div style="text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">${room.period===0?'무제한':room.period+'일'}</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">기간</div></div><div style="width:1px;height:28px;background:rgba(255,255,255,.08)"></div><div style="text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">${room.members}/${room.max===99?'∞':room.max}</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">인원</div></div></div><div style="background:rgba(255,255,255,.05);border-radius:3px;height:4px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,rgba(200,240,80,.5),#c8f050);border-radius:3px;width:${filled}%"></div></div>`;
    card.addEventListener('mouseenter',()=>{card.style.borderColor='rgba(200,240,80,.2)';});
    card.addEventListener('mouseleave',()=>{card.style.borderColor='rgba(255,255,255,.07)';});
    el.appendChild(card);
  });
  if(!allPublic.length) el.innerHTML='<div style="text-align:center;padding:40px 20px;color:rgba(255,255,255,.25);font-size:13px">공개 방이 없어요</div>';
}

function renderMyRooms(){
  const el=document.getElementById('my-room-container');
  if(!el)return;
  const mine=getRooms().filter(r=>r.mine);
  el.innerHTML='';
  mine.forEach(room=>{
    const card=document.createElement('div');
    card.style.cssText='background:rgba(200,240,80,.04);border:1px solid rgba(200,240,80,.12);border-radius:16px;padding:14px 16px;margin-bottom:10px';
    card.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:11px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);display:flex;align-items:center;justify-content:center;font-size:20px">${room.em}</div><div style="flex:1"><div style="font-family:Barlow Condensed,sans-serif;font-size:17px;font-weight:800;color:#fff">${room.name}</div><div style="font-family:Barlow Condensed,sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;color:rgba(200,240,80,.5)">${room.id}${room.hasPw?' · 🔒':''}</div></div><button onclick="deleteRoom('${room.id}')" style="width:28px;height:28px;background:rgba(255,60,60,.08);border:1px solid rgba(255,60,60,.15);border-radius:8px;font-size:12px;cursor:pointer">🗑</button></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px"><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:800;color:#c8f050">${room.goal}km</div><div style="font-size:8px;color:rgba(255,255,255,.3)">목표</div></div><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:800;color:rgba(255,255,255,.7)">${room.period===0?'∞':room.period+'일'}</div><div style="font-size:8px;color:rgba(255,255,255,.3)">기간</div></div><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:800;color:rgba(255,255,255,.7)">${room.members}</div><div style="font-size:8px;color:rgba(255,255,255,.3)">참여 중</div></div></div><div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(0,0,0,.3);border-radius:10px"><span style="font-size:11px;color:rgba(255,255,255,.4)">초대 코드</span><span style="font-family:Barlow Condensed,sans-serif;font-size:13px;font-weight:700;color:rgba(200,240,80,.7);flex:1">${room.id}</span><button onclick="copyRoomCode('${room.id}')" style="height:26px;padding:0 10px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:700;color:#c8f050;cursor:pointer">복사</button></div>`;
    el.appendChild(card);
  });
  if(!mine.length) el.innerHTML=`<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:14px">🚪</div><div style="font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.5);margin-bottom:6px">아직 만든 크루가 없어요</div><div style="font-size:12px;color:rgba(255,255,255,.25);margin-bottom:20px">크루를 만들어 함께 달려요</div><button onclick="openCreateRoom()" style="height:44px;padding:0 24px;background:#c8f050;border:none;border-radius:12px;font-family:Barlow Condensed,sans-serif;font-size:16px;font-weight:800;color:#0a0a0a;cursor:pointer">크루 만들기</button></div>`;
}

function renderRoomHistory(){
  const el=document.getElementById('room-history-container');
  if(!el)return;
  const hist=getHistory();
  el.innerHTML='';
  hist.forEach(room=>{
    const date=room.joinedAt?new Date(room.joinedAt).toLocaleDateString('ko-KR',{month:'long',day:'numeric'}):'';
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';
    row.innerHTML=`<div style="width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${room.em||'🏃'}</div><div style="flex:1;min-width:0"><div style="font-size:14px;font-weight:400;color:rgba(255,255,255,.8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${room.name}</div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-family:Barlow Condensed,sans-serif;font-size:10px;font-weight:600;letter-spacing:.08em;color:rgba(200,240,80,.5)">${room.id}</span><span style="font-size:9px;color:rgba(255,255,255,.25)">${date}</span></div></div><div style="text-align:right;flex-shrink:0"><div style="font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:800;color:#c8f050">${room.goal}km</div><div style="font-size:8px;color:rgba(255,255,255,.3)">목표</div></div>`;
    row.addEventListener('click',()=>tryJoinRoom(room.id));
    el.appendChild(row);
  });
  if(!hist.length) el.innerHTML=`<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:14px">📋</div><div style="font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.5);margin-bottom:6px">참여 기록이 없어요</div><div style="font-size:12px;color:rgba(255,255,255,.25)">크루에 입장하면 기록됩니다</div></div>`;
}

function deleteRoom(roomId){
  const rooms=getRooms().filter(r=>r.id!==roomId);saveRooms(rooms);renderMyRooms();showToast('크루가 삭제됐어요');
}
function copyRoomCode(code){
  var txt=String(code);
  // clipboard API 먼저 시도 (HTTPS 환경)
  if(navigator.clipboard){
    navigator.clipboard.writeText(txt)
      .then(function(){ showToast('📋 '+txt+' 복사됐어요!'); })
      .catch(function(){ _copyFallback(txt); });
  } else {
    _copyFallback(txt);
  }
}
function _copyFallback(txt){
  // execCommand 시도
  var ta=document.createElement('textarea');
  ta.value=txt;
  ta.style.cssText='position:fixed;left:0;top:0;width:100%;height:60px;font-size:16px;z-index:9999;opacity:1;padding:10px;box-sizing:border-box;border:2px solid #c8f050;background:#111;color:#c8f050;font-weight:900;text-align:center;letter-spacing:.1em';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  var ok=false;
  try{ ok=document.execCommand('copy'); }catch(e){}
  document.body.removeChild(ta);
  if(ok){
    showToast('📋 '+txt+' 복사됐어요!');
  } else {
    // 마지막 수단: 코드 강조 표시 (사용자가 직접 복사)
    _showCodePopup(txt);
  }
}

function _showCodePopup(txt){
  var overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:24px';
  overlay.onclick=function(){ document.body.removeChild(overlay); };
  overlay.innerHTML='<div style="background:#161616;border:2px solid #c8f050;border-radius:20px;padding:28px 24px;text-align:center;width:100%;max-width:320px">'
    +'<div style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:12px;letter-spacing:.1em">크루 코드 — 길게 눌러 복사하세요</div>'
    +'<div id="_code_txt" style="font-family:Barlow Condensed,sans-serif;font-size:44px;font-weight:900;color:#c8f050;letter-spacing:.15em;line-height:1;user-select:all;-webkit-user-select:all;cursor:text;padding:10px 0">'+txt+'</div>'
    +'<div style="margin-top:16px;font-size:11px;color:rgba(255,255,255,.3)">터치해서 선택 후 복사</div>'
    +'<button onclick="event.stopPropagation();selectCodeText();" style="margin-top:14px;width:100%;height:42px;background:rgba(200,240,80,.15);border:1px solid rgba(200,240,80,.3);border-radius:10px;font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:700;color:#c8f050;cursor:pointer">선택하기</button>'
    +'</div>';
  document.body.appendChild(overlay);
}

function selectCodeText(){
  var el=document.getElementById('_code_txt');
  if(!el) return;
  var r=document.createRange();
  r.selectNode(el);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(r);
}

// ── JOIN ROOM PREVIEW ──
function tryJoinRoom(roomId){
  showJoinPreview(roomId);
}
function showJoinPreview(roomId){
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);if(!room)return;
  let el=document.getElementById('join-preview-sheet');
  if(!el){el=document.createElement('div');el.id='join-preview-sheet';el.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);display:flex;align-items:flex-end;justify-content:center';el.addEventListener('click',e=>{if(e.target===el)closeJoinPreview();});document.body.appendChild(el);}
  const daysLeft=room.period===0?'무제한':room.period+'일 남음',pct=Math.min(Math.round(room.members/(room.max===99?room.members+10:room.max)*100),100);
  const memberEmojis=['\uD83D\uDC7B','\uD83C\uDFC3','\uD83C\uDF19','\u26A1','\uD83D\uDCA8'].slice(0,Math.min(room.members,5)).map((em,i)=>`<div style="width:30px;height:30px;border-radius:50%;background:#222;border:2px solid #161616;display:flex;align-items:center;justify-content:center;font-size:14px;margin-left:${i?'-7px':'0'}">${em}</div>`).join('');
  el.innerHTML=`<div style="width:100%;max-width:480px;background:#161616;border-radius:28px 28px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 48px;overflow:hidden"><div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)"></div></div><div style="padding:20px 22px 0"><div style="display:flex;align-items:center;gap:14px;margin-bottom:18px"><div style="width:60px;height:60px;border-radius:16px;background:rgba(200,240,80,.1);border:1.5px solid rgba(200,240,80,.18);display:flex;align-items:center;justify-content:center;font-size:30px;flex-shrink:0">${room.em}</div><div><div style="font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:900;color:#fff;line-height:1.1">${room.name}</div><div style="font-family:Barlow Condensed,sans-serif;font-size:12px;font-weight:600;color:rgba(200,240,80,.55);letter-spacing:.1em;margin-top:3px">${room.id}${room.hasPw?' · 🔒':''}</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px"><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;color:#c8f050;line-height:1">${room.goal}<span style="font-size:13px;font-weight:400">km</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">목표 거리</div></div><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;color:rgba(255,255,255,.8);line-height:1">${room.period===0?'∞':room.period}<span style="font-size:12px;font-weight:400">${room.period===0?'':' 일'}</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">${daysLeft}</div></div><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;color:rgba(255,255,255,.8);line-height:1">${room.members}<span style="font-size:12px;font-weight:400">/${room.max===99?'∞':room.max}</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">참여 인원</div></div></div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:rgba(255,255,255,.35)">크루 현황</span><span style="font-size:10px;color:rgba(200,240,80,.6)">${pct}% 채워짐</span></div><div style="background:rgba(255,255,255,.06);border-radius:4px;height:6px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,rgba(200,240,80,.5),#c8f050);border-radius:4px;width:${pct}%"></div></div></div><div style="display:flex;align-items:center;margin-bottom:18px">${memberEmojis}<span style="font-size:11px;color:rgba(255,255,255,.35);margin-left:12px">함께 달리는 중</span></div><div style="background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.12);border-radius:12px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px"><div style="font-size:22px">🎯</div><div><div style="font-size:12px;color:rgba(255,255,255,.7)">목표 <span style="color:#c8f050;font-weight:700">${room.goal}km</span> 달성 여부만 공유돼요</div><div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:2px">순위 없음 · 부담 없음</div></div></div><button onclick="confirmJoinRoom('${room.id}')" style="width:100%;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:900;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;box-shadow:0 6px 20px rgba(200,240,80,.28)">이 크루 참여하기</button><button onclick="closeJoinPreview()" style="width:100%;height:42px;background:none;border:none;font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:600;color:rgba(255,255,255,.3);cursor:pointer;margin-top:6px">취소</button></div></div>`;
  el.style.display='flex';
}
function closeJoinPreview(){const el=document.getElementById('join-preview-sheet');if(el)el.style.display='none';}
function confirmJoinRoom(roomId){
  closeJoinPreview();
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);if(!room)return;
  if(room.hasPw){roomState.pendingJoinId=roomId;const nameEl=document.getElementById('pw-modal-name'),errEl=document.getElementById('pw-modal-err'),inp=document.getElementById('pw-input');if(nameEl)nameEl.textContent=room.name;if(errEl)errEl.textContent='';if(inp)inp.value='';openModal('m-room-pw');}
  else{joinRoom(roomId,'');}
}

// ── CREATE ROOM SUCCESS PREVIEW ──
function showCreateSuccess(room){
  let el=document.getElementById('create-success-sheet');
  if(!el){el=document.createElement('div');el.id='create-success-sheet';el.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.88);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;padding:24px';document.body.appendChild(el);}
  el.innerHTML=`<div style="width:100%;max-width:360px;background:#161616;border-radius:24px;border:1px solid rgba(200,240,80,.15);padding:32px 28px;text-align:center"><div style="width:72px;height:72px;border-radius:50%;background:rgba(200,240,80,.12);border:2px solid rgba(200,240,80,.3);display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 16px">&#127881;</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:28px;font-weight:900;color:#c8f050;margin-bottom:4px">크루 생성 완료!</div><div style="font-size:13px;color:rgba(255,255,255,.45);margin-bottom:24px">${room.name}</div><div style="background:rgba(200,240,80,.06);border:1.5px solid rgba(200,240,80,.2);border-radius:16px;padding:18px;margin-bottom:20px"><div style="font-size:10px;font-weight:700;letter-spacing:.18em;color:rgba(255,255,255,.35);margin-bottom:6px">크루 코드</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:40px;font-weight:900;color:#c8f050;letter-spacing:.12em;line-height:1">${room.id}</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:6px">이 코드로 친구를 초대하세요</div></div><div style="display:flex;justify-content:center;gap:20px;margin-bottom:24px"><div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.goal}km</div><div style="font-size:9px;color:rgba(255,255,255,.3)">목표</div></div><div style="width:1px;background:rgba(255,255,255,.08)"></div><div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.period===0?'무제한':room.period+'일'}</div><div style="font-size:9px;color:rgba(255,255,255,.3)">기간</div></div><div style="width:1px;background:rgba(255,255,255,.08)"></div><div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.hasPw?'&#128274;':'&#128275;'}</div><div style="font-size:9px;color:rgba(255,255,255,.3)">${room.hasPw?'비공개':'공개'}</div></div></div><button onclick="copyRoomCode('${room.id}')" style="width:100%;height:50px;background:#c8f050;border:none;border-radius:14px;font-family:\'Barlow Condensed\',sans-serif;font-size:17px;font-weight:900;color:#0a0a0a;cursor:pointer;margin-bottom:10px">코드 복사 &amp; 공유</button><button onclick="document.getElementById('create-success-sheet').style.display='none';switchRoomTab('mine')" style="width:100%;height:42px;background:none;border:none;font-family:\'Barlow Condensed\',sans-serif;font-size:14px;font-weight:600;color:rgba(255,255,255,.35);cursor:pointer">내 크루 보기</button></div>`;
  el.style.display='flex';
}

// ── FRIENDS SYSTEM ──
const FRIENDS_KEY='claprun_friends_v1';
const SUGGESTED_RUNNERS=[
  {id:'fr_001',nick:'새벽 달리기',em:'🌙',totalKm:312,pace:"5'04",level:'하프',atCode:'AF-M3RN4V'},
  {id:'fr_002',nick:'한강 수호자',em:'🏃',totalKm:580,pace:"4'52",level:'마라톤',atCode:'AF-K7PQ2X'},
  {id:'fr_003',nick:'도시 유령',em:'🦊',totalKm:124,pace:"5'30",level:'10K',atCode:'AF-9WBZ1L'},
  {id:'fr_004',nick:'새벽 4시',em:'⚡',totalKm:88,pace:"5'45",level:'5K',atCode:'AF-R5TH8N'},
  {id:'fr_005',nick:'조용한 발걸음',em:'💨',totalKm:201,pace:"5'12",level:'10K',atCode:'AF-J2CF6D'},
];
function getFriends(){try{return JSON.parse(localStorage.getItem(FRIENDS_KEY)||'[]');}catch{return[];}}
function saveFriends(f){localStorage.setItem(FRIENDS_KEY,JSON.stringify(f));}
function addFriend(runner){
  const friends=getFriends();
  if(friends.find(f=>f.id===runner.id)){showToast('이미 친구예요 😊');return;}
  friends.push({...runner,addedAt:new Date().toISOString()});saveFriends(friends);
  renderFriendsList();showToast('👋 '+runner.nick+'님을 친구로 추가했어요!');
}
function removeFriend(id){saveFriends(getFriends().filter(f=>f.id!==id));renderFriendsList();showToast('친구를 삭제했어요');}
function renderFriendsList(){
  const el=document.getElementById('friends-container');if(!el)return;
  const friends=getFriends();el.innerHTML='';
  if(friends.length){
    const hdr=document.createElement('div');hdr.style.cssText='font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px';hdr.textContent='내 친구 · '+friends.length+'명';el.appendChild(hdr);
    friends.forEach(f=>{
      const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';row.onclick=function(e){if(!e.target.closest('button'))showMemberProfile(f);};
      row.innerHTML='<div style="width:44px;height:44px;border-radius:50%;background:rgba(200,240,80,.08);border:1.5px solid rgba(200,240,80,.15);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">'+f.em+'</div><div style="flex:1"><div style="font-size:14px;color:rgba(255,255,255,.85)">'+f.nick+'</div><div style="font-size:10px;font-weight:500;letter-spacing:.08em;color:rgba(200,240,80,.55);margin-top:2px">'+(f.atCode||'AF-??????')+'</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:1px">'+f.totalKm+'km · '+f.pace+'/km</div></div><button onclick="removeFriend(\'' + f.id + '\')" style="height:30px;padding:0 12px;background:rgba(255,60,60,.07);border:1px solid rgba(255,60,60,.15);border-radius:8px;font-size:10px;font-weight:700;color:rgba(255,80,80,.6);cursor:pointer">삭제</button>';
      el.appendChild(row);
    });
    const sp=document.createElement('div');sp.style.height='20px';el.appendChild(sp);
  }
  const shdr=document.createElement('div');shdr.style.cssText='font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px';shdr.textContent='추천 러너';el.appendChild(shdr);
  SUGGESTED_RUNNERS.filter(r=>!friends.find(f=>f.id===r.id)).forEach(r=>{
    const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';row.onclick=function(e){if(!e.target.closest('button'))showMemberProfile(r);};
    const rj=JSON.stringify(r).replace(/"/g,'&quot;');
    row.innerHTML='<div style="width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">'+r.em+'</div><div style="flex:1"><div style="font-size:14px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:10px;font-weight:500;letter-spacing:.08em;color:rgba(200,240,80,.5);margin-top:2px">'+(r.atCode||'AF-??????')+'</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:1px">'+r.level+' · '+r.totalKm+'km</div></div><button onclick="addFriend('+rj+')" style="height:30px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:8px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>';
    el.appendChild(row);
  });
}
function openFriendsModal(){
  const sug=document.getElementById('friend-suggest-container');
  if(sug){sug.innerHTML='';const friends=getFriends();SUGGESTED_RUNNERS.filter(r=>!friends.find(f=>f.id===r.id)).forEach(r=>{const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';row.onclick=function(e){if(!e.target.closest('button'))showMemberProfile(r);};const rj=JSON.stringify(r).replace(/"/g,'&quot;');row.innerHTML='<div style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">'+r.em+'</div><div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:1px">'+r.level+' · '+r.totalKm+'km</div></div><button onclick="addFriend('+rj+');openFriendsModal()" style="height:28px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>';sug.appendChild(row);});}
  openModal('m-friends');
}
function searchFriends(query){
  const el=document.getElementById('friend-search-results');if(!el)return;
  if(!query||query.trim().length<1){el.innerHTML='';return;}
  const q=query.trim().toLowerCase();
  const results=SUGGESTED_RUNNERS.filter(r=>r.nick.toLowerCase().includes(q)||r.id.includes(q));
  const friends=getFriends();el.innerHTML='';
  if(!results.length){el.innerHTML='<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">"'+query+'"에 해당하는 러너가 없어요</div>';return;}
  results.forEach(r=>{
    const isFr=!!friends.find(f=>f.id===r.id);const rj=JSON.stringify(r).replace(/"/g,'&quot;');
    const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05)';
    row.innerHTML='<div style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:18px">'+r.em+'</div><div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:10px;font-weight:500;letter-spacing:.08em;color:rgba(200,240,80,.55);margin-top:1px">'+(r.atCode||'AF-??????')+'</div><div style="font-size:10px;color:rgba(255,255,255,.3)">'+r.level+' · '+r.totalKm+'km</div></div>'+(isFr?'<span style="font-size:10px;color:rgba(200,240,80,.5)">친구 ✓</span>':'<button onclick="addFriend('+rj+');searchFriends(document.getElementById(\'friend-search-input\').value)" style="height:28px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>');
    el.appendChild(row);
  });
}


// ── PAYMENT MODAL ──
// ── MEMBER / FRIEND PROFILE VIEWER ──
function showMemberProfile(runner){
  var el=document.getElementById('member-profile-sheet');
  if(!el){
    el=document.createElement('div');
    el.id='member-profile-sheet';
    el.style.cssText='position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.88);backdrop-filter:blur(20px);display:none;align-items:flex-end;justify-content:center;padding:0';
    el.addEventListener('click',function(e){if(e.target===el)el.style.display='none';});
    document.body.appendChild(el);
  }
  var isFriend=getFriends().some(function(f){return f.id===runner.id;});
  var runs=[
    {date:'2/25',km:5.2,paceStr:"5'08",timeStr:"26'44"},
    {date:'2/22',km:10.1,paceStr:"5'14",timeStr:"52'56"},
    {date:'2/19',km:3.0,paceStr:"5'30",timeStr:"16'30"},
  ];

  var sheet=document.createElement('div');
  sheet.style.cssText='width:100%;max-width:440px;background:#161616;border-radius:28px 28px 0 0;border:1px solid rgba(255,255,255,.08);overflow:hidden;max-height:85vh;overflow-y:auto;padding-bottom:48px';

  // Handle bar
  var hb=document.createElement('div');hb.style.cssText='display:flex;justify-content:center;padding:12px 0 0';
  var hbb=document.createElement('div');hbb.style.cssText='width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)';
  hb.appendChild(hbb);sheet.appendChild(hb);

  var body=document.createElement('div');body.style.cssText='padding:20px 22px 0';

  // Avatar row
  var avRow=document.createElement('div');avRow.style.cssText='display:flex;align-items:center;gap:16px;margin-bottom:20px';
  var avEl=document.createElement('div');avEl.style.cssText='width:64px;height:64px;border-radius:50%;background:rgba(200,240,80,.1);border:2px solid rgba(200,240,80,.25);display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0';avEl.textContent=runner.em;
  var nameDiv=document.createElement('div');nameDiv.style.cssText='flex:1';
  var nm=document.createElement('div');nm.style.cssText='font-family:Barlow Condensed,sans-serif;font-size:26px;font-weight:900;color:#fff;line-height:1';nm.textContent=runner.nick;
  var lv=document.createElement('div');lv.style.cssText='font-size:11px;font-weight:300;color:rgba(255,255,255,.4);margin-top:3px;letter-spacing:.04em';lv.textContent=(runner.level||'러너')+' 러너';
  nameDiv.appendChild(nm);nameDiv.appendChild(lv);

  var actionBtn=document.createElement('button');
  if(isFriend){
    actionBtn.style.cssText='height:34px;padding:0 14px;background:rgba(255,60,60,.07);border:1px solid rgba(255,60,60,.15);border-radius:9px;font-size:11px;font-weight:600;color:rgba(255,80,80,.6);cursor:pointer';
    actionBtn.textContent='친구 삭제';
    actionBtn.onclick=function(){removeFriend(runner.id);el.style.display='none';};
  }else{
    actionBtn.style.cssText='height:34px;padding:0 14px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:9px;font-size:11px;font-weight:700;color:#c8f050;cursor:pointer';
    actionBtn.textContent='+ 친구 추가';
    actionBtn.onclick=function(){addFriend(runner);el.style.display='none';};
  }
  avRow.appendChild(avEl);avRow.appendChild(nameDiv);avRow.appendChild(actionBtn);body.appendChild(avRow);

  // Stats grid
  var grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px';
  var stats=[
    {val:runner.totalKm,lbl:'총 거리 km',color:'#c8f050'},
    {val:runner.pace||"5'15",lbl:'평균 페이스',color:'rgba(255,255,255,.85)'},
    {val:Math.max(1,Math.floor((runner.totalKm||0)/5)),lbl:'완주 횟수',color:'rgba(255,255,255,.85)'},
  ];
  stats.forEach(function(s){
    var card=document.createElement('div');card.style.cssText='background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center';
    var vEl=document.createElement('div');vEl.style.cssText='font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;line-height:1;color:'+s.color;vEl.textContent=s.val;
    var lEl=document.createElement('div');lEl.style.cssText='font-size:9px;font-weight:300;color:rgba(255,255,255,.35);margin-top:3px;letter-spacing:.06em';lEl.textContent=s.lbl;
    card.appendChild(vEl);card.appendChild(lEl);grid.appendChild(card);
  });
  body.appendChild(grid);

  // Recent runs
  var rlbl=document.createElement('div');rlbl.style.cssText='font-size:10px;font-weight:400;letter-spacing:.12em;color:rgba(255,255,255,.35);margin-bottom:10px';rlbl.textContent='최근 러닝 기록';body.appendChild(rlbl);
  runs.forEach(function(r){
    var row=document.createElement('div');row.style.cssText='display:flex;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)';
    var d=document.createElement('span');d.style.cssText='font-size:11px;font-weight:300;color:rgba(255,255,255,.35);width:36px';d.textContent=r.date;
    var k=document.createElement('span');k.style.cssText='font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:700;color:#c8f050;flex:1';k.innerHTML=r.km+'<span style="font-size:11px;font-weight:300;color:rgba(255,255,255,.4)"> km</span>';
    var p=document.createElement('span');p.style.cssText='font-size:12px;font-weight:300;color:rgba(255,255,255,.5);margin-right:12px';p.textContent=r.paceStr+"''/km";
    var t=document.createElement('span');t.style.cssText='font-size:11px;font-weight:300;color:rgba(255,255,255,.3)';t.textContent=r.timeStr;
    row.appendChild(d);row.appendChild(k);row.appendChild(p);row.appendChild(t);body.appendChild(row);
  });

  sheet.appendChild(body);
  el.innerHTML='';el.appendChild(sheet);
  el.style.display='flex';
}


function showPaymentModal(type){
  var el=document.getElementById('payment-modal');
  if(!el){el=document.createElement('div');el.id='payment-modal';el.style.cssText='position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.9);backdrop-filter:blur(24px);display:flex;align-items:flex-end;justify-content:center;padding:0';el.addEventListener('click',function(e){if(e.target===el)el.style.display='none';});document.body.appendChild(el);}
  var configs={
    clap:{icon:'🦊',title:'오늘의 CLAP을 모두 사용했어요',desc:'매일 10개의 무료 CLAP이 제공됩니다.',
      plans:[{name:'CLAP 50개',price:'₩990',badge:'',key:'clap_50'},{name:'CLAP 무제한',price:'₩2,900/월',badge:'BEST',key:'clap_unlimited'}],
      note:'내일 자정에 10개가 자동으로 충전됩니다'},
    crew_large:{icon:'🏃',title:'크루 10명 이상은 PRO 플랜',desc:'대규모 크루를 운영하려면 Pro 플랜이 필요해요.',
      plans:[{name:'Pro 월간',price:'₩4,900/월',badge:'',key:'pro_month'},{name:'Pro 연간',price:'₩49,000/년',badge:'2개월 무료',key:'pro_year'}],
      note:'Pro 플랜: 크루 인원 무제한, CLAP 무제한, 배지'}
  };
  var c=configs[type]||configs.clap;
  el.innerHTML='';
  var sheet=document.createElement('div');sheet.style.cssText='width:100%;max-width:440px;background:#1a1a1a;border-radius:28px 28px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 44px;overflow:hidden';
  var heroDiv=document.createElement('div');heroDiv.style.cssText='background:linear-gradient(135deg,rgba(200,240,80,.08),rgba(200,240,80,.02));padding:28px 24px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06)';
  var iconEl=document.createElement('div');iconEl.style.cssText='font-size:52px;margin-bottom:10px';iconEl.textContent=c.icon;
  var titleEl=document.createElement('div');titleEl.setAttribute('style','font-size:24px;font-weight:900;color:#fff;line-height:1.2;margin-bottom:8px;font-family:Barlow Condensed,sans-serif');titleEl.textContent=c.title;
  var descEl=document.createElement('div');descEl.style.cssText='font-size:12px;font-weight:300;color:rgba(255,255,255,.45);line-height:1.5';descEl.textContent=c.desc;
  heroDiv.appendChild(iconEl);heroDiv.appendChild(titleEl);heroDiv.appendChild(descEl);sheet.appendChild(heroDiv);
  var plansDiv=document.createElement('div');plansDiv.style.cssText='padding:20px 20px 0';
  c.plans.forEach(function(p){
    var card=document.createElement('div');card.style.cssText='display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.04);border:1.5px solid '+(p.badge?'rgba(200,240,80,.3)':'rgba(255,255,255,.08)')+';border-radius:16px;padding:16px;margin-bottom:10px;cursor:pointer';
    (function(key){card.onclick=function(){processPurchase(key);};})(p.key);
    var cl=document.createElement('div');cl.style.cssText='flex:1';
    var nr=document.createElement('div');nr.style.cssText='display:flex;align-items:center;gap:8px';
    var pn=document.createElement('span');pn.style.cssText='font-size:14px;font-weight:500;color:#fff';pn.textContent=p.name;nr.appendChild(pn);
    if(p.badge){var b=document.createElement('span');b.style.cssText='font-size:9px;font-weight:700;background:#c8f050;color:#0a0a0a;padding:2px 7px;border-radius:4px';b.textContent=p.badge;nr.appendChild(b);}
    var pr=document.createElement('div');pr.setAttribute('style','font-size:20px;font-weight:800;color:#c8f050;margin-top:2px;font-family:Barlow Condensed,sans-serif');pr.textContent=p.price;
    cl.appendChild(nr);cl.appendChild(pr);
    var arrow=document.createElement('div');arrow.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>';
    card.appendChild(cl);card.appendChild(arrow);plansDiv.appendChild(card);
  });
  var noteDiv=document.createElement('div');noteDiv.style.cssText='text-align:center;padding:10px 0 4px';
  var noteSpan=document.createElement('span');noteSpan.style.cssText='font-size:10px;font-weight:300;color:rgba(255,255,255,.25)';noteSpan.textContent=c.note;noteDiv.appendChild(noteSpan);plansDiv.appendChild(noteDiv);
  var cancelBtn=document.createElement('button');cancelBtn.style.cssText='width:100%;height:44px;background:none;border:none;font-size:13px;font-weight:400;color:rgba(255,255,255,.35);cursor:pointer;margin-top:4px';cancelBtn.textContent='나중에';cancelBtn.onclick=function(){el.style.display='none';};plansDiv.appendChild(cancelBtn);
  sheet.appendChild(plansDiv);el.appendChild(sheet);el.style.display='flex';
}
function processPurchase(key){
  var el=document.getElementById('payment-modal');if(el)el.style.display='none';
  showToast('✅ 결제가 완료됐어요! ('+key+')');
  if(key.indexOf('clap')>=0){localStorage.setItem('clap_daily',JSON.stringify({date:new Date().toDateString(),count:0,unlimited:true}));}
}

// ANON RUNNERS
const ANON_RUNNERS=(function(){
  const nicks=['익명의 러너','새벽의 유령','밤의 러너','달리는 그림자','조용한 발걸음','바람처럼','도시의 유령','새벽 4시','혼자가 아닌','골목 러너','한강 유령','새벽별','이름없는 페이스','그림자 러너','도심 탈출자','묵묵한 발','야간 전문','새벽을 달리다','달리는 그림자2','고요한 발걸음','밤하늘 아래','소리없는 발','0시의 러너','새벽빛'];
  const paceBase=[258,265,272,280,288,295,303,312,320,330,342,355,368,380,400,415,430,445,460,480,295,310,325,340];
  return Array.from({length:24},(_,i)=>{
    const paceS=paceBase[i]+Math.floor(Math.random()*10-5);
    const pm=Math.floor(paceS/60),ps=paceS%60;
    const dist=parseFloat((2.1+Math.random()*13.4).toFixed(2));
    return{id:'ghost_'+i,nick:nicks[i],dist,paceS,paceStr:pm+"'"+String(ps).padStart(2,'0')+'"',time:Math.round(dist*paceS/60),em:['🦊','🐆','🦅','⚡','🔥'][i%5]};
  });
})();
const ANON_SORTED_DIST=[...ANON_RUNNERS].sort((a,b)=>b.dist-a.dist).slice(0,10);
const ANON_SORTED_PACE=[...ANON_RUNNERS].sort((a,b)=>a.paceS-b.paceS).slice(0,10);
const ANON_TOTAL_KM=parseFloat(ANON_RUNNERS.reduce((s,r)=>s+r.dist,0).toFixed(1));

function buildHomeLiveStats(){
  const cnt=document.getElementById('hm-runner-count'),tkm=document.getElementById('hm-total-km'),avgP=document.getElementById('hm-avg-pace'),active=document.getElementById('hm-active-now');
  if(cnt)cnt.textContent=ANON_RUNNERS.length;
  if(tkm)tkm.textContent=ANON_TOTAL_KM;
  if(active)active.textContent=Math.floor(ANON_RUNNERS.length*.33);
  if(avgP){const avgS=Math.round(ANON_RUNNERS.reduce((s,r)=>s+r.paceS,0)/ANON_RUNNERS.length),m=Math.floor(avgS/60),s2=avgS%60;avgP.textContent=m+"'"+String(s2).padStart(2,'0')+'"';}
}

function buildLeaderboard(type){
  const list=type==='dist'?ANON_SORTED_DIST:ANON_SORTED_PACE;
  const el=document.getElementById('lb-'+type);
  if(!el)return;el.innerHTML='';
  const COL=r=>r===1?'#d4b54a':r===2?'#a0aab4':r===3?'#b07444':'rgba(255,255,255,.35)';
  list.forEach((runner,i)=>{
    const rank=i+1,medal=rank<=3?['🥇','🥈','🥉'][rank-1]:rank;
    const mainVal=type==='dist'?`<span style="font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:800;color:#fff;line-height:1">${runner.dist.toFixed(2)}<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.35)"> km</span></span>`:`<span style="font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:800;color:#c8f050;line-height:1">${runner.paceStr}<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.35)"> /km</span></span>`;
    const subVal=type==='dist'?`<span style="font-size:10px;color:rgba(255,255,255,.3)">${runner.paceStr}/km · ${runner.time}분</span>`:`<span style="font-size:10px;color:rgba(255,255,255,.3)">${runner.dist.toFixed(2)}km · ${runner.time}분</span>`;
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';(function(rn){row.onclick=function(e){if(!e.target.closest('button'))showMemberProfile(rn);};})(runner);
    row.innerHTML=`<div style="width:32px;text-align:center;font-size:${rank<=3?'20':'13'}px;font-family:Barlow Condensed,sans-serif;font-weight:800;color:${COL(rank)};flex-shrink:0">${medal}</div><div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${runner.em}</div><div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:400;color:rgba(255,255,255,.6);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${runner.nick}</div><div>${subVal}</div></div><div style="text-align:right">${mainVal}</div>`;
    el.appendChild(row);
  });
}

function switchLbTab(type){
  document.querySelectorAll('.lb-tab').forEach(t=>{const isOn=t.dataset.lb===type;t.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';t.style.borderColor=isOn?'rgba(200,240,80,.3)':'rgba(255,255,255,.08)';t.style.color=isOn?'#c8f050':'rgba(255,255,255,.4)';});
  const dEl=document.getElementById('lb-dist'),pEl=document.getElementById('lb-pace');
  if(dEl)dEl.style.display=type==='dist'?'block':'none';
  if(pEl)pEl.style.display=type==='pace'?'block':'none';
}


// ── 인증샷 피드 ──
var SHOT_FEED_KEY = 'claprun_shot_feed_v1';

function getShotFeed() {
  try { return JSON.parse(localStorage.getItem(SHOT_FEED_KEY) || '[]'); } catch(e){ return []; }
}
function saveShotFeed(feed) {
  try { localStorage.setItem(SHOT_FEED_KEY, JSON.stringify(feed)); } catch(e){}
}

async function uploadToFeed() {
  var btn = document.getElementById('bupload');
  if (btn) { btn.disabled = true; btn.textContent = '올리는 중...'; }

  var card = document.getElementById('card');
  if (!card) { showToast('카드를 찾을 수 없어요'); if(btn){btn.disabled=false;btn.textContent='피드 올리기';} return; }

  try {
    var canvas = await html2canvas(card, {
      useCORS: true, allowTaint: true,
      scale: window.devicePixelRatio || 2,
      backgroundColor: null, logging: false,
      ignoreElements: function(el) {
        return el.id === 'shot-acts' || el.classList.contains('btabs');
      }
    });

    var dataUrl = canvas.toDataURL('image/jpeg', 0.85); // jpeg로 용량 줄이기

    // 현재 런 데이터
    var u = currentUser;
    var mins = Math.floor(runSec/60), secs = runSec%60;
    var paceS = runDist>0 ? Math.floor(runSec/runDist) : 0;
    var pm = Math.floor(paceS/60), ps = paceS%60;

    var post = {
      id: 'sp_' + Date.now(),
      em: u ? (u.avatar||'🦊') : '👏',
      user: u ? (u.nickname||'Runner') : 'Runner',
      dist: runDist>0.05 ? parseFloat(runDist.toFixed(2)) : 5.20,
      pace: runDist>0.05 ? (pm+"'"+String(ps).padStart(2,'0')+'"') : "5'12\"",
      time: runDist>0.05 ? (String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0')) : '26:58',
      caption: '',
      dataUrl: dataUrl,
      date: new Date().toLocaleDateString('ko-KR'),
      ts: Date.now(),
      likes: 0,
      likedByMe: false
    };

    // 캡션 입력 시트 열기
    openCaptionSheet(post);

  } catch(err) {
    console.error(err);
    showToast('업로드 실패 - 다시 시도해주세요');
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 10 12 5 7 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>피드 올리기'; }
  }
}

function openCaptionSheet(post) {
  // 간단한 캡션 입력 인라인 시트
  var existing = document.getElementById('caption-sheet');
  if (existing) existing.remove();

  var sheet = document.createElement('div');
  sheet.id = 'caption-sheet';
  sheet.style.cssText = 'position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:flex-end;justify-content:center';
  sheet.innerHTML = `
    <div style="width:100%;max-width:430px;background:#141414;border-radius:20px 20px 0 0;border-top:1px solid rgba(255,255,255,.08);padding:20px 20px 36px">
      <div style="width:36px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;margin:0 auto 18px"></div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:4px">피드에 올리기</div>
      <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:16px">${post.dist}km · ${post.pace}/km · ${post.time}</div>
      <textarea id="caption-input" placeholder="한 줄 메시지를 남겨보세요 (선택)" maxlength="60"
        style="width:100%;height:64px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;font-size:13px;color:#fff;font-family:'Space Grotesk',sans-serif;resize:none;outline:none;margin-bottom:14px"></textarea>
      <div style="display:flex;gap:10px">
        <button onclick="document.getElementById('caption-sheet').remove()" style="flex:1;height:48px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:13px;font-size:14px;font-weight:600;color:rgba(255,255,255,.5);cursor:pointer;touch-action:manipulation">취소</button>
        <button onclick="confirmUpload()" style="flex:2;height:48px;background:#c8f050;border:none;border-radius:13px;font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:800;color:#0a0a0a;cursor:pointer;touch-action:manipulation;box-shadow:0 4px 16px rgba(200,240,80,.3)">올리기 👏</button>
      </div>
    </div>`;

  // post 임시 저장
  sheet._post = post;
  window._pendingPost = post;
  document.body.appendChild(sheet);
  setTimeout(function(){ var inp=document.getElementById('caption-input'); if(inp)inp.focus(); }, 100);
}

function confirmUpload() {
  var post = window._pendingPost;
  if (!post) return;
  var inp = document.getElementById('caption-input');
  post.caption = inp ? (inp.value.trim() || '오늘도 달렸어요 🔥') : '오늘도 달렸어요 🔥';

  // 피드 앞에 추가
  var feed = getShotFeed();
  feed.unshift(post);
  if (feed.length > 50) feed.length = 50;
  saveShotFeed(feed);

  // INSTA_POSTS 맨 앞에도 추가 (홈 피드 즉시 반영)
  INSTA_POSTS.unshift({
    em: post.em, user: post.user, dist: post.dist,
    pace: post.pace, date: '방금', caption: post.caption,
    dataUrl: post.dataUrl,
    colors: ['#0d1a0d','#1a2e0d'], accentAngle: '145deg'
  });
  buildInstaFeed();

  document.getElementById('caption-sheet').remove();
  window._pendingPost = null;

  showToast('✅ 피드에 올렸어요!');
}

function openShotFeed() {
  renderShotFeedGrid();
  openModal('m-shot-feed');
}

function renderShotFeedGrid() {
  var grid = document.getElementById('shot-feed-grid');
  var countEl = document.getElementById('feed-count');
  if (!grid) return;

  // 저장된 피드 + 기본 샘플 병합
  var saved = getShotFeed();
  var all = saved.concat(INSTA_POSTS.map(function(p, i) {
    return {
      id: 'sample_'+i, em: p.em, user: p.user,
      dist: p.dist, pace: p.pace,
      caption: p.caption, date: p.date,
      dataUrl: null, colors: p.colors,
      accentAngle: p.accentAngle,
      likes: Math.floor(Math.random()*24)+1,
      likedByMe: false, ts: Date.now() - i * 3600000
    };
  }));

  if (countEl) countEl.textContent = all.length + '개의 인증샷 · 내 주변 5km';

  grid.innerHTML = '';
  all.forEach(function(post) {
    var card = document.createElement('div');
    card.style.cssText = 'border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.07);background:#111;cursor:pointer;transition:transform .15s';

    var imgHtml = post.dataUrl
      ? '<img src="'+post.dataUrl+'" style="width:100%;aspect-ratio:1;object-fit:cover;display:block">'
      : '<div style="aspect-ratio:1;background:linear-gradient('+post.accentAngle+','+(post.colors||['#111','#222']).join(',')+')'
        +';display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px">'
        +'<div style="font-size:32px">'+post.em+'</div>'
        +'<div style="font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:900;color:#c8f050;line-height:1">'+post.dist.toFixed(2)+'</div>'
        +'<div style="font-size:9px;color:rgba(200,240,80,.6);letter-spacing:.1em">km</div>'
        +'</div>';

    var likeId = 'like_'+post.id;
    card.innerHTML = imgHtml
      + '<div style="padding:9px 10px 10px">'
      + '<div style="font-size:11px;font-weight:600;color:rgba(255,255,255,.8);margin-bottom:2px">'+post.user+'</div>'
      + '<div style="font-size:10px;color:rgba(255,255,255,.4);line-height:1.4;margin-bottom:6px">'+post.caption+'</div>'
      + '<div style="display:flex;align-items:center;justify-content:space-between">'
      + '<span style="font-size:9px;color:rgba(255,255,255,.2)">'+post.date+'</span>'
      + '<button id="'+likeId+'" onclick="toggleLike(this.dataset.pid,this)" data-pid="'+post.id+'" '
      + 'style="background:none;border:none;font-size:12px;color:rgba(255,255,255,.35);cursor:pointer;display:flex;align-items:center;gap:3px;touch-action:manipulation;padding:2px 4px">'
      + '👏 <span class="like-count">'+(post.likes||0)+'</span></button>'
      + '</div>'
      + '</div>';

    card.addEventListener('mouseenter', function(){ card.style.transform='scale(.97)'; });
    card.addEventListener('mouseleave', function(){ card.style.transform=''; });
    grid.appendChild(card);
  });
}

function toggleLike(postId, btn) {
  var countEl = btn.querySelector('.like-count');
  var cur = parseInt(countEl.textContent) || 0;
  var liked = btn.getAttribute('data-liked') === '1';
  if (liked) {
    countEl.textContent = cur - 1;
    btn.setAttribute('data-liked','0');
    btn.style.color = 'rgba(255,255,255,.35)';
  } else {
    countEl.textContent = cur + 1;
    btn.setAttribute('data-liked','1');
    btn.style.color = '#c8f050';
    if(navigator.vibrate) navigator.vibrate(30);
  }
}

function buildInstaFeed(){
  const feed=document.getElementById('insta-feed');
  if(!feed)return;feed.innerHTML='';
  INSTA_POSTS.forEach(post=>{
    const card=document.createElement('div');
    card.style.cssText='flex-shrink:0;width:160px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.07);cursor:pointer;transition:transform .15s;background:'+post.colors[0];
    var imgArea = post.dataUrl
      ? '<img src="'+post.dataUrl+'" style="width:100%;height:160px;object-fit:cover;display:block">'
      : '<div style="height:160px;background:linear-gradient('+post.accentAngle+','+post.colors[0]+','+post.colors[1]+');position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden"><div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 70%,rgba(200,240,80,.08),transparent 55%)"></div><div style="text-align:center;position:relative"><div style="font-size:42px">'+post.em+'</div><div style="font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;color:#c8f050;line-height:1">'+post.dist.toFixed(2)+'</div><div style="font-size:10px;color:rgba(200,240,80,.6);letter-spacing:.1em">km</div></div><div style="position:absolute;bottom:8px;left:10px;right:10px"><div style="font-family:Barlow Condensed,sans-serif;font-size:12px;font-weight:700;color:rgba(255,255,255,.7)">'+post.pace+'<span style="font-size:9px;opacity:.6"> /km</span></div></div></div>';
    card.innerHTML = imgArea + '<div style="padding:10px 11px 12px"><div style="font-size:11px;color:rgba(255,255,255,.75);margin-bottom:4px">'+post.user+'</div><div style="font-size:10px;color:rgba(255,255,255,.45);line-height:1.4">'+post.caption+'</div><div style="font-size:8px;color:rgba(255,255,255,.2);margin-top:5px">'+post.date+'</div></div>';
    card.addEventListener('click',()=>showToast('🦊 '+post.user+' · '+post.dist+'km'));
    card.addEventListener('mouseenter',()=>{card.style.transform='scale(.97)';});
    card.addEventListener('mouseleave',()=>{card.style.transform='';});
    feed.appendChild(card);
  });
}

function initHome(){
  buildHomeLiveStats();buildInstaFeed();buildLeaderboard('dist');buildLeaderboard('pace');
  setInterval(()=>{
    const cnt=document.getElementById('hm-runner-count'),active=document.getElementById('hm-active-now');
    if(cnt){const n=parseInt(cnt.textContent)+(Math.random()>.6?(Math.random()>.5?1:-1):0);cnt.textContent=Math.max(18,Math.min(35,n));}
    if(active){const a=parseInt(active.textContent)+(Math.random()>.7?(Math.random()>.5?1:-1):0);active.textContent=Math.max(6,Math.min(12,a));}
  },4000);
}
initHome();

// ROUTE DATA
const ROUTE=[[37.5665,126.978],[37.567,126.979],[37.5676,126.9796],[37.5682,126.9803],[37.5687,126.9814],[37.5681,126.9822],[37.5673,126.9828],[37.5664,126.9822],[37.5656,126.9815],[37.565,126.9804],[37.5648,126.9793],[37.5654,126.9782],[37.566,126.9778],[37.5665,126.978]];
const ROUTES=[ROUTE,ROUTE.map(p=>[p[0]+.003,p[1]-.002]),ROUTE.map(p=>[p[0]-.002,p[1]+.003])];

// STATE
let curTab='home',selEm='🦊',recInited=false;

// SPLASH
function hideSplash(){
  const sp=document.getElementById('splash');if(!sp)return;
  sp.classList.add('out');
  setTimeout(()=>{if(sp.parentNode)sp.parentNode.removeChild(sp);if(!GR_API.currentUser())showLoginScreen();},800);
}

// CLOCK
function tick(){
  const n=new Date(),p=v=>String(v).padStart(2,'0');
  const clockEl=document.getElementById('clock');if(clockEl)clockEl.textContent=`${p(n.getHours())}:${p(n.getMinutes())}`;
  const ds=`${n.getFullYear()}.${p(n.getMonth()+1)}.${p(n.getDate())}`;
  const dtg=document.getElementById('dt-g');if(dtg)dtg.innerHTML=`${ds}<br>${n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}`;
  const bd=document.getElementById('bd');if(bd)bd.textContent=ds;
  const sc=document.getElementById('setup-clock');if(sc)sc.textContent=`${p(n.getHours())}:${p(n.getMinutes())}`;
}
tick();setInterval(tick,1000);

// TABS
function goTab(v){
  if(v===curTab&&v!=='run')return;curTab=v;
  // If going to run tab and finish screen showing, go back to setup
  if(v==='run'){
    var rfinishEl=document.getElementById('rfinish');
    if(rfinishEl&&rfinishEl.classList.contains('on')){
      // keep finish screen - user can navigate away and come back
    }
    renderRunCrewBadge();
  }
  document.querySelectorAll('.mview').forEach(el=>el.classList.remove('on'));
  const view=document.getElementById('v-'+v);if(view)view.classList.add('on');
  document.querySelectorAll('.btab').forEach(t=>t.classList.toggle('on',t.dataset.v===v));
  if(v==='crew'){switchRoomTab('browse');renderRoomTabs();}
  if(v==='coursemap'){initCourseMap();}
  if(v==='records'){initRec();updateRecCrews();}
  // nav-profile: records 탭에서 숨기기 (우상단 중복 방지)
  var np=document.getElementById('nav-profile');
  if(np) np.style.visibility=(v==='records')?'hidden':'visible';
  if(v==='shot')applyRank();
}
document.getElementById('btabs').addEventListener('click',e=>{const b=e.target.closest('.btab');if(b)goTab(b.dataset.v);});

// GOAL TYPE
let goalType='dist',goalVal='5';
document.querySelectorAll('.gt').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.gt').forEach(x=>x.classList.remove('on'));el.classList.add('on');goalType=el.dataset.gt;
    ['gvd','gvt','gvs'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});
    const mapId={dist:'gvd',time:'gvt',speed:'gvs'};
    const activeGrid=document.getElementById(mapId[goalType]);if(activeGrid)activeGrid.style.display='grid';
    const onEl=document.querySelector('#'+(mapId[goalType]||'gvd')+' .gv.on');goalVal=onEl?onEl.dataset.v:'5';
  });
});
['gvd','gvt','gvs'].forEach(gid=>{
  const grid=document.getElementById(gid);if(!grid)return;
  grid.querySelectorAll('.gv').forEach(el=>{
    el.addEventListener('click',()=>{grid.querySelectorAll('.gv').forEach(x=>x.classList.remove('on'));el.classList.add('on');goalVal=el.dataset.v;});
  });
});

// RUN STATE
let runTimer=null,runSec=0,runDist=0,runPaused=false,watchId=null;
let nearbyRunnerTimer=null;
let locGranted=false,userLat=37.5665,userLng=126.978;
let pathCoords=[],clapCount=0;

function requestHealthAccess(){const m=document.getElementById('health-modal');if(m)m.style.display='flex';}
function denyHealthAccess(){
  var m=document.getElementById('health-modal');
  if(m){m.style.display='none';}
  showToast('건강 데이터를 나중에 연동할 수 있어요');
  startRun();
}
function grantHealthAccess(){
  const m=document.getElementById('health-modal');
  if(m)m.style.display='none';
  showLocationModal();
}
function showLocationModal(){
  let el=document.getElementById('location-modal');
  if(!el){
    el=document.createElement('div');el.id='location-modal';
    el.style.cssText='position:fixed;inset:0;z-index:250;background:rgba(5,5,5,.95);backdrop-filter:blur(28px);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:0 0 40px';
    document.body.appendChild(el);
  }
  el.innerHTML='<div style="width:100%;max-width:420px;background:#161616;border-radius:26px 26px 22px 22px;overflow:hidden;border:1px solid rgba(255,255,255,.08)">'
    +'<div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>'
    +'<div style="display:flex;align-items:center;justify-content:center;gap:16px;padding:24px 28px 0">'
      +'<div style="width:56px;height:56px;border-radius:16px;background:#1d4ed8;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(29,78,216,.4)">'
        +'<svg width="28" height="28" viewBox="0 0 24 24" fill="white"><circle cx="12" cy="10" r="3"/><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>'
      +'</div>'
      +'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>'
      +'<div style="width:56px;height:56px;border-radius:16px;background:rgba(200,240,80,.12);border:1.5px solid rgba(200,240,80,.2);display:flex;align-items:center;justify-content:center"><span style="font-size:28px">👏</span></div>'
    +'</div>'
    +'<div style="padding:20px 24px 0;text-align:center">'
      +'<div style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:900;color:#fff;margin-bottom:8px;line-height:1.2">"ClapRun"이 내 위치에<br>접근하려고 합니다</div>'
      +'<div style="font-size:12px;font-weight:300;color:rgba(255,255,255,.4);line-height:1.6;margin-bottom:4px">달린 경로와 거리를 정확하게 기록하고,<br>주변 러너를 감지하는 데 사용됩니다.</div>'
    +'</div>'
    +'<div style="margin:14px 20px 0;background:rgba(255,255,255,.04);border-radius:14px;overflow:hidden">'
      +'<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.05)">'
        +'<div style="width:32px;height:32px;border-radius:9px;background:rgba(29,78,216,.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">'
          +'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="10" r="3"/><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>'
        +'</div>'
        +'<div><div style="font-size:13px;font-weight:400;color:rgba(255,255,255,.85)">정확한 위치 (GPS)</div><div style="font-size:11px;font-weight:300;color:rgba(255,255,255,.35)">달린 경로 · 거리 측정</div></div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:12px;padding:12px 16px">'
        +'<div style="width:32px;height:32px;border-radius:9px;background:rgba(29,78,216,.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">'
          +'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>'
        +'</div>'
        +'<div><div style="font-size:13px;font-weight:400;color:rgba(255,255,255,.85)">주변 러너 감지</div><div style="font-size:11px;font-weight:300;color:rgba(255,255,255,.35)">2km 반경 익명 러너 현황</div></div>'
      +'</div>'
    +'</div>'
    +'<div style="display:flex;flex-direction:column;gap:10px;padding:18px 20px 28px">'
      +'<button onclick="grantLocationAccess()" style="width:100%;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:\'Barlow Condensed\',sans-serif;font-size:18px;font-weight:900;letter-spacing:.06em;color:#0a0a0a;cursor:pointer">앱 사용 중 허용</button>'
      +'<button onclick="denyLocationAccess()" style="width:100%;height:46px;background:none;border:1.5px solid rgba(255,255,255,.1);border-radius:16px;font-family:\'Barlow Condensed\',sans-serif;font-size:15px;font-weight:400;color:rgba(255,255,255,.4);cursor:pointer">허용 안 함</button>'
    +'</div>'
  +'</div>';
  el.style.display='flex';
}
function grantLocationAccess(){
  var m=document.getElementById('location-modal');
  if(m){m.style.opacity='0';m.style.transition='opacity .3s';setTimeout(function(){if(m.parentNode)m.parentNode.removeChild(m);},300);}
  locGranted=true;
  if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{userLat=pos.coords.latitude;userLng=pos.coords.longitude;},err=>{console.warn('GPS ('+err.code+'): 위치 권한이 없거나 사용 불가합니다. 시뮬레이션 모드로 전환합니다.');locGranted=false;},{enableHighAccuracy:true,timeout:8000});}
  showToast('📍 위치 서비스가 허용됐어요');startRun();
}
function denyLocationAccess(){
  const m=document.getElementById('location-modal');if(m)m.style.display='none';
  locGranted=false;showToast('GPS 없이 시뮬레이션 모드로 진행됩니다');startRun();
}

function initRunSVG(){
  if(typeof runMapboxMap!=="undefined"&&runMapboxMap){return;}
  const rp=document.getElementById('run-path-line')||document.getElementById('run-path');
  const gp=document.getElementById('ghost-path');
  if(!rp)return;
  try{
    const len=rp.getTotalLength();
    rp.style.strokeDasharray=len;
    rp.style.strokeDashoffset=len;
    if(gp){gp.style.strokeDasharray=len;gp.style.strokeDashoffset=0;}
    // Reset runner dot to start
    const pt=rp.getPointAtLength(0);
    const dot=document.getElementById('runner-dot'),glow=document.getElementById('runner-glow');
    if(dot){dot.setAttribute('cx',pt.x);dot.setAttribute('cy',pt.y);}
    if(glow){glow.setAttribute('cx',pt.x);glow.setAttribute('cy',pt.y);}
  }catch(e){}
}
function updateRunSVG(pct){
  if(typeof runMapboxMap!=="undefined"&&runMapboxMap){return;}
  const rp=document.getElementById('run-path-line')||document.getElementById('run-path');
  if(!rp)return;
  try{
    const len=rp.getTotalLength();rp.style.strokeDashoffset=len*(1-Math.min(pct,1));
    const pt=rp.getPointAtLength(len*Math.min(pct,.999));
    const dot=document.getElementById('runner-dot'),glow=document.getElementById('runner-glow');
    if(dot){dot.setAttribute('cx',pt.x);dot.setAttribute('cy',pt.y);}
    if(glow){glow.setAttribute('cx',pt.x);glow.setAttribute('cy',pt.y);}
  }catch(e){}
}

function buildRacingTrack(){
  const container=document.getElementById('track-ghosts');if(!container)return;
  container.innerHTML='';
  const maxGoal=parseFloat(goalVal)||5;
  ANON_RUNNERS.slice(0,5).forEach(r=>{
    const pct=Math.min(r.dist/maxGoal*100,92);
    const icon=document.createElement('div');
    icon.style.cssText=`position:absolute;top:50%;left:${pct}%;transform:translate(-50%,-50%);font-size:16px;z-index:1`;
    icon.textContent=r.em;container.appendChild(icon);
  });
  const myIcon=document.createElement('div');
  myIcon.id='my-ghost';myIcon.style.cssText='position:absolute;top:50%;left:0%;transform:translate(-50%,-50%);font-size:22px;z-index:5;filter:drop-shadow(0 0 6px #c8f050)';
  myIcon.textContent=currentUser?currentUser.avatar||'🦊':'🦊';container.appendChild(myIcon);
}

function updateRacingTrack(pct){
  const mg=document.getElementById('my-ghost');if(mg)mg.style.left=Math.min(pct,92)+'%';
  const tf=document.getElementById('track-fill');if(tf)tf.style.width=Math.min(pct,100)+'%';
}




// ── COURSE SHARING ──
function shareCourse(idOrCourse) {
  var c = null;
  if (typeof idOrCourse === 'object') {
    c = idOrCourse;
  } else {
    c = COURSE_DATA.find(function(x){return x.id===idOrCourse;});
  }
  if (!c) { showToast('코스 정보를 찾을 수 없어요'); return; }

  var sheet = document.getElementById('course-share-sheet');
  if (!sheet) {
    sheet = document.createElement('div');
    sheet.id = 'course-share-sheet';
    sheet.style.cssText = 'position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.88);backdrop-filter:blur(20px);display:none;align-items:flex-end;justify-content:center;pointer-events:auto';
    sheet.addEventListener('click', function(e){ if(e.target===sheet) closeShareSheet(); });
    document.body.appendChild(sheet);
  }

  var color = c.color || '#c8f050';
  var dist  = String(c.dist || c.distKm || '?');
  var name  = c.name || '코스';
  var area  = c.area || '내 코스';
  var shareCode = 'GRC-' + (Math.abs(name.split('').reduce(function(a,ch){return (a*17+ch.charCodeAt(0))|0;},0)) % 90000 + 10000);

  // Build sheet DOM
  var wrap = document.createElement('div');
  wrap.style.cssText = 'width:100%;max-width:440px;background:#161616;border-radius:24px 24px 0 0;border:1px solid rgba(255,255,255,.08);overflow:hidden;max-height:80vh;overflow-y:auto;padding-bottom:40px;pointer-events:auto';

  // Handle bar
  var hb = document.createElement('div');
  hb.style.cssText = 'display:flex;justify-content:center;padding:12px 0 0';
  var hbd = document.createElement('div');
  hbd.style.cssText = 'width:32px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)';
  hb.appendChild(hbd); wrap.appendChild(hb);

  var body = document.createElement('div');
  body.style.cssText = 'padding:16px 20px 0;pointer-events:auto';

  // Course preview
  var preview = document.createElement('div');
  preview.style.cssText = 'background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:14px;margin-bottom:18px';
  var icon = document.createElement('div');
  icon.style.cssText = 'width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;background:'+color+'22;border:1px solid '+color+'44';
  icon.textContent = '🗺';
  var pInfo = document.createElement('div');
  pInfo.style.cssText = 'flex:1';
  var pName = document.createElement('div');
  pName.style.cssText = 'font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:900;color:#fff;line-height:1';
  pName.textContent = name;
  var pSub = document.createElement('div');
  pSub.style.cssText = 'font-size:11px;font-weight:300;color:rgba(255,255,255,.4);margin-top:3px';
  pSub.textContent = dist + 'km · ' + area;
  pInfo.appendChild(pName); pInfo.appendChild(pSub);
  var pKm = document.createElement('div');
  pKm.style.cssText = 'font-family:Barlow Condensed,sans-serif;font-size:20px;font-weight:900;color:'+color;
  pKm.textContent = dist + ' km';
  preview.appendChild(icon); preview.appendChild(pInfo); preview.appendChild(pKm);
  body.appendChild(preview);

  // Share code label
  var codeLbl = document.createElement('div');
  codeLbl.style.cssText = 'font-size:10px;font-weight:400;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:8px';
  codeLbl.textContent = '공유 코드';
  body.appendChild(codeLbl);

  // Code box
  var codeBox = document.createElement('div');
  codeBox.style.cssText = 'background:rgba(200,240,80,.07);border:1.5px solid rgba(200,240,80,.2);border-radius:14px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;margin-bottom:18px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;pointer-events:auto';
  codeBox.onclick = function(){ copyRoomCode(shareCode); };
  var codeSpan = document.createElement('span');
  codeSpan.style.cssText = 'font-family:Barlow Condensed,sans-serif;font-size:24px;font-weight:900;letter-spacing:.12em;color:#c8f050';
  codeSpan.textContent = shareCode;
  var codeCopy = document.createElement('span');
  codeCopy.style.cssText = 'font-size:12px;color:rgba(255,255,255,.4);pointer-events:none';
  codeCopy.textContent = '📋 복사';
  codeBox.appendChild(codeSpan); codeBox.appendChild(codeCopy);
  body.appendChild(codeBox);

  // Share buttons grid
  var grid = document.createElement('div');
  grid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px;pointer-events:auto';
  var btns = [
    {emoji:'🔗', label:'링크 복사', bg:'rgba(255,255,255,.04)', border:'rgba(255,255,255,.08)', col:'rgba(255,255,255,.5)', fn: function(){ copyRoomCode('claprun://course/'+shareCode); }},
    {emoji:'💬', label:'카카오',    bg:'rgba(254,229,0,.08)',   border:'rgba(254,229,0,.15)',   col:'rgba(254,229,0,.7)',   fn: function(){ shareToKakao(name,shareCode); }},
    {emoji:'📸', label:'인스타',    bg:'rgba(225,48,108,.08)',  border:'rgba(225,48,108,.15)',  col:'rgba(225,48,108,.7)',  fn: function(){ shareToInsta(name); }},
  ];
  btns.forEach(function(b){
    var btn = document.createElement('button');
    btn.style.cssText = 'height:56px;background:'+b.bg+';border:1px solid '+b.border+';border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;pointer-events:auto;touch-action:manipulation;-webkit-tap-highlight-color:transparent';
    btn.innerHTML = '<span style="font-size:20px">'+b.emoji+'</span><span style="font-size:9px;font-weight:500;color:'+b.col+';letter-spacing:.04em">'+b.label+'</span>';
    btn.onclick = b.fn;
    grid.appendChild(btn);
  });
  body.appendChild(grid);

  // Friends section
  var friendsLbl = document.createElement('div');
  friendsLbl.style.cssText = 'font-size:10px;font-weight:400;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:8px';
  friendsLbl.textContent = '친구에게 보내기';
  body.appendChild(friendsLbl);

  var friends = getFriends();
  if (friends.length === 0) {
    var emptyDiv = document.createElement('div');
    emptyDiv.style.cssText = 'text-align:center;padding:20px 0;font-size:12px;font-weight:300;color:rgba(255,255,255,.3)';
    emptyDiv.textContent = '친구를 추가하면 코스를 공유할 수 있어요';
    body.appendChild(emptyDiv);
  } else {
    friends.forEach(function(f){
      var fid = f.id, fname = f.nick||'친구', fat = f.atCode||'AF-??????', fem = f.em||'👤';
      var row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';
      row.onclick = function(){ sendCourseToFriend(fid, name, shareCode); };
      var av = document.createElement('div');
      av.style.cssText = 'width:40px;height:40px;border-radius:50%;background:rgba(200,240,80,.08);border:1.5px solid rgba(200,240,80,.15);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0';
      av.textContent = fem;
      var info = document.createElement('div');info.style.cssText='flex:1';
      var nm = document.createElement('div');nm.style.cssText='font-size:14px;color:rgba(255,255,255,.85)';nm.textContent=fname;
      var at = document.createElement('div');at.style.cssText='font-size:10px;font-weight:300;color:rgba(200,240,80,.5);letter-spacing:.06em';at.textContent=fat;
      info.appendChild(nm);info.appendChild(at);
      var arr = document.createElement('span');arr.style.cssText='font-size:12px;color:rgba(255,255,255,.3)';arr.textContent='›';
      row.appendChild(av);row.appendChild(info);row.appendChild(arr);
      body.appendChild(row);
    });
  }

  wrap.appendChild(body);
  sheet.innerHTML = '';
  sheet.appendChild(wrap);
  sheet.style.display = 'flex';
  requestAnimationFrame(function(){
    wrap.style.transform = 'translateY(100%)';
    requestAnimationFrame(function(){
      wrap.style.transition = 'transform .3s cubic-bezier(.22,1,.36,1)';
      wrap.style.transform = 'translateY(0)';
    });
  });
}


function closeShareSheet() {
  var sheet = document.getElementById('course-share-sheet');
  if (sheet) sheet.style.display = 'none';
}

function sendCourseToFriend(friendId, courseName, code) {
  var friends = getFriends();
  var f = friends.find(function(x){return x.id===friendId;});
  if (!f) return;
  closeShareSheet();
  showToast('✅ '+f.nick+'에게 '+courseName+' 공유됨!');
  // Simulate message in crew room if one exists
}

function shareToKakao(name, code) {
  closeShareSheet();
  showToast('카카오로 공유: '+name+' ('+code+')');
}
function shareToInsta(name) {
  closeShareSheet();
  showToast('인스타그램 스토리 공유 준비 중');
}

// ══════════════════════════════════════════
// COURSE MAP SYSTEM
// ══════════════════════════════════════════
let cmDrawing = false;
let cmMode = 'draw'; // 'draw' | 'move'
let cmDrawPoints = [];
let cmSelectedCourse = null;
let activeGuideCourse = null; // 런 중 가이드 코스
let myCourses = [];

const COURSE_DATA = [
  {id:1, name:'여의도 한강 루프', dist:'5.0', runners:76, color:'#c8f050', area:'여의도 한강공원', badge:'인기',
   lat:37.5265, lng:126.9310,
   latLngs:[
     [37.5280,126.9235],[37.5268,126.9245],[37.5255,126.9265],[37.5245,126.9290],
     [37.5240,126.9320],[37.5248,126.9355],[37.5262,126.9375],[37.5278,126.9360],
     [37.5288,126.9335],[37.5285,126.9305],[37.5280,126.9280],[37.5280,126.9235]
   ]},
  {id:2, name:'남산 하트런', dist:'3.2', runners:45, color:'#a78bfa', area:'남산공원', badge:'추천',
   lat:37.5512, lng:126.9882,
   latLngs:[
     [37.5500,126.9840],[37.5508,126.9855],[37.5518,126.9870],[37.5528,126.9880],
     [37.5535,126.9895],[37.5530,126.9910],[37.5520,126.9920],[37.5510,126.9915],
     [37.5500,126.9900],[37.5493,126.9880],[37.5500,126.9860],[37.5500,126.9840]
   ]},
  {id:3, name:'나만의 코스', dist:'2.1', runners:21, color:'#60a5fa', area:'잠실', badge:'',
   lat:37.5133, lng:127.1028,
   latLngs:[
     [37.5133,127.1000],[37.5140,127.1015],[37.5148,127.1028],[37.5143,127.1045],
     [37.5135,127.1055],[37.5125,127.1048],[37.5118,127.1035],[37.5122,127.1018],
     [37.5133,127.1000]
   ]},
  {id:4, name:'강남 야경 런', dist:'7.5', runners:12, color:'#fbbf24', area:'강남구', badge:'',
   lat:37.4979, lng:127.0276,
   latLngs:[
     [37.4979,127.0240],[37.4990,127.0255],[37.5002,127.0270],[37.5010,127.0285],
     [37.5015,127.0305],[37.5008,127.0325],[37.4995,127.0335],[37.4980,127.0330],
     [37.4968,127.0315],[37.4960,127.0295],[37.4965,127.0275],[37.4975,127.0255],
     [37.4979,127.0240]
   ]},
];

function switchCmTab(tab) {
  document.querySelectorAll('.cm-tab').forEach(function(t){
    var isOn = t.dataset.cm === tab;
    t.style.background = isOn ? 'rgba(200,240,80,.12)' : 'rgba(255,255,255,.04)';
    t.style.border = isOn ? '1px solid rgba(200,240,80,.3)' : '1px solid rgba(255,255,255,.08)';
    t.style.color = isOn ? '#c8f050' : 'rgba(255,255,255,.45)';
  });
  document.getElementById('cm-pane-nearby').style.display = tab === 'nearby' ? 'block' : 'none';
  document.getElementById('cm-pane-mine').style.display   = tab === 'mine'   ? 'block' : 'none';
  if (tab === 'mine') renderMyCourses();
  if (tab === 'nearby') renderNearbyCourses();
  // Highlight relevant courses on map
  highlightMapCourses(tab);
}


function renderNearbyCourses() {
  var container = document.getElementById('cm-nearby-cards');
  if (!container) return;
  // 현재 위치 기준 거리 계산
  var courses = COURSE_DATA.map(function(c) {
    var d = haversine(userLat, userLng, c.lat, c.lng);
    return Object.assign({}, c, {distFromUser: d});
  });
  // 5km 이내 우선, 없으면 전체 가까운 순
  var nearby = courses.filter(function(c){ return c.distFromUser <= 5; });
  if (nearby.length === 0) nearby = courses.slice().sort(function(a,b){ return a.distFromUser - b.distFromUser; }).slice(0,4);
  nearby.sort(function(a,b){ return a.distFromUser - b.distFromUser; });

  container.innerHTML = '';
  if (nearby.length === 0) {
    container.innerHTML = '<div style="color:rgba(255,255,255,.3);font-size:12px;padding:20px">주변 코스를 찾을 수 없어요</div>';
    return;
  }

  // SVG 경로 패턴들
  var svgPaths = [
    'M 48 38 Q 30 30 28 45 Q 25 62 48 66 Q 80 70 100 68 Q 130 70 155 62 Q 178 55 178 45 Q 178 33 155 27 Q 130 22 100 24 Q 80 22 48 38 Z',
    'M 38 48 Q 28 35 35 22 Q 42 8 58 18 Q 66 8 75 18 Q 92 6 95 24 Q 98 38 78 52 Q 60 64 38 48 Z',
    'M 80 50 Q 95 30 115 40 Q 135 50 128 66 Q 118 78 98 75 Q 78 72 80 50 Z',
    'M 20 60 L 50 20 L 90 45 L 130 15 L 170 40 L 190 60 L 130 70 L 80 68 Z',
    'M 30 55 Q 50 20 80 30 Q 110 40 130 25 Q 160 10 175 40 Q 185 60 160 70 Q 130 80 90 72 Q 50 65 30 55 Z',
  ];
  var emojis = ['🦊','🐆','🦅','🌊','🔥','⚡','🌙','🚀'];

  nearby.forEach(function(c, i) {
    var card = document.createElement('div');
    card.className = 'cm-card';
    card.style.cssText = 'width:200px;background:rgba(20,20,20,.95);border:1px solid '+hexToRgba(c.color,.2)+';border-radius:16px;overflow:hidden;cursor:pointer;flex-shrink:0;touch-action:manipulation';
    card.onclick = function(){ selectCourse(c.id); };

    var distLabel = c.distFromUser < 1 ? Math.round(c.distFromUser*1000)+'m' : c.distFromUser.toFixed(1)+'km';
    var svgPath = svgPaths[i % svgPaths.length];
    var em1 = emojis[i % emojis.length];
    var em2 = emojis[(i+2) % emojis.length];

    card.innerHTML =
      '<div style="height:80px;position:relative;overflow:hidden;background:#111">' +
        '<svg width="200" height="80" viewBox="0 0 200 80">' +
          '<rect width="200" height="80" fill="#111"/>' +
          '<path d="'+svgPath+'" fill="'+hexToRgba(c.color,.08)+'" stroke="'+c.color+'" stroke-width="2" stroke-dasharray="5 3"/>' +
          '<circle cx="100" cy="46" r="3" fill="'+c.color+'"/>' +
        '</svg>' +
        '<div style="position:absolute;top:8px;left:10px;background:'+hexToRgba(c.color,.15)+';border:1px solid '+hexToRgba(c.color,.3)+';border-radius:5px;padding:2px 7px;font-family:Barlow Condensed,sans-serif;font-size:10px;font-weight:700;color:'+c.color+';letter-spacing:.06em">'+c.dist+' km</div>' +
        (c.badge ? '<div style="position:absolute;top:8px;right:10px;background:rgba(0,0,0,.5);border-radius:4px;padding:2px 6px;font-size:9px;font-weight:700;color:'+c.color+'">'+c.badge+'</div>' : '') +
      '</div>' +
      '<div style="padding:10px 12px">' +
        '<div style="font-family:Barlow Condensed,sans-serif;font-size:16px;font-weight:900;color:#fff;line-height:1;margin-bottom:3px">'+c.name+'</div>' +
        '<div style="font-size:10px;font-weight:300;color:rgba(255,255,255,.4);letter-spacing:.04em;margin-bottom:8px">📍 '+c.area+' · <span style="color:rgba(200,240,80,.6)">내 위치에서 '+distLabel+'</span></div>' +
        '<div style="display:flex;align-items:center;gap:8px">' +
          '<div style="display:flex">' +
            '<div style="width:20px;height:20px;border-radius:50%;background:'+hexToRgba(c.color,.15)+';border:1.5px solid '+hexToRgba(c.color,.3)+';display:flex;align-items:center;justify-content:center;font-size:10px">'+em1+'</div>' +
            '<div style="width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:10px;margin-left:-6px">'+em2+'</div>' +
          '</div>' +
          '<span style="font-size:10px;font-weight:300;color:rgba(255,255,255,.35)">+'+c.runners+'명 러닝 중</span>' +
        '</div>' +
      '</div>';
    container.appendChild(card);
  });
}

function hexToRgba(hex, alpha) {
  var r=0,g=0,b=0;
  if(hex.length===7){ r=parseInt(hex.slice(1,3),16); g=parseInt(hex.slice(3,5),16); b=parseInt(hex.slice(5,7),16); }
  return 'rgba('+r+','+g+','+b+','+alpha+')';
}


function startMyCourseRun(c) {
  activeGuideCourse = c;
  goalType = 'dist';
  goalVal = String(parseFloat(c.dist || c.distKm || '3'));
  goTab('run');
  showToast('🏃 ' + c.name + ' 코스로 달리기 시작!');
  // 가이드는 initRunKakaoMap의 load 콜백에서 자동 처리
  // 이미 지도가 로드된 상태라면 바로 그리기
  if (runMapboxMap && runMapboxMap.isStyleLoaded()) {
    showGuideOnRunMap(c);
  }
}

function showGuideOnRunMap(c) {
  if (!runMapboxMap || !c.latLngs || c.latLngs.length < 2) return;
  // latLngs는 [lat,lng] → mapbox는 [lng,lat]
  var coords = c.latLngs.map(function(ll){ return [ll[1], ll[0]]; });
  function doAdd() {
    if (runMapboxMap.getLayer('guide-layer')) runMapboxMap.removeLayer('guide-layer');
    if (runMapboxMap.getSource('guide-path')) runMapboxMap.removeSource('guide-path');
    // Kakao: 소스/레이어 불필요
    // Kakao: 소스/레이어 불필요
    // 시작점 마커
    var startEl = document.createElement('div');
    startEl.style.cssText = 'width:12px;height:12px;border-radius:50%;background:#c8f050;border:2px solid #fff;box-shadow:0 0 8px rgba(200,240,80,.8)';
    new kakao.maps.CustomOverlay({
      position: new kakao.maps.LatLng(coords[0][1], coords[0][0]),
      content: startEl, zIndex: 10
    }).setMap(runMapboxMap);
    // 끝점 마커
    var endEl = document.createElement('div');
    endEl.style.cssText = 'width:12px;height:12px;border-radius:50%;background:#fff;border:2px solid #c8f050';
    new kakao.maps.CustomOverlay({
      position: new kakao.maps.LatLng(coords[coords.length-1][1], coords[coords.length-1][0]),
      content: endEl, zIndex: 10
    }).setMap(runMapboxMap);
    // 경로 전체 보이게 bounds 조정
    var bounds = coords.reduce(function(b,c){
      b.extend(new kakao.maps.LatLng(c[1],c[0])); return b;
    }, new kakao.maps.LatLngBounds());
    runMapboxMap.setBounds(bounds, 40);
  }
  doAdd();
}

function highlightMapCourses(tab) {
  if (tab === 'mine') {
    ['cm-course-1','cm-course-2','cm-course-3'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.style.opacity = '0.2';
    });
  } else {
    ['cm-course-1','cm-course-2','cm-course-3'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.style.opacity = '0.85';
    });
  }
}

function selectCourse(id) {
  cmSelectedCourse = id;
  var c = COURSE_DATA.find(function(x){return x.id===id;});
  if (!c) return;
  var detail = document.getElementById('cm-detail-content');
  var sheet  = document.getElementById('cm-detail-sheet');
  if (!detail || !sheet) return;
  // Highlight on map
  ['cm-course-1','cm-course-2','cm-course-3'].forEach(function(el){
    var e = document.getElementById(el);
    if (e) e.style.opacity = e.id === 'cm-course-'+id ? '1' : '0.25';
  });
  detail.innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">'
    + '<div>'
    +   '<div style="font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:900;color:#fff;line-height:1">' + c.name + '</div>'
    +   '<div style="font-size:10px;font-weight:300;color:rgba(255,255,255,.4);margin-top:3px;letter-spacing:.04em">📍 ' + c.area + '</div>'
    + '</div>'
    + (c.badge ? '<span style="font-size:10px;font-weight:700;background:' + c.color + '22;color:' + c.color + ';border:1px solid ' + c.color + '44;padding:3px 10px;border-radius:6px">' + c.badge + '</span>' : '')
    + '</div>'
    + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">'
    + '<div style="background:rgba(255,255,255,.04);border-radius:10px;padding:12px;text-align:center">'
    +   '<div style="font-family:Barlow Condensed,sans-serif;font-size:26px;font-weight:900;color:' + c.color + ';line-height:1">' + c.dist + '</div>'
    +   '<div style="font-size:9px;font-weight:300;color:rgba(255,255,255,.35);margin-top:3px">거리 km</div>'
    + '</div>'
    + '<div style="background:rgba(255,255,255,.04);border-radius:10px;padding:12px;text-align:center">'
    +   '<div style="font-family:Barlow Condensed,sans-serif;font-size:26px;font-weight:900;color:rgba(255,255,255,.85);line-height:1">' + c.runners + '</div>'
    +   '<div style="font-size:9px;font-weight:300;color:rgba(255,255,255,.35);margin-top:3px">러닝 중</div>'
    + '</div>'
    + '<div style="background:rgba(255,255,255,.04);border-radius:10px;padding:12px;text-align:center">'
    +   '<div style="font-family:Barlow Condensed,sans-serif;font-size:26px;font-weight:900;color:rgba(255,255,255,.85);line-height:1">⭐4.' + (6 + id % 4) + '</div>'
    +   '<div style="font-size:9px;font-weight:300;color:rgba(255,255,255,.35);margin-top:3px">평점</div>'
    + '</div>'
    + '</div>'
    + '<div style="display:flex;gap:8px;margin-bottom:8px">'
    + '<button onclick="closeCourseDetail()" style="height:46px;padding:0 14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;font-size:13px;font-weight:500;color:rgba(255,255,255,.4);cursor:pointer">닫기</button>'
    + '<button onclick="shareCourse(' + id + ')" style="height:46px;padding:0 16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;font-size:20px;cursor:pointer" title="공유">🔗</button>'
    + '<button onclick="startCourseRun(' + id + ')" style="flex:1;height:46px;background:' + c.color + ';border:none;border-radius:12px;font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:900;letter-spacing:.06em;color:#0a0a0a;cursor:pointer">이 코스로 달리기</button>'
    + '</div>';
  sheet.style.display = 'block';
  requestAnimationFrame(function(){
    requestAnimationFrame(function(){
      sheet.style.transform = 'translateY(0)';
    });
  });
}

function closeCourseDetail() {
  var sheet = document.getElementById('cm-detail-sheet');
  if (sheet) {
    sheet.style.transform = 'translateY(100%)';
    setTimeout(function(){ sheet.style.display = 'none'; }, 300);
  }
  highlightMapCourses('nearby');
}

function startCourseRun(id) {
  // COURSE_DATA + 내 코스 모두 검색
  var c = COURSE_DATA.find(function(x){return x.id===id;}) ||
          myCourses.find(function(x){return x.id===id;});
  if (!c) return;
  activeGuideCourse = c;
  closeCourseDetail();
  goalType = 'dist';
  goalVal = String(parseFloat(c.dist || c.distKm || '5'));
  goTab('run');
  showToast('🏃 ' + c.name + ' 코스로 달리기 시작!');
  // 런 지도에 가이드 경로 표시
  setTimeout(function(){
    if (runMapboxMap && c.latLngs && c.latLngs.length >= 2) {
      // latLngs는 [lat,lng] 형식으로 저장됨 → mapbox는 [lng,lat]
      var coords = c.latLngs.map(function(ll){ return [ll[1], ll[0]]; }); // [lat,lng] → [lng,lat]
      if (runMapboxMap.isStyleLoaded()) {
        addGuideLayerToRunMap(coords);
      } else {
        // Kakao: 맵 로드 완료 시 바로 실행
  (function() { addGuideLayerToRunMap(coords); });
      }
    }
  }, 500);
}

function addGuideLayerToRunMap(coords) {
  if (!runMapboxMap) return;
  // 기존 가이드 레이어 제거
  if (runMapboxMap.getLayer('guide-layer')) runMapboxMap.removeLayer('guide-layer');
  if (runMapboxMap.getSource('guide-path')) runMapboxMap.removeSource('guide-path');
  // Kakao: 소스/레이어 불필요
  // Kakao: 소스/레이어 불필요
  // 시작점으로 지도 이동
  if (coords.length > 0) runMapboxMap.setCenter(coords[0]);
}

// ── Drawing mode ──
function toggleCourseDrawing() {
  if (cmDrawing) { cancelCourseDrawing(); return; }
  cmDrawing = true;
  cmMode = 'draw';
  if (courseMapboxMap) {
    courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
    courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
    courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
    courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
    courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
  }
  cmDrawPoints = [];
  drawLatLngs = [];

  // 그리기 모드: 하단시트·헤더 숨기고 지도 풀스크린
  var bottomSheet = document.getElementById('cm-bottom-sheet');
  var cmHeader = document.querySelector('#v-coursemap > div[style*="position:absolute;top:0"]');
  if (bottomSheet) { bottomSheet.style.transition = 'opacity .2s,transform .2s'; bottomSheet.style.opacity = '0'; bottomSheet.style.transform = 'translateY(20px)'; setTimeout(function(){ bottomSheet.style.display='none'; }, 200); }
  if (cmHeader) { cmHeader.style.transition = 'opacity .2s'; cmHeader.style.opacity = '0'; setTimeout(function(){ cmHeader.style.display='none'; }, 200); }

  var overlay = document.getElementById('cm-draw-overlay');
  if (overlay) { overlay.style.display = 'block'; setTimeout(function(){ overlay.style.opacity='1'; }, 10); }

  // Mapbox: 경로 초기화 + 커서
  if (courseMapboxMap) {
    if (drawPolyline) { drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); })); }
    courseMapboxMap.getNode().style.cursor = 'crosshair';
    // 지도 리사이즈 (전체화면으로 늘어났으므로)
    setTimeout(function(){ courseMapboxMap.relayout(); }, 250);
  }
  closeCourseDetail();
}

function onMapTap(e) {
  if (!cmDrawing) return;
  var svg = document.getElementById('cm-svg');
  var rect = svg.getBoundingClientRect();
  var scaleX = 400 / rect.width;
  var scaleY = 700 / rect.height;
  var x = Math.round((e.clientX - rect.left) * scaleX);
  var y = Math.round((e.clientY - rect.top)  * scaleY);
  cmDrawPoints.push([x, y]);
  updateDrawPath();
}

function onMapMove(e) {
  if (!cmDrawing) return;
  var svg = document.getElementById('cm-svg');
  var cursor = document.getElementById('cm-draw-cursor');
  if (!svg || !cursor) return;
  var rect = svg.getBoundingClientRect();
  var x = (e.clientX - rect.left) / rect.width  * 400;
  var y = (e.clientY - rect.top)  / rect.height * 700;
  cursor.setAttribute('cx', x); cursor.setAttribute('cy', y);
}

function onMapTouchMove(e) {
  e.preventDefault();
  if (!cmDrawing || !e.touches[0]) return;
  var svg = document.getElementById('cm-svg');
  var cursor = document.getElementById('cm-draw-cursor');
  if (!svg || !cursor) return;
  var t = e.touches[0];
  var rect = svg.getBoundingClientRect();
  var x = (t.clientX - rect.left) / rect.width  * 400;
  var y = (t.clientY - rect.top)  / rect.height * 700;
  cursor.setAttribute('cx', x); cursor.setAttribute('cy', y);
  // Auto-add points while dragging
  if (cmDrawPoints.length === 0 || Math.hypot(x - cmDrawPoints[cmDrawPoints.length-1][0], y - cmDrawPoints[cmDrawPoints.length-1][1]) > 15) {
    cmDrawPoints.push([Math.round(x), Math.round(y)]);
    updateDrawPath();
  }
}

function onMapTouchEnd(e) {
  if (!cmDrawing) return;
  var t = e.changedTouches[0];
  if (!t) return;
  var svg = document.getElementById('cm-svg');
  var rect = svg.getBoundingClientRect();
  var x = Math.round((t.clientX - rect.left) / rect.width  * 400);
  var y = Math.round((t.clientY - rect.top)  / rect.height * 700);
  if (cmDrawPoints.length === 0 || Math.hypot(x - cmDrawPoints[cmDrawPoints.length-1][0], y - cmDrawPoints[cmDrawPoints.length-1][1]) > 10) {
    cmDrawPoints.push([x, y]);
    updateDrawPath();
  }
}

function updateDrawPath() {
  var drawPath = document.getElementById('cm-draw-path');
  var distEl   = document.getElementById('cm-draw-dist');
  if (!drawPath) return;
  var pts = cmDrawPoints.map(function(p){return p[0]+','+p[1];}).join(' ');
  drawPath.setAttribute('points', pts);
  // Estimate distance (rough: 1 SVG unit ≈ 5m)
  var totalPx = 0;
  for (var i = 1; i < cmDrawPoints.length; i++) {
    var dx = cmDrawPoints[i][0] - cmDrawPoints[i-1][0];
    var dy = cmDrawPoints[i][1] - cmDrawPoints[i-1][1];
    totalPx += Math.sqrt(dx*dx + dy*dy);
  }
  var estKm = (totalPx * 0.005).toFixed(2);
  if (distEl) distEl.textContent = cmDrawPoints.length > 1 ? ('예상 거리: ' + estKm + ' km · ' + cmDrawPoints.length + '개 포인트') : '지도를 탭해 경로를 그려주세요';
}

function undoDrawPoint() {
  if (drawLatLngs.length === 0) return;
  drawLatLngs.pop();
  if (courseMapboxMap) {
    if (drawPolyline) {
      drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); }));
    }
  }
  updateDrawDistFromLatLngs();
}

function clearDrawPoints() {
  if (drawLatLngs.length === 0) return;
  if (!confirm('경로를 전부 지울까요?')) return;
  drawLatLngs = [];
  cmDrawPoints = [];
  if (courseMapboxMap) {
    if (drawPolyline) { drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); })); }
  }
  updateDrawDistFromLatLngs();
}

function saveDrawnCourse() {
  if (courseMapboxMap && drawLatLngs.length >= 2) {
    var name = '내 코스 ' + (myCourses.length + 1);
    var distKm = window._cmDrawDistKm || '0.00';
    var course = { id: 'mc_'+Date.now(), name:name,
      latLngs: drawLatLngs.map(function(l){return [l[1],l[0]];}),
      dist:distKm, createdAt:new Date().toLocaleDateString('ko-KR'), color:'#c8f050' };
    myCourses.push(course);
    try{localStorage.setItem('claprun_courses',JSON.stringify(myCourses));}catch(e){}
    cancelCourseDrawing();
    switchCmTab('mine');
    showToast('코스 저장됨: '+name+' ('+distKm+'km)');
    return;
  }
  if (cmDrawPoints.length < 2) { showToast('최소 2개 포인트가 필요해요'); return; }
  var name = '내 코스 ' + (myCourses.length + 1);
  var totalPx = 0;
  for (var i = 1; i < cmDrawPoints.length; i++) {
    var dx = cmDrawPoints[i][0] - cmDrawPoints[i-1][0];
    var dy = cmDrawPoints[i][1] - cmDrawPoints[i-1][1];
    totalPx += Math.sqrt(dx*dx + dy*dy);
  }
  var distKm = (totalPx * 0.005).toFixed(2);
  var course = {
    id: 'mc_' + Date.now(),
    name: name,
    points: cmDrawPoints.slice(),
    dist: distKm,
    createdAt: new Date().toLocaleDateString('ko-KR'),
    color: '#c8f050'
  };
  myCourses.push(course);
  try { localStorage.setItem('claprun_courses', JSON.stringify(myCourses)); } catch(e){}
  cancelCourseDrawing();
  switchCmTab('mine');
  showToast('✅ 코스 저장됨: ' + name + ' (' + distKm + 'km)');
}


function setCmMode(mode) {
  cmMode = mode;
  var btnMove = document.getElementById('cm-mode-move');
  var btnDraw = document.getElementById('cm-mode-draw');
  if (!btnMove || !btnDraw) return;

  if (mode === 'draw') {
    btnDraw.style.background = 'rgba(200,240,80,.15)';
    btnDraw.style.borderColor = 'rgba(200,240,80,.5)';
    btnDraw.style.color = '#c8f050';
    btnMove.style.background = 'rgba(10,10,10,.85)';
    btnMove.style.borderColor = 'rgba(255,255,255,.2)';
    btnMove.style.color = 'rgba(255,255,255,.5)';
    if (courseMapboxMap) {
      courseMapboxMap.getNode().style.cursor = 'crosshair';
      courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
      courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
      courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
      courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
      courseMapboxMap.setDraggable(false); courseMapboxMap.setZoomable(false);
    }
  } else {
    btnMove.style.background = 'rgba(200,240,80,.15)';
    btnMove.style.borderColor = 'rgba(200,240,80,.5)';
    btnMove.style.color = '#c8f050';
    btnDraw.style.background = 'rgba(10,10,10,.85)';
    btnDraw.style.borderColor = 'rgba(255,255,255,.2)';
    btnDraw.style.color = 'rgba(255,255,255,.5)';
    if (courseMapboxMap) {
      courseMapboxMap.getNode().style.cursor = 'grab';
      courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
      courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
      courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
      courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
      courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    }
  }
}


function cancelCourseDrawing() {
  cmDrawing = false;
  drawLatLngs = [];
  if (courseMapboxMap) {
    courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    courseMapboxMap.setDraggable(true); courseMapboxMap.setZoomable(true);
    courseMapboxMap.getNode().style.cursor = '';
  }

  // 오버레이 숨기기
  var overlay = document.getElementById('cm-draw-overlay');
  if (overlay) { overlay.style.display = 'none'; overlay.style.opacity = ''; }

  // 하단시트·헤더 복귀
  var bottomSheet = document.getElementById('cm-bottom-sheet');
  var cmHeader = document.querySelector('#v-coursemap > div[style*="position:absolute;top:0"]');
  if (bottomSheet) { bottomSheet.style.display = ''; bottomSheet.style.opacity = ''; bottomSheet.style.transform = ''; }
  if (cmHeader) { cmHeader.style.display = ''; cmHeader.style.opacity = ''; }

  if (courseMapboxMap) {
    courseMapboxMap.getNode().style.cursor = '';
    if (drawPolyline) { drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); })); }
    setTimeout(function(){ courseMapboxMap.relayout(); }, 100);
  }
}

function renderMyCourses() {
  var list = document.getElementById('cm-my-courses-list');
  if (!list) return;
  try { myCourses = JSON.parse(localStorage.getItem('claprun_courses') || '[]'); } catch(e){}
  list.innerHTML = '';
  if (myCourses.length === 0) {
    var empty = document.createElement('div');
    empty.style.cssText = 'text-align:center;padding:30px 0;font-size:12px;font-weight:300;color:rgba(255,255,255,.3)';
    empty.textContent = '아직 저장된 코스가 없어요';
    var sub = document.createElement('div');
    sub.style.cssText = 'margin-top:6px;font-size:11px;color:rgba(200,240,80,.4);cursor:pointer';
    sub.textContent = '코스 그리기 →';
    sub.onclick = function(){ toggleCourseDrawing(); };
    list.appendChild(empty);
    list.appendChild(sub);
    return;
  }
  myCourses.forEach(function(c) {
    var row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);touch-action:manipulation';

    // 미니 경로 미리보기
    var icon = document.createElement('div');
    icon.style.cssText = 'width:52px;height:52px;border-radius:10px;background:rgba(200,240,80,.06);border:1px solid rgba(200,240,80,.15);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden';
    if (c.latLngs && c.latLngs.length >= 2) {
      var mini = document.createElement('canvas');
      mini.width = 52; mini.height = 52;
      icon.appendChild(mini);
      drawMiniRoute(mini, c.latLngs, '#c8f050');
    } else {
      icon.textContent = '🗺';
      icon.style.fontSize = '22px';
    }

    var info = document.createElement('div');
    info.style.cssText = 'flex:1;min-width:0';
    var nm = document.createElement('div');
    nm.style.cssText = 'font-size:14px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
    nm.textContent = c.name;
    var dt = document.createElement('div');
    dt.style.cssText = 'font-size:10px;font-weight:300;color:rgba(255,255,255,.35);margin-top:3px';
    dt.textContent = (c.dist||c.distKm||'?') + 'km · ' + (c.createdAt||'');
    var pts = document.createElement('div');
    pts.style.cssText = 'font-size:10px;color:rgba(200,240,80,.5);margin-top:2px';
    pts.textContent = c.latLngs ? c.latLngs.length + '개 포인트' : '';
    info.appendChild(nm); info.appendChild(dt); info.appendChild(pts);

    // 달리기 시작 버튼
    var runBtn = document.createElement('button');
    runBtn.style.cssText = 'height:34px;padding:0 12px;background:#c8f050;border:none;border-radius:9px;font-family:Barlow Condensed,sans-serif;font-size:13px;font-weight:800;color:#0a0a0a;cursor:pointer;flex-shrink:0;touch-action:manipulation';
    runBtn.textContent = '▶ 달리기';
    runBtn.onclick = function(e) { e.stopPropagation(); startMyCourseRun(c); };

    var delBtn = document.createElement('button');
    delBtn.style.cssText = 'width:28px;height:28px;background:rgba(255,60,60,.07);border:1px solid rgba(255,60,60,.15);border-radius:7px;font-size:12px;color:rgba(255,80,80,.5);cursor:pointer;flex-shrink:0;touch-action:manipulation';
    delBtn.textContent = '✕';
    delBtn.onclick = function(e) { e.stopPropagation(); deleteMyCourse(c.id); };

    row.appendChild(icon); row.appendChild(info); row.appendChild(runBtn); row.appendChild(delBtn);
    list.appendChild(row);
  });
}

// 내 코스 미니 경로 미리보기 canvas 그리기
function drawMiniRoute(canvas, latLngs, color) {
  if (!latLngs || latLngs.length < 2) return;
  var ctx = canvas.getContext('2d');
  var W = canvas.width, H = canvas.height, pad = 6;
  var lats = latLngs.map(function(l){return l[0];}); 
  var lngs = latLngs.map(function(l){return l[1];});
  var minLat=Math.min.apply(null,lats), maxLat=Math.max.apply(null,lats);
  var minLng=Math.min.apply(null,lngs), maxLng=Math.max.apply(null,lngs);
  var rangeY=maxLat-minLat||0.001, rangeX=maxLng-minLng||0.001;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle = color; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
  ctx.globalAlpha = 0.9;
  ctx.beginPath();
  latLngs.forEach(function(ll, i) {
    var x = pad + (ll[1]-minLng)/rangeX*(W-pad*2);
    var y = H - pad - (ll[0]-minLat)/rangeY*(H-pad*2);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // 시작점
  var s = latLngs[0];
  var sx = pad+(s[1]-minLng)/rangeX*(W-pad*2);
  var sy = H-pad-(s[0]-minLat)/rangeY*(H-pad*2);
  ctx.beginPath(); ctx.arc(sx,sy,3,0,Math.PI*2);
  ctx.fillStyle=color; ctx.globalAlpha=1; ctx.fill();
}


function deleteMyCourse(id) {
  myCourses = myCourses.filter(function(c){return c.id !== id;});
  try { localStorage.setItem('claprun_courses', JSON.stringify(myCourses)); } catch(e){}
  renderMyCourses();
}

// Init course map when tab activated
function initCourseMap() {
  if (typeof mapboxgl !== "undefined") {
    initCourseKakaoMap();
  } else {
    var locEl = document.getElementById('cm-location');
    if (locEl) locEl.textContent = '서울특별시';
    setTimeout(initCourseMap, 300);
  }
}

function updateNearbyRunners() {
  // Drift each runner along their direction
  NEARBY_RUNNERS.forEach(function(r) {
    r.lat += Math.cos(r.dir) * r.speed + (Math.random()-.5)*0.000005;
    r.lng += Math.sin(r.dir) * r.speed + (Math.random()-.5)*0.000007;
    // Slight direction drift
    r.dir += (Math.random()-.5) * 0.15;
  });
  renderNearbyOnSVG();
  var badge = document.getElementById('nearby-count');
  if (badge) {
    var onScreen = NEARBY_RUNNERS.filter(function(r){
      var pt = latLngToSVG(r.lat, r.lng);
      return pt.x >= -20 && pt.x <= 420 && pt.y >= -20 && pt.y <= 340;
    }).length;
    badge.textContent = '주변 ' + onScreen + '명';
  }
}

function latLngToSVG(lat, lng) {
  // Map GPS coord to SVG viewBox 0 0 400 320
  var spanLat = mapViewZoom;
  var spanLng = mapViewZoom * (400/320);
  var x = ((lng - (mapViewLng - spanLng/2)) / spanLng) * 400;
  var y = (((mapViewLat + spanLat/2) - lat) / spanLat) * 320;
  return {x: Math.round(x), y: Math.round(y)};
}

function renderNearbyOnSVG() {
  var svg = document.getElementById('ra-svg');
  // In Kakao map mode, skip SVG nearby rendering (Kakao markers used instead)
  if (runMapboxMap) { svg&&svg.querySelectorAll('.nearby-runner').forEach(function(e){e.remove();}); return; }
  if (!svg) return;

  // Update my position if GPS active
  if (locGranted && pathCoords.length > 0) {
    var last = pathCoords[pathCoords.length-1];
    mapViewLat = last[0]; mapViewLng = last[1];
  }

  // Remove old nearby markers
  svg.querySelectorAll('.nearby-runner').forEach(function(el){el.remove();});

  NEARBY_RUNNERS.forEach(function(r) {
    var pt = latLngToSVG(r.lat, r.lng);
    // Skip if off screen
    if (pt.x < -30 || pt.x > 430 || pt.y < -30 || pt.y > 350) return;

    // Glow ring
    var glowEl = document.createElementNS('http://www.w3.org/2000/svg','circle');
    glowEl.setAttribute('cx', pt.x); glowEl.setAttribute('cy', pt.y);
    glowEl.setAttribute('r', '14');
    glowEl.setAttribute('fill', r.color.replace(')', ',.15)').replace('rgb','rgba').replace('#', 'rgba(').replace('a(','a(').replace(r.color.slice(1),''));
    // simpler approach:
    glowEl.setAttribute('fill', 'rgba(255,255,255,.07)');
    glowEl.setAttribute('stroke', r.color);
    glowEl.setAttribute('stroke-width', '1.5');
    glowEl.setAttribute('opacity', '0.7');
    glowEl.classList.add('nearby-runner');
    svg.appendChild(glowEl);

    // Dot
    var dotEl = document.createElementNS('http://www.w3.org/2000/svg','circle');
    dotEl.setAttribute('cx', pt.x); dotEl.setAttribute('cy', pt.y);
    dotEl.setAttribute('r', '5');
    dotEl.setAttribute('fill', r.color);
    dotEl.classList.add('nearby-runner');
    svg.appendChild(dotEl);

    // Emoji label
    var fo = document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
    fo.setAttribute('x', pt.x - 12); fo.setAttribute('y', pt.y - 28);
    fo.setAttribute('width', '24'); fo.setAttribute('height', '24');
    fo.classList.add('nearby-runner');
    var div = document.createElement('div');
    div.style.cssText = 'font-size:16px;line-height:1;text-align:center;pointer-events:none';
    div.textContent = r.em;
    fo.appendChild(div);
    svg.appendChild(fo);

    // Nick label
    var text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', pt.x); text.setAttribute('y', pt.y + 22);
    text.setAttribute('text-anchor','middle');
    text.setAttribute('font-size','8');
    text.setAttribute('font-weight','600');
    text.setAttribute('letter-spacing','0.04em');
    text.setAttribute('fill', r.color);
    text.setAttribute('opacity','0.85');
    text.textContent = r.nick;
    text.classList.add('nearby-runner');
    svg.appendChild(text);
  });

  // Draw distance rings around my position
  renderDistanceRings();
}

function renderDistanceRings() {
  var svg = document.getElementById('ra-svg');
  if (!svg) return;
  svg.querySelectorAll('.dist-ring').forEach(function(el){el.remove();});

  // My dot current position from runner-dot
  var myDot = document.getElementById('runner-dot');
  if (!myDot) return;
  var cx = parseFloat(myDot.getAttribute('cx')) || 200;
  var cy = parseFloat(myDot.getAttribute('cy')) || 160;

  // 500m ring and 1km ring (in SVG units, roughly)
  var ring500 = document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring500.setAttribute('cx', cx); ring500.setAttribute('cy', cy);
  ring500.setAttribute('r', '40');
  ring500.setAttribute('fill','none');
  ring500.setAttribute('stroke','rgba(255,255,255,.06)');
  ring500.setAttribute('stroke-width','1');
  ring500.setAttribute('stroke-dasharray','4 6');
  ring500.classList.add('dist-ring');
  svg.insertBefore(ring500, svg.firstChild);

  var lbl500 = document.createElementNS('http://www.w3.org/2000/svg','text');
  lbl500.setAttribute('x', cx + 42); lbl500.setAttribute('y', cy + 3);
  lbl500.setAttribute('font-size','7'); lbl500.setAttribute('fill','rgba(255,255,255,.2)');
  lbl500.textContent = '500m'; lbl500.classList.add('dist-ring');
  svg.insertBefore(lbl500, svg.firstChild);

  var ring1k = document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring1k.setAttribute('cx', cx); ring1k.setAttribute('cy', cy);
  ring1k.setAttribute('r', '80');
  ring1k.setAttribute('fill','none');
  ring1k.setAttribute('stroke','rgba(255,255,255,.04)');
  ring1k.setAttribute('stroke-width','1');
  ring1k.setAttribute('stroke-dasharray','4 8');
  ring1k.classList.add('dist-ring');
  svg.insertBefore(ring1k, svg.firstChild);

  var lbl1k = document.createElementNS('http://www.w3.org/2000/svg','text');
  lbl1k.setAttribute('x', cx + 82); lbl1k.setAttribute('y', cy + 3);
  lbl1k.setAttribute('font-size','7'); lbl1k.setAttribute('fill','rgba(255,255,255,.15)');
  lbl1k.textContent = '1km'; lbl1k.classList.add('dist-ring');
  svg.insertBefore(lbl1k, svg.firstChild);
}

function startNearbyTracking() {
  if (nearbyRunnerTimer) clearInterval(nearbyRunnerTimer);
  renderNearbyOnSVG();
  nearbyRunnerTimer = setInterval(updateNearbyRunners, 2500);
}
function stopNearbyTracking() {
  if (nearbyRunnerTimer) { clearInterval(nearbyRunnerTimer); nearbyRunnerTimer = null; }
  var svg = document.getElementById('ra-svg');
  if (svg) {
    svg.querySelectorAll('.nearby-runner,.dist-ring').forEach(function(el){el.remove();});
  }
}


// ══════════════════════════════════════════
// KAKAO MAPS + GPS TRACKING + VOICE ALERTS
// ══════════════════════════════════════════
var runMapboxMap = null;
var runMapMarker = null;
var runPolyline = null;
var runLatLngs = [];
var lastVoiceKm = 0;

var courseMapboxMap = null;
var courseMapInited = false;
var drawPolyline = null;
var drawLatLngs = [];
var courseMapMarker = null;

function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  var utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ko-KR';
  utter.rate = 1.15;
  utter.pitch = 1.6;
  utter.volume = 1.0;
  // 밝고 젊은 여성 음성 선택
  var voices = window.speechSynthesis.getVoices();
  var preferred = voices.find(function(v){
    return v.lang === 'ko-KR' && /female|woman|yuna|heami|나래|유나/i.test(v.name);
  }) || voices.find(function(v){
    return v.lang === 'ko-KR';
  });
  if(preferred) utter.voice = preferred;
  window.speechSynthesis.speak(utter);
}

function checkVoiceMilestone(distKm, paceStr) {
  var km = Math.floor(distKm);
  if (km > 0 && km > lastVoiceKm) {
    lastVoiceKm = km;
    var cleaned = paceStr.replace("'","분 ").replace('"','초');
    var msg = km + '킬로미터 완주! 현재 페이스 ' + cleaned + '입니다.';
    speak(msg);
  }
}

function initRunKakaoMap() {
  var container = document.getElementById('run-mapbox-map');
  if (!container || runMapboxMap) return;
  if (typeof mapboxgl === 'undefined') { setTimeout(initRunKakaoMap, 400); return; }
    var runMapContainer = document.getElementById('run-mapbox-map');
  runMapboxMap = new kakao.maps.Map(runMapContainer, {
    center: new kakao.maps.LatLng(userLat, userLng),
    level: 3
  });
  // 다크 스타일 배경
  runMapContainer.style.background = '#0a0a0d';
  // 현재 위치 마커
  var el = document.createElement('div');
  el.style.cssText = 'width:20px;height:20px;border-radius:50%;background:#c8f050;border:3px solid #0a0a0a;box-shadow:0 0 12px rgba(200,240,80,.6)';
  runMapMarker = new kakao.maps.CustomOverlay({
      position: new kakao.maps.LatLng(userLat, userLng),
      content: el, zIndex: 10
    }).setMap(runMapboxMap);
  runLatLngs = [];
  // 경로 레이어 추가
  // Kakao: 맵 로드 완료 시 바로 실행
  (function() {
    // 내 경로 레이어
    // Kakao: 소스/레이어 불필요
    // Kakao: 소스/레이어 불필요
    // 가이드 코스 있으면 바로 그리기
    if (activeGuideCourse) {
      showGuideOnRunMap(activeGuideCourse);
    }
  });
}

function updateRunKakaoMap(lat, lng) {
  if (!runMapboxMap) return;
  runMapMarker.setLngLat([lng, lat]);
  runLatLngs.push([lng, lat]);
  runMapboxMap.setCenter(new kakao.maps.LatLng(lat, lng));
  if (runPolyline) {
    runPolyline.setPath(runLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1], c[0]); }));
    if (!runPolyline.getMap()) runPolyline.setMap(runMapboxMap);
  }
}

function resetRunKakaoMap() {
  if (runMapboxMap) { runMapboxMap.remove(); runMapboxMap = null; }
  runMapMarker = null;
  runPolyline = null;
  runLatLngs = [];
  lastVoiceKm = 0;
}

function initCourseKakaoMap() {
  if (courseMapInited) {
    if (courseMapboxMap && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        userLat = pos.coords.latitude; userLng = pos.coords.longitude;
        courseMapboxMap.setCenter([userLng, userLat]);
        if (courseMapMarker) courseMapMarker.setLngLat([userLng, userLat]);
      }, function(){});
    }
    return;
  }
  var container = document.getElementById('course-mapbox-map');
  if (!container) return;
  if (typeof mapboxgl === 'undefined') { setTimeout(initCourseKakaoMap, 400); return; }
  courseMapInited = true;
    var courseMapContainer = document.getElementById('course-mapbox-map');
  courseMapboxMap = new kakao.maps.Map(courseMapContainer, {
    center: new kakao.maps.LatLng(userLat, userLng),
    level: 4
  });
  courseMapContainer.style.background = '#0a0a0d';
  // 코스 그리기용 폴리라인
  drawPolyline = new kakao.maps.Polyline({
    map: courseMapboxMap,
    path: [],
    strokeWeight: 4,
    strokeColor: '#c8f050',
    strokeOpacity: 0.9,
    strokeStyle: 'solid'
  });
  // 런 경로 폴리라인
  runPolyline = new kakao.maps.Polyline({
    map: courseMapboxMap,
    path: [],
    strokeWeight: 3,
    strokeColor: '#c8f050',
    strokeOpacity: 0.7,
    strokeStyle: 'solid'
  });
  // 현재 위치 마커
  var el = document.createElement('div');
  el.style.cssText = 'width:16px;height:16px;border-radius:50%;background:#c8f050;border:2px solid #fff;box-shadow:0 0 8px rgba(200,240,80,.5)';
  courseMapMarker = new kakao.maps.CustomOverlay({
      position: new kakao.maps.LatLng(userLat, userLng),
      content: el, zIndex: 10
    }).setMap(courseMapboxMap);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      userLat = pos.coords.latitude; userLng = pos.coords.longitude;
      courseMapboxMap.setCenter([userLng, userLat]);
      courseMapMarker.setLngLat([userLng, userLat]);
      var locEl = document.getElementById('cm-location');
      if (locEl) locEl.textContent = '📍 현재 위치';
    }, function() {
      var locEl = document.getElementById('cm-location');
      if (locEl) locEl.textContent = '📍 서울특별시 (GPS 불가)';
    }, { enableHighAccuracy: true, timeout: 8000 });

    navigator.geolocation.watchPosition(function(pos) {
      userLat = pos.coords.latitude; userLng = pos.coords.longitude;
      if (courseMapMarker) courseMapMarker.setLngLat([userLng, userLat]);
      if (!cmDrawing && courseMapboxMap) courseMapboxMap.setCenter([userLng, userLat]);
    }, function(){}, { enableHighAccuracy: true, maximumAge: 3000 });
  }

  // 코스 그리기 클릭 이벤트
  // Kakao: 맵 로드 완료 시 바로 실행
  (function() {
    // 드로잉 경로 소스
    // Kakao: 소스/레이어 불필요
    // Kakao: 소스/레이어 불필요
    drawLatLngs = [];
    // 추천 코스 표시
    highlightMapCourses(null);
    renderNearbyCourses();
  });

  kakao.maps.event.addListener(courseMapboxMap, 'click', function(mouseEvent) {
    if (!cmDrawing || cmMode !== 'draw') return;
    var latlng = mouseEvent.latLng;
    drawLatLngs.push([latlng.getLng(), latlng.getLat()]);
    // Kakao: 폴리라인 업데이트는 setPath로 처리
    updateDrawDistFromLatLngs();
  });

  // 드래그로 연속 그리기 (touchmove)
  var _lastDrawTime = 0;

  // touchstart: 그리기 모드일 때 지도 드래그 원천 차단
  courseMapboxMap.getNode().addEventListener('touchstart', function(e) {
    if (!cmDrawing || cmMode !== 'draw') return;
    e.preventDefault();
    e.stopPropagation();
  }, { passive: false });

  courseMapboxMap.getNode().addEventListener('touchmove', function(e) {
    if (!cmDrawing || cmMode !== 'draw') return;
    e.preventDefault();
    e.stopPropagation();
    var now = Date.now();
    if (now - _lastDrawTime < 80) return; // 80ms 간격으로 포인트 추가
    _lastDrawTime = now;
    var touch = e.touches[0];
    var rect = courseMapboxMap.getNode().getBoundingClientRect();
    var x = touch.clientX - rect.left;
    var y = touch.clientY - rect.top;
    var proj = courseMapboxMap.getProjection();
    var lngLat = proj.coordsFromContainerPoint(new kakao.maps.Point(x, y));
    drawLatLngs.push([lngLat.getLng(), lngLat.getLat()]);
    if (drawPolyline) {
      drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); }));
    }
    updateDrawDistFromLatLngs();
  }, { passive: false });

  // 마우스 드래그로 연속 그리기 (desktop)
  var _mouseDown = false;
  courseMapboxMap.getNode().addEventListener('mousedown', function(e) { if (cmDrawing) _mouseDown = true; });
  courseMapboxMap.getNode().addEventListener('mouseup',   function()  { _mouseDown = false; });
  courseMapboxMap.getNode().addEventListener('mousemove', function(e) {
    if (!cmDrawing || !_mouseDown) return;
    var now = Date.now();
    if (now - _lastDrawTime < 60) return;
    _lastDrawTime = now;
    var rect = courseMapboxMap.getNode().getBoundingClientRect();
    var lngLat = courseMapboxMap.unproject([e.clientX - rect.left, e.clientY - rect.top]);
    drawLatLngs.push([lngLat.lng, lngLat.lat]);
    if (drawPolyline) {
      drawPolyline.setPath(drawLatLngs.map(function(c){ return new kakao.maps.LatLng(c[1],c[0]); }));
    }
    updateDrawDistFromLatLngs();
  });
}

function updateDrawDistFromLatLngs() {
  if (drawLatLngs.length < 2) return;
  var total = 0;
  for (var i = 1; i < drawLatLngs.length; i++) {
    total += haversine(
      drawLatLngs[i-1][1], drawLatLngs[i-1][0],
      drawLatLngs[i][1],   drawLatLngs[i][0]
    );
  }
  var distEl = document.getElementById('cm-draw-dist');
  if (distEl) distEl.textContent = '예상 거리: ' + total.toFixed(2) + ' km · ' + drawLatLngs.length + '개 포인트';
  window._cmDrawDistKm = total.toFixed(2);
}
// ══════════════════════════════════════════

function startRun(){
  document.getElementById('rsetup').classList.remove('on');
  document.getElementById('rpaused').classList.remove('on');
  document.getElementById('ractive').classList.add('on');
  const goalNumLabel={dist:goalVal+'KM',time:goalVal+'MIN',speed:'PACE GOAL',free:'FREE RUN'};
  const glEl=document.getElementById('ra-gl-txt');if(glEl)glEl.textContent=(goalNumLabel[goalType]||'5KM')+' GOAL';
  const rap=document.getElementById('ra-profile');if(rap&&currentUser)rap.textContent=currentUser.avatar||'🦊';
  runSec=0;runDist=0;runPaused=false;pathCoords=[];clapCount=0;
  lastVoiceKm=0;
  resetRunKakaoMap();
  var runMapDiv=document.getElementById("run-mapbox-map");
  var runSvgEl=document.getElementById("ra-svg");
  if(locGranted){
    if(runMapDiv)runMapDiv.style.display="block";
    if(runSvgEl)runSvgEl.style.display="none";
    setTimeout(initRunKakaoMap, 200);
  } else {
    if(runMapDiv)runMapDiv.style.display="none";
    if(runSvgEl)runSvgEl.style.display="block";
  }
  const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent='0';
  initRunSVG();buildRacingTrack();
  if(locGranted){
    watchId=navigator.geolocation.watchPosition(
      pos=>{const lat=pos.coords.latitude,lng=pos.coords.longitude;if(pathCoords.length>0){const prev=pathCoords[pathCoords.length-1];runDist+=haversine(prev[0],prev[1],lat,lng);}pathCoords.push([lat,lng]);userLat=lat;userLng=lng;updateRunKakaoMap(lat,lng);},
      err=>{
        var msg={1:'권한 거부됨',2:'위치 불가',3:'시간 초과'}[err.code]||'알 수 없음';
        console.warn('GPS 오류 ('+err.code+'): '+msg);
        locGranted=false;
      },
      {enableHighAccuracy:true,maximumAge:1000,timeout:10000}
    );
  }
  runTimer=setInterval(runTick,1000);
  startNearbyTracking();
  renderRunCrewBadge();
  // 가이드 코스 표시는 initRunKakaoMap의 load 콜백에서 처리됨
  // (mapbox 스타일 로드 완료 후 자동으로 showGuideOnRunMap 호출)
}

function runTick(){
  if(runPaused)return;runSec++;
  if(!locGranted){
    runDist+=0.0014+Math.random()*.0008;
    // Simulate GPS movement for nearby runners
    userLat+=0.000005+(Math.random()-0.5)*0.00001;
    userLng+=0.000008+(Math.random()-0.5)*0.00001;
  }
  const mins=Math.floor(runSec/60),secs=runSec%60;
  const distEl=document.getElementById('ra-dist'),paceEl=document.getElementById('ra-pace'),timeEl=document.getElementById('ra-time'),calEl=document.getElementById('ra-cal');
  if(distEl)distEl.textContent=runDist.toFixed(2);
  if(timeEl)timeEl.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  if(calEl)calEl.textContent=Math.round(runDist*65);
  const paceS=runDist>0?Math.round(runSec/runDist):0,pm=Math.floor(paceS/60),ps=paceS%60;
  if(paceEl)paceEl.textContent=runDist>0?(pm+"'"+String(ps).padStart(2,'0')+'"'):"--'--\"";
  let pct=0;const gv=parseFloat(goalVal)||5;
  if(goalType==='dist')pct=runDist/gv;else if(goalType==='time')pct=runSec/(gv*60);else pct=runDist/5;
  updateRunSVG(pct);updateRacingTrack(Math.min(pct*100,100));
  if(runDist>0){var _ps=Math.floor(runSec/runDist),_pm=Math.floor(_ps/60),_psec=_ps%60;checkVoiceMilestone(runDist,_pm+String.fromCharCode(39)+String(_psec).padStart(2,'0')+String.fromCharCode(34));}
}

function haversine(la1,lo1,la2,lo2){
  const R=6371,dLa=(la2-la1)*Math.PI/180,dLo=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function handlePauseTap(){
  if(!runPaused){
    runPaused=true;
    document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.add('on');
    const mins=Math.floor(runSec/60),secs=runSec%60;
    const psd=document.getElementById('ps-dist'),pst=document.getElementById('ps-time'),psp=document.getElementById('ps-pace');
    if(psd)psd.textContent=runDist.toFixed(2);
    if(pst)pst.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
    const paceS=runDist>0?Math.round(runSec/runDist):0,pm2=Math.floor(paceS/60),ps2=paceS%60;
    if(psp)psp.textContent=runDist>0?(pm2+"'"+String(ps2).padStart(2,'0')+'"'):"--'--\"";
  }
}
function resumeRun(){
  runPaused=false;
  document.getElementById('rpaused').classList.remove('on');
  document.getElementById('ractive').classList.add('on');
  showToast('계속 달려요!');
  var runMapDiv=document.getElementById('run-mapbox-map');
  var runSvgEl=document.getElementById('ra-svg');
  if(locGranted){if(runMapDiv)runMapDiv.style.display='block';if(runSvgEl)runSvgEl.style.display='none';}
  else{if(runMapDiv)runMapDiv.style.display='none';if(runSvgEl)runSvgEl.style.display='block';}
}
function togglePause(){handlePauseTap();}

// ── CLAP 누적 저장 ──
var CLAP_STORE_KEY = 'claprun_total_clap';
function getTotalClap() {
  try { return parseInt(localStorage.getItem(CLAP_STORE_KEY) || '0'); } catch(e){ return 0; }
}
function addTotalClap(n) {
  try { localStorage.setItem(CLAP_STORE_KEY, getTotalClap() + n); } catch(e){}
}


function doClap(){
  const today=new Date().toDateString();
  const stored=JSON.parse(localStorage.getItem('clap_daily')||'{}');
  const todayCount=stored.date===today?stored.count:0;
  if(todayCount>=10){showPaymentModal('clap');return;}
  localStorage.setItem('clap_daily',JSON.stringify({date:today,count:todayCount+1}));
  clapCount++;
  const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent=clapCount;
  const em=document.getElementById('clap-em');
  if(em){em.style.transform='scale(1.5) rotate(-10deg)';setTimeout(()=>{em.style.transform='';},300);}
  const rv=document.getElementById('v-run');
  if(rv){const f=document.createElement('div');f.style.cssText='position:absolute;pointer-events:none;font-size:22px;z-index:50;animation:clapFloat .8s ease forwards;left:'+(20+Math.random()*60)+'%;bottom:80px';f.textContent='👏';rv.appendChild(f);setTimeout(()=>{if(f.parentNode)f.parentNode.removeChild(f);},800);}
  if(navigator.vibrate)navigator.vibrate([30,20,30]);
  const rem=10-(todayCount+1);
  if(rem<=3&&rem>0)showToast('👏 하이파이브! (오늘 '+rem+'개 남음)');
  else showToast('👏 하이파이브! 근처 러너에게 전달됐어요');
}
function toggleFullMap(){const c=document.getElementById('ra-map-container');if(!c)return;c.style.flex=c.style.flex==='2'?'1':'2';}

function stopRun(){
  clearInterval(runTimer);runTimer=null;
  stopNearbyTracking();
  if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
  document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.remove('on');document.getElementById('rfinish').classList.add('on');
  const mins=Math.floor(runSec/60),secs=runSec%60;
  const rfD=document.getElementById('rf-d'),rfT=document.getElementById('rf-t'),rfP=document.getElementById('rf-p'),rfC=document.getElementById('rf-c'),rfMsg=document.getElementById('rf-msg');
  if(rfD)rfD.textContent=runDist.toFixed(2);
  if(rfT)rfT.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  if(rfC)rfC.textContent=Math.round(runDist*65);
  // 받은 clap 표시
  var rfClap = document.getElementById('rf-clap-row');
  if(rfClap){
    var rcv = runDist>0.05 ? Math.floor(runDist*1.2 + Math.random()*4) : 0;
    rfClap.innerHTML = '<span style="font-size:22px">👏</span><span style="font-family:Barlow Condensed,sans-serif;font-size:28px;font-weight:900;color:#c8f050;margin-left:6px">+'+rcv+'</span><span style="font-size:11px;color:rgba(255,255,255,.4);margin-left:4px">clap 받음</span>';
    rfClap.style.display = 'flex';
  }
  const paceS=runDist>0?Math.round(runSec/runDist):0,pm=Math.floor(paceS/60),ps=paceS%60;
  if(rfP)rfP.textContent=runDist>0?(pm+"'"+String(ps).padStart(2,'0')+'"'):"--'--\"";
  if(rfMsg)rfMsg.textContent=runDist>=5?'오늘도 멋지게 달렸어요 🎉':runDist>=2?'좋은 페이스예요!':'내일은 더 멀리 달려봐요';
  if(currentUser)GR_API.updateUser({totalKm:(currentUser.totalKm||312.4)+runDist,runCount:(currentUser.runCount||62)+1}).then(u=>{currentUser=u;});
  // Save run to history
  var now=new Date();
  var newRun={
    date:String(now.getMonth()+1).padStart(2,"0")+"."+String(now.getDate()).padStart(2,"0"),
    mo:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][now.getMonth()],
    d:parseFloat(runDist.toFixed(2)),
    pace:runDist>0?(Math.floor(runSec/runDist/60)+"'"+String(Math.floor(runSec/runDist)%60).padStart(2,"0")+'"'):'--\'--"',
    t:String(Math.floor(runSec/60)).padStart(2,"0")+":"+String(runSec%60).padStart(2,"0"),
    kcal:Math.round(runDist*65)
  };
  // 이 런에서 받은 clap 계산 (거리 + 시간 기반 시뮬레이션)
  var receivedClap = runDist > 0.05 ? Math.floor(runDist * 1.2 + Math.random() * 4) : 0;
  newRun.receivedClap = receivedClap;
  if(runDist>0.05){
    PAST_LOGS.unshift(newRun);
    if(PAST_LOGS.length>50)PAST_LOGS.length=50;
    try{localStorage.setItem("claprun_runs",JSON.stringify(PAST_LOGS));}catch(e){}
    // 총 받은 clap 누적
    addTotalClap(receivedClap);
  }
  recInited=false;
}

function resetRun(){
  stopNearbyTracking();
  resetRunKakaoMap();
  document.getElementById('rfinish').classList.remove('on');document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.remove('on');document.getElementById('rsetup').classList.add('on');
  runSec=0;runDist=0;clapCount=0;const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent='0';
}

// SHOT
function applyRank(){
  const emB=document.getElementById('em-b');if(emB)emB.textContent=currentUser?currentUser.avatar||'🦊':'🦊';
  // Update overlay stats with last run data
  var mins=Math.floor(runSec/60),secs=runSec%60;
  var paceS=runDist>0?Math.floor(runSec/runDist):0,pm=Math.floor(paceS/60),ps=paceS%60;
  var distStr=runDist>0?runDist.toFixed(2):'5.20';
  var timeStr=runDist>0?(String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0')):'26:58';
  var paceStr=runDist>0?(pm+"'"+String(ps).padStart(2,'0')+'"'):'5\'12"';
  var calStr=runDist>0?String(Math.round(runDist*65)):'312';
  var nm=currentUser?currentUser.nickname||'Runner':'Runner';
  var av=currentUser?currentUser.avatar||'🦊':'🦊';
  ['em-g','em-p','em-s'].forEach(function(id){var e=document.getElementById(id);if(e)e.textContent=av;});
  ['nm-g','nm-p','nm-s'].forEach(function(id){var e=document.getElementById(id);if(e)e.textContent=nm;});
  // Ghost overlay stats
  var gDist=document.querySelector('#ov-g .g-dist');if(gDist)gDist.innerHTML=distStr+'<span class="g-du">km</span>';
  var gStats=document.querySelectorAll('#ov-g .g-sv');
  if(gStats.length>=3){gStats[0].textContent=paceStr;gStats[1].textContent=timeStr;gStats[2].textContent=calStr;}
  // Path overlay stats
  var pStats=document.querySelectorAll('#ov-p .p-v');
  if(pStats.length>=3){pStats[0].innerHTML=distStr+'<span class="p-u"> km</span>';pStats[1].textContent=paceStr;pStats[2].textContent=timeStr;}
  // Date
  var now=new Date();var ds=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][now.getDay()]+', '+(now.getMonth()+1)+'/'+now.getDate();
  document.querySelectorAll('.ov-dt').forEach(function(e){e.textContent=ds;});
    drawRoute(document.getElementById('mmp'),{lw:3,pad:18,alpha:.2,ri:0});
  }

function drawRoute(canvas,opts={}){
  if(!canvas)return;
  const{stroke='#c8f050',lw=1.5,pad=7,alpha=.82,ri=0}=opts;
  const R=ROUTES[ri%3],W=canvas.width,H=canvas.height,ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const la=R.map(p=>p[0]),ln=R.map(p=>p[1]);
  const mla=Math.min(...la),xla=Math.max(...la),mln=Math.min(...ln),xln=Math.max(...ln);
  const rl=xla-mla||.001,rn=xln-mln||.001;
  const xy=(a,n2)=>[pad+(n2-mln)/rn*(W-pad*2),pad+(xla-a)/rl*(H-pad*2)];
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw+2;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=.08;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=alpha;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  const last=R[R.length-1];const[ex,ey]=xy(last[0],last[1]);
  ctx.save();ctx.beginPath();ctx.arc(ex,ey,2.5,0,Math.PI*2);ctx.fillStyle=stroke;ctx.shadowColor=stroke;ctx.shadowBlur=6;ctx.fill();ctx.restore();
}

let AT='g';
document.getElementById('tbar').addEventListener('click',e=>{
  const b=e.target.closest('.th');if(!b)return;const t=b.dataset.t;if(t===AT)return;AT=t;
  ['ov-g','ov-p','ov-s'].forEach(id=>document.getElementById(id).classList.toggle('off',!id.endsWith(t)));
  document.querySelectorAll('.th').forEach(x=>x.classList.toggle('on',x.dataset.t===t));
});

let pURL=null;
const bgEl=document.getElementById('bg-img'),emEl=document.getElementById('empty-state');
function loadFile(f){
  if(!f||!f.type.startsWith('image/'))return;if(pURL)URL.revokeObjectURL(pURL);
  pURL=URL.createObjectURL(f);bgEl.onload=()=>{bgEl.style.opacity='1';if(emEl)emEl.style.display='none';};bgEl.src=pURL;
}
document.getElementById('ic').addEventListener('change',e=>loadFile(e.target.files[0]));
document.getElementById('ig').addEventListener('change',e=>loadFile(e.target.files[0]));

// AVATARS
const AVATARS=[{e:'🦊',l:'여우'},{e:'🐆',l:'치타'},{e:'🦅',l:'독수리'},{e:'🌊',l:'파도'},{e:'🔥',l:'불꽃'},{e:'⚡',l:'번개'},{e:'🌙',l:'달빛'},{e:'💎',l:'다이아'},{e:'🎯',l:'목표'},{e:'🚀',l:'로켓'}];
(function(){
  const g=document.getElementById('avgrid');
  AVATARS.forEach((av,i)=>{
    const c=document.createElement('div');c.className='avc'+(i===0?' on':'');
    c.innerHTML=`<span class="ave">${av.e}</span><span class="avl">${av.l}</span>`;
    c.addEventListener('click',()=>{
      document.querySelectorAll('.avc').forEach(x=>x.classList.remove('on'));c.classList.add('on');
      ['g','p','s'].forEach(t=>{const em=document.getElementById('em-'+t),nm=document.getElementById('nm-'+t);if(em)em.textContent=av.e;if(nm)nm.textContent=currentUser?currentUser.nickname:'Runner';});
      const emb=document.getElementById('em-b');if(emb)emb.textContent=av.e;closeAv();
      if(currentUser)GR_API.updateUser({avatar:av.e}).then(u=>{currentUser=u;const np=document.getElementById('nav-profile');if(np)np.textContent=av.e;});
    });g.appendChild(c);
  });
})();
function openAv(){document.getElementById('avs').classList.add('on');}
function closeAv(){document.getElementById('avs').classList.remove('on');}
document.getElementById('avs').addEventListener('click',function(e){if(e.target===this)closeAv();});

// RECORDS
function initRec(){
  // 크루 섹션은 항상 갱신 (가입 크루 실시간 반영)
  var crewElCheck=document.getElementById('rec-past-crews');
  if(crewElCheck){
    crewElCheck.innerHTML='';
    var hist=getHistory();
    if(hist.length===0){
      var empty=document.createElement('div');
      empty.style.cssText='padding:20px 0;text-align:center;color:rgba(255,255,255,.25);font-size:12px;font-weight:200';
      var emptyTxt=document.createTextNode('아직 참여한 크루가 없어요');
      empty.appendChild(emptyTxt);
      empty.appendChild(document.createElement('br'));
      var emptyLink=document.createElement('span');
      emptyLink.style.cssText='color:rgba(200,240,80,.4);cursor:pointer';
      emptyLink.textContent='크루 둘러보기 →';
      emptyLink.onclick=function(){goTab('crew');};
      empty.appendChild(emptyLink);
      crewElCheck.appendChild(empty);
    } else {
      hist.forEach(function(room){ renderRecCrewBadge(room); });
    }
  }
  if(recInited)return;recInited=true;
  const today=new Date(),days=new Date(today.getFullYear(),today.getMonth()+1,0).getDate(),runDays=new Set([5,10,14,18]);
  const cg=document.getElementById('cal-grid');
  if(cg){for(let d=1;d<=days;d++){const dot=document.createElement('div');dot.className='cal-d'+(d===today.getDate()?' today':runDays.has(d)?' run':'');cg.appendChild(dot);}}
  setTimeout(()=>{const rf=document.getElementById('rt-fill');if(rf)rf.style.width='38%';},100);
  const logEl=document.getElementById('run-log');
  if(logEl)PAST_LOGS.forEach(r=>{
    const item=document.createElement('div');item.className='log-item';
    const cv=document.createElement('canvas');cv.width=52;cv.height=52;cv.className='log-cv';drawRoute(cv,{stroke:'#c8f050',lw:1.5,pad:6,alpha:.8,ri:r.ri});
    item.innerHTML=`<div class="log-date"><span class="log-mo">${r.mo}</span><span class="log-dy">${r.date.split('.')[1]}</span></div>`;item.appendChild(cv);
    const info=document.createElement('div');info.className='log-info';
    info.innerHTML=`<span class="log-km">${r.d.toFixed(2)}<span style="font-size:16px;color:var(--dim)"> km</span></span><span class="log-sub">${r.pace}/km · ${r.time}</span>`;item.appendChild(info);
    const right=document.createElement('div');right.className='log-right';right.innerHTML=`<span class="log-kcal">${r.cal} kcal</span>`;item.appendChild(right);
    logEl.appendChild(item);
  });
}


function renderRunCrewBadge(){
  var el=document.getElementById('run-crew-badge');
  if(!el)return;
  el.innerHTML='';
  var hist=getHistory();
  // 가입 크루 없으면 샘플 크루 첫번째 사용
  if(hist.length===0){
    var allRooms=[...SAMPLE_ROOMS,...getRooms()];
    if(allRooms.length===0){el.style.display='none';return;}
    hist=[allRooms[0]];
  }
  el.style.display='flex';
  // 최대 2개만 표시
  hist.slice(0,2).forEach(function(room){
    var badge=document.createElement('div');
    badge.style.cssText='background:rgba(0,0,0,.6);backdrop-filter:blur(8px);border:1px solid rgba(200,240,80,.25);border-radius:20px;padding:4px 10px 4px 7px;display:flex;align-items:center;gap:5px';
    var em=document.createElement('span');
    em.style.cssText='font-size:13px;line-height:1';
    em.textContent=room.emoji||room.em||'🦊';
    var nm=document.createElement('span');
    nm.style.cssText='font-family:\'Barlow Condensed\',sans-serif;font-size:11px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.85);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
    nm.textContent=room.name;
    badge.style.cursor='pointer';
    badge.onclick=function(){ showCrewRoom(room); };
    badge.appendChild(em);
    badge.appendChild(nm);
    el.appendChild(badge);
  });
}

function updateRecCrews(){
  var crewEl=document.getElementById('rec-past-crews');
  if(!crewEl)return;
  crewEl.innerHTML='';
  var hist=getHistory();
  if(hist.length===0){
    var empty=document.createElement('div');
    empty.style.cssText='padding:20px 0;text-align:center;color:rgba(255,255,255,.25);font-size:12px;font-weight:200';
    var t=document.createTextNode('아직 참여한 크루가 없어요');
    empty.appendChild(t);
    empty.appendChild(document.createElement('br'));
    var lnk=document.createElement('span');
    lnk.style.cssText='color:rgba(200,240,80,.4);cursor:pointer';
    lnk.textContent='크루 둘러보기 →';
    lnk.onclick=function(){goTab('crew');};
    empty.appendChild(lnk);
    crewEl.appendChild(empty);
  } else {
    hist.forEach(function(room){ renderRecCrewBadge(room); });
  }
}

// MODALS
function openModal(id){const el=document.getElementById(id);if(!el)return;el.style.display='flex';requestAnimationFrame(()=>el.classList.add('on'));}
function closeModal(id){const el=document.getElementById(id);if(!el)return;el.classList.remove('on');setTimeout(()=>{el.style.display='none';},200);}
document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',function(e){if(e.target===this)closeModal(this.id);});});


// ══════════════════════════════════════
// SHOT SAVE: html2canvas → download/share
// ══════════════════════════════════════

async function saveShot() {
  var card = document.getElementById('card');
  if (!card) { showToast('카드를 찾을 수 없어요'); return; }

  var btn = document.getElementById('bsave');
  if (btn) { btn.disabled = true; btn.textContent = '저장 중...'; }

  // Flash effect
  var fl = document.getElementById('flash');
  if (fl) { fl.classList.add('on'); setTimeout(function(){ fl.classList.remove('on'); }, 180); }

  try {
    var canvas = await html2canvas(card, {
      useCORS: true,
      allowTaint: true,
      scale: window.devicePixelRatio || 2,
      backgroundColor: null,
      logging: false,
      ignoreElements: function(el) {
        // Ignore the action bar below the card
        return el.id === 'shot-acts' || el.classList.contains('btabs');
      }
    });

    var dataUrl = canvas.toDataURL('image/png');
    var filename = 'claprun_' + new Date().toISOString().slice(0,10) + '.png';

    // Try Web Share API first (mobile: saves to gallery or shares)
    if (navigator.share && navigator.canShare) {
      try {
        var blob = await new Promise(function(res) { canvas.toBlob(res, 'image/png'); });
        var file = new File([blob], filename, { type: 'image/png' });
        if (navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'ClapRun 인증샷',
            text: '오늘도 달렸어요 🔥'
          });
          showToast('✅ 공유 완료!');
          return;
        }
      } catch(shareErr) {
        if (shareErr.name !== 'AbortError') {
          console.warn('Share failed, falling back to download:', shareErr);
        } else {
          // User cancelled share - still ok
          return;
        }
      }
    }

    // Fallback: download as file
    var a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('✅ 사진이 저장됐어요!');

  } catch(err) {
    console.error('Shot save error:', err);
    showToast('저장 실패 - 스크린샷을 이용해주세요');
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>저장하기'; }
  }
}

document.getElementById('bsave').addEventListener('click', saveShot);


let toastTimer=null;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('on'),2400);}

// GR_API
const GR_API = {
  // ── 현재 세션 유저 반환 ──
  currentUser() {
    try { return JSON.parse(localStorage.getItem('claprun_session') || 'null'); } catch { return null; }
  },
  _saveSession(u) { localStorage.setItem('claprun_session', JSON.stringify(u)); },
  _clearSession() { localStorage.removeItem('claprun_session'); },

  // ── 회원가입 ──
  async register(email, password, nickname) {
    if (nickname.trim().length < 2) throw new Error('닉네임은 2자 이상이어야 해요');
    const { data, error } = await _SB.auth.signUp({ email, password });
    if (error) throw new Error(error.message === 'User already registered' ? '이미 사용 중인 이메일이에요' : error.message);
    const uid = data.user.id;
    const atCode = 'AF-' + Math.random().toString(36).toUpperCase().slice(2, 8).replace(/[^A-Z0-9]/g, 'X').padEnd(6, 'X');
    await _SB.from('profiles').insert({ id: uid, nickname: nickname.trim(), avatar: '🦊', at_code: atCode });
    const user = { id: uid, email, nickname: nickname.trim(), avatar: '🦊', atCode, totalKm: 0, runCount: 0, joinedAt: new Date().toISOString() };
    this._saveSession(user);
    return user;
  },

  // ── 로그인 ──
  async login(email, password) {
    const { data, error } = await _SB.auth.signInWithPassword({ email, password });
    if (error) throw new Error('이메일 또는 비밀번호가 맞지 않아요');
    const uid = data.user.id;
    const { data: profile } = await _SB.from('profiles').select('*').eq('id', uid).single();
    const { data: runs } = await _SB.from('runs').select('distance').eq('user_id', uid);
    const totalKm = runs ? runs.reduce((s, r) => s + (r.distance || 0), 0) : 0;
    const user = {
      id: uid, email,
      nickname: profile?.nickname || email.split('@')[0],
      avatar: profile?.avatar || '🦊',
      atCode: profile?.at_code || '',
      totalKm: parseFloat(totalKm.toFixed(1)),
      runCount: runs?.length || 0,
      joinedAt: profile?.joined_at || new Date().toISOString()
    };
    this._saveSession(user);
    return user;
  },

  // ── 소셜 로그인 (Google) ──
  async socialLogin(provider) {
    if (provider === 'google') {
      const { error } = await _SB.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } });
      if (error) throw new Error(error.message);
      return null;
    }
    // kakao/naver: mock 유지
    const mockNames = { kakao: '카카오러너', naver: '네이버러너' };
    const mockEmail = provider + '_' + Date.now() + '@claprun.mock';
    const atCode = 'AF-' + Math.random().toString(36).toUpperCase().slice(2, 8).replace(/[^A-Z0-9]/g, 'X').padEnd(6, 'X');
    const user = { id: 'mock_' + Date.now(), email: mockEmail, nickname: mockNames[provider] || provider, avatar: '🦊', atCode, totalKm: 0, runCount: 0, joinedAt: new Date().toISOString() };
    this._saveSession(user);
    return user;
  },

  // ── 로그아웃 ──
  async logout() {
    await _SB.auth.signOut();
    this._clearSession();
  },

  // ── 유저 정보 업데이트 ──
  async updateUser(fields) {
    const session = this.currentUser();
    if (!session) return;
    const dbFields = {};
    if (fields.nickname) dbFields.nickname = fields.nickname;
    if (fields.avatar) dbFields.avatar = fields.avatar;
    if (Object.keys(dbFields).length) {
      await _SB.from('profiles').update(dbFields).eq('id', session.id);
    }
    const updated = { ...session, ...fields };
    this._saveSession(updated);
    return updated;
  },

  // ── 런 기록 저장 ──
  async saveRun(runData) {
    const session = this.currentUser();
    if (!session) return;
    const { error } = await _SB.from('runs').insert({
      user_id: session.id,
      distance: runData.distance,
      pace: runData.pace,
      time: runData.time,
      cal: runData.cal
    });
    if (error) console.error('런 저장 실패:', error.message);
  },

  // ── Clap 저장 ──
  async saveClap(toUserId, runId) {
    const session = this.currentUser();
    if (!session) return;
    await _SB.from('claps').insert({ from_user: session.id, to_user: toUserId, run_id: runId });
  },

  // ── 내 런 기록 불러오기 ──
  async getMyRuns() {
    const session = this.currentUser();
    if (!session) return [];
    const { data } = await _SB.from('runs').select('*').eq('user_id', session.id).order('created_at', { ascending: false }).limit(20);
    return data || [];
  },

  // ── 받은 Clap 수 ──
  async getReceivedClaps() {
    const session = this.currentUser();
    if (!session) return 0;
    const { count } = await _SB.from('claps').select('*', { count: 'exact', head: true }).eq('to_user', session.id);
    return count || 0;
  },

  async ping() { return true; }
};

// AUTH
let authMode='login',currentUser=null;
function showLoginScreen(){const ls=document.getElementById('login-screen');if(!ls)return;ls.style.display='flex';ls.classList.remove('out');}
function hideLoginScreen(){const ls=document.getElementById('login-screen');if(!ls)return;ls.classList.add('out');setTimeout(()=>{ls.style.display='none';},600);}
function toggleAuthMode(){
  authMode=authMode==='login'?'register':'login';const isReg=authMode==='register';
  const mt=document.getElementById('ls-mode-title'),ms=document.getElementById('ls-mode-sub'),ni=document.getElementById('ls-nick'),sb=document.getElementById('ls-submit'),sw=document.getElementById('ls-switch'),err=document.getElementById('ls-err'),pw=document.getElementById('ls-pw');
  if(mt)mt.textContent=isReg?'회원가입':'로그인';if(ms)ms.textContent=isReg?'새 계정을 만들어보세요':'계속하려면 로그인하세요';
  if(ni)ni.style.display=isReg?'block':'none';if(sb)sb.textContent=isReg?'가입하기':'로그인';
  if(sw)sw.innerHTML=isReg?'이미 계정이 있으신가요? <span>로그인</span>':'계정이 없으신가요? <span>회원가입</span>';
  if(err)err.textContent='';if(pw)pw.setAttribute('autocomplete',isReg?'new-password':'current-password');
}
async function submitAuth(){
  const emailEl=document.getElementById('ls-email'),pwEl=document.getElementById('ls-pw'),nickEl=document.getElementById('ls-nick'),errEl=document.getElementById('ls-err'),btn=document.getElementById('ls-submit');
  if(!emailEl||!pwEl||!errEl||!btn)return;
  const email=emailEl.value.trim(),pw=pwEl.value,nick=nickEl?nickEl.value.trim():'';
  errEl.textContent='';if(!email){errEl.textContent='이메일을 입력해주세요';return;}if(!pw){errEl.textContent='비밀번호를 입력해주세요';return;}
  btn.textContent='처리 중...';btn.style.opacity='.6';btn.disabled=true;
  try{
    let user;
    if(authMode==='register'){if(!nick){errEl.textContent='닉네임을 입력해주세요';return;}user=await GR_API.register(email,pw,nick);showToast('회원가입이 완료됐어요!');}
    else{user=await GR_API.login(email,pw);showToast('어서오세요, '+user.nickname+'님!');}
    onLoginSuccess(user);
  }catch(e){if(errEl)errEl.textContent=e.message;}
  finally{if(btn){btn.textContent=authMode==='register'?'가입하기':'로그인';btn.style.opacity='1';btn.disabled=false;}}
}
async function socialLogin(provider){
  const errEl=document.getElementById('ls-err');
  if(provider==='kakao'||provider==='naver'){
    showToast(provider==='kakao'?'카카오 로그인은 준비 중이에요':'네이버 로그인은 준비 중이에요');
    return;
  }
  if(errEl)errEl.textContent=provider+' 로그인 처리 중...';
  try{
    const user=await GR_API.socialLogin(provider);
    if(user){showToast('어서오세요, '+(user.nickname||'러너')+'님!');onLoginSuccess(user);}
  }catch(e){if(errEl)errEl.textContent=e.message;}
}
function onLoginSuccess(user){
  if(!user) return;
  currentUser=user;
  const np=document.getElementById('nav-profile');
  if(np)np.textContent=user.avatar||'🦊';
  ['nm-g','nm-p','nm-s'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=user.nickname||'러너';});
  hideLoginScreen();setSrvBadge(true);
}
function openProfile(){
  if(!currentUser){showLoginScreen();return;}
  var u=currentUser;
  var box=document.getElementById('prof-box');
  if(!box)return;
  box.innerHTML='';

  var _myAt=u.atCode||('AF-'+u.id.replace(/\D/g,'').slice(-6).padStart(6,'0'));
  var totalKm=(u.totalKm||312.4).toFixed(1);
  var runCnt=u.runCount||62;

  function el(tag,css,txt){
    var e=document.createElement(tag);
    if(css)e.style.cssText=css;
    if(txt!=null)e.textContent=txt;
    return e;
  }
  function div(css,txt){return el('div',css,txt);}
  function span(css,txt){return el('span',css,txt);}

  // ── HEADER ──
  var hd=div('padding:22px 20px 16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:14px');
  var av=div('width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(200,240,80,.25);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0');
  av.textContent=u.avatar||'🦊';
  var info=div('flex:1');
  var nm=div('font-family:Barlow Condensed,sans-serif;font-style:italic;font-size:20px;font-weight:300',u.nickname);
  var em=div('font-size:10px;font-weight:200;color:rgba(255,255,255,.4);margin-top:2px',u.email);
  var jn=div('font-size:9px;font-weight:200;color:rgba(200,240,80,.6);margin-top:3px','가입일 '+new Date(u.joinedAt).toLocaleDateString('ko-KR'));
  var atBox=div('margin-top:6px;display:inline-flex;align-items:center;gap:6px;background:rgba(200,240,80,.08);border:1px solid rgba(200,240,80,.18);border-radius:8px;padding:4px 10px;cursor:pointer');
  atBox.onclick=function(){copyRoomCode(_myAt);};
  atBox.appendChild(span('font-family:Barlow Condensed,sans-serif;font-size:15px;font-weight:700;letter-spacing:.08em;color:#c8f050',_myAt));
  atBox.appendChild(span('font-size:10px;color:rgba(255,255,255,.35)','📋'));
  info.appendChild(nm);info.appendChild(em);info.appendChild(jn);info.appendChild(atBox);
  hd.appendChild(av);hd.appendChild(info);
  box.appendChild(hd);

  // ── 총 러닝 거리 (대형 히어로) ──
  var totalClapVal = getTotalClap();
  // 총 시간 계산 (PAST_LOGS 기반)
  var totalMinutes = (PAST_LOGS||[]).reduce(function(sum, r){
    var parts = (r.time||'0:00').split(':');
    return sum + (parseInt(parts[0]||0)*60 + parseInt(parts[1]||0));
  }, 0);
  var totalTimeStr = totalMinutes >= 60
    ? Math.floor(totalMinutes/60) + 'h ' + (totalMinutes%60) + 'm'
    : totalMinutes + 'm';

  var distHero = div('padding:22px 20px 16px;border-bottom:1px solid rgba(255,255,255,.07);text-align:center;background:linear-gradient(180deg,rgba(200,240,80,.04),transparent)');
  distHero.appendChild(span('font-size:9px;font-weight:300;letter-spacing:.18em;color:rgba(200,240,80,.6)', '총 러닝 거리'));
  var distRow = div('display:flex;align-items:baseline;justify-content:center;gap:6px;margin-top:6px');
  distRow.appendChild(span('font-family:Barlow Condensed,sans-serif;font-size:72px;font-weight:300;color:#c8f050;line-height:.85;letter-spacing:-.02em', totalKm));
  distRow.appendChild(span('font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:300;color:rgba(200,240,80,.5)', 'km'));
  distHero.appendChild(distRow);
  box.appendChild(distHero);

  // ── STATS 4칸: 완주 횟수 / 평균 페이스 / 총 시간 / 받은 CLAP ──
  var sg = div('display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid rgba(255,255,255,.07)');
  [{val:runCnt+'', lbl:'완주 횟수', c:'rgba(255,255,255,.9)'},
   {val:"5'18\"",   lbl:'평균 페이스', c:'rgba(255,255,255,.9)'},
   {val:totalTimeStr, lbl:'총 시간',   c:'rgba(255,255,255,.9)'},
   {val:totalClapVal+'', lbl:'받은 CLAP', c:'#c8f050'}
  ].forEach(function(s, i){
    var cell = div('padding:14px 6px;display:flex;flex-direction:column;align-items:center;gap:3px' + (i<3?';border-right:1px solid rgba(255,255,255,.07)':''));
    cell.appendChild(span('font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:400;color:'+s.c+';line-height:1', s.val));
    cell.appendChild(span('font-size:8px;font-weight:300;letter-spacing:.07em;color:rgba(255,255,255,.35);text-align:center', s.lbl));
    sg.appendChild(cell);
  });
  box.appendChild(sg);

  // ── 이번 달 목표 ──
  var goalSec=div('padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.07)');
  var goalTop=div('display:flex;justify-content:space-between;align-items:center;margin-bottom:8px');
  goalTop.appendChild(span('font-size:10px;font-weight:300;letter-spacing:.1em;color:rgba(255,255,255,.4)','이번 달 목표'));
  goalTop.appendChild(span('font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:700;color:#c8f050','38%'));
  var barWrap=div('height:4px;background:rgba(255,255,255,.08);border-radius:2px');
  var barFill=div('width:38%;height:100%;background:linear-gradient(90deg,rgba(200,240,80,.4),#c8f050);border-radius:2px');
  barWrap.appendChild(barFill);
  goalSec.appendChild(goalTop);goalSec.appendChild(barWrap);
  goalSec.appendChild(div('font-size:10px;font-weight:300;color:rgba(255,255,255,.3);margin-top:5px','37.8 / 100 km'));
  box.appendChild(goalSec);

  // ── 최근 런 ──
  var logSec=div('padding:16px 18px 0');
  logSec.appendChild(div('font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:900;letter-spacing:.04em;color:#fff;margin-bottom:12px','최근 런'));
  (PAST_LOGS||[]).slice(0,5).forEach(function(r){
    var row=div('display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.06)');
    var dt=div('flex-shrink:0;text-align:center;width:32px');
    dt.appendChild(div('font-size:7px;font-weight:200;color:rgba(255,255,255,.3);letter-spacing:.06em',r.mo));
    dt.appendChild(div('font-family:Barlow Condensed,sans-serif;font-size:26px;font-weight:300;color:#fff;line-height:1;letter-spacing:1px',r.date.split('.')[1]));
    var inf=div('flex:1');
    var kmLine=document.createElement('div');
    kmLine.style.cssText='font-family:Barlow Condensed,sans-serif;font-size:22px;font-weight:300;color:#c8f050;line-height:1';
    kmLine.innerHTML=r.d.toFixed(2)+'<span style="font-size:13px;font-weight:300;color:rgba(255,255,255,.35)"> km</span>';
    inf.appendChild(kmLine);
    inf.appendChild(div('font-size:11px;font-weight:200;color:rgba(255,255,255,.3);margin-top:3px',r.pace+'/km · '+r.time));
    row.appendChild(dt);row.appendChild(inf);
    var rightCol = div('text-align:right;flex-shrink:0;display:flex;flex-direction:column;gap:3px');
    rightCol.appendChild(div('font-size:11px;font-weight:200;color:rgba(255,255,255,.25)',r.time));
    rightCol.appendChild(div('font-size:11px;font-weight:300;color:rgba(255,255,255,.35)',r.cal+' kcal'));
    if(r.receivedClap){
      rightCol.appendChild(div('font-size:11px;font-weight:400;color:rgba(200,240,80,.6)','👏 '+r.receivedClap));
    }
    row.appendChild(rightCol);
    logSec.appendChild(row);
  });
  box.appendChild(logSec);

  // ── 참여한 크루 ──
  var crewSec=div('padding:16px 18px 0');
  crewSec.appendChild(div('font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:900;letter-spacing:.04em;color:#fff;margin-bottom:10px','참여한 크루'));
  [{em:'🌙',name:'새벽 5km 챌린지',dist:'24.5 km',period:'7일'},{em:'🏃',name:'한강 10K 런',dist:'10.1 km',period:'14일'},{em:'⚡',name:'번개 달리기단',dist:'15.3 km',period:'30일'}].forEach(function(c){
    var row=div('display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)');
    var ico=div('width:38px;height:38px;border-radius:10px;background:rgba(200,240,80,.07);border:1px solid rgba(200,240,80,.12);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0');
    ico.textContent=c.em;
    var ci=div('flex:1');
    ci.appendChild(div('font-size:13px;font-weight:400;color:rgba(255,255,255,.85)',c.name));
    ci.appendChild(div('font-size:10px;font-weight:300;color:rgba(255,255,255,.35);margin-top:2px',c.dist+' · '+c.period));
    row.appendChild(ico);row.appendChild(ci);crewSec.appendChild(row);
  });
  box.appendChild(crewSec);

  // ── 내 인증샷 ──
  var myShotFeed = getShotFeed().filter(function(p){ return p.user === (u.nickname||'Runner'); });
  var shotSec = div('padding:16px 18px 0');
  var shotHeader = div('display:flex;align-items:center;justify-content:space-between;margin-bottom:12px');
  shotHeader.appendChild(div('font-family:Barlow Condensed,sans-serif;font-size:18px;font-weight:900;letter-spacing:.04em;color:#fff', '내 인증샷'));
  var shotCount = div('font-size:11px;color:rgba(200,240,80,.6);font-weight:600', myShotFeed.length + '장');
  shotHeader.appendChild(shotCount);
  shotSec.appendChild(shotHeader);

  if (myShotFeed.length === 0) {
    var emptyMsg = div('text-align:center;padding:24px 0;font-size:12px;color:rgba(255,255,255,.25);line-height:1.6', '아직 올린 인증샷이 없어요\n피드에 올리기로 공유해보세요 👏');
    emptyMsg.style.whiteSpace = 'pre-line';
    shotSec.appendChild(emptyMsg);
  } else {
    var grid = div('display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px');
    myShotFeed.forEach(function(post) {
      var cell = div('position:relative;border-radius:10px;overflow:hidden;aspect-ratio:1;cursor:pointer;background:#111');
      // 이미지 or 그라디언트
      if (post.dataUrl) {
        var img = document.createElement('img');
        img.src = post.dataUrl;
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block';
        cell.appendChild(img);
      } else {
        cell.style.background = 'linear-gradient(145deg,#0d1a0d,#1a2e0d)';
        var em = div('position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px', post.em || '👏');
        cell.appendChild(em);
      }
      // 거리 오버레이
      var overlay = div('position:absolute;bottom:0;left:0;right:0;padding:4px 6px;background:linear-gradient(transparent,rgba(0,0,0,.7))');
      overlay.appendChild(div('font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:900;color:#c8f050;line-height:1', post.dist.toFixed(2) + 'km'));
      cell.appendChild(overlay);
      // 삭제 버튼
      var delBtn = document.createElement('button');
      delBtn.style.cssText = 'position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.65);border:none;border-radius:50%;font-size:10px;color:rgba(255,255,255,.7);cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation;z-index:2';
      delBtn.textContent = '✕';
      (function(pid) {
        delBtn.onclick = function(e) {
          e.stopPropagation();
          if (!confirm('이 인증샷을 삭제할까요?')) return;
          var feed = getShotFeed().filter(function(p){ return p.id !== pid; });
          saveShotFeed(feed);
          // INSTA_POSTS에서도 제거
          var idx2 = INSTA_POSTS.findIndex ? INSTA_POSTS.findIndex(function(p){ return p._id === pid; }) : -1;
          if (idx2 > -1) INSTA_POSTS.splice(idx2, 1);
          buildInstaFeed();
          cell.style.transition = 'opacity .2s,transform .2s';
          cell.style.opacity = '0';
          cell.style.transform = 'scale(.85)';
          setTimeout(function(){ cell.remove(); shotCount.textContent = (parseInt(shotCount.textContent)-1) + '장'; }, 200);
          showToast('🗑 인증샷 삭제됨');
        };
      })(post.id);
      cell.appendChild(delBtn);
      // 탭하면 피드 전체 열기
      cell.addEventListener('click', function() { openShotFeed(); });
      grid.appendChild(cell);
    });
    shotSec.appendChild(grid);
  }
  box.appendChild(shotSec);

  // ── 설정 메뉴 ──
  var menuSec=div('margin-top:12px;border-top:1px solid rgba(255,255,255,.07)');
  [{em:'✏️',txt:'닉네임 변경',fn:editNickname},{em:'🦊',txt:'아바타 변경',fn:editAvatar}].forEach(function(m){
    var item=div('display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.07);cursor:pointer;transition:background .15s');
    item.onclick=m.fn;
    item.appendChild(span('font-size:16px;width:22px;text-align:center',m.em));
    item.appendChild(span('flex:1;font-size:13px;font-weight:200',m.txt));
    item.appendChild(span('font-size:11px;color:rgba(255,255,255,.35)','›'));
    menuSec.appendChild(item);
  });
  box.appendChild(menuSec);

  // ── 로그아웃 ──
  var logoutBtn=document.createElement('button');
  logoutBtn.className='prof-logout';logoutBtn.textContent='로그아웃';logoutBtn.onclick=doLogout;
  box.appendChild(logoutBtn);

  openModal('m-profile');
}

// ── Supabase 세션 복원 ──
(async function() {
  const { data: { session } } = await _SB.auth.getSession();
  if (session && !GR_API.currentUser()) {
    const uid = session.user.id;
    const { data: profile } = await _SB.from('profiles').select('*').eq('id', uid).single();
    if (profile) {
      const user = {
        id: uid,
        email: session.user.email,
        nickname: profile.nickname,
        avatar: profile.avatar || '🦊',
        atCode: profile.at_code || '',
        totalKm: 0, runCount: 0,
        joinedAt: profile.joined_at
      };
      GR_API._saveSession(user);
    }
  }
  // OAuth 리다이렉트 후 처리
  _SB.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      const uid = session.user.id;
      const { data: profile } = await _SB.from('profiles').select('*').eq('id', uid).single();
      if (profile && !GR_API.currentUser()) {
        const user = { id: uid, email: session.user.email, nickname: profile.nickname, avatar: profile.avatar || '🦊', atCode: profile.at_code || '', totalKm: 0, runCount: 0, joinedAt: profile.joined_at };
        GR_API._saveSession(user);
        onLoginSuccess(user);
      }
    }
  });
})();
async function doLogout(){await GR_API.logout();currentUser=null;recInited=false;const np=document.getElementById('nav-profile');if(np)np.textContent='👤';closeModal('m-profile');showLoginScreen();showToast('로그아웃됐어요');}
function editNickname(){
  var existing = document.getElementById('nickname-sheet');
  if (existing) existing.remove();

  var sheet = document.createElement('div');
  sheet.id = 'nickname-sheet';
  sheet.style.cssText = 'position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.75);backdrop-filter:blur(10px);display:flex;align-items:flex-end;justify-content:center';
  sheet.innerHTML = `
    <div style="width:100%;max-width:430px;background:#161616;border-radius:20px 20px 0 0;border-top:1px solid rgba(255,255,255,.08);padding:20px 20px 40px">
      <div style="width:36px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;margin:0 auto 18px"></div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:#fff;margin-bottom:14px">닉네임 변경</div>
      <input id="nickname-input" type="text" maxlength="16" placeholder="새 닉네임 (2자 이상)"
        style="width:100%;height:48px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:0 14px;font-size:15px;color:#fff;font-family:'Pretendard',sans-serif;outline:none;margin-bottom:14px">
      <div style="display:flex;gap:10px">
        <button onclick="document.getElementById('nickname-sheet').remove()"
          style="flex:1;height:48px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:13px;font-size:14px;font-weight:600;color:rgba(255,255,255,.5);cursor:pointer;touch-action:manipulation">취소</button>
        <button onclick="confirmNickname()"
          style="flex:2;height:48px;background:#c8f050;border:none;border-radius:13px;font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:800;color:#0a0a0a;cursor:pointer;touch-action:manipulation;box-shadow:0 4px 16px rgba(200,240,80,.3)">변경하기</button>
      </div>
    </div>`;
  document.body.appendChild(sheet);
  setTimeout(function(){ var inp = document.getElementById('nickname-input'); if(inp){ inp.value = currentUser ? (currentUser.nickname||'') : ''; inp.focus(); inp.select(); } }, 80);
}

function confirmNickname(){
  var inp = document.getElementById('nickname-input');
  var n = inp ? inp.value.trim() : '';
  if (!n || n.length < 2) { showToast('닉네임은 2자 이상이어야 해요'); return; }
  GR_API.updateUser({nickname: n}).then(function(u){
    currentUser = u;
    // 닉네임 UI 즉시 반영
    var np = document.getElementById('nav-profile');
    if (np) np.textContent = u.avatar || '🦊';
    document.getElementById('nickname-sheet').remove();
    closeModal('m-profile');
    setTimeout(openProfile, 150);
    showToast('✅ 닉네임이 변경됐어요');
  }).catch(function(e){ showToast('변경 실패: ' + e.message); });
}
function editAvatar(){closeModal('m-profile');openAv();}
function setSrvBadge(online){const badge=document.getElementById('srv-badge'),txt=document.getElementById('srv-txt');if(!badge||!txt)return;badge.classList.toggle('online',online);txt.textContent=online?'서버 연결됨':'서버 오프라인';setTimeout(()=>{badge.style.opacity='0';},3000);}
async function checkServer(){const online=await GR_API.ping();setSrvBadge(online);}

// INIT
(function initApp(){
  const badge=document.getElementById('srv-badge');if(badge)badge.style.opacity='1';checkServer();
  const session=GR_API.currentUser();
  if(session){currentUser=session;const np=document.getElementById('nav-profile');if(np)np.textContent=session.avatar||'🦊';['nm-g','nm-p','nm-s'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=session.nickname;});}

renderRunCrewBadge();

// iOS: unlock speechSynthesis on first touch
document.addEventListener('touchstart', function _unlockTTS(){
  if(window.speechSynthesis){
    var u=new SpeechSynthesisUtterance('');
    window.speechSynthesis.speak(u);
    window.speechSynthesis.cancel();
  }
  document.removeEventListener('touchstart', _unlockTTS);
}, {once:true});
})();

</script>

<!-- Course detail sheet (fixed overlay) -->
<div id="cm-detail-sheet" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;background:#161616;border-top:1.5px solid rgba(255,255,255,.08);border-radius:22px 22px 0 0;padding:0 0 40px;max-height:60vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s cubic-bezier(.22,1,.36,1)">
  <div style="display:flex;justify-content:center;padding:10px 0 0"><div style="width:32px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)"></div></div>
  <div id="cm-detail-content" style="padding:16px 20px 0"></div>
</div>

<script>
// ── Service Worker 인라인 등록 (Blob URL) ──
if ('serviceWorker' in navigator) {
  var swCode = `
    const CACHE = 'claprun-v1';
    self.addEventListener('install', function(e) { self.skipWaiting(); });
    self.addEventListener('activate', function(e) { self.clients.claim(); });
    self.addEventListener('fetch', function(e) {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(function(cached) {
          return cached || fetch(e.request).then(function(res) {
            if (res && res.status === 200 && res.type !== 'opaque') {
              var clone = res.clone();
              caches.open(CACHE).then(function(c) { c.put(e.request, clone); });
            }
            return res;
          }).catch(function() { return cached; });
        })
      );
    });
  `;
  try {
    var blob = new Blob([swCode], { type: 'application/javascript' });
    var swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(function(reg) {
      console.log('SW registered');
    }).catch(function(err) {
      console.log('SW skipped:', err.message);
    });
  } catch(e) {}
}

// ── 설치 프롬프트 저장 (Add to Home Screen) ──
let deferredPrompt;
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
});
</script>
</body>
</html>
