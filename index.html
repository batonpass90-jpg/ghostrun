<!DOC
<!-- ── 친구 추가 모달 ── -->
<div id="m-friends" class="modal" style="display:none;position:fixed;inset:0;z-index:210;background:rgba(0,0,0,.88);backdrop-filter:blur(20px);align-items:flex-end;justify-content:center">
  <div style="width:100%;max-width:480px;background:#161616;border-radius:26px 26px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 40px;max-height:85vh;overflow-y:auto">
    <div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>
    <div style="padding:18px 22px 0">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;margin-bottom:4px">친구 추가</div>
      <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:16px">닉네임 또는 GR 코드로 친구를 찾아보세요</div>
      <!-- Search bar -->
      <div style="display:flex;gap:8px;margin-bottom:18px">
        <input id="friend-search-input" type="text" placeholder="닉네임 또는 GR-XXXX 입력" maxlength="30"
          style="flex:1;height:46px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Barlow',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box"
          oninput="searchFriends(this.value)">
        <button onclick="searchFriends(document.getElementById('friend-search-input').value)" style="height:46px;padding:0 18px;background:#c8f050;border:none;border-radius:12px;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:#0a0a0a;cursor:pointer">검색</button>
      </div>
      <div id="friend-search-results"></div>
      <!-- Suggested runners -->
      <div style="margin-top:6px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:12px">추천 러너</div>
        <div id="friend-suggest-container"></div>
      </div>
    </div>
  </div>
</div>

TYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>GhostRun</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,300;0,400;0,600;0,700;0,800;0,900;1,400;1,700&family=Barlow:wght@300;400;500&family=Noto+Sans+KR:wght@200;300;400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
:root{
  --bg:#0a0a0d;--sf:#131316;--sf2:#1a1a1e;
  --ln:rgba(255,255,255,.07);--dim:rgba(255,255,255,.28);--mid:rgba(255,255,255,.52);
  --hi:#ede9e1;--acc:#c8f050;
  --gold:#d4b54a;--silver:#a0aab4;--bronze:#b07444;
  --fd:"Barlow Condensed",Impact,sans-serif;
  --fb:"Barlow","Noto Sans KR",system-ui,sans-serif;
}
body{background:var(--bg);color:var(--hi);font-family:var(--fb);
  display:flex;flex-direction:column;height:100dvh;max-width:430px;margin:0 auto;position:relative}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 36px;text-align:center;transition:opacity .7s,transform .7s}
#splash.out{opacity:0;transform:scale(1.04);pointer-events:none}
.sp-grain{position:absolute;inset:0;opacity:.2;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23f)' opacity='.07'/%3E%3C/svg%3E")}
.sp-glow{position:absolute;width:420px;height:420px;border-radius:50%;background:radial-gradient(circle,rgba(200,240,80,.07) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-55%);animation:spPulse 4s ease-in-out infinite}
@keyframes spPulse{0%,100%{transform:translate(-50%,-55%) scale(1)}50%{transform:translate(-50%,-55%) scale(1.15)}}
.sp-lines{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);background-size:38px 38px;mask-image:radial-gradient(ellipse 80% 60% at 50% 50%,black 40%,transparent 80%)}
.sp-em{font-size:62px;margin-bottom:24px;position:relative;animation:floatGhost 3.5s ease-in-out infinite}
@keyframes floatGhost{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}
.sp-logo{font-family:var(--fd);font-style:italic;font-size:46px;font-weight:300;letter-spacing:-.01em;margin-bottom:14px;position:relative}
.sp-sub{font-size:15px;font-weight:300;color:var(--mid);letter-spacing:.04em;margin-bottom:8px;position:relative}
.sp-desc{font-size:12px;font-weight:200;color:var(--dim);letter-spacing:.07em;line-height:1.9;margin-bottom:54px;position:relative}
.sp-btn{background:var(--hi);border:none;border-radius:99px;padding:17px 58px;font-family:var(--fb);font-size:15px;font-weight:300;color:var(--bg);cursor:pointer;letter-spacing:.04em;transition:all .2s;position:relative;box-shadow:0 8px 30px rgba(237,233,225,.1)}
.sp-btn:active{transform:scale(.96)}
.sp-ver{position:absolute;bottom:30px;font-size:10px;font-weight:200;letter-spacing:.14em;color:rgba(255,255,255,.12)}

/* NAV */
#nav{flex-shrink:0;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid var(--ln)}
.logo{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
#clock{font-size:11px;font-weight:200;color:var(--dim);font-variant-numeric:tabular-nums}

/* BOTTOM TABS */
#btabs{flex-shrink:0;display:flex;align-items:stretch;background:rgba(10,10,13,.97);border-top:1px solid var(--ln);padding-bottom:env(safe-area-inset-bottom,0px);z-index:50}
.btab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:7px 2px 6px;background:none;border:none;cursor:pointer;font-family:var(--fb);font-size:9px;font-weight:200;letter-spacing:.04em;color:var(--dim);transition:color .2s;min-width:0}
.btab svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}
.btab.on{color:var(--hi)}
.btab-dot{width:4px;height:4px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity .2s}
.btab.on .btab-dot{opacity:1}
.btab-run-wrap{width:42px;height:42px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;margin-bottom:1px;transition:transform .15s,background .2s}
.btab-run-wrap svg{stroke:var(--bg);fill:var(--bg);width:18px;height:18px}
.btab.on .btab-run-wrap{background:var(--hi);transform:scale(.94)}
.btab[data-v="run"] .btab-dot{display:none}

/* VIEWS */
#main{flex:1;min-height:0;overflow:hidden;position:relative}
.mview{position:absolute;inset:0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .22s;overflow:hidden}
.mview.on{opacity:1;pointer-events:all}

/* ══ HOME ══ */
#v-home{background:var(--bg);overflow-y:auto;scrollbar-width:none}
#v-home::-webkit-scrollbar{display:none}
.hm-hero{position:relative;height:272px;flex-shrink:0;overflow:hidden}
.hm-hero-bg{position:absolute;inset:0;background:linear-gradient(145deg,#0d0d1a 0%,#111128 60%,#0a0a0d 100%)}
.hm-hero-pattern{position:absolute;inset:0;opacity:.05;background-image:repeating-linear-gradient(45deg,var(--hi) 0,var(--hi) 1px,transparent 0,transparent 50%);background-size:22px 22px;mask-image:radial-gradient(ellipse at 50% 50%,black 50%,transparent 80%)}
.hm-hero-glow{position:absolute;width:340px;height:340px;border-radius:50%;background:radial-gradient(circle,rgba(200,240,80,.1) 0%,transparent 65%);top:50%;left:50%;transform:translate(-50%,-50%)}
.hm-hero-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 24px}
.hm-tag{font-size:9px;font-weight:200;letter-spacing:.18em;color:rgba(200,240,80,.65);background:rgba(200,240,80,.07);border:1px solid rgba(200,240,80,.14);border-radius:99px;padding:4px 14px;margin-bottom:16px}
.hm-hero-title{font-family:var(--fd);font-style:italic;font-size:32px;font-weight:300;text-align:center;line-height:1.1;margin-bottom:10px}
.hm-hero-sub{font-size:11px;font-weight:200;color:var(--dim);text-align:center;letter-spacing:.06em;margin-bottom:20px}
.hm-hero-stats{display:flex;gap:28px}
.hm-hs{display:flex;flex-direction:column;align-items:center;gap:2px}
.hm-hsv{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;color:var(--acc);line-height:1}
.hm-hsl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}

.hm-today{margin:16px 16px 0;padding:16px;background:var(--sf2);border:1px solid rgba(200,240,80,.13);border-radius:18px}
.hm-today-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.hm-today-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:rgba(200,240,80,.7)}
.hm-today-btn{background:var(--acc);border:none;border-radius:99px;padding:7px 16px;font-family:var(--fb);font-size:10px;font-weight:300;color:var(--bg);cursor:pointer;transition:opacity .2s}
.hm-today-btn:active{opacity:.8}
.hm-today-row{display:flex}
.hm-ts{flex:1;display:flex;flex-direction:column;gap:3px}
.hm-ts+.hm-ts{border-left:1px solid var(--ln);padding-left:16px}
.hm-tsl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.hm-tsv{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;line-height:1}

.hm-sec{padding:22px 16px 0}
.hm-sec-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:14px}
.hm-sec-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.hm-sec-more{font-size:10px;font-weight:200;color:var(--dim);cursor:pointer}
.hm-cbar{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--ln)}
.hm-cb-rk{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300;width:20px;flex-shrink:0;text-align:right}
.hm-cb-rk.g{color:var(--gold)}.hm-cb-rk.s{color:var(--silver)}.hm-cb-rk.b{color:var(--bronze)}.hm-cb-rk.o{color:var(--dim)}
.hm-cb-em{font-size:15px;flex-shrink:0}
.hm-cb-info{flex:1;min-width:0}
.hm-cb-name{font-size:13px;font-weight:300;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hm-cb-dist{font-size:10px;font-weight:200;color:var(--dim)}
.hm-cb-bar{width:50px;flex-shrink:0}
.hm-cb-bg{height:2px;background:rgba(255,255,255,.07);border-radius:2px}
.hm-cb-fill{height:2px;border-radius:2px}

.hm-feat{background:var(--sf);border:1px solid var(--ln);border-radius:18px;overflow:hidden;cursor:pointer;transition:transform .15s;margin-bottom:12px}
.hm-feat:active{transform:scale(.985)}
.hm-feat-img{height:140px;background:linear-gradient(145deg,#14142a,#0d0d1a);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hm-feat-glow{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 60%,rgba(200,240,80,.1),transparent 55%)}
.hm-feat-em{font-size:56px;position:relative;filter:drop-shadow(0 0 20px rgba(200,240,80,.18))}
.hm-feat-body{padding:16px 18px 18px}
.hm-feat-tag{font-size:9px;font-weight:200;letter-spacing:.14em;color:rgba(200,240,80,.7);margin-bottom:7px}
.hm-feat-title{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;line-height:1.25;margin-bottom:7px}
.hm-feat-desc{font-size:11px;font-weight:200;color:var(--dim);line-height:1.65}
.hm-feat-foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.hm-feat-by{font-size:9px;font-weight:200;color:rgba(255,255,255,.2)}
.hm-feat-cta{font-size:9px;font-weight:200;color:var(--acc);opacity:.8}

.hm-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.hm-card{background:var(--sf);border:1px solid var(--ln);border-radius:14px;overflow:hidden;cursor:pointer;transition:transform .15s}
.hm-card:active{transform:scale(.97)}
.hm-card-top{height:82px;background:linear-gradient(145deg,#161620,#0e0e18);display:flex;align-items:center;justify-content:center;font-size:32px;position:relative}
.hm-card-glow{position:absolute;inset:0;background:radial-gradient(circle at 70% 30%,rgba(200,240,80,.07),transparent 60%)}
.hm-card-body{padding:10px 12px 12px}
.hm-card-tag{font-size:8px;font-weight:200;letter-spacing:.12em;color:var(--acc);opacity:.7;margin-bottom:4px}
.hm-card-title{font-size:11px;font-weight:300;line-height:1.4}
.hm-card-time{font-size:9px;font-weight:200;color:var(--dim);margin-top:4px}

/* ══ RUN ══ */
#v-run{background:var(--bg)}
.rstate{display:none;flex-direction:column;height:100%;overflow-y:auto;scrollbar-width:none}
.rstate::-webkit-scrollbar{display:none}
.rstate.on{display:flex}

.rs-top{padding:20px 18px 16px;border-bottom:1px solid var(--ln);flex-shrink:0}
.rs-title{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;margin-bottom:4px}
.rs-sub{font-size:11px;font-weight:200;color:var(--dim)}

#map-wrap{flex-shrink:0;height:220px;margin:16px 16px 0;border-radius:18px;border:1px solid var(--ln);overflow:hidden;position:relative;background:var(--sf2)}
#gmap{width:100%;height:100%}
.map-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#111124,#0a0a0d);pointer-events:none}
.map-ph.hide{display:none}
.map-ph-em{font-size:32px;opacity:.35}
.map-ph-txt{font-size:11px;font-weight:200;color:var(--dim);text-align:center;padding:0 20px;line-height:1.7}
.loc-btn{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:7px;background:rgba(10,10,13,.88);border:1px solid rgba(255,255,255,.12);border-radius:99px;padding:9px 18px;cursor:pointer;backdrop-filter:blur(12px);font-family:var(--fb);font-size:11px;font-weight:200;color:var(--hi);transition:all .2s;white-space:nowrap}
.loc-btn.on{border-color:rgba(200,240,80,.4);color:var(--acc)}
.loc-dot{width:8px;height:8px;border-radius:50%;background:var(--dim);flex-shrink:0;transition:all .3s}
.loc-btn.on .loc-dot{background:var(--acc);box-shadow:0 0 8px rgba(200,240,80,.6)}

.rs-body{padding:16px 16px 0;flex:1}
.rs-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:var(--dim);margin-bottom:10px}
.gt-row{display:flex;gap:8px;margin-bottom:18px}
.gt{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:14px;padding:12px 4px;text-align:center;cursor:pointer;transition:all .2s}
.gt.on{border-color:rgba(200,240,80,.4);background:rgba(200,240,80,.06)}
.gt-em{font-size:18px;margin-bottom:4px}
.gt-nm{font-size:10px;font-weight:200;color:var(--mid)}
.gt.on .gt-nm{color:var(--hi)}
.gv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
.gv{background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:11px 4px;text-align:center;cursor:pointer;transition:all .2s}
.gv.on{border-color:rgba(200,240,80,.35);background:rgba(200,240,80,.06)}
.gv-n{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300;display:block}
.gv-u{font-size:9px;font-weight:200;color:var(--dim)}
.rs-start{margin:0 16px 16px;background:var(--hi);border:none;border-radius:18px;padding:17px;font-family:var(--fb);font-size:15px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:opacity .2s;flex-shrink:0;letter-spacing:.03em}
.rs-start:active{opacity:.85}

/* active run */
.ra-map-big{flex-shrink:0;height:300px;position:relative;overflow:hidden;background:var(--sf2)}
#gmap-active{width:100%;height:100%}
.ra-map-ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#111124,#0a0a0d)}
.ra-map-ph.hide{display:none}
.ra-stats{display:flex;border-top:1px solid var(--ln);border-bottom:1px solid var(--ln);flex-shrink:0}
.ra-st{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 4px;gap:4px;position:relative}
.ra-st+.ra-st::before{content:'';position:absolute;left:0;top:15%;height:70%;width:1px;background:var(--ln)}
.ra-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.ra-sv{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.ra-su{font-size:9px;font-weight:200;color:var(--dim)}
.ra-goal{padding:14px 18px;background:var(--sf);border-bottom:1px solid var(--ln);flex-shrink:0}
.ra-gl{font-size:9px;font-weight:200;letter-spacing:.1em;color:var(--dim);margin-bottom:7px;display:flex;justify-content:space-between}
.ra-bar{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:visible;position:relative}
.ra-fill{height:3px;border-radius:2px;background:var(--acc);transition:width .5s}
.ra-ctrl{display:flex;gap:10px;padding:18px 16px 20px;flex-shrink:0}
.ra-stop{flex:1;background:rgba(255,70,70,.1);border:1px solid rgba(255,70,70,.22);border-radius:16px;padding:16px;font-family:var(--fb);font-size:14px;font-weight:300;color:rgba(255,110,110,.9);cursor:pointer;transition:all .2s}
.ra-stop:active{background:rgba(255,70,70,.2)}
.ra-pause{width:56px;height:56px;background:var(--sf);border:1px solid var(--ln);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s}
.ra-pause:active{background:rgba(255,255,255,.07)}

/* finish */
#rfinish{overflow-y:auto;scrollbar-width:none}
#rfinish::-webkit-scrollbar{display:none}
.rf-top{padding:30px 20px 22px;text-align:center;border-bottom:1px solid var(--ln)}
.rf-em{font-size:52px;margin-bottom:14px}
.rf-title{font-family:var(--fd);font-style:italic;font-size:28px;font-weight:300;margin-bottom:5px}
.rf-msg{font-size:12px;font-weight:200;color:var(--dim)}
.rf-grid{display:grid;grid-template-columns:1fr 1fr}
.rf-cell{padding:20px 18px;display:flex;flex-direction:column;gap:4px;border-bottom:1px solid var(--ln)}
.rf-cell:nth-child(odd){border-right:1px solid var(--ln)}
.rf-cl{font-size:9px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.rf-cv{font-family:var(--fd);font-style:italic;font-size:34px;font-weight:300;line-height:1}
.rf-cu{font-size:11px;font-weight:200;color:var(--dim)}
.rf-acts{display:flex;gap:10px;padding:20px 16px 28px}
.rf-shot{flex:1;background:var(--hi);border:none;border-radius:16px;padding:16px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:opacity .2s}
.rf-shot:active{opacity:.85}
.rf-done{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:16px 20px;font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid);cursor:pointer}

/* ══ CREW ══ */
#v-crew{background:var(--bg)}
#no-crew{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 28px 80px;text-align:center;overflow-y:auto;scrollbar-width:none}
#no-crew::-webkit-scrollbar{display:none}
.nc-em{font-size:54px;margin-bottom:20px;animation:floatGhost 3.5s ease-in-out infinite}
.nc-title{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;margin-bottom:8px}
.nc-sub{font-size:12px;font-weight:200;color:var(--dim);line-height:1.75;margin-bottom:32px}
.nc-actions{display:flex;flex-direction:column;gap:10px;width:100%}
.nc-primary{background:var(--hi);border:none;border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .2s}
.nc-primary:active{opacity:.85}
.nc-sec{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:15px 20px;font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.nc-divider{display:flex;align-items:center;gap:10px;padding:2px 0}
.nc-divider::before,.nc-divider::after{content:'';flex:1;height:1px;background:var(--ln)}
.nc-divider span{font-size:10px;font-weight:200;color:rgba(255,255,255,.15)}
.nc-nearby{width:100%;background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:14px 16px}
.nc-nl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:10px}
.nc-nr{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--ln)}
.nc-nr:last-child{border-bottom:none;padding-bottom:0}
.nc-nem{font-size:15px;flex-shrink:0}
.nc-ni{flex:1;min-width:0}
.nc-nn{font-size:12px;font-weight:300}
.nc-nm{font-size:9px;font-weight:200;color:var(--dim);margin-top:1px}
.nc-npct{font-family:var(--fd);font-style:italic;font-size:15px;color:var(--acc);opacity:.8;flex-shrink:0}
.nc-njoin{background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:5px 13px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer;flex-shrink:0}

#crew-content{display:none;flex-direction:column;flex:1;overflow:hidden}
#ctabs{flex-shrink:0;display:flex;padding:0 18px;border-bottom:1px solid var(--ln);overflow-x:auto;scrollbar-width:none;background:var(--bg)}
#ctabs::-webkit-scrollbar{display:none}
.ctab{flex-shrink:0;background:none;border:none;border-bottom:1.5px solid transparent;padding:12px 12px 9px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.07em;color:var(--dim);cursor:pointer;transition:all .25s;white-space:nowrap}
.ctab.on{color:var(--hi);border-bottom-color:var(--hi)}
.cpane{flex:1;display:none;flex-direction:column;overflow-y:auto;scrollbar-width:none;padding:0 18px 100px}
.cpane::-webkit-scrollbar{display:none}
.cpane.on{display:flex}
.crew-hdr{display:flex;justify-content:space-between;align-items:flex-start;padding:18px 0 14px;border-bottom:1px solid var(--ln)}
.crew-hdr-name{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.crew-hdr-sub{font-size:10px;font-weight:200;color:var(--dim);margin-top:2px}
.crew-hdr-loc{font-size:10px;font-weight:200;color:rgba(200,240,80,.7);margin-top:2px}
.crew-expert{background:linear-gradient(135deg,rgba(212,181,74,.14),rgba(200,240,80,.07));border:1px solid rgba(212,181,74,.28);border-radius:99px;padding:5px 11px;font-size:10px;font-weight:300;color:rgba(212,181,74,.9);flex-shrink:0;margin-top:4px}
.gc-card{background:var(--sf);border:1px solid var(--ln);border-radius:16px;padding:16px;margin:14px 0}
.gc-top{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.gc-lbl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:5px}
.gc-nums{display:flex;align-items:baseline;gap:3px}
.gc-cur{font-family:var(--fd);font-style:italic;font-size:36px;font-weight:300;line-height:1}
.gc-sep,.gc-tot{font-size:14px;font-weight:200;color:var(--dim)}
.gc-unit{font-size:10px;font-weight:200;color:var(--dim);opacity:.5;margin-left:2px}
.gc-pct{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300;color:var(--acc);opacity:.85}
.prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:12px}
.pf{height:1px;background:var(--acc);transition:width 1.4s cubic-bezier(.4,0,.2,1);position:relative}
.pd{position:absolute;right:-3px;top:-2.5px;width:6px;height:6px;border-radius:50%;background:var(--acc);box-shadow:0 0 8px rgba(200,240,80,.5)}
.gc-meta{display:flex}
.gm{flex:1;display:flex;flex-direction:column;gap:2px}
.gm+.gm{border-left:1px solid var(--ln);padding-left:12px}
.gm-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.gm-v{font-size:13px;font-weight:300;color:var(--mid)}
.gm-v.a{color:var(--acc);opacity:.85}
.lb-hdr{display:flex;justify-content:space-between;padding-top:4px;margin-bottom:10px}
.lb-ttl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim)}
.lb-cnt{font-size:9px;font-weight:200;color:rgba(255,255,255,.15)}
.lbrow{display:flex;align-items:center;gap:9px;padding:10px 0;border-bottom:1px solid var(--ln)}
.lbrow.click{cursor:pointer;border-radius:8px;padding:10px 6px;margin:0 -6px;transition:background .15s}
.lbrow.click:active{background:rgba(255,255,255,.04)}
.lbrow.me .lb-nm{color:var(--hi)}.lbrow.me .lb-d{color:var(--acc)}
.lbpos{width:17px;font-size:11px;font-weight:300;text-align:center;color:var(--dim);flex-shrink:0}
.lbpos.g{color:var(--gold)}.lbpos.s{color:var(--silver)}.lbpos.b{color:var(--bronze)}
.lbem{font-size:15px;flex-shrink:0}
.lb-nc{flex:1;min-width:0;display:flex;flex-direction:column;gap:1px}
.lb-nm{font-size:12px;font-weight:200;color:var(--mid);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-hint{font-size:9px;font-weight:200;color:rgba(255,255,255,.2)}
.lb-rt{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.lb-d{font-size:12px;font-weight:300;color:var(--mid)}
.lb-bg{width:40px;height:1px;background:rgba(255,255,255,.07)}
.lb-bar{height:1px}.lb-bar.me{background:var(--acc)}.lb-bar.g{background:var(--gold)}.lb-bar.s{background:var(--silver)}.lb-bar.b{background:var(--bronze)}.lb-bar.o{background:rgba(255,255,255,.18)}
.nb-hdr{padding:18px 0 10px;border-bottom:1px solid var(--ln)}
.nb-area{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.nb-desc{font-size:10px;font-weight:200;color:var(--dim);margin-top:3px}
.nb-row{padding:14px 0;border-bottom:1px solid var(--ln)}
.nb-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.nb-rn{font-family:var(--fd);font-style:italic;font-size:18px;flex-shrink:0}
.nb-rn.g{color:var(--gold)}.nb-rn.s{color:var(--silver)}.nb-rn.b{color:var(--bronze)}.nb-rn.o{color:var(--acc)}
.nb-cname{font-size:14px;font-weight:300}.nb-mine{font-size:8px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:99px;padding:2px 7px;color:rgba(200,240,80,.8)}
.nb-cmeta{font-size:9px;font-weight:200;color:var(--dim)}.nb-pct{font-family:var(--fd);font-style:italic;font-size:22px;color:var(--acc);opacity:.85}
.nb-prog{height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible;margin-bottom:10px}
.nb-pf{height:1px;background:rgba(200,240,80,.5);position:relative}
.nb-pd{position:absolute;right:-2px;top:-2px;width:5px;height:5px;border-radius:50%;background:rgba(200,240,80,.7)}
.nb-bot{display:flex;justify-content:space-between;align-items:center}
.nb-ghosts{font-size:14px;letter-spacing:.02em}.nb-nums{display:flex;gap:14px}
.nbn{display:flex;flex-direction:column;align-items:flex-end;gap:1px}
.nbn-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}.nbn-v{font-family:var(--fd);font-style:italic;font-size:14px}
.past-hdr{display:flex;justify-content:space-between;align-items:center;padding:18px 0 12px;border-bottom:1px solid var(--ln)}
.past-title{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.expert-btn{display:flex;align-items:center;gap:5px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:6px 12px;font-family:var(--fb);font-size:10px;font-weight:300;color:rgba(200,240,80,.85);cursor:pointer}
.past-card{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--ln)}
.pc-em{font-size:20px;flex-shrink:0}
.pc-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:3px}
.pc-name{font-size:13px;font-weight:300}.pc-meta{font-size:10px;font-weight:200;color:var(--dim)}
.pc-xb{background:linear-gradient(135deg,rgba(212,181,74,.14),rgba(200,240,80,.07));border:1px solid rgba(212,181,74,.28);border-radius:99px;padding:2px 8px;font-size:8px;color:rgba(212,181,74,.85);display:inline-block;margin-top:3px}
.pc-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.pc-rank{font-family:var(--fd);font-style:italic;font-size:18px;font-weight:300}
.pc-rank.g{color:var(--gold)}.pc-rank.s{color:var(--silver)}.pc-rank.b{color:var(--bronze)}.pc-rank.o{color:var(--acc)}
.pc-dist{font-size:10px;font-weight:200;color:var(--dim)}

/* ══ SHOT ══ */
#v-shot{padding:10px 14px 0;background:var(--bg)}
#card{flex:1;position:relative;border-radius:18px;overflow:hidden;background:#101012;min-height:0}
#bg-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s}
#empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at 50% 40%,#13131a,#0a0a0d)}
.e-grain{position:absolute;inset:0;opacity:.3;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23f)' opacity='.07'/%3E%3C/svg%3E")}
.e-icon{font-size:28px;opacity:.18;filter:grayscale(1);position:relative}
.e-hint{font-size:10px;font-weight:200;letter-spacing:.14em;color:var(--dim);opacity:.55;position:relative}
#ovs{position:absolute;inset:0;z-index:5;pointer-events:none}
.ov{position:absolute;inset:0;transition:opacity .35s}.ov.off{opacity:0}
.ft{position:absolute;top:0;left:0;right:0;height:170px;background:linear-gradient(180deg,rgba(0,0,0,.75),transparent)}
.fb{position:absolute;bottom:0;left:0;right:0;height:260px;background:linear-gradient(0deg,rgba(0,0,0,.92) 0%,rgba(0,0,0,.4) 55%,transparent)}
.ov-hd{position:absolute;top:0;left:0;right:0;padding:16px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.runner{display:flex;align-items:center;gap:6px;cursor:pointer;pointer-events:all}
.r-em{font-size:17px;line-height:1}.r-nm{font-size:12px;font-weight:200;color:rgba(255,255,255,.72)}
.ov-dt{font-size:9px;font-weight:200;color:rgba(255,255,255,.22);text-align:right;line-height:1.9}
.chip{position:absolute;display:flex;align-items:baseline;gap:4px;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.09);border-radius:99px;padding:5px 12px;pointer-events:none}
.ch-n{font-family:var(--fd);font-style:italic;font-size:20px;line-height:1}
.ch-n.g{color:var(--gold)}.ch-n.s{color:var(--silver)}.ch-n.b{color:var(--bronze)}.ch-n.o{color:var(--acc)}
.ch-of{font-size:10px;font-weight:200;color:rgba(255,255,255,.28)}
.gchip{top:16px;right:16px}
.gboard{position:absolute;right:14px;bottom:68px;display:flex;flex-direction:column;gap:2px;pointer-events:none}
.gb-lbl{font-size:8px;font-weight:200;letter-spacing:.12em;color:rgba(255,255,255,.18);text-align:right;margin-bottom:3px}
.gb-row{display:flex;align-items:center;gap:5px;padding:4px 8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.06);border-radius:6px}
.gb-row.me{background:rgba(200,240,80,.08);border-color:rgba(200,240,80,.2)}
.gb-n{font-size:9px;font-weight:300;color:rgba(255,255,255,.22);width:11px;text-align:right}
.gb-n.g{color:var(--gold)}.gb-n.s{color:var(--silver)}.gb-n.b{color:var(--bronze)}
.gb-e{font-size:11px}.gb-d{font-size:9px;font-weight:300;color:rgba(255,255,255,.42);margin-left:auto}
.gb-d.me{color:var(--acc)}
.g-bot{position:absolute;bottom:0;left:0;right:64px;padding:0 18px 18px}
.g-dist{font-family:var(--fd);font-style:italic;font-size:52px;font-weight:300;line-height:.9;letter-spacing:-.02em}
.g-du{font-family:var(--fb);font-size:15px;font-weight:200;color:var(--mid);margin-left:3px;vertical-align:middle}
.g-stats{display:flex;margin-top:9px}
.g-s{flex:1;display:flex;flex-direction:column;gap:2px}
.g-s+.g-s{border-left:1px solid rgba(255,255,255,.07);padding-left:13px}
.g-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:rgba(255,255,255,.2)}
.g-sv{font-size:13px;font-weight:300;color:var(--mid)}
.g-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.g-brand{font-size:9px;font-weight:200;letter-spacing:.16em;color:rgba(255,255,255,.1)}
.g-tag{font-size:9px;font-weight:200;color:rgba(200,240,80,.42)}
#mmg{width:40px;height:40px;border-radius:5px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4);position:absolute;right:16px;bottom:20px}
.p-logo{font-family:var(--fd);font-style:italic;font-size:13px;font-weight:300;color:rgba(255,255,255,.3)}
.p-mapbg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
#mmp{width:62%;max-width:220px;aspect-ratio:1;opacity:.25}
.p-chip{bottom:116px;left:50%;top:auto;transform:translateX(-50%)}
.p-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px;display:flex;justify-content:space-between;align-items:flex-end}
.p-stat{display:flex;flex-direction:column;gap:2px}
.p-l{font-size:8px;font-weight:200;letter-spacing:.12em;color:rgba(255,255,255,.22)}
.p-v{font-family:var(--fd);font-style:italic;font-size:29px;color:var(--hi);line-height:1}
.p-u{font-family:var(--fb);font-size:13px;font-weight:200;color:var(--mid)}
.st-vign{position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.62) 100%)}
.st-logo{font-size:9px;font-weight:200;letter-spacing:.2em;color:rgba(255,255,255,.2)}
.st-bot{position:absolute;bottom:0;left:0;right:0;padding:0 18px 18px}
.st-rrow{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.st-rn{font-family:var(--fd);font-style:italic;font-size:34px;line-height:1}
.st-rn.g{color:var(--gold)}.st-rn.s{color:var(--silver)}.st-rn.b{color:var(--bronze)}.st-rn.o{color:var(--acc)}
.st-of{font-size:12px;font-weight:200;color:rgba(255,255,255,.3)}
.st-dist{font-family:var(--fd);font-style:italic;font-size:50px;line-height:.9;letter-spacing:-.02em}
.st-du{font-family:var(--fb);font-size:17px;font-weight:200;color:var(--mid);margin-left:2px}
.st-sub{display:flex;gap:14px;margin-top:8px}
.ss{display:flex;flex-direction:column;gap:1px}
.ss-l{font-size:8px;font-weight:200;letter-spacing:.1em;color:rgba(255,255,255,.2)}
.ss-v{font-size:13px;font-weight:300;color:var(--mid)}
.st-badge{position:absolute;bottom:16px;right:16px;width:82px;height:82px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.44);backdrop-filter:blur(8px)}
.st-badge::before{content:"";position:absolute;inset:5px;border-radius:50%;border:1px solid rgba(200,240,80,.1)}
.sb-em{font-size:23px;line-height:1}.sb-done{font-size:7px;font-weight:200;letter-spacing:.12em;color:rgba(200,240,80,.5)}.sb-date{font-size:7px;font-weight:200;color:rgba(255,255,255,.18)}
#mms{position:absolute;top:70px;right:18px;width:42px;height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4)}
#tbar{flex-shrink:0;display:flex;gap:6px;padding:8px 14px 5px;overflow-x:auto;scrollbar-width:none}
#tbar::-webkit-scrollbar{display:none}
.th{flex-shrink:0;background:none;border:1px solid var(--ln);border-radius:99px;padding:6px 14px;font-family:var(--fb);font-size:10px;font-weight:200;letter-spacing:.06em;color:var(--dim);cursor:pointer;transition:all .2s}
.th.on{border-color:rgba(255,255,255,.3);color:var(--hi)}
#shot-acts{flex-shrink:0;display:flex;gap:8px;padding:5px 14px 10px}
.ai{width:46px;background:var(--sf);border:1px solid var(--ln);border-radius:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.ai svg{width:17px;height:17px;stroke:var(--mid);stroke-width:1.5;fill:none;stroke-linecap:round;stroke-linejoin:round}
.asave{flex:1;background:var(--hi);border:none;border-radius:13px;font-family:var(--fb);font-size:13px;font-weight:300;letter-spacing:.04em;color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:opacity .2s}
.asave:active{opacity:.85}

/* ══ RECORDS ══ */
#v-records{background:var(--bg);overflow-y:auto;scrollbar-width:none}
#v-records::-webkit-scrollbar{display:none}
.rec-hero{padding:26px 18px 22px;border-bottom:1px solid var(--ln)}
.rec-hero-lbl{font-size:9px;font-weight:200;letter-spacing:.18em;color:var(--dim);margin-bottom:12px}
.rec-big{display:flex;align-items:flex-end;gap:6px;margin-bottom:5px}
.rec-big-n{font-family:var(--fd);font-style:italic;font-size:84px;font-weight:300;line-height:.82;letter-spacing:-.03em}
.rec-big-u{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;color:var(--dim);padding-bottom:8px}
.rec-hero-sub{font-size:12px;font-weight:200;color:var(--dim);margin-bottom:24px}
.rec-3{display:flex;border-top:1px solid var(--ln);padding-top:0}
.rec-3s{flex:1;padding:16px 0;display:flex;flex-direction:column;align-items:center;gap:3px}
.rec-3s+.rec-3s{border-left:1px solid var(--ln)}
.rec-3sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.rec-3sv{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.rec-3su{font-size:10px;font-weight:200;color:var(--dim)}
.rec-cal{padding:22px 18px 0}
.rec-cal-lbl{font-size:9px;font-weight:200;letter-spacing:.14em;color:var(--dim);margin-bottom:12px}
.cal-grid{display:flex;gap:4px;flex-wrap:wrap}
.cal-d{width:13px;height:13px;border-radius:3px;background:rgba(255,255,255,.06)}
.cal-d.run{background:rgba(200,240,80,.5)}.cal-d.today{background:var(--acc);box-shadow:0 0 7px rgba(200,240,80,.5)}
.rec-target{margin:22px 18px 0;background:var(--sf);border:1px solid var(--ln);border-radius:18px;padding:18px}
.rt-top{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.rt-lbl{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:4px}
.rt-val{font-family:var(--fd);font-style:italic;font-size:26px;font-weight:300}
.rt-pct{font-family:var(--fd);font-style:italic;font-size:20px;color:var(--acc);opacity:.85}
.rt-bar{height:3px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden}
.rt-fill{height:100%;background:var(--acc);border-radius:2px;transition:width 1.4s cubic-bezier(.4,0,.2,1)}
.rec-log{padding:24px 18px 0}
.rec-log-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:16px}
.rec-log-title{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300}
.rec-log-cnt{font-size:10px;font-weight:200;color:var(--dim)}
.log-item{display:flex;align-items:center;gap:14px;padding:15px 0;border-bottom:1px solid var(--ln)}
.log-date{flex-shrink:0;display:flex;flex-direction:column;align-items:center;width:36px}
.log-mo{font-size:8px;font-weight:200;color:var(--dim)}
.log-dy{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.log-cv{width:52px;height:52px;flex-shrink:0;border-radius:10px;border:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.4)}
.log-info{flex:1;display:flex;flex-direction:column;gap:4px}
.log-crew{font-size:9px;font-weight:200;background:var(--sf2);border:1px solid var(--ln);border-radius:99px;padding:3px 9px;color:var(--dim);display:inline-flex;align-items:center;width:fit-content}
.log-km{font-family:var(--fd);font-style:italic;font-size:30px;font-weight:300;line-height:1}
.log-sub{font-size:11px;font-weight:200;color:var(--dim)}
.log-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.log-rn{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300}
.log-rn.g{color:var(--gold)}.log-rn.s{color:var(--silver)}.log-rn.b{color:var(--bronze)}.log-rn.o{color:var(--acc)}
.log-kcal{font-size:9px;font-weight:200;color:var(--dim)}
.rec-crews{padding:24px 18px 100px}
.rec-crews-title{font-family:var(--fd);font-style:italic;font-size:24px;font-weight:300;margin-bottom:16px}
.rcr{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--ln)}
.rcr-em{font-size:24px;flex-shrink:0}
.rcr-info{flex:1;display:flex;flex-direction:column;gap:3px}
.rcr-name{font-size:14px;font-weight:300}.rcr-meta{font-size:10px;font-weight:200;color:var(--dim)}
.rcr-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.rcr-xp{background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.22);border-radius:99px;padding:3px 10px;font-size:9px;color:rgba(200,240,80,.85)}
.rcr-rank{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.rcr-rank.g{color:var(--gold)}.rcr-rank.s{color:var(--silver)}.rcr-rank.b{color:var(--bronze)}.rcr-rank.o{color:var(--acc)}

/* ══ MODALS ══ */
.modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .28s}
.modal.on{opacity:1;pointer-events:all}
.m-box{width:100%;max-width:430px;background:#111114;border:1px solid var(--ln);border-bottom:none;border-radius:22px 22px 0 0;padding:24px 20px 44px;transform:translateY(16px);transition:transform .3s;max-height:90dvh;overflow-y:auto;scrollbar-width:none}
.m-box::-webkit-scrollbar{display:none}
.modal.on .m-box{transform:translateY(0)}
.m-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:5px}
.m-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:22px;line-height:1.6}
.m-cancel{width:100%;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--dim);cursor:pointer;margin-top:8px}
.m-ok{width:100%;background:var(--hi);border:none;border-radius:14px;padding:14px;font-family:var(--fb);font-size:13px;font-weight:300;color:var(--bg);cursor:pointer;transition:opacity .2s}
.m-ok:active{opacity:.85}
.mf{margin-bottom:16px}.ml{font-size:9px;font-weight:200;letter-spacing:.12em;color:var(--dim);margin-bottom:8px}
.mi{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;font-family:var(--fb);font-size:14px;font-weight:200;color:var(--hi);outline:none;transition:border-color .2s;caret-color:var(--acc)}
.mi:focus{border-color:rgba(200,240,80,.35)}
.mi::placeholder{color:rgba(255,255,255,.18)}
.em-row{display:flex;gap:8px;flex-wrap:wrap}
.em-opt{width:46px;height:46px;background:var(--sf);border:1px solid var(--ln);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all .2s}
.em-opt.on{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.07);transform:scale(1.06)}
.g-row{display:flex;gap:8px}
.g-opt{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s}
.g-opt.on{border-color:rgba(200,240,80,.35);background:rgba(200,240,80,.07)}
.g-opt span:first-child{font-family:var(--fd);font-style:italic;font-size:18px;display:block}
.g-opt span:last-child{font-size:8px;font-weight:200;color:var(--dim)}
.join-inp{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px 16px;font-family:var(--fb);font-size:16px;font-weight:300;color:var(--hi);letter-spacing:.1em;outline:none;transition:border-color .2s;caret-color:var(--acc);margin-bottom:12px;text-transform:uppercase}
.join-inp::placeholder{color:rgba(255,255,255,.2);text-transform:none}
.join-inp:focus{border-color:rgba(200,240,80,.4)}
.join-prev{display:none;align-items:center;gap:12px;background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.18);border-radius:14px;padding:14px 16px;margin-bottom:14px}
.join-prev.on{display:flex}
/* member modal */
.mm-hd{display:flex;align-items:center;gap:12px;padding:22px 20px 16px;border-bottom:1px solid var(--ln)}
.mm-em{font-size:32px}.mm-name{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}.mm-cl{font-size:11px;font-weight:200;color:var(--dim);margin-top:2px}
.mm-rank{font-family:var(--fd);font-style:italic;font-size:28px;font-weight:300;margin-left:auto}
.mm-rank.g{color:var(--gold)}.mm-rank.s{color:var(--silver)}.mm-rank.b{color:var(--bronze)}.mm-rank.o{color:var(--acc)}
.mm-stats{display:flex;padding:16px 20px;border-bottom:1px solid var(--ln)}
.mm-st{flex:1;display:flex;flex-direction:column;gap:2px}
.mm-st+.mm-st{border-left:1px solid var(--ln);padding-left:14px}
.mm-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}.mm-sv{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.mm-rl{padding:14px 20px 8px;font-size:9px;letter-spacing:.12em;color:var(--dim)}
.mm-rr{display:flex;align-items:center;gap:10px;padding:10px 20px;border-bottom:1px solid var(--ln)}
.mm-rd{font-size:9px;color:var(--dim);width:44px;flex-shrink:0}.mm-rk{font-family:var(--fd);font-style:italic;font-size:17px;flex:1}.mm-rp{font-size:10px;color:var(--dim)}
.mm-close{width:calc(100% - 40px);margin:14px 20px 0;background:none;border:1px solid var(--ln);border-radius:14px;padding:12px;font-family:var(--fb);font-size:12px;color:var(--dim);cursor:pointer}
/* avatar */
#avs{position:fixed;inset:0;z-index:90;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
#avs.on{opacity:1;pointer-events:all}
.av-box{width:100%;max-width:430px;background:#111114;border:1px solid var(--ln);border-bottom:none;border-radius:20px 20px 0 0;padding:16px 18px 36px;transform:translateY(12px);transition:transform .3s}
#avs.on .av-box{transform:translateY(0)}
.av-ttl{font-size:9px;letter-spacing:.14em;color:var(--dim);text-align:center;margin-bottom:12px}
.av-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px}
.avc{display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 3px 7px;border-radius:11px;border:1px solid transparent;background:var(--sf);cursor:pointer;transition:all .2s}
.avc.on{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06)}
.ave{font-size:22px;line-height:1}.avl{font-size:8px;font-weight:200;color:var(--dim)}.avc.on .avl{color:var(--hi)}
/* toast/flash */
#toast{position:fixed;z-index:200;bottom:74px;left:50%;transform:translateX(-50%) translateY(5px);background:rgba(10,10,13,.96);border:1px solid rgba(255,255,255,.08);border-radius:99px;padding:8px 18px;font-size:11px;color:var(--mid);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
#flash{position:fixed;inset:0;z-index:300;background:rgba(255,255,255,.1);opacity:0;pointer-events:none;transition:opacity .08s}
#flash.on{opacity:1}
input[type=file]{display:none}

/* ══ LOGIN SCREEN ══ */
#login-screen{position:fixed;inset:0;z-index:998;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;transition:opacity .5s,transform .5s}
#login-screen.out{opacity:0;transform:scale(1.04);pointer-events:none}
.ls-logo{font-family:var(--fd);font-style:italic;font-size:36px;font-weight:300;margin-bottom:6px;text-align:center}
.ls-sub{font-size:11px;font-weight:200;color:var(--dim);text-align:center;letter-spacing:.06em;margin-bottom:36px}
.ls-form{width:100%;display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.ls-input{width:100%;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px 16px;font-family:var(--fb);font-size:14px;font-weight:200;color:var(--hi);outline:none;caret-color:var(--acc);transition:border-color .2s}
.ls-input:focus{border-color:rgba(200,240,80,.4)}
.ls-input::placeholder{color:rgba(255,255,255,.2)}
.ls-btn{width:100%;background:var(--acc);border:none;border-radius:14px;padding:16px;font-family:var(--fb);font-size:14px;font-weight:400;color:var(--bg);cursor:pointer;transition:opacity .2s;letter-spacing:.03em}
.ls-btn:active{opacity:.85}
.ls-err{font-size:11px;font-weight:200;color:rgba(255,100,100,.8);text-align:center;min-height:16px;margin-top:-2px}
.ls-switch{font-size:11px;font-weight:200;color:var(--dim);text-align:center;cursor:pointer;margin-top:4px}
.ls-switch span{color:var(--acc);opacity:.85;text-decoration:underline;text-underline-offset:2px}
.ls-divider{display:flex;align-items:center;gap:10px;margin:14px 0}
.ls-divider::before,.ls-divider::after{content:'';flex:1;height:1px;background:var(--ln)}
.ls-divider span{font-size:10px;font-weight:200;color:rgba(255,255,255,.2)}
.ls-social{display:flex;gap:10px;width:100%}
.ls-social-btn{flex:1;background:var(--sf);border:1px solid var(--ln);border-radius:12px;padding:12px 8px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-family:var(--fb);font-size:12px;font-weight:200;color:var(--mid);transition:all .2s}
.ls-social-btn:active{background:var(--sf2)}
.ls-social-em{font-size:16px}
.ls-mode-title{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300;margin-bottom:4px;align-self:flex-start}
.ls-mode-sub{font-size:11px;font-weight:200;color:var(--dim);margin-bottom:28px;align-self:flex-start}
/* profile badge in nav */
#nav-profile{width:28px;height:28px;border-radius:50%;background:var(--sf2);border:1px solid rgba(200,240,80,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .2s}
#nav-profile:active{transform:scale(.9)}
/* user profile modal */
.prof-hd{padding:22px 20px 16px;border-bottom:1px solid var(--ln);display:flex;align-items:center;gap:14px}
.prof-avatar{width:52px;height:52px;border-radius:50%;background:var(--sf2);border:1px solid rgba(200,240,80,.25);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
.prof-name{font-family:var(--fd);font-style:italic;font-size:20px;font-weight:300}
.prof-email{font-size:10px;font-weight:200;color:var(--dim);margin-top:2px}
.prof-joined{font-size:9px;font-weight:200;color:rgba(200,240,80,.6);margin-top:3px}
.prof-stats-row{display:flex;padding:16px 20px;border-bottom:1px solid var(--ln)}
.prof-st{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.prof-st+.prof-st{border-left:1px solid var(--ln)}
.prof-sl{font-size:8px;font-weight:200;letter-spacing:.1em;color:var(--dim)}
.prof-sv{font-family:var(--fd);font-style:italic;font-size:22px;font-weight:300}
.prof-menu-item{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--ln);cursor:pointer;transition:background .15s}
.prof-menu-item:active{background:rgba(255,255,255,.03)}
.prof-menu-em{font-size:16px;width:22px;text-align:center}
.prof-menu-txt{flex:1;font-size:13px;font-weight:200}
.prof-menu-arrow{font-size:11px;color:var(--dim)}
.prof-logout{width:calc(100% - 40px);margin:14px 20px;background:rgba(255,70,70,.08);border:1px solid rgba(255,70,70,.18);border-radius:14px;padding:13px;font-family:var(--fb);font-size:13px;font-weight:300;color:rgba(255,110,110,.85);cursor:pointer;transition:all .2s}
.prof-logout:active{background:rgba(255,70,70,.15)}
/* server status badge */
.srv-badge{position:fixed;top:56px;right:10px;z-index:80;display:flex;align-items:center;gap:5px;background:rgba(10,10,13,.88);border:1px solid var(--ln);border-radius:99px;padding:4px 10px;font-size:9px;font-weight:200;color:var(--dim);backdrop-filter:blur(8px);pointer-events:none;transition:opacity .3s}
.srv-dot{width:6px;height:6px;border-radius:50%;background:var(--dim);flex-shrink:0}
.srv-badge.online .srv-dot{background:var(--acc);box-shadow:0 0 5px rgba(200,240,80,.5)}
.srv-badge.online{color:rgba(200,240,80,.7);border-color:rgba(200,240,80,.15)}

/* ══ RUN ACTIVE REDESIGN ══ */
@keyframes syncPulse{0%,100%{opacity:1;box-shadow:0 0 6px #c8f050}50%{opacity:.5;box-shadow:0 0 14px #c8f050}}
#ractive{display:flex;flex-direction:column}
#ra-map-container{flex:1;min-height:200px}
/* override font vars for active run */
#ra-dist{font-family:'Barlow Condensed',sans-serif!important}
#ra-pace,#ra-time{font-family:'Barlow Condensed',sans-serif!important}
/* Clap animation */
@keyframes clapBounce{0%,100%{transform:scale(1)}30%{transform:scale(1.5) rotate(-10deg)}60%{transform:scale(.9) rotate(5deg)}}
.clap-anim{animation:clapBounce .4s ease!important}
@keyframes clapFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(.7)}}
.clap-float{position:absolute;pointer-events:none;font-size:22px;animation:clapFloat .8s ease forwards;z-index:50}
/* Racing track ghost icons */
.track-icon{position:absolute;top:50%;transform:translateY(-50%);font-size:18px;transition:left .5s;pointer-events:none;filter:drop-shadow(0 0 4px rgba(200,240,80,.4))}
/* Insta feed scrollbar hide */
#insta-feed::-webkit-scrollbar{display:none}
/* Home hero number */
.hm-big-dist{font-family:'Barlow Condensed',sans-serif;font-size:88px;font-weight:900;letter-spacing:-.02em;line-height:.85;color:#c8f050}
/* Barlow font override for key elements */
.rec-big-n,.ra-sv,.log-km,.rec-3sv,.rf-cv{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.hm-sec-title,.rec-log-title,.rec-crews-title,.past-title{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.sp-logo,.ls-logo{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.gc-cur,.gc-pct,.gm-v,.lb-d,.mm-sv,.nb-pct,.pc-rank{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.log-dy,.log-km{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}
.rec-big-n,.rec-3sv{font-family:'Barlow Condensed',sans-serif!important;font-style:normal!important}

/* Room tabs */
.rtab{cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s;}
.rpane{display:none;}
/* Modal base (used by room modals too) */
.modal{display:none;position:fixed;inset:0;z-index:200;}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-grain"></div><div class="sp-glow"></div><div class="sp-lines"></div>
  <div class="sp-em">👻</div>
  <div class="sp-logo">GhostRun</div>
  <div class="sp-sub">우리는 함께 달리고 있습니다.</div>
  <div class="sp-desc">느슨한 연대를 위한<br>비대면 매칭 플랫폼</div>
  <button class="sp-btn" onclick="hideSplash()">시작하기</button>
  <span class="sp-ver">v2.0 · 2025</span>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none">
  <div class="ls-logo">👻 GhostRun</div>
  <div class="ls-sub" id="ls-sub-txt">함께 달리는 사람들</div>
  <div class="ls-mode-title" id="ls-mode-title">로그인</div>
  <div class="ls-mode-sub" id="ls-mode-sub">계속하려면 로그인하세요</div>
  <div class="ls-form">
    <input class="ls-input" id="ls-email" type="email" placeholder="이메일" autocomplete="email">
    <input class="ls-input" id="ls-pw" type="password" placeholder="비밀번호" autocomplete="current-password">
    <input class="ls-input" id="ls-nick" type="text" placeholder="닉네임 (회원가입 시)" style="display:none" autocomplete="nickname" maxlength="12">
    <div class="ls-err" id="ls-err"></div>
    <button class="ls-btn" id="ls-submit" onclick="submitAuth()">로그인</button>
  </div>
  <div class="ls-switch" id="ls-switch" onclick="toggleAuthMode()">계정이 없으신가요? <span>회원가입</span></div>
  <div class="ls-divider"><span>또는</span></div>
  <div class="ls-social">
    <button class="ls-social-btn" onclick="socialLogin('kakao')"><span class="ls-social-em">💛</span>카카오</button>
    <button class="ls-social-btn" onclick="socialLogin('naver')"><span class="ls-social-em">🟢</span>네이버</button>
    <button class="ls-social-btn" onclick="socialLogin('google')"><span class="ls-social-em">🔵</span>구글</button>
  </div>
</div>

<!-- SERVER STATUS -->
<div class="srv-badge" id="srv-badge"><div class="srv-dot"></div><span id="srv-txt">서버 연결 중...</span></div>

<!-- PROFILE MODAL -->
<div id="m-profile" class="modal"><div class="m-box" id="prof-box"></div></div>

<div id="nav"><span class="logo">GhostRun</span><div style="display:flex;align-items:center;gap:10px"><span id="clock"></span><div id="nav-profile" onclick="openProfile()" title="프로필">👤</div></div></div>

<div id="main">

<!-- HOME -->
<div id="v-home" class="mview on" style="overflow-y:auto;scrollbar-width:none">
  <!-- HERO: Live runner count -->
  <div style="position:relative;overflow:hidden;flex-shrink:0;background:#0a0a0a;padding:52px 20px 28px">
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(200,240,80,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(200,240,80,.03) 1px,transparent 1px);background-size:28px 28px"></div>
    <div style="position:absolute;bottom:-40px;left:50%;transform:translateX(-50%);width:320px;height:200px;background:radial-gradient(ellipse,rgba(200,240,80,.09) 0%,transparent 65%);pointer-events:none"></div>
    <div style="position:relative">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px">
        <div style="width:8px;height:8px;border-radius:50%;background:#c8f050;box-shadow:0 0 8px #c8f050;animation:syncPulse 1.5s infinite"></div>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.2em;color:rgba(200,240,80,.65)">LIVE · 내 주변 2km</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:4px">
        <span id="hm-runner-count" style="font-family:'Barlow Condensed',sans-serif;font-size:88px;font-weight:900;color:#c8f050;line-height:.85;letter-spacing:-.02em;text-shadow:0 0 40px rgba(200,240,80,.3)">24</span>
        <div style="display:flex;flex-direction:column;gap:2px;padding-bottom:8px">
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:rgba(255,255,255,.7);line-height:1">명이</span>
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:rgba(255,255,255,.7);line-height:1">뛰는 중</span>
        </div>
      </div>
      <div style="font-size:12px;font-weight:300;color:rgba(255,255,255,.3);letter-spacing:.04em;margin-bottom:22px">지금 이 순간, 당신도 혼자가 아닙니다</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:rgba(255,255,255,.06);border-radius:14px;overflow:hidden">
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:800;color:#fff;line-height:1" id="hm-total-km">187.4</div>
          <div style="font-size:8px;font-weight:600;letter-spacing:.12em;color:rgba(255,255,255,.3);margin-top:3px">총 km (오늘)</div>
        </div>
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:800;color:#fff;line-height:1" id="hm-avg-pace">5'14"</div>
          <div style="font-size:8px;font-weight:600;letter-spacing:.12em;color:rgba(255,255,255,.3);margin-top:3px">평균 페이스</div>
        </div>
        <div style="background:#111;padding:14px 12px;text-align:center">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:800;color:rgba(200,240,80,.85);line-height:1" id="hm-active-now">8</div>
          <div style="font-size:8px;font-weight:600;letter-spacing:.12em;color:rgba(255,255,255,.3);margin-top:3px">지금 러닝 중</div>
        </div>
      </div>
    </div>
  </div>
  <!-- CTA -->
  <div style="padding:16px 16px 0;flex-shrink:0">
    <button onclick="goTab('run')" style="width:100%;height:60px;background:#c8f050;border:none;border-radius:18px;font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.1em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 6px 24px rgba(200,240,80,.25);-webkit-tap-highlight-color:transparent">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      지금 함께 달리기
    </button>
  </div>
  <!-- 인증샷 피드 -->
  <div style="padding:24px 0 0;flex-shrink:0">
    <div style="padding:0 16px;display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px">
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800">최근 인증샷</span>
      <span style="font-size:10px;color:rgba(255,255,255,.3);cursor:pointer" onclick="goTab('shot')">나도 찍기 →</span>
    </div>
    <div id="insta-feed" style="overflow-x:auto;scrollbar-width:none;padding:0 16px 4px;display:flex;gap:10px"></div>
  </div>
  <!-- 주변 러너 랭킹 -->
  <div style="padding:24px 16px 0;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800">주변 러너 랭킹</span>
      <div style="flex:1;height:1px;background:rgba(255,255,255,.07)"></div>
      <span style="font-size:9px;font-weight:500;letter-spacing:.1em;color:rgba(200,240,80,.55)">2KM 반경</span>
    </div>
    <div style="font-size:11px;color:rgba(255,255,255,.3);margin-bottom:16px">모두 익명 · 오늘 기준</div>
    <div style="display:flex;gap:6px;margin-bottom:14px" id="lb-tabs">
      <button class="lb-tab on" data-lb="dist" onclick="switchLbTab('dist')" style="flex:1;height:36px;border-radius:10px;border:1px solid rgba(200,240,80,.3);background:rgba(200,240,80,.1);font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:.06em;color:#c8f050;cursor:pointer">📍 거리 TOP 10</button>
      <button class="lb-tab" data-lb="pace" onclick="switchLbTab('pace')" style="flex:1;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">⚡ 페이스 TOP 10</button>
    </div>
    <div id="lb-dist"></div>
    <div id="lb-pace" style="display:none"></div>
  </div>
  <div style="height:32px;flex-shrink:0"></div>
</div>

<!-- RUN -->
<div id="v-run" class="mview" style="background:#0a0a0a;overflow:hidden;display:flex;flex-direction:column">

  <!-- STATE 0: SETUP -->
  <div id="rsetup" class="rstate on" style="flex-direction:column;background:#0a0a0a;position:relative">
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(200,240,80,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(200,240,80,.03) 1px,transparent 1px);background-size:32px 32px;pointer-events:none"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:50%;background:radial-gradient(ellipse at 50% 100%,rgba(200,240,80,.07) 0%,transparent 65%);pointer-events:none"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 18px 0;flex-shrink:0;position:relative">
      <div style="display:flex;align-items:center;gap:7px">
        <div style="width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15)"></div>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.25)">GHOSTRUN</span>
      </div>
      <div id="setup-clock" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;color:rgba(255,255,255,.2);letter-spacing:.06em"></div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 24px;position:relative">
      <div style="font-size:56px;margin-bottom:18px;animation:floatGhost 3.5s ease-in-out infinite;filter:drop-shadow(0 0 22px rgba(200,240,80,.28))">👻</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:900;color:#fff;line-height:1;text-align:center;margin-bottom:6px">오늘의 러닝</div>
      <div style="font-size:11px;font-weight:300;color:rgba(255,255,255,.28);letter-spacing:.08em;margin-bottom:32px">크루와 함께 · 따로 또 같이</div>
      <!-- Goal type -->
      <div style="display:flex;gap:8px;margin-bottom:12px;width:100%">
        <div class="gt on" data-gt="dist" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">📍</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.5)">거리</div>
        </div>
        <div class="gt" data-gt="time" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">⏱</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.5)">시간</div>
        </div>
        <div class="gt" data-gt="speed" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">⚡</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.5)">페이스</div>
        </div>
        <div class="gt" data-gt="free" style="flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer">
          <div style="font-size:18px;margin-bottom:3px">🌙</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.5)">자유</div>
        </div>
      </div>
      <!-- Goal values -->
      <div class="gv-grid" id="gvd" style="width:100%">
        <div class="gv" data-v="3"><span class="gv-n">3</span><span class="gv-u">km</span></div>
        <div class="gv on" data-v="5"><span class="gv-n">5</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="10"><span class="gv-n">10</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="15"><span class="gv-n">15</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="21"><span class="gv-n">21</span><span class="gv-u">km</span></div>
        <div class="gv" data-v="42"><span class="gv-n">42</span><span class="gv-u">km</span></div>
      </div>
      <div class="gv-grid" id="gvt" style="display:none;width:100%">
        <div class="gv" data-v="20"><span class="gv-n">20</span><span class="gv-u">분</span></div>
        <div class="gv on" data-v="30"><span class="gv-n">30</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="45"><span class="gv-n">45</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="60"><span class="gv-n">60</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="90"><span class="gv-n">90</span><span class="gv-u">분</span></div>
        <div class="gv" data-v="120"><span class="gv-n">120</span><span class="gv-u">분</span></div>
      </div>
      <div class="gv-grid" id="gvs" style="display:none;width:100%">
        <div class="gv" data-v="430"><span class="gv-n">4'30"</span><span class="gv-u">/km</span></div>
        <div class="gv on" data-v="500"><span class="gv-n">5'00"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="530"><span class="gv-n">5'30"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="600"><span class="gv-n">6'00"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="630"><span class="gv-n">6'30"</span><span class="gv-u">/km</span></div>
        <div class="gv" data-v="700"><span class="gv-n">7'00"</span><span class="gv-u">/km</span></div>
      </div>
    </div>
    <!-- START RUN -->
    <div style="padding:0 16px 36px;flex-shrink:0">
      <button id="start-btn" onclick="requestHealthAccess()" style="width:100%;height:72px;background:#c8f050;border:none;border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;letter-spacing:.12em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:14px;box-shadow:0 8px 32px rgba(200,240,80,.32);-webkit-tap-highlight-color:transparent" onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform=''" ontouchstart="this.style.transform='scale(.97)'" ontouchend="this.style.transform=''">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        START RUN
      </button>
    </div>
  </div>

  <!-- HEALTH PERMISSION MODAL -->
  <div id="health-modal" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(5,5,5,.94);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);flex-direction:column;align-items:center;justify-content:flex-end;padding:0 0 40px">
    <div style="width:100%;max-width:420px;background:#161616;border-radius:26px 26px 22px 22px;overflow:hidden;border:1px solid rgba(255,255,255,.08)">
      <div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>
      <div style="display:flex;align-items:center;justify-content:center;gap:16px;padding:24px 28px 0">
        <div style="width:56px;height:56px;border-radius:16px;background:#ff3b30;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(255,59,48,.3)">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        </div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        <div style="width:56px;height:56px;border-radius:16px;background:rgba(200,240,80,.12);border:1.5px solid rgba(200,240,80,.2);display:flex;align-items:center;justify-content:center"><span style="font-size:28px">👻</span></div>
      </div>
      <div style="padding:20px 24px 0;text-align:center">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:#fff;margin-bottom:8px;line-height:1.1">"GhostRun"이 건강 데이터에<br>접근하려고 합니다</div>
        <div style="font-size:13px;color:rgba(255,255,255,.45);line-height:1.55;margin-bottom:4px">iPhone 피트니스 활동 데이터를 사용하여 더 정확한 러닝 기록을 제공합니다.</div>
      </div>
      <div style="margin:16px 24px 0;background:rgba(255,255,255,.04);border-radius:14px;overflow:hidden">
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.05)">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">활동 에너지 (칼로리)</div><div style="font-size:11px;color:rgba(255,255,255,.35)">소모 칼로리 측정</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.05)">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">운동 시간</div><div style="font-size:11px;color:rgba(255,255,255,.35)">운동 지속 시간</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:13px 16px">
          <div style="width:32px;height:32px;border-radius:9px;background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c8f050" stroke-width="2.5" stroke-linecap="round"><path d="M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0"/><path d="M12 8v4l3 3"/></svg></div>
          <div><div style="font-size:13px;color:rgba(255,255,255,.85)">이동 거리</div><div style="font-size:11px;color:rgba(255,255,255,.35)">GPS 기반 거리</div></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;padding:20px 24px 28px">
        <button onclick="grantHealthAccess()" style="width:100%;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:.07em;color:#0a0a0a;cursor:pointer">허용</button>
        <button onclick="denyHealthAccess()" style="width:100%;height:48px;background:none;border:1.5px solid rgba(255,255,255,.1);border-radius:16px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:600;color:rgba(255,255,255,.4);cursor:pointer">허용 안 함</button>
      </div>
    </div>
  </div>

  <!-- STATE 1: ACTIVE RUN -->
  <div id="ractive" class="rstate" style="flex-direction:column;background:#0a0a0a;position:relative;flex:1;min-height:0">
    <div style="position:absolute;top:16px;left:16px;z-index:10;display:flex;align-items:center;gap:7px;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);border-radius:99px;padding:5px 12px 5px 8px;border:1px solid rgba(255,255,255,.08)">
      <div style="width:7px;height:7px;border-radius:50%;background:#c8f050;box-shadow:0 0 8px #c8f050;animation:syncPulse 1.5s infinite"></div>
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.15em;color:rgba(255,255,255,.6)">GHOST SYNC ACTIVE</span>
    </div>
    <div id="ra-profile" onclick="openProfile()" style="position:absolute;top:10px;right:14px;z-index:10;width:38px;height:38px;border-radius:50%;background:rgba(30,30,30,.9);border:1.5px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer">👻</div>
    <!-- MAP + STATS -->
    <div id="ra-map-container" style="flex:1;min-height:200px;position:relative;background:#0a0a0a;display:flex;flex-direction:column">
      <svg id="ra-svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none" viewBox="0 0 400 320" preserveAspectRatio="none">
        <path id="ghost-path" d="M 30 290 C 70 270,100 230,140 200 C 180 170,220 150,270 110 C 310 78,350 52,390 28" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="3.5" stroke-dasharray="9 9"/>
        <path id="run-path" d="M 30 290 C 70 270,100 230,140 200 C 180 170,220 150,270 110 C 310 78,350 52,390 28" fill="none" stroke="#c8f050" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M 30 290 C 70 270,100 230,140 200 C 180 170,220 150,270 110 C 310 78,350 52,390 28" fill="none" stroke="rgba(200,240,80,.15)" stroke-width="12" stroke-linecap="round"/>
        <circle id="runner-glow" cx="30" cy="290" r="18" fill="rgba(200,240,80,.12)"><animate attributeName="r" values="16;22;16" dur="1.6s" repeatCount="indefinite"/></circle>
        <circle id="runner-dot" cx="30" cy="290" r="8" fill="#c8f050"><animate attributeName="r" values="8;10;8" dur="1.6s" repeatCount="indefinite"/></circle>
      </svg>
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;z-index:2;pointer-events:none;padding:16px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.24em;color:rgba(255,255,255,.35);margin-bottom:4px">DISTANCE (KM)</div>
        <div id="ra-dist" style="font-family:'Barlow Condensed',sans-serif;font-size:96px;font-weight:900;line-height:.85;color:#c8f050;text-shadow:0 0 50px rgba(200,240,80,.4);letter-spacing:-.02em">0.00</div>
        <div style="display:flex;align-items:center;gap:32px;margin-top:20px">
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
            <span style="font-size:9px;font-weight:600;letter-spacing:.2em;color:rgba(255,255,255,.3)">PACE</span>
            <span id="ra-pace" style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;color:rgba(255,255,255,.9);line-height:1">--'--"</span>
          </div>
          <div style="width:1px;height:46px;background:rgba(255,255,255,.1)"></div>
          <div style="display:flex;flex-direction:column;align-items:flex-start;gap:4px">
            <span style="font-size:9px;font-weight:600;letter-spacing:.2em;color:rgba(255,255,255,.3)">TIME</span>
            <span id="ra-time" style="font-family:'Barlow Condensed',sans-serif;font-size:42px;font-weight:800;color:rgba(255,255,255,.9);line-height:1">00:00</span>
          </div>
        </div>
      </div>
    </div>
    <!-- RACING BAR -->
    <div style="background:#111;border-top:1px solid rgba(255,255,255,.06);padding:11px 16px 9px;flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.16em;color:rgba(255,255,255,.3)">START</span>
        <span id="ra-gl-txt" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.16em;color:rgba(200,240,80,.5)">5KM GOAL</span>
      </div>
      <div style="position:relative;height:32px">
        <div style="position:absolute;top:50%;left:0;right:0;height:6px;background:rgba(255,255,255,.06);border-radius:3px;transform:translateY(-50%)"></div>
        <div id="track-fill" style="position:absolute;top:50%;left:0;height:6px;background:linear-gradient(90deg,rgba(200,240,80,.25),#c8f050);border-radius:3px;transform:translateY(-50%);transition:width .6s ease;width:0%"></div>
        <div id="track-ghosts" style="position:absolute;inset:0"></div>
      </div>
    </div>
    <!-- BOTTOM ACTIONS: CLAP + huge PAUSE -->
    <div style="background:#0a0a0a;border-top:1px solid rgba(255,255,255,.05);display:flex;align-items:stretch;flex-shrink:0;min-height:110px">
      <!-- CLAP -->
      <button id="clap-btn" onclick="doClap()" style="flex:0 0 100px;background:rgba(255,255,255,.03);border:none;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:14px 10px;cursor:pointer;-webkit-tap-highlight-color:transparent">
        <span id="clap-em" style="font-size:32px;display:block;transition:transform .2s">👏</span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35)">CLAP</span>
        <span id="clap-count" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:rgba(200,240,80,.7)">0</span>
      </button>
      <!-- PAUSE — massive lime -->
      <button id="pause-btn" onclick="handlePauseTap()" style="flex:1;background:#c8f050;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:transform .1s,opacity .1s;box-shadow:0 -4px 24px rgba(200,240,80,.3)" onmousedown="this.style.transform='scale(.98)'" onmouseup="this.style.transform=''" ontouchstart="this.style.transform='scale(.98)'" ontouchend="this.style.transform=''">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="#0a0a0a" stroke="none">
          <rect x="5" y="3" width="4" height="18" rx="1.5"/>
          <rect x="15" y="3" width="4" height="18" rx="1.5"/>
        </svg>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.18em;color:#0a0a0a;line-height:1">PAUSE</span>
      </button>
    </div>

        <span id="ra-cal" style="display:none">0</span>
  </div>

  <!-- STATE 1.5: PAUSED -->
  <div id="rpaused" class="rstate" style="flex-direction:column;background:#0a0a0a;position:relative;align-items:center;justify-content:center">
    <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)"></div>
    <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;padding:0 28px;width:100%">
      <div style="width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;margin-bottom:20px">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.5)" stroke-width="2.5" stroke-linecap="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      </div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;color:#fff;margin-bottom:6px">일시 중지됨</div>
      <div style="display:flex;gap:28px;margin-bottom:40px">
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:#c8f050" id="ps-dist">0.00</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">KM</div></div>
        <div style="width:1px;background:rgba(255,255,255,.08)"></div>
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:rgba(255,255,255,.7)" id="ps-time">00:00</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">TIME</div></div>
        <div style="width:1px;background:rgba(255,255,255,.08)"></div>
        <div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:rgba(255,255,255,.7)" id="ps-pace">--'--"</div><div style="font-size:9px;letter-spacing:.14em;color:rgba(255,255,255,.3)">PACE</div></div>
      </div>
      <button onclick="resumeRun()" style="width:100%;height:64px;background:#c8f050;border:none;border-radius:18px;font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:12px;-webkit-tap-highlight-color:transparent;box-shadow:0 6px 24px rgba(200,240,80,.28)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#0a0a0a"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        RE-START RUN
      </button>
      <button onclick="stopRun()" style="width:100%;height:56px;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.1);border-radius:18px;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:rgba(255,255,255,.55);cursor:pointer;-webkit-tap-highlight-color:transparent">FINISH RUN</button>
    </div>
  </div>

  <!-- STATE 2: FINISH -->
  <div id="rfinish" class="rstate" style="flex-direction:column;background:#0a0a0a">
    <div style="background:linear-gradient(180deg,rgba(200,240,80,.07) 0%,transparent 100%);border-bottom:1px solid rgba(200,240,80,.1);padding:32px 20px 24px;text-align:center;flex-shrink:0">
      <div style="font-size:52px;margin-bottom:10px">🏅</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:900;color:#c8f050;line-height:1">완주!</div>
      <div id="rf-msg" style="font-size:13px;color:rgba(255,255,255,.4);margin-top:8px">오늘도 잘 달렸어요</div>
    </div>
    <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06);overflow:hidden">
      <div style="padding:24px 20px;display:flex;flex-direction:column;gap:5px;border-right:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)">
        <span style="font-size:8px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.28)">DISTANCE</span>
        <span id="rf-d" style="font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:900;color:#c8f050;line-height:1">0.00</span>
        <span style="font-size:13px;color:rgba(255,255,255,.3)">km</span>
      </div>
      <div style="padding:24px 20px;display:flex;flex-direction:column;gap:5px;border-bottom:1px solid rgba(255,255,255,.06)">
        <span style="font-size:8px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.28)">TIME</span>
        <span id="rf-t" style="font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:900;color:rgba(255,255,255,.85);line-height:1">00:00</span>
        <span style="font-size:13px;color:rgba(255,255,255,.3)">min</span>
      </div>
      <div style="padding:24px 20px;display:flex;flex-direction:column;gap:5px;border-right:1px solid rgba(255,255,255,.06)">
        <span style="font-size:8px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.28)">AVG PACE</span>
        <span id="rf-p" style="font-family:'Barlow Condensed',sans-serif;font-size:44px;font-weight:900;color:rgba(255,255,255,.82);line-height:1">--'--"</span>
        <span style="font-size:11px;color:rgba(255,255,255,.28)">/km</span>
      </div>
      <div style="padding:24px 18px;display:flex;flex-direction:column;gap:5px">
        <span style="font-size:8px;font-weight:700;letter-spacing:.2em;color:rgba(255,255,255,.28)">CALORIES</span>
        <span id="rf-c" style="font-family:'Barlow Condensed',sans-serif;font-size:44px;font-weight:900;color:rgba(255,255,255,.82);line-height:1">0</span>
        <span style="font-size:11px;color:rgba(255,255,255,.28)">kcal</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;padding:20px 16px 42px;flex-shrink:0">
      <button onclick="goTab('shot')" style="flex:1;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;letter-spacing:.07em;color:#080808;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;-webkit-tap-highlight-color:transparent">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        인증샷
      </button>
      <button onclick="resetRun()" style="height:56px;padding:0 24px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:16px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:rgba(255,255,255,.45);cursor:pointer;-webkit-tap-highlight-color:transparent">완료</button>
    </div>
  </div>

</div>

<div id="v-crew" class="mview" style="background:#0a0a0a;overflow-y:auto;scrollbar-width:none">

  <!-- Sticky header -->
    <!-- Sticky header -->
  <div style="position:sticky;top:0;z-index:20;background:rgba(10,10,10,.96);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,.07);padding:16px 16px 12px;flex-shrink:0">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;letter-spacing:.02em;line-height:1">러닝 크루</div>
        <div style="font-size:10px;font-weight:300;color:rgba(255,255,255,.3);letter-spacing:.04em;margin-top:1px">사회적 피로감 없는 건강한 연결</div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="openFriendsModal()" style="height:38px;padding:0 14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.6);cursor:pointer;display:flex;align-items:center;gap:7px;-webkit-tap-highlight-color:transparent">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>
          친구 추가
        </button>
        <button onclick="openCreateRoom()" style="height:38px;padding:0 16px;background:#c8f050;border:none;border-radius:10px;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;display:flex;align-items:center;gap:7px;-webkit-tap-highlight-color:transparent">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="#0a0a0a"><path d="M12 5v14M5 12h14"/></svg>
          크루 만들기
        </button>
      </div>
    </div>
    <div style="display:flex;gap:6px" id="room-tabs">
      <button class="rtab on" data-rt="browse" onclick="switchRoomTab('browse')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(200,240,80,.3);background:rgba(200,240,80,.1);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.06em;color:#c8f050;cursor:pointer">공개 크루</button>
      <button class="rtab" data-rt="mine" onclick="switchRoomTab('mine')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">내 크루</button>
      <button class="rtab" data-rt="friends" onclick="switchRoomTab('friends')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">친구</button>
      <button class="rtab" data-rt="history" onclick="switchRoomTab('history')" style="flex:1;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.06em;color:rgba(255,255,255,.4);cursor:pointer">기록</button>
    </div>
  </div>

  <!-- ── 공개 크루 목록 ── -->
  <div id="room-pane-browse" class="rpane" style="padding:12px 16px 24px">
    <div id="room-list-container"></div>
  </div>

  <!-- ── 내 크루 ── -->
  <div id="room-pane-mine" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="my-room-container"></div>
  </div>

  <!-- ── 친구 ── -->
  <div id="room-pane-friends" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="friends-container"></div>
  </div>

  <!-- ── 참여 기록 ── -->
  <div id="room-pane-history" class="rpane" style="display:none;padding:12px 16px 24px">
    <div id="room-history-container"></div>
  </div>


</div>

<!-- ── 방 만들기 모달 ── -->
<div id="m-create-room" class="modal" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);align-items:flex-end;justify-content:center">
  <div style="width:100%;max-width:480px;background:#161616;border-radius:26px 26px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 40px;overflow:hidden">
    <div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15)"></div></div>
    <div style="padding:20px 22px 0">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;margin-bottom:4px">크루 만들기</div>
      <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:20px">방을 만들고 함께 뛸 러너를 초대하세요</div>

      <!-- 방 이름 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">크루 이름</div>
        <input id="cr-name" type="text" placeholder="예: 새벽 달리기 크루" maxlength="20"
          style="width:100%;height:46px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Barlow',sans-serif;font-size:15px;font-weight:300;color:#fff;outline:none;box-sizing:border-box;-webkit-tap-highlight-color:transparent"
          oninput="updateRoomCode(this.value)">
      </div>

      <!-- 목표 거리 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">목표 거리</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="cr-goal-row">
          <div class="cr-opt on" data-crv="5" onclick="setCrOpt('goal','5',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#c8f050;line-height:1">5</span>
            <span style="font-size:8px;color:rgba(200,240,80,.6)">km</span>
          </div>
          <div class="cr-opt" data-crv="10" onclick="setCrOpt('goal','10',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">10</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="21" onclick="setCrOpt('goal','21',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">21</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="42" onclick="setCrOpt('goal','42',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">42</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">km</span>
          </div>
          <div class="cr-opt" data-crv="custom" onclick="setCrOpt('goal','custom',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">?</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">직접</span>
          </div>
        </div>
        <input id="cr-custom-km" type="number" placeholder="직접 입력 (km)" min="1" max="999"
          style="display:none;width:100%;height:40px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:0 14px;font-family:'Barlow',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-top:8px">
      </div>

      <!-- 기간 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">기간</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px" id="cr-period-row">
          <div class="cr-opt cr-period-opt on" data-crv="7" onclick="setCrOpt('period','7',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#c8f050;line-height:1">7</span>
            <span style="font-size:8px;color:rgba(200,240,80,.6)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="14" onclick="setCrOpt('period','14',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">14</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="30" onclick="setCrOpt('period','30',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">30</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">일</span>
          </div>
          <div class="cr-opt cr-period-opt" data-crv="0" onclick="setCrOpt('period','0',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:1px">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">∞</span>
            <span style="font-size:8px;color:rgba(255,255,255,.3)">무제한</span>
          </div>
        </div>
      </div>

      <!-- 최대 인원 -->
      <div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.4);margin-bottom:7px">최대 인원</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="cr-max-row">
          <div class="cr-opt cr-max-opt on" data-crv="4" onclick="setCrOpt('max','4',this)" style="height:42px;border-radius:10px;border:1px solid rgba(200,240,80,.35);background:rgba(200,240,80,.1);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:#c8f050">4</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="8" onclick="setCrOpt('max','8',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">8</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="16" onclick="setCrOpt('max','16',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">16</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="32" onclick="setCrOpt('max','32',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">32</span>
          </div>
          <div class="cr-opt cr-max-opt" data-crv="99" onclick="setCrOpt('max','99',this)" style="height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7)">∞</span>
          </div>
        </div>
      </div>

      <!-- 비밀번호 토글 -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;border:1px solid rgba(255,255,255,.07)">
        <div>
          <div style="font-size:13px;font-weight:400;color:rgba(255,255,255,.8)">🔒 비밀번호 설정</div>
          <div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:1px">비공개 크루으로 만들기</div>
        </div>
        <div id="pw-toggle" onclick="toggleRoomPw()" style="width:44px;height:26px;border-radius:13px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.12);cursor:pointer;position:relative;transition:background .2s">
          <div id="pw-thumb" style="width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.4);position:absolute;top:2px;left:2px;transition:left .2s,background .2s"></div>
        </div>
      </div>
      <input id="cr-pw" type="password" placeholder="비밀번호 입력 (4~12자)" maxlength="12"
        style="display:none;width:100%;height:44px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0 14px;font-family:'Barlow',sans-serif;font-size:14px;color:#fff;outline:none;box-sizing:border-box;margin-bottom:8px">

      <!-- 크루 코드 미리보기 -->
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.12);border-radius:10px;margin-bottom:20px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(200,240,80,.6)" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span style="font-size:10px;color:rgba(255,255,255,.4)">크루 코드</span>
        <span id="cr-code-preview" style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:rgba(200,240,80,.7);letter-spacing:.1em">GR-????</span>
      </div>

      <button onclick="createRoom()" style="width:100%;height:52px;background:#c8f050;border:none;border-radius:14px;font-family:'Barlow Condensed',sans-serif;font-size:19px;font-weight:900;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;-webkit-tap-highlight-color:transparent">만들기</button>
      <button onclick="closeModal('m-create-room')" style="width:100%;height:38px;background:none;border:none;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px">취소</button>
    </div>
  </div>
</div>

<!-- ── 비밀번호 입장 모달 ── -->
<div id="m-room-pw" class="modal" style="display:none;position:fixed;inset:0;z-index:210;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);align-items:center;justify-content:center;padding:24px">
  <div style="width:100%;max-width:340px;background:#1a1a1a;border-radius:20px;border:1px solid rgba(255,255,255,.1);padding:28px 24px 24px;text-align:center">
    <div style="font-size:36px;margin-bottom:12px">🔒</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;margin-bottom:4px" id="pw-modal-name">비공개 크루</div>
    <div style="font-size:11px;color:rgba(255,255,255,.35);margin-bottom:20px">비밀번호를 입력하세요</div>
    <input id="pw-input" type="password" placeholder="비밀번호" maxlength="12"
      style="width:100%;height:48px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:0 16px;font-family:'Barlow',sans-serif;font-size:16px;color:#fff;outline:none;box-sizing:border-box;text-align:center;letter-spacing:.2em;margin-bottom:8px">
    <div id="pw-modal-err" style="font-size:11px;color:rgba(255,80,80,.8);min-height:16px;margin-bottom:12px"></div>
    <button onclick="submitRoomPw()" style="width:100%;height:48px;background:#c8f050;border:none;border-radius:12px;font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:900;color:#0a0a0a;cursor:pointer">입장</button>
    <button onclick="closeModal('m-room-pw')" style="width:100%;height:36px;background:none;border:none;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px">취소</button>
  </div>
</div>

<!-- SHOT -->
<div id="v-shot" class="mview">
  <div id="card">
    <img id="bg-img" src="" alt="">
    <div id="empty-state"><div class="e-grain"></div><div class="e-icon">🌙</div><div class="e-hint">사진을 불러오세요</div></div>
    <div id="ovs">

      <!-- Ghost overlay -->
      <div class="ov" id="ov-g">
        <div class="ft"></div><div class="fb"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-g">👻</span><span class="r-nm" id="nm-g">Runner</span></div>
          <div class="ov-dt" id="dt-g"></div>
        </div>
        <div class="g-bot">
          <div class="g-dist">5.20<span class="g-du">km</span></div>
          <div class="g-stats">
            <div class="g-s"><span class="g-sl">Pace</span><span class="g-sv">5'12"</span></div>
            <div class="g-s"><span class="g-sl">Time</span><span class="g-sv">26'58"</span></div>
            <div class="g-s"><span class="g-sl">Cal</span><span class="g-sv">312</span></div>
          </div>
          <div class="g-foot"><span class="g-brand">GhostRun · 따로 또 같이</span><span class="g-tag"># Ghost</span></div>
        </div>
        <canvas id="mmg" width="40" height="40"></canvas>
      </div>

      <!-- Path overlay -->
      <div class="ov off" id="ov-p">
        <div class="ft"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:190px;background:linear-gradient(0deg,rgba(0,0,0,.9),rgba(0,0,0,.4) 55%,transparent)"></div>
        <div class="ov-hd">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-p">👻</span><span class="r-nm" id="nm-p">Runner</span></div>
          <span class="p-logo">GhostRun</span>
        </div>
        <div class="p-mapbg"><canvas id="mmp" width="220" height="220"></canvas></div>
        <div class="p-bot">
          <div class="p-stat"><span class="p-l">Distance</span><span class="p-v">5.20<span class="p-u"> km</span></span></div>
          <div class="p-stat" style="text-align:right"><span class="p-l" style="text-align:right">Avg Pace</span><span class="p-v">5'12"<span class="p-u">/km</span></span></div>
        </div>
      </div>

      <!-- Stamp overlay -->
      <div class="ov off" id="ov-s">
        <div class="st-vign"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:300px;background:linear-gradient(0deg,rgba(0,0,0,.95),rgba(0,0,0,.5) 60%,transparent)"></div>
        <div class="ov-hd" style="background:linear-gradient(180deg,rgba(0,0,0,.6),transparent);padding-bottom:10px">
          <div class="runner" onclick="openAv()"><span class="r-em" id="em-s">👻</span><span class="r-nm" id="nm-s">Runner</span></div>
          <span class="st-logo">GhostRun</span>
        </div>
        <div class="st-bot">
          <!-- Goal vs Achieved -->
          <div style="margin-bottom:10px">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:600;letter-spacing:.18em;color:rgba(200,240,80,.6);margin-bottom:5px">GOAL vs ACHIEVED</div>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="display:flex;flex-direction:column;gap:1px">
                <span style="font-size:8px;font-weight:300;color:rgba(255,255,255,.35);letter-spacing:.08em">목표</span>
                <span id="st-goal-val" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:rgba(255,255,255,.45);line-height:1">5.0<span style="font-size:14px;font-weight:400"> km</span></span>
              </div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;color:rgba(200,240,80,.4);font-weight:700">→</div>
              <div style="display:flex;flex-direction:column;gap:1px">
                <span style="font-size:8px;font-weight:300;color:rgba(200,240,80,.6);letter-spacing:.08em">달성</span>
                <span style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:#c8f050;line-height:1">5.20<span style="font-size:14px;font-weight:400"> km</span></span>
              </div>
            </div>
          </div>
          <div class="st-sub">
            <div class="ss"><span class="ss-l">Pace</span><span class="ss-v">5'12"</span></div>
            <div class="ss"><span class="ss-l">Time</span><span class="ss-v">26'58"</span></div>
            <div class="ss"><span class="ss-l">Cal</span><span class="ss-v">312</span></div>
          </div>
        </div>
        <!-- BIG COMPLETED STAMP -->
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-18deg);pointer-events:none;z-index:10">
          <div style="border:5px solid rgba(200,240,80,.75);border-radius:12px;padding:14px 22px;text-align:center;background:rgba(0,0,0,.1);backdrop-filter:blur(2px)">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:48px;font-weight:900;letter-spacing:.06em;color:rgba(200,240,80,.82);line-height:.9;text-shadow:0 0 20px rgba(200,240,80,.3)">COMPLETED</div>
            <div id="bd" style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:.2em;color:rgba(200,240,80,.5);margin-top:5px"></div>
            <div id="em-b" style="font-size:28px;margin-top:4px">👻</div>
          </div>
        </div>
        <canvas id="mms" width="40" height="40"></canvas>
      </div>
    </div>
  </div>
  <div id="tbar">
    <button class="th on" data-t="g">👻 Ghost</button>
    <button class="th" data-t="p">🗺 Path</button>
    <button class="th" data-t="s">🎖 Stamp</button>
  </div>
  <div id="shot-acts">
    <label class="ai"><input type="file" id="ic" accept="image/*" capture="environment"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></label>
    <label class="ai"><input type="file" id="ig" accept="image/*"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></label>
    <button class="asave" id="bsave"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>저장하기</button>
  </div>
</div>

<!-- RECORDS -->

<!-- RECORDS -->
<div id="v-records" class="mview">
  <div class="rec-hero">
    <div class="rec-hero-lbl">총 누적 거리</div>
    <div class="rec-big"><span class="rec-big-n">312</span><span class="rec-big-u">.4 km</span></div>
    <div class="rec-hero-sub">62회 완주 · 러닝 47시간 28분</div>
    <div class="rec-3">
      <div class="rec-3s"><span class="rec-3sl">총 시간</span><span class="rec-3sv">47<span style="font-family:var(--fb);font-size:16px;color:var(--dim)">h</span></span><span class="rec-3su">28분</span></div>
      <div class="rec-3s"><span class="rec-3sl">평균 페이스</span><span class="rec-3sv">5'18"</span><span class="rec-3su">/km</span></div>
      <div class="rec-3s"><span class="rec-3sl">참여 크루</span><span class="rec-3sv">5</span><span class="rec-3su">개</span></div>
    </div>
  </div>
  <div class="rec-cal"><div class="rec-cal-lbl">이번 달 활동</div><div class="cal-grid" id="cal-grid"></div></div>
  <div class="rec-target">
    <div class="rt-top"><div><div class="rt-lbl">이번 달 목표</div><div class="rt-val">37.8 <span style="font-size:14px;font-weight:200;color:var(--dim)">/ 100 km</span></div></div><span class="rt-pct">38%</span></div>
    <div class="rt-bar"><div class="rt-fill" id="rt-fill" style="width:0%"></div></div>
  </div>
  <div class="rec-log">
    <div class="rec-log-hd"><span class="rec-log-title">최근 런</span><span class="rec-log-cnt">6회</span></div>
    <div id="run-log"></div>
  </div>
  <div class="rec-crews">
    <div class="rec-crews-title">참여한 크루</div>
    <div id="rec-past-crews"></div>
  </div>
</div>

</div><!-- /main -->

<!-- BOTTOM TABS -->
<div id="btabs">
  <button class="btab on" data-v="home">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>홈<div class="btab-dot"></div>
  </button>
  <button class="btab" data-v="crew">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>크루<div class="btab-dot"></div>
  </button>
  <button class="btab btab-start" data-v="run">
    <div class="btab-run-wrap"><svg viewBox="0 0 24 24" style="width:18px;height:18px"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor" stroke="none"/></svg></div>시작
  </button>
  <button class="btab" data-v="shot">
    <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>인증샷<div class="btab-dot"></div>
  </button>
  <button class="btab" data-v="records">
    <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>내 기록<div class="btab-dot"></div>
  </button>
</div>

<!-- MODALS -->
<div id="m-join" class="modal"><div class="m-box">
  <div class="m-title">크루 참여하기</div><div class="m-sub">초대 코드를 입력하면 크루원의 기록을 함께 볼 수 있어요</div>
  <input class="join-inp" id="jin" type="text" placeholder="초대 코드 (예: GR-2847)" maxlength="10" oninput="onJoinInput(this.value)">
  <div class="join-prev" id="jprev"><span style="font-size:26px" id="jp-em">👻</span><div style="flex:1"><div style="font-size:14px;font-weight:300;margin-bottom:3px" id="jp-name"></div><div style="font-size:10px;color:var(--dim)" id="jp-meta"></div></div><span style="font-family:var(--fd);font-style:italic;font-size:22px;color:var(--acc)" id="jp-pct"></span></div>
  <button class="m-ok" id="jok" style="display:none" onclick="confirmJoin()">이 크루 참여하기 🤝</button>
  <button class="m-cancel" onclick="closeModal('m-join')">취소</button>
</div></div>

<div id="m-create" class="modal"><div class="m-box">
  <div class="m-title">새 크루 만들기</div><div class="m-sub">크루를 만들고 친구들을 초대해보세요</div>
  <div class="mf"><div class="ml">크루 이름</div><input class="mi" id="cn-inp" type="text" placeholder="예: 새벽 유령 크루" maxlength="16"></div>
  <div class="mf"><div class="ml">크루 이모지</div>
    <div class="em-row" id="em-row">
      <div class="em-opt on" data-em="👻">👻</div><div class="em-opt" data-em="🧛">🧛</div><div class="em-opt" data-em="🧟">🧟</div><div class="em-opt" data-em="💀">💀</div><div class="em-opt" data-em="🎃">🎃</div><div class="em-opt" data-em="🦇">🦇</div><div class="em-opt" data-em="😈">😈</div><div class="em-opt" data-em="⚡">⚡</div>
    </div>
  </div>
  <div class="mf"><div class="ml">이번 달 목표</div>
    <div class="g-row" id="g-row">
      <div class="g-opt" data-km="50"><span>50</span><span>km</span></div>
      <div class="g-opt on" data-km="100"><span>100</span><span>km</span></div>
      <div class="g-opt" data-km="150"><span>150</span><span>km</span></div>
      <div class="g-opt" data-km="200"><span>200</span><span>km</span></div>
    </div>
  </div>
  <div class="mf"><div class="ml">활동 지역</div><input class="mi" id="ca-inp" type="text" placeholder="예: 마포구" maxlength="12" value="마포구"></div>
  <button class="m-ok" onclick="confirmCreate()">크루 만들기 ✨</button>
  <button class="m-cancel" onclick="closeModal('m-create')">취소</button>
</div></div>

<div id="m-expert" class="modal"><div class="m-box">
  <div class="m-title">Expert 크루</div><div class="m-sub">일정 기간 달성 시 전용 크루를 개설할 수 있어요</div>
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--sf);border:1px solid var(--ln);border-radius:14px;margin-bottom:8px;cursor:pointer">
    <span style="font-size:24px">👻</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:300">Ghost Master 크루</div><div style="font-size:10px;color:var(--dim);margin-top:2px">조건: 3개월 연속 100km 달성 ✓</div></div>
    <span style="font-size:10px;color:rgba(200,240,80,.8)">개설 가능</span>
  </div>
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--sf);border:1px solid var(--ln);border-radius:14px;margin-bottom:8px;opacity:.5">
    <span style="font-size:24px">💀</span>
    <div style="flex:1"><div style="font-size:13px;font-weight:300">Skull Elite 크루</div><div style="font-size:10px;color:var(--dim);margin-top:2px">조건: 6개월 연속 150km (4/6 진행중)</div></div>
    <span style="font-size:11px;color:rgba(255,255,255,.25)">🔒</span>
  </div>
  <button class="m-cancel" onclick="closeModal('m-expert')">닫기</button>
</div></div>

<div id="m-member" class="modal"><div class="m-box" id="mm-box"></div></div>
<div id="avs"><div class="av-box"><div class="av-ttl">캐릭터 선택</div><div class="av-grid" id="avgrid"></div></div></div>
<canvas id="ec" style="display:none"></canvas>
<div id="flash"></div>
<div id="toast"></div>

<script>
// DATA
const PAST_LOGS=[
  {date:'02.18',mo:'Feb',d:5.20,pace:"5'12\"",time:"26'58\"",cal:312,ri:0},
  {date:'02.14',mo:'Feb',d:4.80,pace:"5'20\"",time:"25'36\"",cal:288,ri:1},
  {date:'02.10',mo:'Feb',d:6.10,pace:"5'08\"",time:"31'17\"",cal:366,ri:2},
  {date:'02.05',mo:'Feb',d:3.90,pace:"5'35\"",time:"21'47\"",cal:234,ri:0},
  {date:'01.28',mo:'Jan',d:9.80,pace:"5'01\"",time:"49'10\"",cal:588,ri:1},
  {date:'01.21',mo:'Jan',d:8.40,pace:"5'14\"",time:"43'58\"",cal:504,ri:2},
];
const INSTA_POSTS=[
  {em:'👻',user:'익명의 러너',dist:5.20,pace:"5'12\"",date:'오늘',caption:'새벽 러닝 성공! 🌙',colors:['#0d1a0d','#1a2e0d'],accentAngle:'145deg'},
  {em:'🏃',user:'새벽의 유령',dist:8.40,pace:"4'55\"",date:'어제',caption:'10km 도전 중! 💪',colors:['#1a0d0d','#2e1a0d'],accentAngle:'135deg'},
  {em:'🌙',user:'밤의 러너',dist:6.10,pace:"5'08\"",date:'2일 전',caption:'비 오는 날도 고!',colors:['#0d0d1a','#0d1a2e'],accentAngle:'155deg'},
  {em:'⚡',user:'바람처럼',dist:3.80,pace:"5'45\"",date:'3일 전',caption:'첫 5K 도전! 🎉',colors:['#1a100d','#2e200d'],accentAngle:'125deg'},
  {em:'💨',user:'도심 탈출자',dist:10.50,pace:"4'42\"",date:'4일 전',caption:'하프 마라톤 준비중',colors:['#0d0d0d','#141414'],accentAngle:'160deg'},
];

// ROOM SYSTEM
const ROOM_KEY='ghostrun_rooms_v2', HISTORY_KEY='ghostrun_room_history_v2';
const SAMPLE_ROOMS=[
  {id:'GR-2847',name:'새벽 5km 챌린지',goal:5,period:7,max:8,members:3,hasPw:false,em:'🌙',createdAt:'2025-02-24'},
  {id:'GR-1138',name:'한강 10K 런',goal:10,period:14,max:16,members:11,hasPw:false,em:'🏃',createdAt:'2025-02-23'},
  {id:'GR-0442',name:'비밀 러닝 클럽',goal:21,period:30,max:4,members:2,hasPw:true,em:'🔒',createdAt:'2025-02-22'},
  {id:'GR-3391',name:'도시 탈출 런',goal:5,period:0,max:99,members:7,hasPw:false,em:'💨',createdAt:'2025-02-20'},
  {id:'GR-5512',name:'주말 러너즈',goal:42,period:30,max:8,members:4,hasPw:false,em:'🏅',createdAt:'2025-02-18'},
  {id:'GR-6680',name:'월간 100km',goal:100,period:30,max:32,members:18,hasPw:false,em:'⚡',createdAt:'2025-02-15'},
];
let roomState={createGoal:'5',createPeriod:'7',createMax:'4',createPwEnabled:false,pendingJoinId:null};

function getRooms(){try{return JSON.parse(localStorage.getItem(ROOM_KEY)||'[]');}catch{return[];}}
function saveRooms(r){localStorage.setItem(ROOM_KEY,JSON.stringify(r));}
function getHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');}catch{return[];}}
function addHistory(room){
  const hist=getHistory(), exists=hist.findIndex(h=>h.id===room.id);
  const entry={...room,joinedAt:new Date().toISOString()};
  if(exists>=0)hist.splice(exists,1);
  hist.unshift(entry);
  localStorage.setItem(HISTORY_KEY,JSON.stringify(hist.slice(0,20)));
}

function openCreateRoom(){
  document.getElementById('cr-name').value='';
  document.getElementById('cr-pw').style.display='none';
  document.getElementById('cr-custom-km').style.display='none';
  roomState.createPwEnabled=false;
  const toggle=document.getElementById('pw-toggle');
  const thumb=document.getElementById('pw-thumb');
  if(toggle)toggle.style.background='rgba(255,255,255,.1)';
  if(thumb){thumb.style.left='2px';thumb.style.background='rgba(255,255,255,.4)';}
  ['cr-goal-row','cr-period-row','cr-max-row'].forEach(rowId=>{
    const row=document.getElementById(rowId);
    if(!row)return;
    row.querySelectorAll('.cr-opt').forEach((opt,i)=>{
      const on=i===0;
      opt.style.border=on?'1px solid rgba(200,240,80,.35)':'1px solid rgba(255,255,255,.08)';
      opt.style.background=on?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    });
  });
  roomState.createGoal='5';roomState.createPeriod='7';roomState.createMax='4';
  updateRoomCode('');
  openModal('m-create-room');
}

function setCrOpt(type,val,el){
  const rowMap={goal:'cr-goal-row',period:'cr-period-row',max:'cr-max-row'};
  const row=document.getElementById(rowMap[type]);
  if(!row)return;
  row.querySelectorAll('.cr-opt').forEach(opt=>{
    const isOn=opt===el;
    opt.style.border=isOn?'1px solid rgba(200,240,80,.35)':'1px solid rgba(255,255,255,.08)';
    opt.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    opt.querySelectorAll('span').forEach(s=>{
      s.style.color=isOn?(s.classList.contains('cr-sub')&&s.style.fontSize==='8px'?'rgba(200,240,80,.6)':'#c8f050'):(s.style.fontSize==='8px'?'rgba(255,255,255,.3)':'rgba(255,255,255,.7)');
    });
  });
  if(type==='goal')roomState.createGoal=val;
  if(type==='period')roomState.createPeriod=val;
  if(type==='max')roomState.createMax=val;
  const customKm=document.getElementById('cr-custom-km');
  if(customKm)customKm.style.display=(type==='goal'&&val==='custom')?'block':'none';
}

function toggleRoomPw(){
  roomState.createPwEnabled=!roomState.createPwEnabled;
  const on=roomState.createPwEnabled;
  const toggle=document.getElementById('pw-toggle');
  const thumb=document.getElementById('pw-thumb');
  const input=document.getElementById('cr-pw');
  if(toggle)toggle.style.background=on?'#c8f050':'rgba(255,255,255,.1)';
  if(thumb){thumb.style.left=on?'20px':'2px';thumb.style.background=on?'#0a0a0a':'rgba(255,255,255,.4)';}
  if(input)input.style.display=on?'block':'none';
}

function updateRoomCode(name){
  const preview=document.getElementById('cr-code-preview');
  if(!preview)return;
  if(!name||name.length<1){preview.textContent='CR-????';return;}
  const code='GR-'+(Math.abs(name.split('').reduce((a,c)=>a+c.charCodeAt(0)*31,0))%9000+1000);
  preview.textContent=code;
}

function createRoom(){
  const name=document.getElementById('cr-name').value.trim();
  if(!name){showToast('방 이름을 입력해주세요');return;}
  let goal=roomState.createGoal==='custom'?parseInt(document.getElementById('cr-custom-km').value||'5'):parseInt(roomState.createGoal);
  const pw=roomState.createPwEnabled?(document.getElementById('cr-pw').value||''):'';
  if(roomState.createPwEnabled&&pw.length<4){showToast('비밀번호는 4자 이상이어야 해요');return;}
  const code='GR-'+(Math.abs(name.split('').reduce((a,c)=>a+c.charCodeAt(0)*31,0))%9000+1000);
  const room={id:code,name,goal,period:parseInt(roomState.createPeriod),max:parseInt(roomState.createMax),members:1,hasPw:!!pw,pw,em:['🌙','🏃','⚡','💨','🏅','👻'][Math.floor(Math.random()*6)],createdAt:new Date().toISOString().slice(0,10),mine:true};
  const rooms=getRooms();rooms.unshift(room);saveRooms(rooms);addHistory(room);
  closeModal('m-create-room');
  showToast('🎉 크루가 만들어졌어요! 코드: '+code);
  switchRoomTab('mine');renderRoomTabs();
}



function submitRoomPw(){
  const inp=document.getElementById('pw-input');
  const errEl=document.getElementById('pw-modal-err');
  const pw=inp?inp.value:'';
  const id=roomState.pendingJoinId;
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===id);
  if(!room){closeModal('m-room-pw');return;}
  if(room.pw&&room.pw!==pw){if(errEl)errEl.textContent='비밀번호가 맞지 않아요';return;}
  closeModal('m-room-pw');joinRoom(id,pw);
}

function joinRoom(roomId,pw){
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);
  if(!room)return;
  addHistory(room);
  showToast('🏃 '+room.name+' 크루에 입장했어요!');
  goalType='dist';goalVal=String(room.goal);
  renderRoomTabs();
}

function switchRoomTab(tab){
  document.querySelectorAll('.rtab').forEach(t=>{
    const isOn=t.dataset.rt===tab;
    t.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';
    t.style.borderColor=isOn?'rgba(200,240,80,.3)':'rgba(255,255,255,.08)';
    t.style.color=isOn?'#c8f050':'rgba(255,255,255,.4)';
  });
  ['browse','mine','friends','history'].forEach(rt=>{
    const el=document.getElementById('room-pane-'+rt);
    if(el)el.style.display=rt===tab?'block':'none';
  });
  if(tab==='browse')renderPublicRooms();
  if(tab==='mine')renderMyRooms();
  if(tab==='friends')renderFriendsList();
  if(tab==='history')renderRoomHistory();
}

function renderRoomTabs(){renderPublicRooms();renderMyRooms();renderFriendsList();renderRoomHistory();}

function renderPublicRooms(){
  const el=document.getElementById('room-list-container');
  if(!el)return;
  const allPublic=[...SAMPLE_ROOMS,...getRooms().filter(r=>!r.mine)];
  el.innerHTML='';
  allPublic.forEach(room=>{
    const filled=Math.min(Math.round(room.members/room.max*100),100);
    const isFull=room.members>=room.max;
    const card=document.createElement('div');
    card.style.cssText='background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:border-color .15s';
    card.innerHTML=`<div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:10px"><div style="width:42px;height:42px;border-radius:12px;background:rgba(200,240,80,.08);border:1px solid rgba(200,240,80,.12);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${room.em}</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:6px;margin-bottom:2px"><span style="font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:800;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${room.name}</span>${room.hasPw?'<span style="font-size:10px">🔒</span>':''}</div><span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;color:rgba(200,240,80,.5)">${room.id}</span></div><button onclick="tryJoinRoom('${room.id}')" ${isFull?'disabled':''} style="height:32px;padding:0 14px;background:${isFull?'rgba(255,255,255,.04)':'#c8f050'};border:none;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:${isFull?'rgba(255,255,255,.2)':'#0a0a0a'};cursor:${isFull?'default':'pointer'};flex-shrink:0">${isFull?'마감':'입장'}</button></div><div style="display:flex;align-items:center;gap:16px;margin-bottom:10px"><div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:#c8f050;line-height:1">${room.goal}km</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">목표</div></div><div style="width:1px;height:28px;background:rgba(255,255,255,.08)"></div><div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">${room.period===0?'무제한':room.period+'일'}</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">기간</div></div><div style="width:1px;height:28px;background:rgba(255,255,255,.08)"></div><div style="text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.7);line-height:1">${room.members}/${room.max===99?'∞':room.max}</div><div style="font-size:8px;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.3)">인원</div></div></div><div style="background:rgba(255,255,255,.05);border-radius:3px;height:4px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,rgba(200,240,80,.5),#c8f050);border-radius:3px;width:${filled}%"></div></div>`;
    card.addEventListener('mouseenter',()=>{card.style.borderColor='rgba(200,240,80,.2)';});
    card.addEventListener('mouseleave',()=>{card.style.borderColor='rgba(255,255,255,.07)';});
    el.appendChild(card);
  });
  if(!allPublic.length) el.innerHTML='<div style="text-align:center;padding:40px 20px;color:rgba(255,255,255,.25);font-size:13px">공개 방이 없어요</div>';
}

function renderMyRooms(){
  const el=document.getElementById('my-room-container');
  if(!el)return;
  const mine=getRooms().filter(r=>r.mine);
  el.innerHTML='';
  mine.forEach(room=>{
    const card=document.createElement('div');
    card.style.cssText='background:rgba(200,240,80,.04);border:1px solid rgba(200,240,80,.12);border-radius:16px;padding:14px 16px;margin-bottom:10px';
    card.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:11px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);display:flex;align-items:center;justify-content:center;font-size:20px">${room.em}</div><div style="flex:1"><div style="font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:800;color:#fff">${room.name}</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;color:rgba(200,240,80,.5)">${room.id}${room.hasPw?' · 🔒':''}</div></div><button onclick="deleteRoom('${room.id}')" style="width:28px;height:28px;background:rgba(255,60,60,.08);border:1px solid rgba(255,60,60,.15);border-radius:8px;font-size:12px;cursor:pointer">🗑</button></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px"><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:#c8f050">${room.goal}km</div><div style="font-size:8px;color:rgba(255,255,255,.3)">목표</div></div><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:rgba(255,255,255,.7)">${room.period===0?'∞':room.period+'일'}</div><div style="font-size:8px;color:rgba(255,255,255,.3)">기간</div></div><div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:rgba(255,255,255,.7)">${room.members}</div><div style="font-size:8px;color:rgba(255,255,255,.3)">참여 중</div></div></div><div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(0,0,0,.3);border-radius:10px"><span style="font-size:11px;color:rgba(255,255,255,.4)">초대 코드</span><span style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:rgba(200,240,80,.7);flex:1">${room.id}</span><button onclick="copyRoomCode('${room.id}')" style="height:26px;padding:0 10px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:700;color:#c8f050;cursor:pointer">복사</button></div>`;
    el.appendChild(card);
  });
  if(!mine.length) el.innerHTML=`<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:14px">🚪</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.5);margin-bottom:6px">아직 만든 크루가 없어요</div><div style="font-size:12px;color:rgba(255,255,255,.25);margin-bottom:20px">크루를 만들어 함께 달려요</div><button onclick="openCreateRoom()" style="height:44px;padding:0 24px;background:#c8f050;border:none;border-radius:12px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:#0a0a0a;cursor:pointer">크루 만들기</button></div>`;
}

function renderRoomHistory(){
  const el=document.getElementById('room-history-container');
  if(!el)return;
  const hist=getHistory();
  el.innerHTML='';
  hist.forEach(room=>{
    const date=room.joinedAt?new Date(room.joinedAt).toLocaleDateString('ko-KR',{month:'long',day:'numeric'}):'';
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer';
    row.innerHTML=`<div style="width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${room.em||'🏃'}</div><div style="flex:1;min-width:0"><div style="font-size:14px;font-weight:400;color:rgba(255,255,255,.8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${room.name}</div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:600;letter-spacing:.08em;color:rgba(200,240,80,.5)">${room.id}</span><span style="font-size:9px;color:rgba(255,255,255,.25)">${date}</span></div></div><div style="text-align:right;flex-shrink:0"><div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#c8f050">${room.goal}km</div><div style="font-size:8px;color:rgba(255,255,255,.3)">목표</div></div>`;
    row.addEventListener('click',()=>tryJoinRoom(room.id));
    el.appendChild(row);
  });
  if(!hist.length) el.innerHTML=`<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:14px">📋</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:rgba(255,255,255,.5);margin-bottom:6px">참여 기록이 없어요</div><div style="font-size:12px;color:rgba(255,255,255,.25)">크루에 입장하면 기록됩니다</div></div>`;
}

function deleteRoom(roomId){
  const rooms=getRooms().filter(r=>r.id!==roomId);saveRooms(rooms);renderMyRooms();showToast('크루가 삭제됐어요');
}
function copyRoomCode(code){
  if(navigator.clipboard)navigator.clipboard.writeText(code);showToast('📋 코드 복사됨: '+code);
}

// ── JOIN ROOM PREVIEW ──
function tryJoinRoom(roomId){
  showJoinPreview(roomId);
}
function showJoinPreview(roomId){
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);if(!room)return;
  let el=document.getElementById('join-preview-sheet');
  if(!el){el=document.createElement('div');el.id='join-preview-sheet';el.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);display:flex;align-items:flex-end;justify-content:center';el.addEventListener('click',e=>{if(e.target===el)closeJoinPreview();});document.body.appendChild(el);}
  const daysLeft=room.period===0?'무제한':room.period+'일 남음',pct=Math.min(Math.round(room.members/(room.max===99?room.members+10:room.max)*100),100);
  const memberEmojis=['\uD83D\uDC7B','\uD83C\uDFC3','\uD83C\uDF19','\u26A1','\uD83D\uDCA8'].slice(0,Math.min(room.members,5)).map((em,i)=>`<div style="width:30px;height:30px;border-radius:50%;background:#222;border:2px solid #161616;display:flex;align-items:center;justify-content:center;font-size:14px;margin-left:${i?'-7px':'0'}">${em}</div>`).join('');
  el.innerHTML=`<div style="width:100%;max-width:480px;background:#161616;border-radius:28px 28px 0 0;border:1px solid rgba(255,255,255,.08);padding:0 0 48px;overflow:hidden"><div style="display:flex;justify-content:center;padding:12px 0 0"><div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)"></div></div><div style="padding:20px 22px 0"><div style="display:flex;align-items:center;gap:14px;margin-bottom:18px"><div style="width:60px;height:60px;border-radius:16px;background:rgba(200,240,80,.1);border:1.5px solid rgba(200,240,80,.18);display:flex;align-items:center;justify-content:center;font-size:30px;flex-shrink:0">${room.em}</div><div><div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;color:#fff;line-height:1.1">${room.name}</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;color:rgba(200,240,80,.55);letter-spacing:.1em;margin-top:3px">${room.id}${room.hasPw?' · 🔒':''}</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px"><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:#c8f050;line-height:1">${room.goal}<span style="font-size:13px;font-weight:400">km</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">목표 거리</div></div><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:rgba(255,255,255,.8);line-height:1">${room.period===0?'∞':room.period}<span style="font-size:12px;font-weight:400">${room.period===0?'':' 일'}</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">${daysLeft}</div></div><div style="background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center"><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:rgba(255,255,255,.8);line-height:1">${room.members}<span style="font-size:12px;font-weight:400">/${room.max===99?'∞':room.max}</span></div><div style="font-size:9px;color:rgba(255,255,255,.3);margin-top:3px">참여 인원</div></div></div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:rgba(255,255,255,.35)">크루 현황</span><span style="font-size:10px;color:rgba(200,240,80,.6)">${pct}% 채워짐</span></div><div style="background:rgba(255,255,255,.06);border-radius:4px;height:6px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,rgba(200,240,80,.5),#c8f050);border-radius:4px;width:${pct}%"></div></div></div><div style="display:flex;align-items:center;margin-bottom:18px">${memberEmojis}<span style="font-size:11px;color:rgba(255,255,255,.35);margin-left:12px">함께 달리는 중</span></div><div style="background:rgba(200,240,80,.05);border:1px solid rgba(200,240,80,.12);border-radius:12px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px"><div style="font-size:22px">🎯</div><div><div style="font-size:12px;color:rgba(255,255,255,.7)">목표 <span style="color:#c8f050;font-weight:700">${room.goal}km</span> 달성 여부만 공유돼요</div><div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:2px">순위 없음 · 부담 없음</div></div></div><button onclick="confirmJoinRoom('${room.id}')" style="width:100%;height:56px;background:#c8f050;border:none;border-radius:16px;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:.08em;color:#0a0a0a;cursor:pointer;box-shadow:0 6px 20px rgba(200,240,80,.28)">이 크루 참여하기</button><button onclick="closeJoinPreview()" style="width:100%;height:42px;background:none;border:none;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;color:rgba(255,255,255,.3);cursor:pointer;margin-top:6px">취소</button></div></div>`;
  el.style.display='flex';
}
function closeJoinPreview(){const el=document.getElementById('join-preview-sheet');if(el)el.style.display='none';}
function confirmJoinRoom(roomId){
  closeJoinPreview();
  const allRooms=[...SAMPLE_ROOMS,...getRooms()];
  const room=allRooms.find(r=>r.id===roomId);if(!room)return;
  if(room.hasPw){roomState.pendingJoinId=roomId;const nameEl=document.getElementById('pw-modal-name'),errEl=document.getElementById('pw-modal-err'),inp=document.getElementById('pw-input');if(nameEl)nameEl.textContent=room.name;if(errEl)errEl.textContent='';if(inp)inp.value='';openModal('m-room-pw');}
  else{joinRoom(roomId,'');}
}

// ── CREATE ROOM SUCCESS PREVIEW ──
function showCreateSuccess(room){
  let el=document.getElementById('create-success-sheet');
  if(!el){el=document.createElement('div');el.id='create-success-sheet';el.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.88);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;padding:24px';document.body.appendChild(el);}
  el.innerHTML=`<div style="width:100%;max-width:360px;background:#161616;border-radius:24px;border:1px solid rgba(200,240,80,.15);padding:32px 28px;text-align:center"><div style="width:72px;height:72px;border-radius:50%;background:rgba(200,240,80,.12);border:2px solid rgba(200,240,80,.3);display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 16px">&#127881;</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:#c8f050;margin-bottom:4px">크루 생성 완료!</div><div style="font-size:13px;color:rgba(255,255,255,.45);margin-bottom:24px">${room.name}</div><div style="background:rgba(200,240,80,.06);border:1.5px solid rgba(200,240,80,.2);border-radius:16px;padding:18px;margin-bottom:20px"><div style="font-size:10px;font-weight:700;letter-spacing:.18em;color:rgba(255,255,255,.35);margin-bottom:6px">크루 코드</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:40px;font-weight:900;color:#c8f050;letter-spacing:.12em;line-height:1">${room.id}</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:6px">이 코드로 친구를 초대하세요</div></div><div style="display:flex;justify-content:center;gap:20px;margin-bottom:24px"><div><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.goal}km</div><div style="font-size:9px;color:rgba(255,255,255,.3)">목표</div></div><div style="width:1px;background:rgba(255,255,255,.08)"></div><div><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.period===0?'무제한':room.period+'일'}</div><div style="font-size:9px;color:rgba(255,255,255,.3)">기간</div></div><div style="width:1px;background:rgba(255,255,255,.08)"></div><div><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:#fff">${room.hasPw?'&#128274;':'&#128275;'}</div><div style="font-size:9px;color:rgba(255,255,255,.3)">${room.hasPw?'비공개':'공개'}</div></div></div><button onclick="copyRoomCode('${room.id}');showToast('코드가 복사됐어요!')" style="width:100%;height:50px;background:#c8f050;border:none;border-radius:14px;font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:900;color:#0a0a0a;cursor:pointer;margin-bottom:10px">코드 복사 &amp; 공유</button><button onclick="document.getElementById('create-success-sheet').style.display='none';switchRoomTab('mine')" style="width:100%;height:42px;background:none;border:none;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;color:rgba(255,255,255,.35);cursor:pointer">내 크루 보기</button></div>`;
  el.style.display='flex';
}

// ── FRIENDS SYSTEM ──
const FRIENDS_KEY='ghostrun_friends_v1';
const SUGGESTED_RUNNERS=[
  {id:'fr_001',nick:'새벽 달리기',em:'🌙',totalKm:312,pace:"5'04",level:'하프'},
  {id:'fr_002',nick:'한강 수호자',em:'🏃',totalKm:580,pace:"4'52",level:'마라톤'},
  {id:'fr_003',nick:'도시 유령',em:'👻',totalKm:124,pace:"5'30",level:'10K'},
  {id:'fr_004',nick:'새벽 4시',em:'⚡',totalKm:88,pace:"5'45",level:'5K'},
  {id:'fr_005',nick:'조용한 발걸음',em:'💨',totalKm:201,pace:"5'12",level:'10K'},
];
function getFriends(){try{return JSON.parse(localStorage.getItem(FRIENDS_KEY)||'[]');}catch{return[];}}
function saveFriends(f){localStorage.setItem(FRIENDS_KEY,JSON.stringify(f));}
function addFriend(runner){
  const friends=getFriends();
  if(friends.find(f=>f.id===runner.id)){showToast('이미 친구예요 😊');return;}
  friends.push({...runner,addedAt:new Date().toISOString()});saveFriends(friends);
  renderFriendsList();showToast('👋 '+runner.nick+'님을 친구로 추가했어요!');
}
function removeFriend(id){saveFriends(getFriends().filter(f=>f.id!==id));renderFriendsList();showToast('친구를 삭제했어요');}
function renderFriendsList(){
  const el=document.getElementById('friends-container');if(!el)return;
  const friends=getFriends();el.innerHTML='';
  if(friends.length){
    const hdr=document.createElement('div');hdr.style.cssText='font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px';hdr.textContent='내 친구 · '+friends.length+'명';el.appendChild(hdr);
    friends.forEach(f=>{
      const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)';
      row.innerHTML='<div style="width:44px;height:44px;border-radius:50%;background:rgba(200,240,80,.08);border:1.5px solid rgba(200,240,80,.15);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">'+f.em+'</div><div style="flex:1"><div style="font-size:14px;color:rgba(255,255,255,.85)">'+f.nick+'</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:1px">'+f.totalKm+'km · '+f.pace+'/km</div></div><button onclick="removeFriend(\'' + f.id + '\')" style="height:30px;padding:0 12px;background:rgba(255,60,60,.07);border:1px solid rgba(255,60,60,.15);border-radius:8px;font-size:10px;font-weight:700;color:rgba(255,80,80,.6);cursor:pointer">삭제</button>';
      el.appendChild(row);
    });
    const sp=document.createElement('div');sp.style.height='20px';el.appendChild(sp);
  }
  const shdr=document.createElement('div');shdr.style.cssText='font-size:10px;font-weight:700;letter-spacing:.14em;color:rgba(255,255,255,.35);margin-bottom:10px';shdr.textContent='추천 러너';el.appendChild(shdr);
  SUGGESTED_RUNNERS.filter(r=>!friends.find(f=>f.id===r.id)).forEach(r=>{
    const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)';
    const rj=JSON.stringify(r).replace(/"/g,'&quot;');
    row.innerHTML='<div style="width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">'+r.em+'</div><div style="flex:1"><div style="font-size:14px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:1px">'+r.level+' · '+r.totalKm+'km</div></div><button onclick="addFriend('+rj+')" style="height:30px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:8px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>';
    el.appendChild(row);
  });
}
function openFriendsModal(){
  const sug=document.getElementById('friend-suggest-container');
  if(sug){sug.innerHTML='';const friends=getFriends();SUGGESTED_RUNNERS.filter(r=>!friends.find(f=>f.id===r.id)).forEach(r=>{const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)';const rj=JSON.stringify(r).replace(/"/g,'&quot;');row.innerHTML='<div style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">'+r.em+'</div><div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:1px">'+r.level+' · '+r.totalKm+'km</div></div><button onclick="addFriend('+rj+');openFriendsModal()" style="height:28px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>';sug.appendChild(row);});}
  openModal('m-friends');
}
function searchFriends(query){
  const el=document.getElementById('friend-search-results');if(!el)return;
  if(!query||query.trim().length<1){el.innerHTML='';return;}
  const q=query.trim().toLowerCase();
  const results=SUGGESTED_RUNNERS.filter(r=>r.nick.toLowerCase().includes(q)||r.id.includes(q));
  const friends=getFriends();el.innerHTML='';
  if(!results.length){el.innerHTML='<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">"'+query+'"에 해당하는 러너가 없어요</div>';return;}
  results.forEach(r=>{
    const isFr=!!friends.find(f=>f.id===r.id);const rj=JSON.stringify(r).replace(/"/g,'&quot;');
    const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05)';
    row.innerHTML='<div style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:18px">'+r.em+'</div><div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,.8)">'+r.nick+'</div><div style="font-size:10px;color:rgba(255,255,255,.3)">'+r.level+' · '+r.totalKm+'km</div></div>'+(isFr?'<span style="font-size:10px;color:rgba(200,240,80,.5)">친구 ✓</span>':'<button onclick="addFriend('+rj+');searchFriends(document.getElementById(\'friend-search-input\').value)" style="height:28px;padding:0 12px;background:rgba(200,240,80,.1);border:1px solid rgba(200,240,80,.2);border-radius:7px;font-size:10px;font-weight:800;color:#c8f050;cursor:pointer">+ 추가</button>');
    el.appendChild(row);
  });
}


// ANON RUNNERS
const ANON_RUNNERS=(function(){
  const nicks=['익명의 러너','새벽의 유령','밤의 러너','달리는 그림자','조용한 발걸음','바람처럼','도시의 유령','새벽 4시','혼자가 아닌','골목 러너','한강 유령','새벽별','이름없는 페이스','그림자 러너','도심 탈출자','묵묵한 발','야간 전문','새벽을 달리다','달리는 그림자2','고요한 발걸음','밤하늘 아래','소리없는 발','0시의 러너','새벽빛'];
  const paceBase=[258,265,272,280,288,295,303,312,320,330,342,355,368,380,400,415,430,445,460,480,295,310,325,340];
  return Array.from({length:24},(_,i)=>{
    const paceS=paceBase[i]+Math.floor(Math.random()*10-5);
    const pm=Math.floor(paceS/60),ps=paceS%60;
    const dist=parseFloat((2.1+Math.random()*13.4).toFixed(2));
    return{id:'ghost_'+i,nick:nicks[i],dist,paceS,paceStr:pm+"'"+String(ps).padStart(2,'0')+'"',time:Math.round(dist*paceS/60),em:['👻','🏃','🌙','⚡','💨'][i%5]};
  });
})();
const ANON_SORTED_DIST=[...ANON_RUNNERS].sort((a,b)=>b.dist-a.dist).slice(0,10);
const ANON_SORTED_PACE=[...ANON_RUNNERS].sort((a,b)=>a.paceS-b.paceS).slice(0,10);
const ANON_TOTAL_KM=parseFloat(ANON_RUNNERS.reduce((s,r)=>s+r.dist,0).toFixed(1));

function buildHomeLiveStats(){
  const cnt=document.getElementById('hm-runner-count'),tkm=document.getElementById('hm-total-km'),avgP=document.getElementById('hm-avg-pace'),active=document.getElementById('hm-active-now');
  if(cnt)cnt.textContent=ANON_RUNNERS.length;
  if(tkm)tkm.textContent=ANON_TOTAL_KM;
  if(active)active.textContent=Math.floor(ANON_RUNNERS.length*.33);
  if(avgP){const avgS=Math.round(ANON_RUNNERS.reduce((s,r)=>s+r.paceS,0)/ANON_RUNNERS.length),m=Math.floor(avgS/60),s2=avgS%60;avgP.textContent=m+"'"+String(s2).padStart(2,'0')+'"';}
}

function buildLeaderboard(type){
  const list=type==='dist'?ANON_SORTED_DIST:ANON_SORTED_PACE;
  const el=document.getElementById('lb-'+type);
  if(!el)return;el.innerHTML='';
  const COL=r=>r===1?'#d4b54a':r===2?'#a0aab4':r===3?'#b07444':'rgba(255,255,255,.35)';
  list.forEach((runner,i)=>{
    const rank=i+1,medal=rank<=3?['🥇','🥈','🥉'][rank-1]:rank;
    const mainVal=type==='dist'?`<span style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:#fff;line-height:1">${runner.dist.toFixed(2)}<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.35)"> km</span></span>`:`<span style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:#c8f050;line-height:1">${runner.paceStr}<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.35)"> /km</span></span>`;
    const subVal=type==='dist'?`<span style="font-size:10px;color:rgba(255,255,255,.3)">${runner.paceStr}/km · ${runner.time}분</span>`:`<span style="font-size:10px;color:rgba(255,255,255,.3)">${runner.dist.toFixed(2)}km · ${runner.time}분</span>`;
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)';
    row.innerHTML=`<div style="width:32px;text-align:center;font-size:${rank<=3?'20':'13'}px;font-family:'Barlow Condensed',sans-serif;font-weight:800;color:${COL(rank)};flex-shrink:0">${medal}</div><div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${runner.em}</div><div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:400;color:rgba(255,255,255,.6);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${runner.nick}</div><div>${subVal}</div></div><div style="text-align:right">${mainVal}</div>`;
    el.appendChild(row);
  });
}

function switchLbTab(type){
  document.querySelectorAll('.lb-tab').forEach(t=>{const isOn=t.dataset.lb===type;t.style.background=isOn?'rgba(200,240,80,.1)':'rgba(255,255,255,.04)';t.style.borderColor=isOn?'rgba(200,240,80,.3)':'rgba(255,255,255,.08)';t.style.color=isOn?'#c8f050':'rgba(255,255,255,.4)';});
  const dEl=document.getElementById('lb-dist'),pEl=document.getElementById('lb-pace');
  if(dEl)dEl.style.display=type==='dist'?'block':'none';
  if(pEl)pEl.style.display=type==='pace'?'block':'none';
}

function buildInstaFeed(){
  const feed=document.getElementById('insta-feed');
  if(!feed)return;feed.innerHTML='';
  INSTA_POSTS.forEach(post=>{
    const card=document.createElement('div');
    card.style.cssText='flex-shrink:0;width:160px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.07);cursor:pointer;transition:transform .15s;background:'+post.colors[0];
    card.innerHTML=`<div style="height:160px;background:linear-gradient(${post.accentAngle},${post.colors[0]},${post.colors[1]});position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden"><div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 70%,rgba(200,240,80,.08),transparent 55%)"></div><div style="text-align:center;position:relative"><div style="font-size:42px">${post.em}</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:#c8f050;line-height:1">${post.dist.toFixed(2)}</div><div style="font-size:10px;color:rgba(200,240,80,.6);letter-spacing:.1em">km</div></div><div style="position:absolute;bottom:8px;left:10px;right:10px"><div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;color:rgba(255,255,255,.7)">${post.pace}<span style="font-size:9px;opacity:.6"> /km</span></div></div></div><div style="padding:10px 11px 12px"><div style="font-size:11px;color:rgba(255,255,255,.75);margin-bottom:4px">${post.user}</div><div style="font-size:10px;color:rgba(255,255,255,.45);line-height:1.4">${post.caption}</div><div style="font-size:8px;color:rgba(255,255,255,.2);margin-top:5px">${post.date}</div></div>`;
    card.addEventListener('click',()=>showToast('👻 '+post.user+' · '+post.dist+'km'));
    card.addEventListener('mouseenter',()=>{card.style.transform='scale(.97)';});
    card.addEventListener('mouseleave',()=>{card.style.transform='';});
    feed.appendChild(card);
  });
}

function initHome(){
  buildHomeLiveStats();buildInstaFeed();buildLeaderboard('dist');buildLeaderboard('pace');
  setInterval(()=>{
    const cnt=document.getElementById('hm-runner-count'),active=document.getElementById('hm-active-now');
    if(cnt){const n=parseInt(cnt.textContent)+(Math.random()>.6?(Math.random()>.5?1:-1):0);cnt.textContent=Math.max(18,Math.min(35,n));}
    if(active){const a=parseInt(active.textContent)+(Math.random()>.7?(Math.random()>.5?1:-1):0);active.textContent=Math.max(6,Math.min(12,a));}
  },4000);
}
initHome();

// ROUTE DATA
const ROUTE=[[37.5665,126.978],[37.567,126.979],[37.5676,126.9796],[37.5682,126.9803],[37.5687,126.9814],[37.5681,126.9822],[37.5673,126.9828],[37.5664,126.9822],[37.5656,126.9815],[37.565,126.9804],[37.5648,126.9793],[37.5654,126.9782],[37.566,126.9778],[37.5665,126.978]];
const ROUTES=[ROUTE,ROUTE.map(p=>[p[0]+.003,p[1]-.002]),ROUTE.map(p=>[p[0]-.002,p[1]+.003])];

// STATE
let curTab='home',selEm='👻',recInited=false;

// SPLASH
function hideSplash(){
  const sp=document.getElementById('splash');if(!sp)return;
  sp.classList.add('out');
  setTimeout(()=>{if(sp.parentNode)sp.parentNode.removeChild(sp);if(!GR_API.currentUser())showLoginScreen();},800);
}

// CLOCK
function tick(){
  const n=new Date(),p=v=>String(v).padStart(2,'0');
  const clockEl=document.getElementById('clock');if(clockEl)clockEl.textContent=`${p(n.getHours())}:${p(n.getMinutes())}`;
  const ds=`${n.getFullYear()}.${p(n.getMonth()+1)}.${p(n.getDate())}`;
  const dtg=document.getElementById('dt-g');if(dtg)dtg.innerHTML=`${ds}<br>${n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}`;
  const bd=document.getElementById('bd');if(bd)bd.textContent=ds;
  const sc=document.getElementById('setup-clock');if(sc)sc.textContent=`${p(n.getHours())}:${p(n.getMinutes())}`;
}
tick();setInterval(tick,1000);

// TABS
function goTab(v){
  if(v===curTab&&v!=='run')return;curTab=v;
  document.querySelectorAll('.mview').forEach(el=>el.classList.remove('on'));
  const view=document.getElementById('v-'+v);if(view)view.classList.add('on');
  document.querySelectorAll('.btab').forEach(t=>t.classList.toggle('on',t.dataset.v===v));
  if(v==='crew'){switchRoomTab('browse');renderRoomTabs();}
  if(v==='records')initRec();
  if(v==='shot')applyRank();
}
document.getElementById('btabs').addEventListener('click',e=>{const b=e.target.closest('.btab');if(b)goTab(b.dataset.v);});

// GOAL TYPE
let goalType='dist',goalVal='5';
document.querySelectorAll('.gt').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.gt').forEach(x=>x.classList.remove('on'));el.classList.add('on');goalType=el.dataset.gt;
    ['gvd','gvt','gvs'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});
    const mapId={dist:'gvd',time:'gvt',speed:'gvs'};
    const activeGrid=document.getElementById(mapId[goalType]);if(activeGrid)activeGrid.style.display='grid';
    const onEl=document.querySelector('#'+(mapId[goalType]||'gvd')+' .gv.on');goalVal=onEl?onEl.dataset.v:'5';
  });
});
['gvd','gvt','gvs'].forEach(gid=>{
  const grid=document.getElementById(gid);if(!grid)return;
  grid.querySelectorAll('.gv').forEach(el=>{
    el.addEventListener('click',()=>{grid.querySelectorAll('.gv').forEach(x=>x.classList.remove('on'));el.classList.add('on');goalVal=el.dataset.v;});
  });
});

// RUN STATE
let runTimer=null,runSec=0,runDist=0,runPaused=false,watchId=null;
let locGranted=false,userLat=37.5665,userLng=126.978;
let pathCoords=[],clapCount=0;

function requestHealthAccess(){const m=document.getElementById('health-modal');if(m)m.style.display='flex';}
function grantHealthAccess(){
  const m=document.getElementById('health-modal');if(m)m.style.display='none';
  locGranted=true;
  if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{userLat=pos.coords.latitude;userLng=pos.coords.longitude;},err=>{console.warn('GPS:',err);},{enableHighAccuracy:true,timeout:8000});}
  showToast('건강 데이터 접근이 허용됐어요');startRun();
}
function denyHealthAccess(){const m=document.getElementById('health-modal');if(m)m.style.display='none';locGranted=false;showToast('GPS 없이 시뮬레이션으로 진행됩니다');startRun();}

function initRunSVG(){
  const rp=document.getElementById('run-path');if(!rp)return;
  try{const len=rp.getTotalLength();rp.style.strokeDasharray=len;rp.style.strokeDashoffset=len;}catch(e){}
}

function updateRunSVG(pct){
  const rp=document.getElementById('run-path');if(!rp)return;
  try{
    const len=rp.getTotalLength();rp.style.strokeDashoffset=len*(1-Math.min(pct,1));
    const pt=rp.getPointAtLength(len*Math.min(pct,.999));
    const dot=document.getElementById('runner-dot'),glow=document.getElementById('runner-glow');
    if(dot){dot.setAttribute('cx',pt.x);dot.setAttribute('cy',pt.y);}
    if(glow){glow.setAttribute('cx',pt.x);glow.setAttribute('cy',pt.y);}
  }catch(e){}
}

function buildRacingTrack(){
  const container=document.getElementById('track-ghosts');if(!container)return;
  container.innerHTML='';
  const maxGoal=parseFloat(goalVal)||5;
  ANON_RUNNERS.slice(0,5).forEach(r=>{
    const pct=Math.min(r.dist/maxGoal*100,92);
    const icon=document.createElement('div');
    icon.style.cssText=`position:absolute;top:50%;left:${pct}%;transform:translate(-50%,-50%);font-size:16px;z-index:1`;
    icon.textContent=r.em;container.appendChild(icon);
  });
  const myIcon=document.createElement('div');
  myIcon.id='my-ghost';myIcon.style.cssText='position:absolute;top:50%;left:0%;transform:translate(-50%,-50%);font-size:22px;z-index:5;filter:drop-shadow(0 0 6px #c8f050)';
  myIcon.textContent=currentUser?currentUser.avatar||'👻':'👻';container.appendChild(myIcon);
}

function updateRacingTrack(pct){
  const mg=document.getElementById('my-ghost');if(mg)mg.style.left=Math.min(pct,92)+'%';
  const tf=document.getElementById('track-fill');if(tf)tf.style.width=Math.min(pct,100)+'%';
}

function startRun(){
  document.getElementById('rsetup').classList.remove('on');
  document.getElementById('rpaused').classList.remove('on');
  document.getElementById('ractive').classList.add('on');
  const goalNumLabel={dist:goalVal+'KM',time:goalVal+'MIN',speed:'PACE GOAL',free:'FREE RUN'};
  const glEl=document.getElementById('ra-gl-txt');if(glEl)glEl.textContent=(goalNumLabel[goalType]||'5KM')+' GOAL';
  const rap=document.getElementById('ra-profile');if(rap&&currentUser)rap.textContent=currentUser.avatar||'👻';
  runSec=0;runDist=0;runPaused=false;pathCoords=[];clapCount=0;
  const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent='0';
  initRunSVG();buildRacingTrack();
  if(locGranted){
    watchId=navigator.geolocation.watchPosition(
      pos=>{const lat=pos.coords.latitude,lng=pos.coords.longitude;if(pathCoords.length>0){const prev=pathCoords[pathCoords.length-1];runDist+=haversine(prev[0],prev[1],lat,lng);}pathCoords.push([lat,lng]);},
      err=>{console.warn('GPS error:',err.code);},
      {enableHighAccuracy:true,maximumAge:1000,timeout:10000}
    );
  }
  runTimer=setInterval(runTick,1000);
}

function runTick(){
  if(runPaused)return;runSec++;
  if(!locGranted)runDist+=0.0014+Math.random()*.0008;
  const mins=Math.floor(runSec/60),secs=runSec%60;
  const distEl=document.getElementById('ra-dist'),paceEl=document.getElementById('ra-pace'),timeEl=document.getElementById('ra-time'),calEl=document.getElementById('ra-cal');
  if(distEl)distEl.textContent=runDist.toFixed(2);
  if(timeEl)timeEl.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  if(calEl)calEl.textContent=Math.round(runDist*65);
  const paceS=runDist>0?Math.round(runSec/runDist):0,pm=Math.floor(paceS/60),ps=paceS%60;
  if(paceEl)paceEl.textContent=runDist>0?(pm+"'"+String(ps).padStart(2,'0')+'"'):"--'--\"";
  let pct=0;const gv=parseFloat(goalVal)||5;
  if(goalType==='dist')pct=runDist/gv;else if(goalType==='time')pct=runSec/(gv*60);else pct=runDist/5;
  updateRunSVG(pct);updateRacingTrack(Math.min(pct*100,100));
}

function haversine(la1,lo1,la2,lo2){
  const R=6371,dLa=(la2-la1)*Math.PI/180,dLo=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function handlePauseTap(){
  if(!runPaused){
    runPaused=true;
    document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.add('on');
    const mins=Math.floor(runSec/60),secs=runSec%60;
    const psd=document.getElementById('ps-dist'),pst=document.getElementById('ps-time'),psp=document.getElementById('ps-pace');
    if(psd)psd.textContent=runDist.toFixed(2);
    if(pst)pst.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
    const paceS=runDist>0?Math.round(runSec/runDist):0,pm2=Math.floor(paceS/60),ps2=paceS%60;
    if(psp)psp.textContent=runDist>0?(pm2+"'"+String(ps2).padStart(2,'0')+'"'):"--'--\"";
  }
}
function resumeRun(){runPaused=false;document.getElementById('rpaused').classList.remove('on');document.getElementById('ractive').classList.add('on');showToast('계속 달려요!');}
function togglePause(){handlePauseTap();}

function doClap(){
  clapCount++;const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent=clapCount;
  const em=document.getElementById('clap-em');if(em){em.style.transform='scale(1.5) rotate(-10deg)';setTimeout(()=>{em.style.transform='';},300);}
  const rv=document.getElementById('v-run');
  if(rv){const float=document.createElement('div');float.style.cssText='position:absolute;pointer-events:none;font-size:22px;z-index:50;animation:clapFloat .8s ease forwards;left:'+(20+Math.random()*60)+'%;bottom:80px';float.textContent='👏';rv.appendChild(float);setTimeout(()=>{if(float.parentNode)float.parentNode.removeChild(float);},800);}
  if(navigator.vibrate)navigator.vibrate([30,20,30]);
  showToast('👏 하이파이브! 근처 러너에게 전달됐어요');
}
function toggleFullMap(){const c=document.getElementById('ra-map-container');if(!c)return;c.style.flex=c.style.flex==='2'?'1':'2';}

function stopRun(){
  clearInterval(runTimer);runTimer=null;
  if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
  document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.remove('on');document.getElementById('rfinish').classList.add('on');
  const mins=Math.floor(runSec/60),secs=runSec%60;
  const rfD=document.getElementById('rf-d'),rfT=document.getElementById('rf-t'),rfP=document.getElementById('rf-p'),rfC=document.getElementById('rf-c'),rfMsg=document.getElementById('rf-msg');
  if(rfD)rfD.textContent=runDist.toFixed(2);
  if(rfT)rfT.textContent=String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  if(rfC)rfC.textContent=Math.round(runDist*65);
  const paceS=runDist>0?Math.round(runSec/runDist):0,pm=Math.floor(paceS/60),ps=paceS%60;
  if(rfP)rfP.textContent=runDist>0?(pm+"'"+String(ps).padStart(2,'0')+'"'):"--'--\"";
  if(rfMsg)rfMsg.textContent=runDist>=5?'오늘도 멋지게 달렸어요 🎉':runDist>=2?'좋은 페이스예요!':'내일은 더 멀리 달려봐요';
  if(currentUser)GR_API.updateUser({totalKm:(currentUser.totalKm||312.4)+runDist,runCount:(currentUser.runCount||62)+1}).then(u=>{currentUser=u;});
}

function resetRun(){
  document.getElementById('rfinish').classList.remove('on');document.getElementById('ractive').classList.remove('on');document.getElementById('rpaused').classList.remove('on');document.getElementById('rsetup').classList.add('on');
  runSec=0;runDist=0;clapCount=0;const ccEl=document.getElementById('clap-count');if(ccEl)ccEl.textContent='0';
}

// SHOT
function applyRank(){
  const emB=document.getElementById('em-b');if(emB)emB.textContent=currentUser?currentUser.avatar||'👻':'👻';
  drawRoute(document.getElementById('mmg'),{ri:0});
  drawRoute(document.getElementById('mmp'),{lw:3,pad:18,alpha:.2,ri:0});
  drawRoute(document.getElementById('mms'),{ri:0});
}

function drawRoute(canvas,opts={}){
  if(!canvas)return;
  const{stroke='#c8f050',lw=1.5,pad=7,alpha=.82,ri=0}=opts;
  const R=ROUTES[ri%3],W=canvas.width,H=canvas.height,ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const la=R.map(p=>p[0]),ln=R.map(p=>p[1]);
  const mla=Math.min(...la),xla=Math.max(...la),mln=Math.min(...ln),xln=Math.max(...ln);
  const rl=xla-mla||.001,rn=xln-mln||.001;
  const xy=(a,n2)=>[pad+(n2-mln)/rn*(W-pad*2),pad+(xla-a)/rl*(H-pad*2)];
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw+2;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=.08;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  ctx.save();ctx.strokeStyle=stroke;ctx.lineWidth=lw;ctx.lineJoin='round';ctx.lineCap='round';ctx.globalAlpha=alpha;
  ctx.beginPath();R.forEach(([a,n2],i)=>{const[x,y]=xy(a,n2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();ctx.restore();
  const last=R[R.length-1];const[ex,ey]=xy(last[0],last[1]);
  ctx.save();ctx.beginPath();ctx.arc(ex,ey,2.5,0,Math.PI*2);ctx.fillStyle=stroke;ctx.shadowColor=stroke;ctx.shadowBlur=6;ctx.fill();ctx.restore();
}

let AT='g';
document.getElementById('tbar').addEventListener('click',e=>{
  const b=e.target.closest('.th');if(!b)return;const t=b.dataset.t;if(t===AT)return;AT=t;
  ['ov-g','ov-p','ov-s'].forEach(id=>document.getElementById(id).classList.toggle('off',!id.endsWith(t)));
  document.querySelectorAll('.th').forEach(x=>x.classList.toggle('on',x.dataset.t===t));
});

let pURL=null;
const bgEl=document.getElementById('bg-img'),emEl=document.getElementById('empty-state');
function loadFile(f){
  if(!f||!f.type.startsWith('image/'))return;if(pURL)URL.revokeObjectURL(pURL);
  pURL=URL.createObjectURL(f);bgEl.onload=()=>{bgEl.style.opacity='1';if(emEl)emEl.style.display='none';};bgEl.src=pURL;
}
document.getElementById('ic').addEventListener('change',e=>loadFile(e.target.files[0]));
document.getElementById('ig').addEventListener('change',e=>loadFile(e.target.files[0]));

// AVATARS
const AVATARS=[{e:'👻',l:'유령'},{e:'🧛',l:'뱀파이어'},{e:'🧟',l:'좀비'},{e:'🧌',l:'괴물'},{e:'💀',l:'해골'},{e:'🕷',l:'거미'},{e:'🦇',l:'박쥐'},{e:'🐺',l:'늑대'},{e:'😈',l:'악마'},{e:'🎃',l:'호박'}];
(function(){
  const g=document.getElementById('avgrid');
  AVATARS.forEach((av,i)=>{
    const c=document.createElement('div');c.className='avc'+(i===0?' on':'');
    c.innerHTML=`<span class="ave">${av.e}</span><span class="avl">${av.l}</span>`;
    c.addEventListener('click',()=>{
      document.querySelectorAll('.avc').forEach(x=>x.classList.remove('on'));c.classList.add('on');
      ['g','p','s'].forEach(t=>{const em=document.getElementById('em-'+t),nm=document.getElementById('nm-'+t);if(em)em.textContent=av.e;if(nm)nm.textContent=currentUser?currentUser.nickname:'Runner';});
      const emb=document.getElementById('em-b');if(emb)emb.textContent=av.e;closeAv();
      if(currentUser)GR_API.updateUser({avatar:av.e}).then(u=>{currentUser=u;const np=document.getElementById('nav-profile');if(np)np.textContent=av.e;});
    });g.appendChild(c);
  });
})();
function openAv(){document.getElementById('avs').classList.add('on');}
function closeAv(){document.getElementById('avs').classList.remove('on');}
document.getElementById('avs').addEventListener('click',function(e){if(e.target===this)closeAv();});

// RECORDS
function initRec(){
  if(recInited)return;recInited=true;
  const today=new Date(),days=new Date(today.getFullYear(),today.getMonth()+1,0).getDate(),runDays=new Set([5,10,14,18]);
  const cg=document.getElementById('cal-grid');
  if(cg){for(let d=1;d<=days;d++){const dot=document.createElement('div');dot.className='cal-d'+(d===today.getDate()?' today':runDays.has(d)?' run':'');cg.appendChild(dot);}}
  setTimeout(()=>{const rf=document.getElementById('rt-fill');if(rf)rf.style.width='38%';},100);
  const logEl=document.getElementById('run-log');
  if(logEl)PAST_LOGS.forEach(r=>{
    const item=document.createElement('div');item.className='log-item';
    const cv=document.createElement('canvas');cv.width=52;cv.height=52;cv.className='log-cv';drawRoute(cv,{stroke:'#c8f050',lw:1.5,pad:6,alpha:.8,ri:r.ri});
    item.innerHTML=`<div class="log-date"><span class="log-mo">${r.mo}</span><span class="log-dy">${r.date.split('.')[1]}</span></div>`;item.appendChild(cv);
    const info=document.createElement('div');info.className='log-info';
    info.innerHTML=`<span class="log-km">${r.d.toFixed(2)}<span style="font-size:16px;color:var(--dim)"> km</span></span><span class="log-sub">${r.pace}/km · ${r.time}</span>`;item.appendChild(info);
    const right=document.createElement('div');right.className='log-right';right.innerHTML=`<span class="log-kcal">${r.cal} kcal</span>`;item.appendChild(right);
    logEl.appendChild(item);
  });
}

// MODALS
function openModal(id){const el=document.getElementById(id);if(el)el.style.display='flex';}
function closeModal(id){const el=document.getElementById(id);if(el)el.style.display='none';}
document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',function(e){if(e.target===this)closeModal(this.id);});});

document.getElementById('bsave').addEventListener('click',()=>{
  const fl=document.getElementById('flash');fl.classList.add('on');setTimeout(()=>fl.classList.remove('on'),180);showToast('인증샷이 저장됐어요');
});

let toastTimer=null;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('on'),2400);}

// GR_API
const GR_API={
  _DB_KEY:'ghostrun_users',_SESSION_KEY:'ghostrun_session',_SRV_URL:null,
  _getDB(){try{return JSON.parse(localStorage.getItem(this._DB_KEY)||'{}')}catch{return{}}},
  _saveDB(db){localStorage.setItem(this._DB_KEY,JSON.stringify(db))},
  _getSession(){try{return JSON.parse(localStorage.getItem(this._SESSION_KEY)||'null')}catch{return null}},
  _saveSession(s){localStorage.setItem(this._SESSION_KEY,JSON.stringify(s))},
  _clearSession(){localStorage.removeItem(this._SESSION_KEY)},
  _delay(ms=320){return new Promise(r=>setTimeout(r,ms))},
  async register(email,password,nickname){
    await this._delay();const db=this._getDB();
    if(db[email])throw new Error('이미 사용 중인 이메일이에요');
    if(password.length<6)throw new Error('비밀번호는 6자 이상이어야 해요');
    if(nickname.trim().length<2)throw new Error('닉네임은 2자 이상이어야 해요');
    const user={id:'GR_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),email,nickname:nickname.trim(),avatar:'👻',totalKm:0,runCount:0,joinedAt:new Date().toISOString(),_pw:btoa(password)};
    db[email]=user;this._saveDB(db);const session={...user};delete session._pw;this._saveSession(session);return session;
  },
  async login(email,password){
    await this._delay();const db=this._getDB(),user=db[email];
    if(!user)throw new Error('등록된 이메일이 없어요');
    if(atob(user._pw||'')!==password)throw new Error('비밀번호가 맞지 않아요');
    const session={...user};delete session._pw;this._saveSession(session);return session;
  },
  async logout(){await this._delay(100);this._clearSession();},
  async socialLogin(provider){
    await this._delay(500);const mockNames={kakao:'카카오러너',naver:'네이버러너',google:'구글러너'};
    const mockEmail=provider+'_'+Date.now()+'@ghostrun.mock';const db=this._getDB();
    if(!db[mockEmail]){const user={id:'GR_'+provider+'_'+Date.now(),email:mockEmail,nickname:mockNames[provider]||provider,avatar:'👻',totalKm:0,runCount:0,joinedAt:new Date().toISOString(),provider};db[mockEmail]=user;this._saveDB(db);}
    const session={...db[mockEmail]};delete session._pw;this._saveSession(session);return session;
  },
  async updateUser(fields){
    await this._delay(200);const session=this._getSession();if(!session)return;
    const db=this._getDB();if(db[session.email])Object.assign(db[session.email],fields);this._saveDB(db);
    const updated={...session,...fields};this._saveSession(updated);return updated;
  },
  currentUser(){return this._getSession();},
  async ping(){if(this._SRV_URL){try{const r=await fetch(this._SRV_URL+'/ping',{signal:AbortSignal.timeout(3000)});return r.ok;}catch{return false;}}return true;}
};

// AUTH
let authMode='login',currentUser=null;
function showLoginScreen(){const ls=document.getElementById('login-screen');if(!ls)return;ls.style.display='flex';ls.classList.remove('out');}
function hideLoginScreen(){const ls=document.getElementById('login-screen');if(!ls)return;ls.classList.add('out');setTimeout(()=>{ls.style.display='none';},600);}
function toggleAuthMode(){
  authMode=authMode==='login'?'register':'login';const isReg=authMode==='register';
  const mt=document.getElementById('ls-mode-title'),ms=document.getElementById('ls-mode-sub'),ni=document.getElementById('ls-nick'),sb=document.getElementById('ls-submit'),sw=document.getElementById('ls-switch'),err=document.getElementById('ls-err'),pw=document.getElementById('ls-pw');
  if(mt)mt.textContent=isReg?'회원가입':'로그인';if(ms)ms.textContent=isReg?'새 계정을 만들어보세요':'계속하려면 로그인하세요';
  if(ni)ni.style.display=isReg?'block':'none';if(sb)sb.textContent=isReg?'가입하기':'로그인';
  if(sw)sw.innerHTML=isReg?'이미 계정이 있으신가요? <span>로그인</span>':'계정이 없으신가요? <span>회원가입</span>';
  if(err)err.textContent='';if(pw)pw.setAttribute('autocomplete',isReg?'new-password':'current-password');
}
async function submitAuth(){
  const emailEl=document.getElementById('ls-email'),pwEl=document.getElementById('ls-pw'),nickEl=document.getElementById('ls-nick'),errEl=document.getElementById('ls-err'),btn=document.getElementById('ls-submit');
  if(!emailEl||!pwEl||!errEl||!btn)return;
  const email=emailEl.value.trim(),pw=pwEl.value,nick=nickEl?nickEl.value.trim():'';
  errEl.textContent='';if(!email){errEl.textContent='이메일을 입력해주세요';return;}if(!pw){errEl.textContent='비밀번호를 입력해주세요';return;}
  btn.textContent='처리 중...';btn.style.opacity='.6';btn.disabled=true;
  try{
    let user;
    if(authMode==='register'){if(!nick){errEl.textContent='닉네임을 입력해주세요';return;}user=await GR_API.register(email,pw,nick);showToast('회원가입이 완료됐어요!');}
    else{user=await GR_API.login(email,pw);showToast('어서오세요, '+user.nickname+'님!');}
    onLoginSuccess(user);
  }catch(e){if(errEl)errEl.textContent=e.message;}
  finally{if(btn){btn.textContent=authMode==='register'?'가입하기':'로그인';btn.style.opacity='1';btn.disabled=false;}}
}
async function socialLogin(provider){
  const errEl=document.getElementById('ls-err');if(errEl)errEl.textContent=provider+' 로그인 처리 중...';
  try{const user=await GR_API.socialLogin(provider);showToast('어서오세요, '+user.nickname+'님!');onLoginSuccess(user);}catch(e){if(errEl)errEl.textContent=e.message;}
}
function onLoginSuccess(user){
  currentUser=user;const np=document.getElementById('nav-profile');if(np)np.textContent=user.avatar||'👻';
  ['nm-g','nm-p','nm-s'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=user.nickname;});
  hideLoginScreen();setSrvBadge(true);
}
function openProfile(){
  if(!currentUser){showLoginScreen();return;}const u=currentUser,box=document.getElementById('prof-box');if(!box)return;
  box.innerHTML=`<div class="prof-hd"><div class="prof-avatar">${u.avatar||'👻'}</div><div><div class="prof-name">${u.nickname}</div><div class="prof-email">${u.email}</div><div class="prof-joined">가입일 ${new Date(u.joinedAt).toLocaleDateString('ko-KR')}</div></div></div><div class="prof-stats-row"><div class="prof-st"><span class="prof-sl">총 거리</span><span class="prof-sv">${(u.totalKm||312.4).toFixed(1)}<span style="font-size:12px;color:var(--dim)"> km</span></span></div><div class="prof-st"><span class="prof-sl">런 횟수</span><span class="prof-sv">${u.runCount||62}<span style="font-size:12px;color:var(--dim)"> 회</span></span></div></div><div class="prof-menu-item" onclick="editNickname()"><span class="prof-menu-em">✏️</span><span class="prof-menu-txt">닉네임 변경</span><span class="prof-menu-arrow">›</span></div><div class="prof-menu-item" onclick="editAvatar()"><span class="prof-menu-em">👻</span><span class="prof-menu-txt">아바타 변경</span><span class="prof-menu-arrow">›</span></div><button class="prof-logout" onclick="doLogout()">로그아웃</button>`;
  openModal('m-profile');
}
async function doLogout(){await GR_API.logout();currentUser=null;recInited=false;const np=document.getElementById('nav-profile');if(np)np.textContent='👤';closeModal('m-profile');showLoginScreen();showToast('로그아웃됐어요');}
function editNickname(){const n=prompt('새 닉네임','');if(!n||n.trim().length<2){showToast('닉네임은 2자 이상');return;}GR_API.updateUser({nickname:n.trim()}).then(u=>{currentUser=u;closeModal('m-profile');setTimeout(openProfile,200);showToast('닉네임이 변경됐어요');});}
function editAvatar(){closeModal('m-profile');openAv();}
function setSrvBadge(online){const badge=document.getElementById('srv-badge'),txt=document.getElementById('srv-txt');if(!badge||!txt)return;badge.classList.toggle('online',online);txt.textContent=online?'서버 연결됨':'서버 오프라인';setTimeout(()=>{badge.style.opacity='0';},3000);}
async function checkServer(){const online=await GR_API.ping();setSrvBadge(online);}

// INIT
(function initApp(){
  const badge=document.getElementById('srv-badge');if(badge)badge.style.opacity='1';checkServer();
  const session=GR_API.currentUser();
  if(session){currentUser=session;const np=document.getElementById('nav-profile');if(np)np.textContent=session.avatar||'👻';['nm-g','nm-p','nm-s'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=session.nickname;});}
})();

</script>
</body>
</html>
